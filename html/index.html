<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCGtrade - Intercambio Pokémon TCG</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKQAAADlAAAA5QAAAKQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApAAAAOUAAADlAAAA5QAAAP8AAAD/AAAA/wAAAP8AAADlAAAA5QAAAOUAAACkAAAAAAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAApAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAApAAAAAAAAACkAAAA5QAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA5QAAAKQAAACkAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAKQAAACkAAAA5QAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA5QAAAKQAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAApAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAApAAAAAAAAAAAAAAAAAAAAKQAAADlAAAA5QAAAP8AAAD/AAAA/wAAAP8AAADlAAAA5QAAAOUAAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApAAAAP8AAAD/AAAA/wAAAP8AAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApAAAAOUAAADlAAAApAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==">
    <!-- Favicon placeholder - Pokéball style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase - Usando versión más reciente compat para compatibilidad -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/js/main.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1a1a1a',
                        'dark-card': '#2d2d2d',
                        'dark-text': '#ffffff',
                        'dark-text-secondary': '#a0a0a0'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos para modo oscuro */
        .dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .dark-mode .bg-white {
            background-color: #2d2d2d;
        }
        
        .dark-mode .text-gray-800 {
            color: #ffffff;
        }
        
        .dark-mode .text-gray-600 {
            color: #a0a0a0;
        }
        
        .dark-mode .text-gray-700 {
            color: #d1d5db;
        }
        
        .dark-mode .border-gray-200 {
            border-color: #4b5563;
        }
        
        .dark-mode .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        
        /* Transiciones suaves */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        

    </style>

    <script type="module">
        // Importar las funciones necesarias de Firebase
        // Deploy forzado: 2024-01-16 - Correcciones completas de modo oscuro aplicadas
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken, updateEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getDatabase } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        
        // Importar módulos de chat
        import ChatManager from '/js/modules/chat.js?v=33';
        import ChatUI from '/js/modules/chat-ui.js?v=33';
        import { ChatDebugger } from '/js/modules/chat-debug.js?v=33';
        
        // Importar módulos de migración y sincronización
        import DataMigration from '/js/modules/data-migration.js?v=34';
        import DataSync from '/js/modules/data-sync.js?v=34';
        

        // CONFIGURACIÓN DE FIREBASE - REEMPLAZA CON TUS DATOS
        const firebaseConfig = {
            apiKey: "AIzaSyCkgz6_Zpu0VOW6GgJxOxd9QlVccsBXnog",
            authDomain: "tcgtrade-7ba27.firebaseapp.com",
            projectId: "tcgtrade-7ba27",
            storageBucket: "tcgtrade-7ba27.firebasestorage.app",
            messagingSenderId: "207150886257",
            appId: "1:207150886257:web:26edebbeb7df7a1d935ad0",
            databaseURL: "https://tcgtrade-7ba27-default-rtdb.europe-west1.firebasedatabase.app" // URL de Realtime Database
         };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ID único de tu aplicación para Firestore
        const appId = 'tcgtrade-pokemon-app';
        
        // Hacer disponibles globalmente para compatibilidad con main.js
        window.auth = auth;
        window.db = db;
        window.EmailAuthProvider = EmailAuthProvider;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.updateEmail = updateEmail;
        window.updatePassword = updatePassword;
        window.reauthenticateWithCredential = reauthenticateWithCredential;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        
        // Emitir evento cuando Firebase esté listo (por si algún módulo lo necesita)
        setTimeout(() => {
            window.dispatchEvent(new CustomEvent('firebaseReady', {
                detail: { auth, db, EmailAuthProvider }
            }));
            console.log('🔥 Evento firebaseReady emitido');
        }, 100);

        // Variables globales
        let currentUser = null;
        let allSets = []; // Cache para todos los sets de la API
        let userCardsCache = []; // Cache para las cartas del usuario
        
        // Variables para migración y sincronización
        let dataMigration = null;
        let dataSync = null;
        
        // Variable para búsqueda avanzada
        let advancedSearch = null;
        
        // Hacer variables disponibles globalmente
        window.currentUser = currentUser;
        window.userCardsCache = userCardsCache;
        window.dataMigration = dataMigration;
        window.dataSync = dataSync;
        window.advancedSearch = advancedSearch;
        let chatManager = null; // Gestor de chat
        let chatUI = null; // UI del chat

        // Referencias a elementos del DOM
        let searchInput, searchResultsSection, heroSection, howItWorksSection, cardsContainer, loadingSpinner, noResultsMessage, errorMessage;
        let authModal, loginForm, registerForm, loginEmailInput, loginPasswordInput, loginBtn, loginError;
        let registerEmailInput, registerPasswordInput, confirmPasswordInput, registerBtn, registerError;
        let closeAuthModalBtn, toggleToRegister, toggleToLogin;
        let loginLink, registerLink, profileLink, logoutLink;
        let myCardsNavLink, myCardsLink, myCardsSection, myCardsContainer, noMyCardsMessage, myCardsErrorMessage;
        let seriesFilter, setFilter, languageFilter, applyFiltersBtn, showAllSetCardsToggle;
        let profileSection, profileSidebarLinks, profileGeneralInfo, profileMyCardsTabContent, profileTradeHistory, profileSettings;
        let profileEmailDisplay, profileUidDisplay, profileMemberSince, profileLoginRequiredMessage, profileGeneralInfoContent;
        let profileNameInput, profileLastNameInput, profileAddressInput, profilePhoneInput, profileSaveMessage, saveProfileBtn;
        let settingsNewEmailInput, emailChangeMessage, saveEmailBtn;
        let settingsCurrentPasswordInput, settingsNewPasswordInput, settingsConfirmNewPasswordInput, passwordChangeMessage, savePasswordBtn;
        let darkModeToggle, interchangesSection, helpSection;

        // Token de autenticación inicial (si existe)
        const initialAuthToken = null; // Puedes configurar esto si tienes un token personalizado

        // --- Funciones de Utilidad ---
        function showLoadingSpinner() {
            if (loadingSpinner) loadingSpinner.style.display = 'block';
        }

        function hideLoadingSpinner() {
            if (loadingSpinner) loadingSpinner.style.display = 'none';
        }
        
        // Helper function para ocultar todas las secciones de inicio
        function hideHomeSections() {
            if (heroSection) heroSection.classList.add('hidden');
            const howItWorksSection = document.getElementById('howItWorksSection');
            const featuresSection = document.getElementById('featuresSection');
            const ctaSection = document.getElementById('ctaSection');
            if (howItWorksSection) howItWorksSection.classList.add('hidden');
            if (featuresSection) featuresSection.classList.add('hidden');
            if (ctaSection) ctaSection.classList.add('hidden');
        }

        function showInitialSections() {
            // Mostrar secciones iniciales
            if (heroSection) heroSection.classList.remove('hidden');
            
            // Mostrar las nuevas secciones de la página de inicio
            const howItWorksSection = document.getElementById('howItWorksSection');
            const featuresSection = document.getElementById('featuresSection');
            const ctaSection = document.getElementById('ctaSection');
            
            if (howItWorksSection) howItWorksSection.classList.remove('hidden');
            if (featuresSection) featuresSection.classList.remove('hidden');
            if (ctaSection) ctaSection.classList.remove('hidden');

            // Ocultar otras secciones
            if (searchResultsSection) searchResultsSection.classList.add('hidden');
            if (myCardsSection) myCardsSection.classList.add('hidden');
            if (profileSection) profileSection.classList.add('hidden');
            if (interchangesSection) interchangesSection.classList.add('hidden');
            if (helpSection) helpSection.classList.add('hidden');
            
            // Ocultar también el buzón
            const inboxSection = document.getElementById('inboxSection');
            if (inboxSection) inboxSection.classList.add('hidden');
        }

        function showSearchResults() {
            // Ocultar secciones iniciales
            hideHomeSections();
            
            // Ocultar otras secciones
            if (myCardsSection) myCardsSection.classList.add('hidden');
            if (profileSection) profileSection.classList.add('hidden');
            if (interchangesSection) interchangesSection.classList.add('hidden');
            if (helpSection) helpSection.classList.add('hidden');
            
            // Ocultar también el buzón
            const inboxSection = document.getElementById('inboxSection');
            if (inboxSection) inboxSection.classList.add('hidden');

            // Mostrar resultados de búsqueda
            if (searchResultsSection) searchResultsSection.classList.remove('hidden');
        }
        
        function showInboxSection() {
            // Ocultar otras secciones
            hideHomeSections();
            if (searchResultsSection) searchResultsSection.classList.add('hidden');
            if (myCardsSection) myCardsSection.classList.add('hidden');
            if (profileSection) profileSection.classList.add('hidden');
            if (helpSection) helpSection.classList.add('hidden');
            if (interchangesSection) interchangesSection.classList.add('hidden');
            
            // Mostrar sección del buzón
            const inboxSection = document.getElementById('inboxSection');
            if (inboxSection) {
                inboxSection.classList.remove('hidden');
                
                // Cargar datos del buzón
                loadInbox();
            }
        }

        function showMyCardsSection() {
            // Ocultar otras secciones
            hideHomeSections();
            if (searchResultsSection) searchResultsSection.classList.add('hidden');
            if (profileSection) profileSection.classList.add('hidden');
            if (interchangesSection) interchangesSection.classList.add('hidden');
            if (helpSection) helpSection.classList.add('hidden');
            
            // Ocultar también el buzón
            const inboxSection = document.getElementById('inboxSection');
            if (inboxSection) inboxSection.classList.add('hidden');

            // Mostrar sección de mis cartas
            if (myCardsSection) myCardsSection.classList.remove('hidden');

            // Cargar colección si hay usuario autenticado
            if (currentUser) {
                loadMyCollection(currentUser.uid);
                fetchSetsAndPopulateFilter(); // Cargar sets para filtros
            } else {
                if (noMyCardsMessage) {
                    noMyCardsMessage.textContent = 'Debes iniciar sesión para ver tu colección.';
                    noMyCardsMessage.classList.remove('hidden');
                }
            }
        }

        function showInterchangesSection() {
            // Ocultar otras secciones
            hideHomeSections();
            if (searchResultsSection) searchResultsSection.classList.add('hidden');
            if (myCardsSection) myCardsSection.classList.add('hidden');
            if (profileSection) profileSection.classList.add('hidden');
            if (helpSection) helpSection.classList.add('hidden');
            
            // Ocultar también el buzón
            const inboxSection = document.getElementById('inboxSection');
            if (inboxSection) inboxSection.classList.add('hidden');

            // Mostrar sección de intercambios
            if (interchangesSection) interchangesSection.classList.remove('hidden');

            // Cargar intercambios si hay usuario autenticado
            if (currentUser) {
                loadAvailableTrades();
            } else {
                // Mostrar mensaje de login si no está autenticado
                const interchangesContainer = document.getElementById('interchangesContainer');
                if (interchangesContainer) {
                    interchangesContainer.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                            <p>Debes iniciar sesión para ver intercambios disponibles</p>
                            <button class="btn-primary mt-4 px-4 py-2 rounded-lg text-sm font-semibold" onclick="showAuthModal('login')">
                                Iniciar Sesión
                            </button>
                        </div>
                    `;
                }
            }
        }

        function showHelpSection(tabToShow = null) {
            // Ocultar otras secciones
            hideHomeSections();
            if (searchResultsSection) searchResultsSection.classList.add('hidden');
            if (myCardsSection) myCardsSection.classList.add('hidden');
            if (profileSection) profileSection.classList.add('hidden');
            if (interchangesSection) interchangesSection.classList.add('hidden');
            
            // Ocultar también el buzón
            const inboxSection = document.getElementById('inboxSection');
            if (inboxSection) inboxSection.classList.add('hidden');

            // Mostrar sección de ayuda
            if (helpSection) helpSection.classList.remove('hidden');

            // Inicializar FAQ
            initializeFAQ();
            
            // Si se especificó una pestaña, cambiar a ella
            if (tabToShow) {
                // Pequeño delay para asegurar que el DOM esté listo
                setTimeout(() => {
                    switchHelpTab(tabToShow);
                }, 50);
            }
        }


        function showProfileSection() {
            // Ocultar otras secciones
            hideHomeSections();
            if (searchResultsSection) searchResultsSection.classList.add('hidden');
            if (myCardsSection) myCardsSection.classList.add('hidden');
            if (interchangesSection) interchangesSection.classList.add('hidden');
            if (helpSection) helpSection.classList.add('hidden');
            
            // Ocultar también el buzón
            const inboxSection = document.getElementById('inboxSection');
            if (inboxSection) inboxSection.classList.add('hidden');

            // Mostrar sección de perfil
            if (profileSection) {
                profileSection.classList.remove('hidden');
                // Cargar datos del usuario y estadísticas
                loadProfileData();
            } else {
                // Si no existe la sección de perfil, mostrar mensaje
                showNotification('Sección de perfil en desarrollo. Por ahora puedes usar "Mis Cartas" para gestionar tu colección.', 'info', 5000);
                showMyCardsSection();
            }
        }

        // Función para cambiar entre tabs del perfil
        function switchProfileTab(tabName) {
            // Ocultar todos los contenidos de tabs
            const tabContents = document.querySelectorAll('.profile-tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));

            // Remover clase active de todos los tabs
            const tabs = document.querySelectorAll('.profile-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.classList.remove('border-orange-500', 'text-orange-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });

            // Mostrar el contenido del tab seleccionado
            let targetContent;
            let targetTab;

            switch(tabName) {
                case 'personal':
                    targetContent = document.getElementById('profilePersonalContent');
                    targetTab = document.getElementById('profilePersonalTab');
                    break;
                case 'dashboard':
                    targetContent = document.getElementById('profileDashboardContent');
                    targetTab = document.getElementById('profileDashboardTab');
                    break;
                case 'collection':
                    targetContent = document.getElementById('profileCollectionContent');
                    targetTab = document.getElementById('profileCollectionTab');
                    break;
                case 'trades':
                    targetContent = document.getElementById('profileTradesContent');
                    targetTab = document.getElementById('profileTradesTab');
                    break;
                case 'settings':
                    targetContent = document.getElementById('profileSettingsContent');
                    targetTab = document.getElementById('profileSettingsTab');
                    break;
                case 'ratings':
                    targetContent = document.getElementById('profileRatingsContent');
                    targetTab = document.getElementById('profileRatingsTab');
                    // Cargar valoraciones al abrir la pestaña
                    if (typeof loadRatingsTab === 'function') {
                        loadRatingsTab();
                    }
                    break;
            }

            if (targetContent) {
                targetContent.classList.remove('hidden');
            }

            if (targetTab) {
                targetTab.classList.add('active', 'border-orange-500', 'text-orange-600');
                targetTab.classList.remove('border-transparent', 'text-gray-500');
            }

            // Cargar estadísticas al abrir el Dashboard
            if (tabName === 'dashboard' && typeof loadProfileStats === 'function' && currentUser) {
                try {
                    loadProfileStats();
                } catch (e) {
                    console.error('Error al cargar estadísticas al abrir Dashboard:', e);
                }
            }

            // Cargar colección al abrir la pestaña Mi Colección
            if (tabName === 'collection' && typeof loadUserCollection === 'function') {
                loadUserCollection();
            }
        }

        // Función para cambiar entre tabs de ayuda
        function switchHelpTab(tabName) {
            // Ocultar todos los contenidos de tabs
            const tabContents = document.querySelectorAll('.help-tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));

            // Remover clase active de todos los tabs
            const tabs = document.querySelectorAll('.help-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.classList.remove('border-orange-500', 'text-orange-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });

            // Mostrar el contenido del tab seleccionado
            let targetContent;
            let targetTab;

            switch(tabName) {
                case 'getting-started':
                    targetContent = document.getElementById('helpGettingStartedContent');
                    targetTab = document.getElementById('helpGettingStartedTab');
                    break;
                case 'trading':
                    targetContent = document.getElementById('helpTradingContent');
                    targetTab = document.getElementById('helpTradingTab');
                    break;
                case 'card-conditions':
                    targetContent = document.getElementById('helpCardConditionsContent');
                    targetTab = document.getElementById('helpCardConditionsTab');
                    break;
                case 'account':
                    targetContent = document.getElementById('helpAccountContent');
                    targetTab = document.getElementById('helpAccountTab');
                    break;
                case 'faq':
                    targetContent = document.getElementById('helpFAQContent');
                    targetTab = document.getElementById('helpFAQTab');
                    break;
                case 'newFeatures':
                    targetContent = document.getElementById('helpNewFeaturesContent');
                    targetTab = document.getElementById('helpNewFeaturesTab');
                    break;
            }

            if (targetContent) {
                targetContent.classList.remove('hidden');
            }

            if (targetTab) {
                targetTab.classList.add('active', 'border-orange-500', 'text-orange-600');
                targetTab.classList.remove('border-transparent', 'text-gray-500');
            }
        }

        // Función para cambiar entre tabs de intercambios
        function switchTradeTab(tabName) {
            // Ocultar todos los contenidos de tabs
            const tabContents = document.querySelectorAll('.trade-tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));

            // Remover clase active de todos los tabs
            const tabs = document.querySelectorAll('.trade-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.classList.remove('border-orange-500', 'text-orange-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });

            // Mostrar el contenido del tab seleccionado
            let targetContent;
            let targetTab;

            switch(tabName) {
                case 'active':
                    targetContent = document.getElementById('tradesActiveContent');
                    targetTab = document.getElementById('tradesActiveTab');
                    break;
                case 'pending':
                    targetContent = document.getElementById('tradesPendingContent');
                    targetTab = document.getElementById('tradesPendingTab');
                    break;
                case 'completed':
                    targetContent = document.getElementById('tradesCompletedContent');
                    targetTab = document.getElementById('tradesCompletedTab');
                    break;
                case 'received':
                    targetContent = document.getElementById('tradesReceivedContent');
                    targetTab = document.getElementById('tradesReceivedTab');
                    break;
            }

            if (targetContent) {
                targetContent.classList.remove('hidden');
            }

            if (targetTab) {
                targetTab.classList.add('active', 'border-orange-500', 'text-orange-600');
                targetTab.classList.remove('border-transparent', 'text-gray-500');
            }
        }

        // Función para cargar datos del perfil
        async function loadProfileData() {
            // Usar auth.currentUser directamente
            const user = auth.currentUser;
            
            if (!user) {
                console.log('❌ No hay usuario conectado en loadProfileData');
                return;
            }

            try {
                console.log('🔄 Cargando datos del perfil...');
                
                // Cargar información del usuario
                await loadUserInfo();
                
                // Cargar estadísticas
                await loadProfileStats();
                
                // Cargar valoraciones del usuario
                loadUserRating();
                
                console.log('✅ Datos del perfil cargados correctamente');
            } catch (error) {
                console.error('❌ Error al cargar datos del perfil:', error);
            }
        }

        // Función para mostrar mensajes de estado del perfil
        function showProfileSaveMessage(message, type = 'success') {
            const messageElement = document.getElementById('profileSaveMessage');
            if (!messageElement) return;

            const messageText = messageElement.querySelector('p');
            if (messageText) {
                messageText.textContent = message;
            }

            // Aplicar estilos según el tipo
            messageElement.className = 'mt-4 p-3 rounded-lg';
            if (type === 'success') {
                messageElement.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200');
            } else if (type === 'error') {
                messageElement.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            } else if (type === 'info') {
                messageElement.classList.add('bg-blue-100', 'text-blue-700', 'border', 'border-blue-200');
            }

            messageElement.classList.remove('hidden');

            // Ocultar después de 3 segundos
            setTimeout(() => {
                messageElement.classList.add('hidden');
            }, 3000);
        }

        // Función para guardar datos del perfil
        async function saveProfileData() {
            console.log('🔧 saveProfileData iniciada');
            
            if (!currentUser) {
                console.error('❌ No hay usuario conectado');
                showProfileSaveMessage('Debes iniciar sesión para guardar cambios', 'error');
                return;
            }

            try {
                console.log('🔧 Obteniendo valores del formulario...');
                const name = document.getElementById('profileName')?.value?.trim();
                const lastName = document.getElementById('profileLastName')?.value?.trim();
                const address = document.getElementById('profileAddress')?.value?.trim();
                const birthDate = document.getElementById('profileBirthDate')?.value;
                const email = document.getElementById('profileEmail')?.value?.trim();

                console.log('🔧 Valores obtenidos:', { name, lastName, address, birthDate, email });

                // Validaciones básicas
                if (!name) {
                    console.error('❌ Nombre vacío');
                    showProfileSaveMessage('El nombre es obligatorio', 'error');
                    return;
                }
                if (!lastName) {
                    console.error('❌ Apellidos vacíos');
                    showProfileSaveMessage('Los apellidos son obligatorios', 'error');
                    return;
                }
                if (!email) {
                    console.error('❌ Email vacío');
                    showProfileSaveMessage('El correo electrónico es obligatorio', 'error');
                    return;
                }

                // Validar formato de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    console.error('❌ Formato de email inválido');
                    showProfileSaveMessage('El formato del correo electrónico no es válido', 'error');
                    return;
                }

                // Preparar datos para guardar
                const profileData = {
                    name: name,
                    lastName: lastName,
                    address: address || '',
                    birthDate: birthDate || '',
                    email: email,
                    updatedAt: new Date()
                };

                console.log('🔧 Datos a guardar:', profileData);
                console.log('🔧 Usuario UID:', currentUser.uid);
                console.log('🔧 Firebase db disponible:', !!db);
                console.log('🔧 Firebase auth disponible:', !!auth);

                // Verificar que Firebase esté inicializado correctamente
                if (!db) {
                    throw new Error('Firebase Firestore no está inicializado');
                }

                // Guardar en Firestore
                console.log('🔧 Guardando en Firestore...');
                const userDocRef = doc(db, 'users', currentUser.uid);
                console.log('🔧 Referencia del documento:', userDocRef);
                
                await setDoc(userDocRef, profileData, { merge: true });
                console.log('✅ Datos guardados en Firestore');

                // Actualizar el nombre en el header del perfil
                const userNameElement = document.getElementById('profileUserName');
                if (userNameElement) {
                    userNameElement.textContent = `${name} ${lastName}`;
                    console.log('✅ Nombre actualizado en header');
                }

                // Actualizar email en Firebase Auth si ha cambiado
                if (email !== currentUser.email) {
                    console.log('🔧 Email ha cambiado, actualizando en Auth...');
                    console.log('🔧 Email actual:', currentUser.email);
                    console.log('🔧 Email nuevo:', email);
                    
                    if (!auth) {
                        throw new Error('Firebase Auth no está inicializado');
                    }
                    
                    try {
                        await updateEmail(currentUser, email);
                        console.log('✅ Email actualizado en Firebase Auth');
                        // Actualizar el objeto currentUser localmente
                        currentUser.email = email;
                    } catch (authError) {
                        console.error('❌ Error al actualizar email en Auth:', authError);
                        console.error('❌ Código de error:', authError.code);
                        console.error('❌ Mensaje de error:', authError.message);
                        
                        if (authError.code === 'auth/requires-recent-login') {
                            showProfileSaveMessage('⚠️ Datos guardados pero el email no se pudo actualizar. Por seguridad, debes volver a iniciar sesión para cambiar el email.', 'info');
                        } else {
                            showProfileSaveMessage(`⚠️ Datos guardados pero el email no se pudo actualizar: ${authError.message}`, 'info');
                        }
                    }
                }

                showProfileSaveMessage('✅ Perfil actualizado correctamente', 'success');
                console.log('✅ Datos del perfil guardados exitosamente');

            } catch (error) {
                console.error('❌ Error al guardar datos del perfil:', error);
                
                // Manejo específico de errores de permisos
                if (error.code === 'permission-denied') {
                    showProfileSaveMessage('❌ Error de permisos. Verifica que las reglas de Firestore estén configuradas correctamente.', 'error');
                } else if (error.code === 'unauthenticated') {
                    showProfileSaveMessage('❌ Error de autenticación. Por favor, vuelve a iniciar sesión.', 'error');
                } else {
                    showProfileSaveMessage('❌ Error al guardar los cambios: ' + error.message, 'error');
                }
            }
        }

        // Función para mostrar mensajes de cambio de contraseña
        function showPasswordChangeMessage(message, type = 'success') {
            const messageElement = document.getElementById('passwordChangeMessage');
            if (!messageElement) {
                console.error('❌ Elemento passwordChangeMessage no encontrado');
                return;
            }

            const messageText = messageElement.querySelector('p');
            if (messageText) {
                messageText.textContent = message;
            }

            // Limpiar clases anteriores
            messageElement.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700');
            messageElement.classList.remove('hidden');

            // Aplicar clases según el tipo
            if (type === 'success') {
                messageElement.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageElement.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'info') {
                messageElement.classList.add('bg-blue-100', 'text-blue-700');
            }

            // Ocultar después de 5 segundos
            setTimeout(() => {
                messageElement.classList.add('hidden');
            }, 5000);
        }



        // Función para cambiar contraseña
        async function changePassword() {
            console.log('🔧 changePassword iniciada');
            
            if (!currentUser) {
                console.error('❌ No hay usuario conectado');
                showPasswordChangeMessage('Debes iniciar sesión para cambiar la contraseña', 'error');
                return;
            }

            try {
                console.log('🔧 Obteniendo valores del formulario...');
                const currentPassword = document.getElementById('currentPassword')?.value;
                const newPassword = document.getElementById('newPassword')?.value;
                const confirmNewPassword = document.getElementById('confirmNewPassword')?.value;

                console.log('🔧 Valores obtenidos:', { 
                    hasCurrentPassword: !!currentPassword, 
                    hasNewPassword: !!newPassword, 
                    hasConfirmPassword: !!confirmNewPassword 
                });

                // Validaciones
                if (!currentPassword) {
                    console.error('❌ Contraseña actual vacía');
                    showPasswordChangeMessage('Debes ingresar tu contraseña actual', 'error');
                    return;
                }
                if (!newPassword) {
                    console.error('❌ Nueva contraseña vacía');
                    showPasswordChangeMessage('Debes ingresar una nueva contraseña', 'error');
                    return;
                }
                if (newPassword.length < 6) {
                    console.error('❌ Nueva contraseña muy corta');
                    showPasswordChangeMessage('La nueva contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    console.error('❌ Contraseñas no coinciden');
                    showPasswordChangeMessage('Las contraseñas nuevas no coinciden', 'error');
                    return;
                }
                if (newPassword === currentPassword) {
                    console.error('❌ Nueva contraseña igual a la actual');
                    showPasswordChangeMessage('La nueva contraseña debe ser diferente a la actual', 'error');
                    return;
                }

                console.log('🔧 Validaciones pasadas, reautenticando...');
                console.log('🔧 Email del usuario:', currentUser.email);
                console.log('🔧 Firebase Auth disponible:', !!auth);

                // Verificar que Firebase Auth esté inicializado
                if (!auth) {
                    throw new Error('Firebase Auth no está inicializado');
                }

                // Reautenticar al usuario antes de cambiar la contraseña
                console.log('🔧 Creando credenciales...');
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                console.log('🔧 Credenciales creadas:', !!credential);
                
                console.log('🔧 Iniciando reautenticación...');
                await reauthenticateWithCredential(currentUser, credential);
                console.log('✅ Reautenticación exitosa');

                // Cambiar la contraseña
                console.log('🔧 Cambiando contraseña...');
                await updatePassword(currentUser, newPassword);
                console.log('✅ Contraseña cambiada exitosamente');

                // Limpiar el formulario
                document.getElementById('passwordChangeForm').reset();
                console.log('✅ Formulario limpiado');

                showPasswordChangeMessage('✅ Contraseña cambiada correctamente', 'success');

            } catch (error) {
                console.error('❌ Error al cambiar contraseña:', error);
                console.error('❌ Tipo de error:', typeof error);
                console.error('❌ Código de error:', error.code);
                console.error('❌ Mensaje de error:', error.message);
                console.error('❌ Stack trace:', error.stack);
                
                let errorMessage = 'Error al cambiar la contraseña';
                
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'La contraseña actual es incorrecta';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La nueva contraseña es demasiado débil';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Por seguridad, debes volver a iniciar sesión para cambiar la contraseña';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Demasiados intentos. Intenta de nuevo más tarde';
                } else if (error.code === 'auth/user-mismatch') {
                    errorMessage = 'Error de autenticación. Por favor, vuelve a iniciar sesión.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Credenciales inválidas. Verifica tu contraseña actual.';
                }
                
                showPasswordChangeMessage(`❌ ${errorMessage}`, 'error');
            }
        }

        // Función para cargar información del usuario
        async function loadUserInfo() {
            if (!currentUser) return;

            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                let userData = userDoc.data();

                // MIGRACIÓN AUTOMÁTICA: Si el usuario tiene un name pero no username,
                // significa que es un usuario antiguo donde el username estaba en name
                if (userData && userData.name && !userData.username) {
                    console.log('🔄 Detectado usuario antiguo, migrando estructura de datos...');
                    
                    // Verificar si el name parece ser un username (sin espacios, formato de usuario)
                    const nameValue = userData.name;
                    const isUsername = !nameValue.includes(' ') && /^[a-zA-Z0-9_]+$/.test(nameValue);
                    
                    if (isUsername) {
                        // Migrar: mover name a username
                        userData.username = nameValue;
                        userData.name = ''; // Limpiar el campo name para el nombre real
                        
                        // Actualizar en Firestore
                        try {
                            await setDoc(doc(db, 'users', currentUser.uid), {
                                username: nameValue,
                                name: ''
                            }, { merge: true });
                            console.log('✅ Datos migrados exitosamente');
                        } catch (migrationError) {
                            console.error('Error al migrar datos:', migrationError);
                        }
                    }
                }

                // Actualizar información del usuario en la UI (header del perfil)
                const userNameElement = document.getElementById('profileUserName');
                const userEmailElement = document.getElementById('profileUserEmail');
                const joinDateElement = document.getElementById('profileJoinDate');

                if (userNameElement) {
                    // Mostrar username primero, luego nombre completo si existe
                    let displayName = 'Usuario';
                    
                    if (userData?.username) {
                        displayName = userData.username;
                    } else if (userData?.name && userData?.lastName) {
                        displayName = `${userData.name} ${userData.lastName}`;
                    } else if (userData?.name) {
                        displayName = userData.name;
                    } else if (userData?.displayName) {
                        displayName = userData.displayName;
                    } else if (currentUser.displayName) {
                        displayName = currentUser.displayName;
                    }
                    
                    userNameElement.textContent = displayName;
                }

                if (userEmailElement) {
                    userEmailElement.textContent = currentUser.email || 'usuario@ejemplo.com';
                }

                if (joinDateElement) {
                    const joinDate = userData?.createdAt?.toDate() || currentUser.metadata?.creationTime;
                    if (joinDate) {
                        const date = new Date(joinDate);
                        joinDateElement.textContent = date.toLocaleDateString('es-ES', { 
                            year: 'numeric', 
                            month: 'long' 
                        });
                    }
                }

                // Cargar datos en el formulario de perfil personal
                const profileUsernameInput = document.getElementById('profileUsername');
                const profileNameInput = document.getElementById('profileName');
                const profileLastNameInput = document.getElementById('profileLastName');
                const profileAddressInput = document.getElementById('profileAddress');
                const profileBirthDateInput = document.getElementById('profileBirthDate');
                const profileEmailInput = document.getElementById('profileEmail');

                // Usar los datos ya migrados
                if (profileUsernameInput) profileUsernameInput.value = userData?.username || '';
                if (profileNameInput) profileNameInput.value = userData?.name || '';
                if (profileLastNameInput) profileLastNameInput.value = userData?.lastName || '';
                if (profileAddressInput) profileAddressInput.value = userData?.address || '';
                if (profileBirthDateInput) profileBirthDateInput.value = userData?.birthDate || '';
                if (profileEmailInput) profileEmailInput.value = userData?.email || currentUser.email || '';

                // Cargar preferencia de modo oscuro
                loadDarkModePreference(userData);

                console.log('✅ Información del usuario cargada:', userData);

            } catch (error) {
                console.error('❌ Error al cargar información del usuario:', error);
            }
        }

        // Función para cargar preferencia de modo oscuro
        function loadDarkModePreference(userData) {
            // NO cambiar el modo si no hay preferencia guardada
            if (userData?.darkMode === undefined) {
                console.log('No hay preferencia de modo oscuro guardada, manteniendo estado actual');
                // El estado ya está sincronizado visualmente con las clases CSS
                return;
            }
            
            const darkMode = userData.darkMode;
            applyDarkMode(darkMode);
        }

        // Función para aplicar modo oscuro
        function applyDarkMode(isDark) {
            const html = document.documentElement;
            
            if (isDark) {
                html.classList.add('dark');
                document.body.classList.add('dark-mode');
            } else {
                html.classList.remove('dark');
                document.body.classList.remove('dark-mode');
            }
            
            // Actualizar elementos flotantes
            updateFloatingElementsOpacity();
            
            // Guardar también en localStorage para persistencia local
            localStorage.setItem('darkMode', isDark ? 'true' : 'false');
        }

        // Función para guardar preferencia de modo oscuro
        async function saveDarkModePreference(isDark) {
            if (!currentUser) return;

            try {
                await setDoc(doc(db, 'users', currentUser.uid), {
                    darkMode: isDark,
                    updatedAt: new Date()
                }, { merge: true });

                applyDarkMode(isDark);
                console.log('✅ Preferencia de modo oscuro guardada:', isDark);
            } catch (error) {
                console.error('❌ Error al guardar preferencia de modo oscuro:', error);
            }
        }

        // Hacer funciones disponibles globalmente
        window.saveDarkModePreference = saveDarkModePreference;
        window.applyDarkMode = applyDarkMode;
        window.loadDarkModePreference = loadDarkModePreference;

        // Función de prueba para verificar que todo funciona
        window.testNavigation = function() {
            console.log('🧪 Probando navegación...');
            console.log('Funciones disponibles:', {
                showInitialSections: typeof showInitialSections,
                showAuthModal: typeof showAuthModal,
                showMyCardsSection: typeof showMyCardsSection,
                showInterchangesSection: typeof showInterchangesSection,
                showProfileSection: typeof showProfileSection,
                logoutUser: typeof logoutUser
            });
            
            // Probar cada función
            try {
                console.log('✅ Todas las funciones están disponibles');
                return true;
            } catch (error) {
                console.error('❌ Error en las funciones:', error);
                return false;
            }
        };

        // Función para cargar estadísticas del perfil
        async function loadProfileStats() {
            if (!currentUser) return;

            try {
                console.log('📊 Cargando estadísticas del perfil...');

                // Obtener colección del usuario
                const userCardsRef = collection(db, 'users', currentUser.uid, 'my_cards');
                const userCardsSnapshot = await getDocs(userCardsRef);
                
                const cards = [];
                userCardsSnapshot.forEach(doc => {
                    cards.push({ id: doc.id, ...doc.data() });
                });

                // Calcular estadísticas
                // Total de cartas sumando las cantidades
                const totalCards = cards.reduce((total, card) => {
                    // Si no tiene quantity o es 0, contar como 1
                    const qty = card.quantity > 0 ? card.quantity : 1;
                    return total + qty;
                }, 0);
                
                const uniqueCards = new Set(cards.map(card => card.id)).size;
                const uniqueSets = new Set(cards.map(card => (typeof card.set === 'string' ? card.set : card.set?.name)).filter(Boolean)).size;
                
                // Por ahora, intercambios completados = 0 (se implementará más adelante)
                const completedTrades = 0;

                // Actualizar UI con las estadísticas
                updateProfileStats(totalCards, uniqueCards, uniqueSets, completedTrades, cards);

                // Cargar desglose por sets
                await loadSetsBreakdown(cards);

            } catch (error) {
                console.error('❌ Error al cargar estadísticas:', error);
            }
        }

        // --- Constantes de Condiciones de Cartas (CardMarket) ---
        const CARD_CONDITIONS = {
            M: {
                code: 'M',
                name: 'Mint (M)',
                description: 'Perfectas condiciones, sin excusas. Carta como recién salida del sobre.',
                color: '#10B981', // Verde
                icon: '💎'
            },
            NM: {
                code: 'NM',
                name: 'Near Mint (NM)',
                description: 'Aspecto de no haber sido jugada sin fundas. Marcas mínimas permitidas.',
                color: '#059669', // Verde oscuro
                icon: '✨'
            },
            EX: {
                code: 'EX',
                name: 'Excellent (EX)',
                description: 'Como si se hubiera usado poco sin fundas. Daño visible pero menor.',
                color: '#3B82F6', // Azul
                icon: '⭐'
            },
            GD: {
                code: 'GD',
                name: 'Good (GD)',
                description: 'Aspecto de mucho uso en torneo sin fundas. Deterioro notable.',
                color: '#F59E0B', // Amarillo
                icon: '🟡'
            },
            LP: {
                code: 'LP',
                name: 'Light Played (LP)',
                description: 'Uso prolongado sin fundas. Válida para torneos con fundas.',
                color: '#F97316', // Naranja
                icon: '🟠'
            },
            PL: {
                code: 'PL',
                name: 'Played (PL)',
                description: 'Aspecto muy deteriorado. Dudoso para torneos incluso con fundas.',
                color: '#DC2626', // Rojo
                icon: '🔴'
            },
            PO: {
                code: 'PO',
                name: 'Poor (PO)',
                description: 'Literalmente destrozada o alterada. No válida para torneos.',
                color: '#7F1D1D', // Rojo oscuro
                icon: '💀'
            }
        };

        // --- Función de Notificaciones Personalizadas ---
        function showNotification(message, type = 'success', duration = 3000) {
            // Remover notificación anterior si existe
            const existingNotification = document.querySelector('.custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Crear nueva notificación
            const notification = document.createElement('div');
            notification.className = 'custom-notification fixed top-4 right-4 z-[10000] transform translate-x-full transition-transform duration-300';
            
            // Estilos según el tipo
            let bgColor, borderColor, iconColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-50 dark:bg-green-900/30';
                    borderColor = 'border-green-200 dark:border-green-800';
                    iconColor = 'text-green-600 dark:text-green-400';
                    icon = '✅';
                    break;
                case 'error':
                    bgColor = 'bg-red-50 dark:bg-red-900/30';
                    borderColor = 'border-red-200 dark:border-red-800';
                    iconColor = 'text-red-600 dark:text-red-400';
                    icon = '❌';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50 dark:bg-yellow-900/30';
                    borderColor = 'border-yellow-200 dark:border-yellow-800';
                    iconColor = 'text-yellow-600 dark:text-yellow-400';
                    icon = '⚠️';
                    break;
                case 'info':
                    bgColor = 'bg-blue-50 dark:bg-blue-900/30';
                    borderColor = 'border-blue-200 dark:border-blue-800';
                    iconColor = 'text-blue-600 dark:text-blue-400';
                    icon = 'ℹ️';
                    break;
            }
            
            notification.innerHTML = `
                <div class="${bgColor} ${borderColor} border-2 rounded-lg shadow-xl p-4 max-w-sm">
                    <div class="flex items-center gap-3">
                        <span class="${iconColor} text-2xl">${icon}</span>
                        <p class="text-gray-800 dark:text-gray-200 font-medium">${message}</p>
                        <button onclick="this.closest('.custom-notification').remove()" 
                                class="ml-auto text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            ×
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 10);
            
            // Auto-ocultar después de la duración especificada
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }
        
        // --- Funciones de Intercambios ---
        
        // Función de búsqueda de cartas para intercambios con debounce
        let searchTimeout;
        window.searchCardForTrade = async function(input, type, cardIndex) {
            const query = input.value.trim();
            const resultsContainer = input.parentElement.nextElementSibling;
            
            // Limpiar timeout anterior
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                resultsContainer.innerHTML = '';
                return;
            }
            
            // Mostrar loading
            resultsContainer.innerHTML = `
                <div class="p-3 text-center text-gray-500 dark:text-gray-400">
                    <div class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full"></div>
                    <span class="ml-2">Buscando...</span>
                </div>
            `;
            resultsContainer.classList.remove('hidden');
            
            // Debounce de 300ms
            searchTimeout = setTimeout(async () => {
                try {
                    // Usar el proxy en lugar de la API directa
                    const encodedQuery = encodeURIComponent(query);
                    const response = await fetch(`https://tcgtrade-production.up.railway.app/api/pokemontcg/cards?q=${encodedQuery}&pageSize=10`, {
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    
                    if (data.data && data.data.length > 0) {
                        // Función para escapar caracteres especiales en onclick
                        const escapeForOnclick = (str) => {
                            return String(str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                        };
                        
                        resultsContainer.innerHTML = data.data.map(card => `
                            <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-center gap-2 border-b border-gray-200 dark:border-gray-600 last:border-0"
                                 onclick="selectCardForTrade('${type}', ${cardIndex}, '${escapeForOnclick(card.id)}', '${escapeForOnclick(card.name)}', '${escapeForOnclick(card.images.small)}', '${escapeForOnclick(card.set?.name || '')}', '${escapeForOnclick(card.number || '')}')">
                                <img src="${card.images.small}" alt="${card.name}" class="w-10 h-14 object-contain">
                                <div class="flex-1">
                                    <div class="font-medium text-sm text-gray-900 dark:text-white">${card.name}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${card.set?.name || 'Set desconocido'} - ${card.number || 'N/A'}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        resultsContainer.innerHTML = `
                            <div class="p-3 text-center text-gray-500 dark:text-gray-400">
                                No se encontraron cartas
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error buscando cartas:', error);
                    resultsContainer.innerHTML = `
                        <div class="p-3 text-center text-red-500">
                            Error al buscar cartas. Intenta de nuevo.
                        </div>
                    `;
                    // Reintentar con timeout más largo
                    setTimeout(() => {
                        resultsContainer.classList.add('hidden');
                    }, 3000);
                }
            }, 500); // Aumentar debounce a 500ms para evitar demasiadas peticiones
        };
        
        // Función para seleccionar una carta del autocompletado
        window.selectCardForTrade = function(type, cardIndex, cardId, cardName, cardImage, setName, cardNumber, shouldLock = false) {
            console.log('🎯 selectCardForTrade llamado:', { type, cardIndex, cardName, shouldLock });
            console.log('📍 Llamado desde:', shouldLock ? 'MIS CARTAS' : 'BUSCADOR API');
            
            // Usar el ID correcto del contenedor
            const containerId = type === 'offered' ? 'offeredCardsContainer' : 'wantedCardsContainer';
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.error('❌ selectCardForTrade: No se encontró el contenedor:', containerId);
                alert('Error: No se pudo encontrar el contenedor de cartas. Recarga la página.');
                return;
            }
            
            const cardElement = container.querySelectorAll('.trade-card')[cardIndex];
            
            if (cardElement) {
                console.log('✅ Elemento de carta encontrado en índice:', cardIndex);
                
                // Actualizar el input visible
                const nameInput = cardElement.querySelector(`input[name="${type}_name_${cardIndex}"]`);
                if (nameInput) {
                    nameInput.value = cardName;
                    
                    // Solo bloquear si viene de "Mis Cartas" (shouldLock = true)
                    if (shouldLock) {
                        nameInput.readOnly = true;
                        nameInput.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                        nameInput.classList.remove('bg-white', 'dark:bg-gray-700');
                        console.log('✅ Carta seleccionada desde Mis Cartas y BLOQUEADA:', cardName);
                        
                        // Bloquear también los selectores
                        const conditionSelect = cardElement.querySelector('select[name*="_condition_"]');
                        const languageSelect = cardElement.querySelector('select[name*="_language_"]');
                        if (conditionSelect) {
                            conditionSelect.disabled = true;
                            conditionSelect.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                        }
                        if (languageSelect) {
                            languageSelect.disabled = true;
                            languageSelect.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                        }
                        
                        // SOLO desde Mis Cartas: Añadir nueva fila vacía después de bloquear
                        setTimeout(() => {
                            addCardToTrade(type);
                        }, 100);
                    } else {
                        // Desde el buscador API - NO bloquear y NO crear nueva línea
                        console.log('✅ Carta seleccionada desde buscador (sin bloquear, sin nueva línea):', cardName);
                        // NO hacer nada más, solo llenar los datos
                    }
                } else {
                    console.error('❌ No se encontró el input de nombre');
                }
                
                // Actualizar los campos ocultos
                const idInput = cardElement.querySelector(`input[name="${type}_id_${cardIndex}"]`);
                const imageInput = cardElement.querySelector(`input[name="${type}_image_${cardIndex}"]`);
                const setInput = cardElement.querySelector(`input[name="${type}_set_${cardIndex}"]`);
                const numberInput = cardElement.querySelector(`input[name="${type}_number_${cardIndex}"]`);
                
                if (idInput) idInput.value = cardId;
                if (imageInput) imageInput.value = cardImage;
                if (setInput) setInput.value = setName;
                if (numberInput) numberInput.value = cardNumber;
                
                // Ocultar resultados (solo si existe nameInput)
                if (nameInput && nameInput.parentElement && nameInput.parentElement.nextElementSibling) {
                    const resultsContainer = nameInput.parentElement.nextElementSibling;
                    resultsContainer.classList.add('hidden');
                    resultsContainer.innerHTML = '';
                }
                
                // Solo mostrar miniatura si viene de "Mis Cartas" (cuando se bloquea)
                if (shouldLock) {
                    showCardThumbnail(cardElement, cardImage, cardName);
                }
                
                // Actualizar título generado
                updateGeneratedTitle();
            }
        };
        
        // Función para mostrar miniatura de carta seleccionada
        function showCardThumbnail(cardElement, imageUrl, cardName) {
            if (!imageUrl) {
                console.log('⚠️ No hay URL de imagen para mostrar miniatura');
                return;
            }
            
            // Buscar el input de nombre
            const nameInput = cardElement.querySelector('.card-name-input');
            if (!nameInput) return;
            
            // Buscar o crear contenedor de miniatura al lado del input
            let thumbnailContainer = cardElement.querySelector('.card-thumbnail-inline');
            
            if (!thumbnailContainer) {
                // Crear contenedor inline para el icono con hover
                thumbnailContainer = document.createElement('div');
                thumbnailContainer.className = 'card-thumbnail-inline absolute right-2 top-1/2 -translate-y-1/2 z-10';
                nameInput.parentElement.style.position = 'relative';
                nameInput.parentElement.appendChild(thumbnailContainer);
                
                // Ajustar padding del input para hacer espacio al icono
                nameInput.style.paddingRight = '2.5rem';
            }
            
            // Usar un ID único en lugar del índice para evitar problemas
            const uniqueId = `card_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            thumbnailContainer.setAttribute('data-card-id', uniqueId);
            
            thumbnailContainer.innerHTML = `
                <div class="relative group">
                    <button type="button" 
                            class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors"
                            title="Ver carta">
                        <span class="text-xl">🖼️</span>
                    </button>
                    <!-- Preview on hover - Tamaño grande y centrado -->
                    <div class="fixed inset-0 z-[10000] hidden group-hover:flex items-center justify-center pointer-events-none">
                        <div class="relative">
                            <img src="${imageUrl}" alt="${cardName}" 
                                 class="max-w-[400px] max-h-[560px] w-auto h-auto shadow-2xl rounded-lg border-2 border-white dark:border-gray-700">
                        </div>
                    </div>
                </div>
            `;
            
            console.log('🖼️ Miniatura mostrada para:', cardName);
        }
        
        // Función para limpiar la selección de una carta
        window.clearCardSelection = function(type, cardIndex) {
            const containerId = type === 'offered' ? 'offeredCardsContainer' : 'wantedCardsContainer';
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const cardElement = container.querySelectorAll('.trade-card')[cardIndex];
            if (!cardElement) return;
            
            // Limpiar el input de nombre y desbloquearlo
            const nameInput = cardElement.querySelector(`input[name="${type}_name_${cardIndex}"]`);
            if (nameInput) {
                nameInput.value = '';
                nameInput.readOnly = false;
                nameInput.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                nameInput.focus();
            }
            
            // Limpiar campos ocultos
            const idInput = cardElement.querySelector(`input[name="${type}_id_${cardIndex}"]`);
            const imageInput = cardElement.querySelector(`input[name="${type}_image_${cardIndex}"]`);
            const setInput = cardElement.querySelector(`input[name="${type}_set_${cardIndex}"]`);
            const numberInput = cardElement.querySelector(`input[name="${type}_number_${cardIndex}"]`);
            
            if (idInput) idInput.value = '';
            if (imageInput) imageInput.value = '';
            if (setInput) setInput.value = '';
            if (numberInput) numberInput.value = '';
            
            // Quitar el icono de miniatura
            const thumbnailContainer = cardElement.querySelector('.card-thumbnail-inline');
            if (thumbnailContainer) {
                thumbnailContainer.remove();
                // Restaurar el padding del input
                const nameInput2 = cardElement.querySelector('.card-name-input');
                if (nameInput2) {
                    nameInput2.style.paddingRight = '';
                }
            }
            
            // Actualizar título generado
            updateGeneratedTitle();
        };
        
        // Función para manejar Enter en el input de carta
        window.handleCardInputKeypress = function(event, type, cardIndex) {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Por ahora, Enter no hace nada automáticamente
                // El usuario debe hacer click en "Añadir carta"
                console.log('↩️ Enter presionado - usar botón "Añadir carta" para confirmar');
            }
        };
        
        // Función para manejar cuando el input pierde el foco
        window.handleCardInputBlur = function(input, type, cardIndex) {
            // Por ahora, no hacer nada automáticamente al perder el foco
            // El usuario debe hacer click en "Añadir carta" para confirmar
            console.log('👁️ Input perdió el foco - usar botón "Añadir carta" para confirmar');
        };
        
        // Función para añadir cartas desde "Mis Cartas"
        window.addFromMyCards = async function(type) {
            if (!currentUser) {
                showNotification('Debes iniciar sesión para acceder a tu colección', 'warning', 4000);
                return;
            }
            
            // Si no hay cache, cargar las cartas desde Firestore
            if (!userCardsCache || userCardsCache.length === 0) {
                try {
                    const myCardsCollectionRef = collection(db, `users/${currentUser.uid}/my_cards`);
                    const querySnapshot = await getDocs(myCardsCollectionRef);
                    userCardsCache = [];
                    
                    querySnapshot.forEach(doc => {
                        userCardsCache.push(doc.data());
                    });
                } catch (error) {
                    console.error('Error cargando cartas:', error);
                    showNotification('Error al cargar tu colección. Por favor, intenta de nuevo.', 'error', 5000);
                    return;
                }
            }
            
            if (userCardsCache.length === 0) {
                showNotification('No tienes cartas guardadas en tu colección. Ve a "Mis Cartas" para añadir algunas.', 'info', 5000);
                return;
            }
            
            // Crear modal para seleccionar cartas
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
            
            // Ordenar cartas por set y número
            const sortedCards = [...userCardsCache].sort((a, b) => {
                if (a.set !== b.set) return (a.set || '').localeCompare(b.set || '');
                return parseInt(a.number || 0) - parseInt(b.number || 0);
            });
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b dark:border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                                Seleccionar de Mis Cartas (${userCardsCache.length} cartas)
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">
                                &times;
                            </button>
                        </div>
                        
                        <!-- Barra de búsqueda -->
                        <div class="flex gap-2">
                            <input type="text" 
                                   id="myCardsSearchInput"
                                   placeholder="Buscar en tu colección..."
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-400"
                                   oninput="filterMyCardsModal(this.value)">
                            
                            <select id="myCardsSetFilter" 
                                    class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-400"
                                    onchange="filterMyCardsModal(document.getElementById('myCardsSearchInput').value)">
                                <option value="">Todos los sets</option>
                                ${[...new Set(sortedCards.map(c => c.set))].filter(Boolean).sort().map(set => 
                                    `<option value="${set}">${set}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="p-3 overflow-y-auto flex-1" id="myCardsListContainer">
                        <div class="space-y-1" id="myCardsList">
                            ${sortedCards.map((card, index) => {
                                // Función para escapar caracteres especiales
                                const escapeForOnclick = (str) => {
                                    return String(str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                                };
                                
                                const safeCardName = escapeForOnclick(card.name);
                                const safeImageUrl = escapeForOnclick(card.imageUrl);
                                const safeSet = escapeForOnclick(card.set);
                                const safeNumber = escapeForOnclick(card.number);
                                
                                return `
                                <div class="my-card-row flex items-center gap-2 p-2 bg-white dark:bg-gray-700 rounded hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600"
                                     data-card-name="${card.name?.toLowerCase() || ''}"
                                     data-card-set="${card.set?.toLowerCase() || ''}">
                                    
                                    <!-- Icono de imagen con hover -->
                                    <div class="relative group">
                                        <button type="button" 
                                                class="w-8 h-8 bg-gray-100 dark:bg-gray-600 rounded flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors"
                                                title="Ver carta">
                                            <span class="text-lg">🖼️</span>
                                        </button>
                                        
                                        <!-- Vista previa al hover (solo imagen) -->
                                        <div class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-[10000] hidden group-hover:block pointer-events-none">
                                            <img src="${card.imageUrl}" 
                                                 alt="${card.name}" 
                                                 class="w-80 h-auto shadow-2xl rounded-lg">
                                        </div>
                                    </div>
                                    
                                    <!-- Información de la carta (más compacta) -->
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-sm text-gray-900 dark:text-white truncate">${card.name || 'Sin nombre'}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                                            ${card.set || 'Set desconocido'} • #${card.number || 'N/A'} • ${card.language || 'Español'} ${card.condition ? `• ${CARD_CONDITIONS[card.condition]?.icon || ''} ${card.condition}` : ''}
                                        </div>
                                    </div>
                                    
                                    <!-- Botón de seleccionar -->
                                    <button onclick="selectFromMyCards('${type}', '${card.id}', '${safeCardName}', '${safeImageUrl}', '${safeSet}', '${safeNumber}', '${card.language || 'Español'}', '${card.condition || 'NM'}'); this.closest('.fixed').remove();"
                                            class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-medium">
                                        + Añadir
                                    </button>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Mensaje cuando no hay resultados -->
                        <div id="noResultsMessage" class="hidden text-center py-8 text-gray-500 dark:text-gray-400">
                            No se encontraron cartas que coincidan con tu búsqueda
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Función para filtrar cartas en el modal
        window.filterMyCardsModal = function(searchTerm) {
            const setFilter = document.getElementById('myCardsSetFilter');
            const selectedSet = setFilter ? setFilter.value.toLowerCase() : '';
            const searchLower = searchTerm.toLowerCase();
            
            const cardRows = document.querySelectorAll('.my-card-row');
            const noResultsMsg = document.getElementById('noResultsMessage');
            let visibleCount = 0;
            
            cardRows.forEach(row => {
                const cardName = row.dataset.cardName || '';
                const cardSet = row.dataset.cardSet || '';
                
                const matchesSearch = !searchLower || cardName.includes(searchLower);
                const matchesSet = !selectedSet || cardSet === selectedSet;
                
                if (matchesSearch && matchesSet) {
                    row.style.display = 'flex';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Mostrar mensaje si no hay resultados
            if (noResultsMsg) {
                noResultsMsg.classList.toggle('hidden', visibleCount > 0);
            }
        };
        
        // Función para seleccionar carta desde "Mis Cartas"
        window.selectFromMyCards = function(type, cardId, cardName, cardImage, setName, cardNumber, language = 'Español', condition = 'NM') {
            console.log('📋 selectFromMyCards llamada con:', { type, cardId, cardName, cardImage, setName, cardNumber, language, condition });
            
            // Obtener el contenedor correcto
            const containerId = type === 'offered' ? 'offeredCardsContainer' : 'wantedCardsContainer';
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.error('❌ No se encontró el contenedor:', containerId);
                return;
            }
            
            const cards = container.querySelectorAll('.trade-card');
            
            // Buscar la primera fila vacía
            let targetCardIndex = -1;
            let cardElement = null;
            
            for (let i = 0; i < cards.length; i++) {
                const nameInput = cards[i].querySelector(`input[name="${type}_name_${i}"]`);
                if (nameInput && !nameInput.value && !nameInput.readOnly) {
                    targetCardIndex = i;
                    cardElement = cards[i];
                    break;
                }
            }
            
            // Si no hay filas vacías, añadir una nueva
            if (targetCardIndex === -1) {
                addCardToTrade(type);
                const newCards = container.querySelectorAll('.trade-card');
                targetCardIndex = newCards.length - 1;
                cardElement = newCards[targetCardIndex];
            }
            
            if (!cardElement) {
                console.error('❌ No se encontró el elemento de carta');
                return;
            }
            
            // Rellenar los datos de la carta seleccionada
            // Pasar shouldLock = true porque viene de "Mis Cartas"
            selectCardForTrade(type, targetCardIndex, cardId, cardName, cardImage, setName, cardNumber, true);
            
            // Establecer el idioma de la carta
            const languageSelect = cardElement.querySelector(`select[name="${type}_language_${targetCardIndex}"]`);
            if (languageSelect) {
                console.log('✅ Selector de idioma encontrado, estableciendo:', language);
                // Buscar la opción que coincida con el idioma
                const options = languageSelect.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === language) {
                        languageSelect.selectedIndex = i;
                        console.log('✅ Idioma establecido en índice:', i);
                        break;
                    }
                }
            } else {
                console.error('❌ No se encontró el selector de idioma');
            }
            
            // Establecer la condición de la carta
            const conditionSelect = cardElement.querySelector(`select[name="${type}_condition_${targetCardIndex}"]`);
            if (conditionSelect) {
                console.log('✅ Selector de condición encontrado, estableciendo:', condition);
                conditionSelect.value = condition;
            } else {
                console.error('❌ No se encontró el selector de condición');
            }
            
            // IMPORTANTE: Marcar que esta carta viene de "Mis Cartas"
            const fromMyCardsInput = cardElement.querySelector(`input[name="${type}_fromMyCards_${targetCardIndex}"]`);
            if (fromMyCardsInput) {
                fromMyCardsInput.value = 'true';
                console.log('✅ Carta marcada como proveniente de "Mis Cartas"');
            }
            
            // Verificar que el nombre se haya establecido correctamente
            const nameInput = cardElement.querySelector(`input[name="${type}_name_${targetCardIndex}"]`);
            if (nameInput) {
                console.log('✅ Nombre establecido:', nameInput.value);
            } else {
                console.error('❌ No se encontró el input de nombre');
            }
        };
        
        // Función para contar cuántas personas ofrecen una carta específica
        function getCardOffersCount(cardName, cardSet) {
            let offersCount = 0;
            
            // Debug: log para ver qué carta estamos buscando
            console.log('🔍 Buscando ofertas para:', cardName, 'del set:', cardSet);
            
            // Buscar en todos los intercambios guardados en localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (key && key.startsWith('userTrades_')) {
                    try {
                        const trades = JSON.parse(localStorage.getItem(key) || '[]');
                        console.log(`📦 Revisando ${trades.length} intercambios en ${key}`);
                        
                        // Contar las veces que esta carta aparece en las cartas ofrecidas
                        trades.forEach(trade => {
                            if (trade.offeredCards && Array.isArray(trade.offeredCards)) {
                                trade.offeredCards.forEach(offeredCard => {
                                    const offeredCardName = offeredCard.name || offeredCard;
                                    const offeredCardSet = offeredCard.set || '';
                                    
                                    console.log(`  - Comparando "${cardName}" (${cardSet}) con "${offeredCardName}" (${offeredCardSet})`);
                                    
                                    // Comparación exacta de nombre Y set
                                    const nameMatch = offeredCardName && offeredCardName.toLowerCase() === cardName.toLowerCase();
                                    const setMatch = offeredCardSet && offeredCardSet.toLowerCase() === cardSet.toLowerCase();
                                    
                                    if (nameMatch && setMatch) {
                                        console.log('  ✅ ¡Coincidencia exacta encontrada!');
                                        offersCount++;
                                    }
                                });
                            }
                        });
                    } catch (error) {
                        console.error('Error al procesar intercambios:', error);
                    }
                }
            }
            
            console.log(`📊 Total de ofertas encontradas para "${cardName}" del set "${cardSet}": ${offersCount}`);
            return offersCount;
        }
        
        // Función de debug para ver todos los intercambios
        window.debugShowAllTrades = function() {
            console.log('🔍 === MOSTRANDO TODOS LOS INTERCAMBIOS ===');
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (key && key.startsWith('userTrades_')) {
                    try {
                        const trades = JSON.parse(localStorage.getItem(key) || '[]');
                        console.log(`\n📦 Usuario: ${key}`);
                        console.log(`Total de intercambios: ${trades.length}`);
                        
                        trades.forEach((trade, index) => {
                            console.log(`\n--- Intercambio ${index + 1} ---`);
                            console.log('ID:', trade.id);
                            console.log('Título:', trade.title);
                            console.log('Descripción:', trade.description);
                            console.log('Creado:', trade.createdAt);
                            
                            console.log('\n📤 Cartas Ofrecidas:');
                            if (trade.offeredCards && trade.offeredCards.length > 0) {
                                trade.offeredCards.forEach((card, i) => {
                                    if (typeof card === 'object') {
                                        console.log(`  ${i + 1}. ${card.name} - Set: ${card.set || 'N/A'} - Condición: ${card.condition || 'N/A'} - Idioma: ${card.language || 'N/A'}`);
                                    } else {
                                        console.log(`  ${i + 1}. ${card}`);
                                    }
                                });
                            } else {
                                console.log('  (Sin cartas ofrecidas)');
                            }
                            
                            console.log('\n📥 Cartas Buscadas:');
                            if (trade.wantedCards && trade.wantedCards.length > 0) {
                                trade.wantedCards.forEach((card, i) => {
                                    if (typeof card === 'object') {
                                        console.log(`  ${i + 1}. ${card.name} - Set: ${card.set || 'N/A'} - Condición: ${card.condition || 'N/A'} - Idioma: ${card.language || 'N/A'}`);
                                    } else {
                                        console.log(`  ${i + 1}. ${card}`);
                                    }
                                });
                            } else {
                                console.log('  (Sin cartas buscadas)');
                            }
                            
                            console.log('\n------------------------');
                        });
                    } catch (error) {
                        console.error('Error al procesar intercambios:', error);
                    }
                }
            }
            
            console.log('\n🔍 === FIN DE LA LISTA ===');
        };

        // Función para obtener todos los intercambios que ofrecen una carta específica
        function getCardOfferDetails(cardName, cardSet) {
            const offers = [];
            
            // Buscar en todos los intercambios guardados en localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (key && key.startsWith('userTrades_')) {
                    try {
                        const trades = JSON.parse(localStorage.getItem(key) || '[]');
                        
                        trades.forEach(trade => {
                            if (trade.offeredCards && Array.isArray(trade.offeredCards)) {
                                const hasCard = trade.offeredCards.some(offeredCard => {
                                    const offeredCardName = offeredCard.name || offeredCard;
                                    const offeredCardSet = offeredCard.set || '';
                                    
                                    // Comparación exacta de nombre Y set
                                    const nameMatch = offeredCardName && offeredCardName.toLowerCase() === cardName.toLowerCase();
                                    const setMatch = offeredCardSet && offeredCardSet.toLowerCase() === cardSet.toLowerCase();
                                    
                                    return nameMatch && setMatch;
                                });
                                
                                if (hasCard) {
                                    offers.push({
                                        user: trade.user || 'Usuario desconocido',
                                        userId: trade.userId || key.replace('userTrades_', ''),
                                        title: trade.title,
                                        offeredCards: trade.offeredCards,
                                        wantedCards: trade.wantedCards,
                                        createdAt: trade.createdAt
                                    });
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error al procesar intercambios:', error);
                    }
                }
            }
            
            return offers;
        }
        
        // Función para mostrar el modal con las ofertas de una carta
        window.showCardOffers = function(cardName, cardSet, cardImageUrl) {
            const offers = getCardOfferDetails(cardName, cardSet);
            
            if (offers.length === 0) {
                showNotification('No hay ofertas disponibles para esta carta en este momento.', 'info', 4000);
                return;
            }
            
            // Crear el modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
            
            let offersHTML = offers.map(offer => `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4 border border-gray-200 dark:border-gray-600">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">${offer.title || 'Intercambio sin título'}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Por: <span class="font-medium">${offer.user}</span></p>
                        </div>
                        <span class="text-xs text-gray-500 dark:text-gray-400">
                            ${offer.createdAt ? new Date(offer.createdAt).toLocaleDateString('es-ES') : 'Fecha no disponible'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">📤 Ofrece:</h5>
                            <div class="space-y-1">
                                ${offer.offeredCards.map(card => `
                                    <div class="bg-white dark:bg-gray-600 px-2 py-1 rounded text-xs flex items-center gap-1">
                                        ${card.image ? `<img src="${card.image}" alt="${card.name}" class="w-6 h-8 object-contain">` : ''}
                                        <span class="text-gray-700 dark:text-gray-200">${card.name || card}</span>
                                        ${card.condition ? `<span class="ml-2 text-gray-500 dark:text-gray-400">(${card.condition})</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">📥 Busca:</h5>
                            <div class="space-y-1">
                                ${offer.wantedCards.map(card => `
                                    <div class="bg-white dark:bg-gray-600 px-2 py-1 rounded text-xs flex items-center gap-1">
                                        ${card.image ? `<img src="${card.image}" alt="${card.name}" class="w-6 h-8 object-contain">` : ''}
                                        <span class="text-gray-700 dark:text-gray-200">${card.name || card}</span>
                                        ${card.condition ? `<span class="ml-2 text-gray-500 dark:text-gray-400">(${card.condition})</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 flex justify-end">
                        <button class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm"
                                onclick="alert('Función de contacto en desarrollo')">
                            💬 Contactar
                        </button>
                    </div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-6 border-b dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <img src="${cardImageUrl}" alt="${cardName}" class="w-16 h-20 object-contain rounded">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                                        Ofertas de ${cardName}
                                    </h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        ${offers.length} ${offers.length === 1 ? 'persona ofrece' : 'personas ofrecen'} esta carta
                                    </p>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">
                                &times;
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto flex-1">
                        ${offersHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Función helper para obtener el nombre de usuario para mostrar en intercambios
        async function getUserDisplayName(uid = null) {
            try {
                const userId = uid || currentUser?.uid;
                if (!userId) return 'Usuario';
                
                // Si es el usuario actual y no se proporciona uid
                if (!uid && currentUser) {
                    // Primero intentar obtener de Firestore
                    if (typeof db !== 'undefined' && db) {
                        const userDoc = await getDoc(doc(db, 'users', userId));
                        const userData = userDoc.data();
                        
                        if (userData) {
                            // PRIORIDAD 1: Username (nombre de usuario único)
                            if (userData.username) {
                                return userData.username;
                            }
                            // PRIORIDAD 2: Nombre completo si no hay username
                            if (userData.name && userData.lastName) {
                                return `${userData.name} ${userData.lastName}`;
                            }
                            // PRIORIDAD 3: Solo nombre
                            if (userData.name) {
                                return userData.name;
                            }
                            // PRIORIDAD 4: DisplayName guardado
                            if (userData.displayName) {
                                return userData.displayName;
                            }
                        }
                    }
                    
                    // Si no hay datos en Firestore, usar displayName de Auth
                    if (currentUser.displayName) {
                        return currentUser.displayName;
                    }
                    
                    // Como último recurso, usar parte del email antes del @
                    if (currentUser.email) {
                        return currentUser.email.split('@')[0];
                    }
                }
                
                return 'Usuario';
            } catch (error) {
                console.error('Error obteniendo nombre de usuario:', error);
                // Si hay error, intentar con el displayName o email del currentUser
                if (currentUser?.displayName) return currentUser.displayName;
                if (currentUser?.email) return currentUser.email.split('@')[0];
                return 'Usuario';
            }
        }
        
        // Función para cargar intercambios del usuario
        async function loadUserTrades() {
            if (!currentUser) return;

            try {
                console.log('🤝 Cargando intercambios del usuario...');

                // Cargar intercambios guardados del usuario ACTUAL (usando su UID)
                const userTradesKey = `userTrades_${currentUser.uid}`;
                const savedTrades = JSON.parse(localStorage.getItem(userTradesKey) || '[]');
                
                // Usar solo los intercambios guardados reales, sin datos de ejemplo
                let allTrades = [...savedTrades];

                // Convertir fechas de string a Date si es necesario
                allTrades = allTrades.map(trade => ({
                    ...trade,
                    createdAt: typeof trade.createdAt === 'string' ? new Date(trade.createdAt) : trade.createdAt
                }));

                displayTrades(allTrades, 'myTradesContainer');

            } catch (error) {
                console.error('❌ Error al cargar intercambios:', error);
            }
        }

        // Función para cargar intercambios disponibles
        async function loadAvailableTrades() {
            if (!currentUser) return;

            try {
                console.log('🎯 Cargando intercambios disponibles...');

                // Cargar TODOS los intercambios de localStorage
                let allAvailableTrades = [];
                
                // Obtener todas las claves de localStorage que sean de intercambios
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    // Si la clave es de intercambios y NO es del usuario actual
                    if (key.startsWith('userTrades_') && key !== `userTrades_${currentUser.uid}`) {
                        const trades = JSON.parse(localStorage.getItem(key) || '[]');
                        
                        // Añadir todos los intercambios de otros usuarios
                        trades.forEach(trade => {
                            // Asegurarse de que no se puedan editar intercambios de otros
                            allAvailableTrades.push({
                                ...trade,
                                type: 'available', // Marcar como disponible, no creado
                                userId: key.replace('userTrades_', '') // Extraer el userId de la clave
                            });
                        });
                    }
                }

                // No mostrar datos de ejemplo, solo intercambios reales

                // Convertir fechas si es necesario
                allAvailableTrades = allAvailableTrades.map(trade => ({
                    ...trade,
                    createdAt: typeof trade.createdAt === 'string' ? new Date(trade.createdAt) : trade.createdAt
                }));

                displayTrades(allAvailableTrades, 'availableTradesContainer');

            } catch (error) {
                console.error('❌ Error al cargar intercambios disponibles:', error);
            }
        }

        // Función para mostrar intercambios en un contenedor
        function displayTrades(trades, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (trades.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <p>No hay intercambios disponibles</p>
                    </div>
                `;
                return;
            }

            let tradesHTML = '';
            trades.forEach(trade => {
                // Escapar valores para usar en onclick
                // Función para escapar caracteres especiales
                const escapeForOnclick = (str) => {
                    return String(str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                };
                
                const escapedTitle = escapeForOnclick(trade.title);
                const escapedUserId = escapeForOnclick(trade.userId);
                
                tradesHTML += `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600 hover:border-orange-300 dark:hover:border-orange-400 transition-colors">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800 dark:text-white">${trade.title}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-300">${trade.description}</p>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400 dark:text-gray-400">${formatDate(trade.createdAt)}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">📤 Ofrezco:</h5>
                                <div class="space-y-2">
                                    ${trade.offeredCards.map(card => `
                                        <div class="flex items-center justify-between bg-white dark:bg-gray-600 px-3 py-2 rounded border border-gray-200 dark:border-gray-500">
                                            <div class="flex items-center gap-2 flex-1">
                                                ${card.image ? `<img src="${card.image}" alt="${card.name}" class="w-8 h-11 object-contain rounded">` : ''}
                                                <span class="text-sm text-gray-700 dark:text-gray-200">${card.name || card}</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs px-2 py-1 rounded-full text-white font-medium" 
                                                      style="background-color: ${CARD_CONDITIONS[card.condition || 'NM'].color}">
                                                    ${CARD_CONDITIONS[card.condition || 'NM'].icon} ${card.condition || 'NM'}
                                                </span>
                                                <span class="text-xs text-gray-500 dark:text-gray-400">${card.language || 'Español'}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">📥 Busco:</h5>
                                <div class="space-y-2">
                                    ${trade.wantedCards.map(card => `
                                        <div class="flex items-center justify-between bg-white dark:bg-gray-600 px-3 py-2 rounded border border-gray-200 dark:border-gray-500">
                                            <div class="flex items-center gap-2 flex-1">
                                                ${card.image ? `<img src="${card.image}" alt="${card.name}" class="w-8 h-11 object-contain rounded">` : ''}
                                                <span class="text-sm text-gray-700 dark:text-gray-200">${card.name || card}</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs px-2 py-1 rounded-full text-white font-medium" 
                                                      style="background-color: ${CARD_CONDITIONS[card.condition || 'NM'].color}">
                                                    ${CARD_CONDITIONS[card.condition || 'NM'].icon} ${card.condition || 'NM'}
                                                </span>
                                                <span class="text-xs text-gray-500 dark:text-gray-400">${card.language || 'Español'}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500 dark:text-gray-400 dark:text-gray-400">Por: ${trade.user}</span>
                            <div class="flex space-x-2">
                                <!-- Botón de chat solo visible si no es tu propio intercambio -->
                                ${trade.userId !== currentUser?.uid ? `
                                    <button class="btn-secondary px-3 py-1 rounded text-xs" data-trade-id="${trade.id}" data-user-id="${escapedUserId}" data-trade-title="${escapedTitle}" onclick="console.log('Chat clicked', window.openTradeChat); if(window.openTradeChat) { window.openTradeChat('${trade.id}', '${escapedUserId}', '${escapedTitle}'); } else { console.error('openTradeChat no está definido'); }">
                                        💭 Chat
                                    </button>
                                ` : `
                                    <span class="text-xs text-gray-400 dark:text-gray-500 italic">
                                        (Tu intercambio)
                                    </span>
                                `}
                                
                                ${trade.userId === currentUser?.uid ? `
                                    <button class="btn-secondary px-3 py-1 rounded text-xs" onclick="editTrade('${trade.id}')">
                                        ✏️ Editar
                                    </button>
                                    <button class="btn-secondary px-3 py-1 rounded text-xs" onclick="deleteTrade('${trade.id}')">
                                        🗑️ Eliminar
                                    </button>
                                ` : `
                                    <button class="btn-primary px-3 py-1 rounded text-xs" onclick="proposeTrade('${trade.id}')">
                                        💬 Proponer
                                    </button>
                                    <button class="btn-secondary px-3 py-1 rounded text-xs" onclick="viewTradeDetails('${trade.id}')">
                                        👁️ Ver
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = tradesHTML;
        }

        // Función para formatear fechas
        function formatDate(date) {
            return new Intl.DateTimeFormat('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        // Funciones de acción para intercambios
        // Función para encontrar un intercambio por ID
        function findTradeById(tradeId) {
            // Primero buscar en los intercambios del usuario actual
            if (currentUser) {
                const userTradesKey = `userTrades_${currentUser.uid}`;
                const userTrades = JSON.parse(localStorage.getItem(userTradesKey) || '[]');
                const userTrade = userTrades.find(trade => trade.id === tradeId);
                if (userTrade) return userTrade;
            }
            
            // Si no se encuentra, buscar en todos los intercambios disponibles
            // Esto incluye intercambios de otros usuarios
            const allKeys = Object.keys(localStorage);
            for (const key of allKeys) {
                if (key.startsWith('userTrades_')) {
                    const trades = JSON.parse(localStorage.getItem(key) || '[]');
                    const trade = trades.find(t => t.id === tradeId);
                    if (trade) return trade;
                }
            }
            
            return null;
        }

        // Función para editar intercambio (abre modal con datos pre-cargados)
        function editTrade(tradeId) {
            console.log('🔍 === INICIANDO EDICIÓN ===');
            console.log('✏️ Editando intercambio ID:', tradeId);
            
            // Verificar localStorage
            const userTradesKey = `userTrades_${currentUser.uid}`;
            const savedTrades = JSON.parse(localStorage.getItem(userTradesKey) || '[]');
            console.log('📦 Intercambios en localStorage:', savedTrades.length);
            console.log('📦 Todos los intercambios:', savedTrades);
            
            const trade = findTradeById(tradeId);
            console.log('🔍 Intercambio encontrado:', trade);
            
            if (!trade) {
                console.error('❌ No se encontró el intercambio para editar. ID buscado:', tradeId);
                showNotification('No se encontró el intercambio para editar', 'error', 4000);
                return;
            }
            
            console.log('📋 Datos completos del intercambio a editar:');
            console.log('- ID:', trade.id);
            console.log('- Título:', trade.title);
            console.log('- Descripción:', trade.description);
            console.log('- Cartas ofrecidas:', trade.offeredCards);
            console.log('- Cartas buscadas:', trade.wantedCards);
            
            // Abrir modal de crear intercambio con datos pre-cargados
            console.log('🚀 Abriendo modal con datos...');
            showCreateTradeModal(trade);
        }

        // Función para eliminar intercambio directamente
        async function deleteTrade(tradeId) {
            console.log('🗑️ Eliminando intercambio:', tradeId);
            
            const trade = findTradeById(tradeId);
            if (!trade) {
                showNotification('No se encontró el intercambio para eliminar', 'error', 4000);
                return;
            }
            
            // Usar modal personalizado en lugar de confirm()
            const confirmed = await showConfirmDeleteModal(trade.title);
            
            if (confirmed) {
                // Eliminar del localStorage
                const userTradesKey = `userTrades_${currentUser.uid}`;
                let savedTrades = JSON.parse(localStorage.getItem(userTradesKey) || '[]');
                savedTrades = savedTrades.filter(t => t.id !== tradeId);
                localStorage.setItem(userTradesKey, JSON.stringify(savedTrades));
                
                console.log('✅ Intercambio eliminado exitosamente');
                
                // Mostrar mensaje de éxito con estilo personalizado
                showSuccessMessage('¡Intercambio eliminado exitosamente! 🗑️');
                
                // Recargar la lista de intercambios
                loadUserTrades();
            }
        }

        // Función para abrir chat de intercambio (disponible globalmente)
        window.openTradeChat = async function(tradeId, otherUserId, tradeTitle) {
            console.log('🔍 openTradeChat llamado con:', { tradeId, otherUserId, tradeTitle });
            
            if (!currentUser) {
                showNotification('Debes iniciar sesión para usar el chat', 'warning');
                showAuthModal('login');
                return;
            }

            // Verificar que no estés intentando chatear contigo mismo
            if (otherUserId === currentUser.uid) {
                showNotification('No puedes abrir un chat contigo mismo', 'warning');
                return;
            }

            // Si el chat no está inicializado, intentar inicializarlo
            if (!window.chatManager || !window.chatUI) {
                console.log('⏳ Chat no inicializado, intentando inicializar...');
                
                // Verificar si las clases están disponibles
                if (typeof ChatManager === 'undefined' || typeof ChatUI === 'undefined') {
                    console.error('❌ Clases de chat no disponibles');
                    showNotification('Error: El sistema de chat no se cargó correctamente', 'error');
                    return;
                }
                
                // Intentar inicializar
                try {
                    window.chatManager = new ChatManager(auth, db);
                    window.chatUI = new ChatUI(window.chatManager);
                    console.log('✅ Chat inicializado exitosamente');
                } catch (error) {
                    console.error('❌ Error al inicializar chat:', error);
                    showNotification('Error al inicializar el chat. Por favor, recarga la página.', 'error');
                    return;
                }
            }

            try {
                // Normalizar el chatId - si ya tiene el prefijo trade_, no duplicarlo
                let chatId = tradeId;
                if (!tradeId.startsWith('trade_')) {
                    chatId = `trade_${tradeId}`;
                }
                
                // Obtener información del intercambio
                const trade = findTradeById(tradeId);
                let displayName = 'Chat del Intercambio';
                
                if (trade) {
                    // Usar un nombre más descriptivo para el chat
                    displayName = `Chat: ${trade.title || 'Intercambio'}`;
                    
                    // Si no se proporciona título, usar el título del intercambio
                    if (!tradeTitle) {
                        tradeTitle = trade.title;
                    }
                }
                
                console.log('📨 Abriendo chat compartido:', { chatId, tradeId, displayName });
                console.log('👤 Usuario actual:', currentUser.uid);
                
                // Inicializar o unirse al chat del intercambio
                // Extraer el ID real del intercambio (sin el prefijo trade_)
                const realTradeId = tradeId.replace(/^trade_/, '');
                await window.chatManager.initializeTradeChat(chatId, realTradeId, tradeTitle || displayName, otherUserId);
                
                // Abrir ventana de chat
                await window.chatUI.openChat(chatId);
                
                // Automáticamente escuchar mensajes para este chat
                if (!window.chatManager.chatListeners.has(chatId)) {
                    console.log('🔊 Iniciando escucha de mensajes para:', chatId);
                }
                
                console.log('✅ Chat abierto exitosamente');
                console.log('💡 Tip: Ejecuta chatDebugger.runFullDiagnostic("' + tradeId + '") en la consola para diagnóstico');
                
            } catch (error) {
                console.error('❌ Error al abrir chat:', error);
                showNotification('Error al abrir el chat: ' + error.message, 'error');
            }
        };

        function proposeTrade(tradeId) {
            console.log('💬 Proponiendo intercambio:', tradeId);
            
            // Buscar el intercambio original
            const originalTrade = findTradeById(tradeId);
            if (!originalTrade) {
                showNotification('No se encontró el intercambio', 'error');
                return;
            }
            
            // Verificar que el usuario esté logueado
            if (!currentUser) {
                showNotification('Debes iniciar sesión para proponer un intercambio', 'warning');
                return;
            }
            
            // Verificar que no sea el propio intercambio del usuario
            if (originalTrade.userId === currentUser.uid) {
                showNotification('No puedes proponer en tu propio intercambio', 'warning');
                return;
            }
            
            // Crear modal de contrapropuesta
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'proposalModal';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-green-500 to-green-600 dark:from-green-700 dark:to-green-800 p-6">
                        <div class="flex justify-between items-start">
                            <div class="text-white">
                                <h2 class="text-2xl font-bold mb-2">
                                    💬 Proponer Intercambio
                                </h2>
                                <p class="text-sm opacity-90">
                                    Respondiendo a: ${originalTrade.title || 'Intercambio sin título'}
                                </p>
                                <p class="text-xs opacity-75 mt-1">
                                    De: ${originalTrade.userName || originalTrade.user || 'Usuario'}
                                </p>
                            </div>
                            <button onclick="document.getElementById('proposalModal').remove()" 
                                    class="text-white hover:text-gray-200 transition-colors">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="overflow-y-auto max-h-[calc(90vh-120px)] p-6">
                        <form id="proposalForm" onsubmit="handleProposalSubmit(event, '${tradeId}')">
                            <!-- Información del intercambio original -->
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 mb-6">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                    📋 Intercambio Original
                                </h3>
                                <div class="grid md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">Ofrece:</span>
                                        <ul class="mt-1 space-y-1">
                                            ${originalTrade.offeredCards.map(card => `
                                                <li class="text-gray-600 dark:text-gray-400">
                                                    • ${card.name} ${card.condition ? `(${card.condition})` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">Busca:</span>
                                        <ul class="mt-1 space-y-1">
                                            ${originalTrade.wantedCards.map(card => `
                                                <li class="text-gray-600 dark:text-gray-400">
                                                    • ${card.name} ${card.condition ? `(${card.condition})` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tu Contrapropuesta -->
                            <div class="space-y-6">
                                <h3 class="font-bold text-lg text-gray-900 dark:text-white">
                                    ✨ Tu Contrapropuesta
                                </h3>
                                
                                <!-- Cartas que ofreces (lo que el otro busca) -->
                                <div>
                                    <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                                        <span class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 p-1 rounded">
                                            📤
                                        </span>
                                        Cartas que Ofreces (respuesta a lo que busca)
                                    </h4>
                                    <div id="proposalOfferedCardsContainer" class="space-y-3">
                                        <!-- Se pre-cargarán las cartas que el otro busca -->
                                    </div>
                                    <div class="flex gap-2 mt-3">
                                        <button type="button" onclick="addCardToProposal('offered')"
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                            + Añadir Carta
                                        </button>
                                        <button type="button" onclick="addFromMyCardsToProposal('offered')"
                                                class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                            📚 Desde Mis Cartas
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Cartas que buscas (modificación de lo que ofrece) -->
                                <div>
                                    <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                                        <span class="bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 p-1 rounded">
                                            📥
                                        </span>
                                        Cartas que Buscas (de lo que ofrece)
                                    </h4>
                                    <div id="proposalWantedCardsContainer" class="space-y-3">
                                        <!-- Se pre-cargarán las cartas que el otro ofrece -->
                                    </div>
                                    <button type="button" onclick="addCardToProposal('wanted')"
                                            class="mt-3 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                        + Añadir Carta
                                    </button>
                                </div>
                                
                                <!-- Mensaje adicional -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Mensaje (opcional)
                                    </label>
                                    <textarea id="proposalMessage" rows="3"
                                              class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-400"
                                              placeholder="Añade un mensaje para explicar tu propuesta..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Botones de acción -->
                            <div class="flex gap-3 justify-end mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <button type="button" onclick="document.getElementById('proposalModal').remove()"
                                        class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold">
                                    Cancelar
                                </button>
                                <button type="submit"
                                        class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold">
                                    Enviar Propuesta
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Pre-cargar las cartas sugeridas basadas en el intercambio original
            preloadProposalCards(originalTrade);
        }
        
        // Función para pre-cargar las cartas en la propuesta
        function preloadProposalCards(originalTrade) {
            const offeredContainer = document.getElementById('proposalOfferedCardsContainer');
            const wantedContainer = document.getElementById('proposalWantedCardsContainer');
            
            console.log('📋 Pre-cargando cartas para propuesta:', originalTrade);
            
            // Pre-cargar las cartas que el otro busca (para que las ofrezcas)
            originalTrade.wantedCards.forEach((card, index) => {
                console.log('📤 Pre-cargando carta ofrecida:', card);
                const cardHtml = createProposalCardInput('offered', index, card, true);
                offeredContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
            
            // Pre-cargar las cartas que el otro ofrece (para que las selecciones)
            originalTrade.offeredCards.forEach((card, index) => {
                console.log('📥 Pre-cargando carta buscada:', card);
                const cardHtml = createProposalCardInput('wanted', index, card, true);
                wantedContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
        
        // Función para crear un input de carta en la propuesta
        function createProposalCardInput(type, index, cardData = {}, isPreloaded = false) {
            const uniqueId = `proposal_${type}_${Date.now()}_${index}`;
            
            // Asegurar que la condición tenga un valor por defecto
            if (!cardData.condition) {
                cardData.condition = 'NM';
            }
            
            console.log(`🎴 createProposalCardInput llamado:`, {
                type,
                index,
                cardData,
                isPreloaded,
                hasImage: !!cardData.image,
                imageUrl: cardData.image ? cardData.image.substring(0, 100) : 'NO IMAGE'
            });
            
            return `
                <div class="proposal-card bg-white dark:bg-gray-700 rounded-lg p-3 border border-gray-200 dark:border-gray-600" data-unique-id="${uniqueId}">
                    <div class="flex items-center gap-3">
                        ${cardData.image ? `
                            <img src="${cardData.image}" 
                                 alt="${cardData.name || 'Carta'}" 
                                 class="w-16 h-20 object-contain rounded proposal-card-image"
                                 loading="lazy"
                                 onerror="console.error('Error loading image:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                 onload="console.log('Image loaded:', this.src);">
                            <div class="w-16 h-20 bg-gray-200 dark:bg-gray-600 rounded flex items-center justify-center proposal-card-image" style="display:none;">
                                <span class="text-2xl">🎴</span>
                            </div>
                        ` : `
                            <div class="w-16 h-20 bg-gray-200 dark:bg-gray-600 rounded flex items-center justify-center proposal-card-image">
                                <span class="text-2xl">🎴</span>
                            </div>
                        `}
                        
                        <div class="flex-1 space-y-2">
                            <div class="relative">
                                <input type="text" 
                                       name="${uniqueId}_name"
                                       value="${cardData.name || ''}"
                                       placeholder="Buscar carta..."
                                       ${isPreloaded ? 'readonly' : `oninput="searchProposalCard(this, '${uniqueId}')"`}
                                       class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white ${isPreloaded ? 'bg-gray-100 dark:bg-gray-600' : ''} focus:outline-none focus:ring-2 focus:ring-green-400">
                                ${!isPreloaded ? `
                                    <div class="proposal-search-results absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                                ` : ''}
                            </div>
                            
                            <div class="flex gap-2">
                                <select name="${uniqueId}_condition"
                                        ${isPreloaded ? 'disabled' : ''}
                                        class="flex-1 p-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white ${isPreloaded ? 'bg-gray-100 dark:bg-gray-600' : ''} focus:outline-none focus:ring-2 focus:ring-green-400">
                                    ${Object.entries(CARD_CONDITIONS).map(([key, condition]) => `
                                        <option value="${key}" ${cardData.condition === key ? 'selected' : ''}>
                                            ${condition.icon} ${condition.code}
                                        </option>
                                    `).join('')}
                                </select>
                                
                                <select name="${uniqueId}_language"
                                        ${isPreloaded ? 'disabled' : ''}
                                        class="flex-1 p-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white ${isPreloaded ? 'bg-gray-100 dark:bg-gray-600' : ''} focus:outline-none focus:ring-2 focus:ring-green-400">
                                    <option value="Español" ${cardData.language === 'Español' ? 'selected' : ''}>Español</option>
                                    <option value="Inglés" ${cardData.language === 'Inglés' ? 'selected' : ''}>Inglés</option>
                                    <option value="Japonés" ${cardData.language === 'Japonés' ? 'selected' : ''}>Japonés</option>
                                    <option value="Francés" ${cardData.language === 'Francés' ? 'selected' : ''}>Francés</option>
                                    <option value="Alemán" ${cardData.language === 'Alemán' ? 'selected' : ''}>Alemán</option>
                                    <option value="Italiano" ${cardData.language === 'Italiano' ? 'selected' : ''}>Italiano</option>
                                    <option value="Portugués" ${cardData.language === 'Portugués' ? 'selected' : ''}>Portugués</option>
                                    <option value="Chino" ${cardData.language === 'Chino' ? 'selected' : ''}>Chino</option>
                                    <option value="Coreano" ${cardData.language === 'Coreano' ? 'selected' : ''}>Coreano</option>
                                </select>
                            </div>
                            
                            <!-- Campos ocultos para datos adicionales -->
                            <input type="hidden" name="${uniqueId}_id" value="${cardData.id || ''}">
                            <input type="hidden" name="${uniqueId}_image" value="${cardData.image || ''}">
                            <input type="hidden" name="${uniqueId}_set" value="${cardData.set || ''}">
                            <input type="hidden" name="${uniqueId}_number" value="${cardData.number || ''}">
                        </div>
                        
                        <button type="button" onclick="this.closest('.proposal-card').remove()"
                                class="text-red-500 hover:text-red-700 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Función para añadir carta a la propuesta
        window.addCardToProposal = function(type) {
            const container = document.getElementById(`proposal${type === 'offered' ? 'Offered' : 'Wanted'}CardsContainer`);
            const index = container.children.length;
            const cardHtml = createProposalCardInput(type, index);
            container.insertAdjacentHTML('beforeend', cardHtml);
        };
        
        // Función para buscar cartas en la API desde el modal de propuesta
        let proposalSearchTimeout;
        window.searchProposalCard = async function(input, uniqueId) {
            const query = input.value.trim();
            const resultsContainer = input.parentElement.querySelector('.proposal-search-results');
            
            if (!resultsContainer) return;
            
            // Limpiar timeout anterior
            clearTimeout(proposalSearchTimeout);
            
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // Mostrar loading
            resultsContainer.innerHTML = `
                <div class="p-3 text-center text-gray-500">
                    <div class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full"></div>
                    <span class="ml-2">Buscando...</span>
                </div>
            `;
            resultsContainer.classList.remove('hidden');
            
            // Debounce de 500ms
            proposalSearchTimeout = setTimeout(async () => {
                try {
                    const encodedQuery = encodeURIComponent(query);
                    const response = await fetch(`https://tcgtrade-production.up.railway.app/api/pokemontcg/cards?q=${encodedQuery}&pageSize=10`, {
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    
                    if (data.data && data.data.length > 0) {
                        // Función para escapar caracteres especiales en onclick
                        const escapeForOnclick = (str) => {
                            return String(str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                        };
                        
                        resultsContainer.innerHTML = data.data.map(card => `
                            <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-center gap-2 border-b border-gray-200 dark:border-gray-600 last:border-0"
                                 onclick="selectProposalCard('${uniqueId}', '${escapeForOnclick(card.id)}', '${escapeForOnclick(card.name)}', '${escapeForOnclick(card.images.small)}', '${escapeForOnclick(card.set?.name || '')}', '${escapeForOnclick(card.number || '')}')">
                                <img src="${card.images.small}" alt="${card.name}" class="w-10 h-14 object-contain">
                                <div class="flex-1">
                                    <div class="font-medium text-sm text-gray-900 dark:text-white">${card.name}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${card.set?.name || 'Set desconocido'} - ${card.number || 'N/A'}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        resultsContainer.innerHTML = `
                            <div class="p-3 text-center text-gray-500 dark:text-gray-400">
                                No se encontraron cartas
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error buscando cartas:', error);
                    resultsContainer.innerHTML = `
                        <div class="p-3 text-center text-red-500">
                            Error al buscar cartas
                        </div>
                    `;
                }
            }, 500);
        };
        
        // Función para seleccionar una carta del buscador en propuesta
        window.selectProposalCard = function(uniqueId, cardId, cardName, cardImage, setName, cardNumber) {
            const cardElement = document.querySelector(`[data-unique-id="${uniqueId}"]`);
            if (!cardElement) return;
            
            // Actualizar el input de nombre
            const nameInput = cardElement.querySelector(`input[name="${uniqueId}_name"]`);
            if (nameInput) {
                nameInput.value = cardName;
            }
            
            // Actualizar campos ocultos
            const idInput = cardElement.querySelector(`input[name="${uniqueId}_id"]`) || 
                           (() => {
                               const input = document.createElement('input');
                               input.type = 'hidden';
                               input.name = `${uniqueId}_id`;
                               cardElement.appendChild(input);
                               return input;
                           })();
            idInput.value = cardId;
            
            const imageInputHidden = cardElement.querySelector(`input[name="${uniqueId}_image"]`) || 
                                    (() => {
                                        const input = document.createElement('input');
                                        input.type = 'hidden';
                                        input.name = `${uniqueId}_image`;
                                        cardElement.appendChild(input);
                                        return input;
                                    })();
            imageInputHidden.value = cardImage;
            
            const setInput = cardElement.querySelector(`input[name="${uniqueId}_set"]`) || 
                            (() => {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = `${uniqueId}_set`;
                                cardElement.appendChild(input);
                                return input;
                            })();
            setInput.value = setName;
            
            const numberInput = cardElement.querySelector(`input[name="${uniqueId}_number"]`) || 
                               (() => {
                                   const input = document.createElement('input');
                                   input.type = 'hidden';
                                   input.name = `${uniqueId}_number`;
                                   cardElement.appendChild(input);
                                   return input;
                               })();
            numberInput.value = cardNumber;
            
            // Actualizar la imagen
            const imageContainer = cardElement.querySelector('.proposal-card-image');
            if (imageContainer) {
                if (imageContainer.tagName === 'IMG') {
                    imageContainer.src = cardImage;
                    imageContainer.alt = cardName;
                } else {
                    // Reemplazar el div con una imagen
                    const newImg = document.createElement('img');
                    newImg.src = cardImage;
                    newImg.alt = cardName;
                    newImg.className = 'w-16 h-20 object-contain rounded proposal-card-image';
                    imageContainer.replaceWith(newImg);
                }
            }
            
            // Ocultar resultados de búsqueda
            const resultsContainer = nameInput?.parentElement?.querySelector('.proposal-search-results');
            if (resultsContainer) {
                resultsContainer.classList.add('hidden');
            }
        };
        
        // Función para añadir desde Mis Cartas a la propuesta
        window.addFromMyCardsToProposal = async function(type) {
            if (!currentUser) {
                showNotification('Debes iniciar sesión para acceder a tu colección', 'warning', 4000);
                return;
            }
            
            // Crear modal similar al de addFromMyCards pero para propuesta
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4';
            modal.id = 'proposalCardsModal';
            
            // Cargar las cartas del usuario
            const cardsRef = collection(db, 'users', currentUser.uid, 'my_cards');
            const snapshot = await getDocs(cardsRef);
            const userCards = [];
            snapshot.forEach(doc => {
                const cardData = doc.data();
                console.log('📦 Carta cargada desde Firebase:', cardData);
                userCards.push({ id: doc.id, ...cardData });
            });
            
            console.log('📚 Total de cartas cargadas:', userCards.length);
            console.log('🎴 Primera carta (ejemplo):', userCards[0]);
            
            // Guardar las cartas en el window para acceso fácil
            window.tempProposalCards = userCards;
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[80vh] overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                            📚 Seleccionar desde Mis Cartas
                        </h3>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        ${userCards.length === 0 ? `
                            <p class="text-center text-gray-500 dark:text-gray-400">
                                No tienes cartas en tu colección
                            </p>
                        ` : `
                            <div class="space-y-2">
                                ${userCards.map((card, idx) => {
                                    const cardImage = card.image || card.imageUrl || card.cardImage || card.imageSmall || '';
                                    return `
                                    <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600">
                                        ${cardImage ? `
                                            <img src="${cardImage}" alt="${card.name}" class="w-12 h-16 object-contain rounded"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <div class="w-12 h-16 bg-gray-200 dark:bg-gray-600 rounded flex items-center justify-center" style="display:none;">
                                                <span class="text-xl">🎴</span>
                                            </div>
                                        ` : `
                                            <div class="w-12 h-16 bg-gray-200 dark:bg-gray-600 rounded flex items-center justify-center">
                                                <span class="text-xl">🎴</span>
                                            </div>
                                        `}
                                        <div class="flex-1">
                                            <div class="font-medium text-sm text-gray-900 dark:text-white">${card.name || 'Sin nombre'}</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                ${card.set || 'Set desconocido'} • ${card.condition || 'NM'} • ${card.language || 'Español'}
                                            </div>
                                        </div>
                                        <button data-card-index="${idx}" 
                                                onclick="handleProposalCardSelection(this, '${type}')"
                                                class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-sm font-semibold">
                                            Seleccionar
                                        </button>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                    <div class="p-6 border-t border-gray-200 dark:border-gray-700">
                        <button onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Nueva función para manejar la selección de cartas
        window.handleProposalCardSelection = function(button, type) {
            const cardIndex = parseInt(button.getAttribute('data-card-index'));
            const card = window.tempProposalCards[cardIndex];
            
            if (!card) {
                console.error('❌ No se encontró la carta en el índice:', cardIndex);
                showNotification('Error al seleccionar la carta', 'error');
                return;
            }
            
            console.log('🎴 Carta seleccionada:', card);
            
            // Buscar el campo de imagen correcto
            const imageUrl = card.image || card.imageUrl || card.cardImage || card.imageSmall || '';
            
            console.log('🖼️ Buscando imagen:', {
                'card.image': card.image,
                'card.imageUrl': card.imageUrl,
                'card.cardImage': card.cardImage,
                'card.imageSmall': card.imageSmall,
                'Imagen final': imageUrl
            });
            
            // Llamar a la función original con los datos correctos
            selectFromMyCardsToProposal(
                type,
                card.id,
                card.name || '',
                imageUrl,
                card.set || '',
                card.number || '',
                card.language || 'Español',
                card.condition || 'NM'
            );
            
            // Cerrar el modal
            const modal = document.getElementById('proposalCardsModal');
            if (modal) modal.remove();
        };
        
        // Función para seleccionar carta desde Mis Cartas para propuesta
        window.selectFromMyCardsToProposal = function(type, cardId, cardName, cardImage, setName, cardNumber, language, condition) {
            console.log('🎴 selectFromMyCardsToProposal - Datos recibidos:', {
                type, cardId, cardName, 
                cardImage: cardImage ? cardImage.substring(0, 50) + '...' : 'NO IMAGE',
                setName, cardNumber, language, condition
            });
            
            const containerId = `proposal${type === 'offered' ? 'Offered' : 'Wanted'}CardsContainer`;
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.error('❌ No se encontró el contenedor:', containerId);
                showNotification('Error al añadir la carta. Por favor, intenta de nuevo.', 'error');
                return;
            }
            
            const index = container.children.length;
            
            // Crear los datos de la carta
            const cardData = {
                id: cardId,
                name: cardName,
                image: cardImage,
                set: setName,
                number: cardNumber,
                language: language,
                condition: condition,
                fromMyCards: true
            };
            
            console.log('📝 cardData creado:', cardData);
            
            // Crear el HTML de la carta (bloqueada porque viene de Mis Cartas)
            const cardHtml = createProposalCardInput(type, index, cardData, true);
            
            // Verificar si el HTML contiene la imagen
            if (cardImage && !cardHtml.includes(cardImage)) {
                console.error('❌ La imagen no está en el HTML generado');
            } else if (cardImage) {
                console.log('✅ Imagen incluida en el HTML');
            }
            
            container.insertAdjacentHTML('beforeend', cardHtml);
            
            // Verificar que la imagen se renderizó correctamente
            setTimeout(() => {
                const addedCard = container.lastElementChild;
                if (addedCard) {
                    const imgElement = addedCard.querySelector('img.proposal-card-image');
                    if (imgElement) {
                        console.log('✅ Imagen encontrada en el DOM:', imgElement.src);
                        // Verificar si la imagen se está cargando
                        imgElement.onerror = function() {
                            console.error('❌ Error al cargar la imagen:', this.src);
                            // Reemplazar con placeholder si falla
                            const placeholder = document.createElement('div');
                            placeholder.className = 'w-16 h-20 bg-gray-200 dark:bg-gray-600 rounded flex items-center justify-center proposal-card-image';
                            placeholder.innerHTML = '<span class="text-2xl">🎴</span>';
                            this.replaceWith(placeholder);
                        };
                        imgElement.onload = function() {
                            console.log('✅ Imagen cargada correctamente:', this.src);
                        };
                    } else {
                        console.log('⚠️ No se encontró elemento img en la carta añadida');
                    }
                }
            }, 100);
            
            // Mostrar notificación de éxito
            showNotification('Carta añadida desde tu colección', 'success', 2000);
        };
        
        // Función para manejar el envío de la propuesta
        window.handleProposalSubmit = function(event, originalTradeId) {
            event.preventDefault();
            
            if (!currentUser) {
                showNotification('Debes iniciar sesión para enviar una propuesta', 'warning');
                return;
            }
            
            // Obtener el intercambio original
            const allTrades = [];
            // Buscar en todos los usuarios
            const userKeys = Object.keys(localStorage).filter(key => key.startsWith('userTrades_'));
            userKeys.forEach(key => {
                const trades = JSON.parse(localStorage.getItem(key) || '[]');
                trades.forEach(trade => {
                    allTrades.push({...trade, ownerKey: key});
                });
            });
            
            const originalTradeData = allTrades.find(t => t.id === originalTradeId);
            
            // Recopilar datos de la propuesta
            const proposalData = {
                id: 'proposal_' + Date.now(),
                originalTradeId: originalTradeId,
                fromUserId: currentUser.uid,
                fromUserName: localStorage.getItem(`username_${currentUser.uid}`) || currentUser.email.split('@')[0],
                message: document.getElementById('proposalMessage')?.value || '',
                offeredCards: [],
                wantedCards: [],
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            // Recopilar cartas ofrecidas
            const offeredContainer = document.getElementById('proposalOfferedCardsContainer');
            Array.from(offeredContainer.children).forEach(cardEl => {
                const inputs = cardEl.querySelectorAll('input, select');
                const cardData = {};
                inputs.forEach(input => {
                    const name = input.name;
                    if (name) {
                        const field = name.split('_').pop();
                        cardData[field] = input.value;
                    }
                });
                if (cardData.name && cardData.name.trim()) {
                    proposalData.offeredCards.push(cardData);
                }
            });
            
            // Recopilar cartas buscadas
            const wantedContainer = document.getElementById('proposalWantedCardsContainer');
            Array.from(wantedContainer.children).forEach(cardEl => {
                const inputs = cardEl.querySelectorAll('input, select');
                const cardData = {};
                inputs.forEach(input => {
                    const name = input.name;
                    if (name) {
                        const field = name.split('_').pop();
                        cardData[field] = input.value;
                    }
                });
                if (cardData.name && cardData.name.trim()) {
                    proposalData.wantedCards.push(cardData);
                }
            });
            
            // Validar que haya al menos una carta en cada lado
            if (proposalData.offeredCards.length === 0 || proposalData.wantedCards.length === 0) {
                showNotification('Debes incluir al menos una carta en cada lado de la propuesta', 'warning');
                return;
            }
            
            // Actualizar el intercambio original con las cartas extras
            if (originalTradeData) {
                // Añadir las cartas ofrecidas como cartas adicionales que se buscan
                proposalData.offeredCards.forEach(card => {
                    // Verificar si la carta ya existe
                    const exists = originalTradeData.wantedCards.some(wc => 
                        wc.name === card.name && 
                        wc.condition === card.condition && 
                        wc.language === card.language
                    );
                    
                    if (!exists) {
                        originalTradeData.wantedCards.push({
                            ...card,
                            fromProposal: true,
                            proposalId: proposalData.id,
                            addedBy: proposalData.fromUserName
                        });
                    }
                });
                
                // Marcar que tiene propuestas
                originalTradeData.hasProposals = true;
                originalTradeData.proposalCount = (originalTradeData.proposalCount || 0) + 1;
                originalTradeData.lastProposalAt = new Date().toISOString();
                
                // Guardar el intercambio actualizado
                const ownerKey = originalTradeData.ownerKey;
                const ownerTrades = JSON.parse(localStorage.getItem(ownerKey) || '[]');
                const tradeIndex = ownerTrades.findIndex(t => t.id === originalTradeId);
                if (tradeIndex !== -1) {
                    ownerTrades[tradeIndex] = originalTradeData;
                    localStorage.setItem(ownerKey, JSON.stringify(ownerTrades));
                }
                
                // Crear notificación para el dueño del intercambio
                const ownerId = ownerKey.replace('userTrades_', '');
                const notification = {
                    id: `notif_${Date.now()}`,
                    type: 'proposal',
                    title: '📬 Nueva propuesta recibida',
                    message: `${proposalData.fromUserName} ha enviado una propuesta para tu intercambio "${originalTradeData.title}"`,
                    tradeId: originalTradeId,
                    proposalId: proposalData.id,
                    from: proposalData.fromUserName,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                // Guardar notificación
                const notificationsKey = `notifications_${ownerId}`;
                const notifications = JSON.parse(localStorage.getItem(notificationsKey) || '[]');
                notifications.unshift(notification);
                localStorage.setItem(notificationsKey, JSON.stringify(notifications));
                
                // Actualizar badge si es el usuario actual
                if (ownerId === currentUser.uid) {
                    updateNotificationBadge();
                }
            }
            
            // Guardar la propuesta
            const proposalsKey = `proposals_${originalTradeId}`;
            const existingProposals = JSON.parse(localStorage.getItem(proposalsKey) || '[]');
            existingProposals.push(proposalData);
            localStorage.setItem(proposalsKey, JSON.stringify(existingProposals));
            
            // Cerrar modal y mostrar confirmación
            document.getElementById('proposalModal').remove();
            showNotification('✅ Propuesta enviada con éxito! El usuario será notificado.', 'success', 5000);
            
            // Actualizar la vista de intercambios si está visible
            if (document.getElementById('availableTradesContainer')) {
                loadAvailableTrades();
            }
        };
        
        // Función para actualizar el contador de notificaciones
        function updateNotificationBadge() {
            if (!currentUser) {
                const badge = document.getElementById('notificationBadge');
                if (badge) badge.classList.add('hidden');
                return;
            }
            
            const notificationsKey = `notifications_${currentUser.uid}`;
            const notifications = JSON.parse(localStorage.getItem(notificationsKey) || '[]');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }
        
        // Función para cargar el Buzón
        function loadInbox() {
            if (!currentUser) {
                const container = document.getElementById('notificationsList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                            <p>Debes iniciar sesión para ver tu buzón</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Cargar notificaciones
            loadNotifications();
            
            // Cargar propuestas recibidas
            loadReceivedProposals();
            
            // Cargar propuestas enviadas
            loadSentProposals();
        }
        
        // Función para cargar notificaciones
        function loadNotifications() {
            if (!currentUser) return;
            
            const notificationsKey = `notifications_${currentUser.uid}`;
            const notifications = JSON.parse(localStorage.getItem(notificationsKey) || '[]');
            
            const container = document.getElementById('notificationsList');
            if (!container) return;
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <span class="text-4xl">📭</span>
                        <p class="mt-2">No tienes notificaciones</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notifications.map(notif => `
                <div class="notification-item bg-gray-50 dark:bg-gray-700 rounded-lg p-4 ${!notif.read ? 'border-l-4 border-purple-500' : ''}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                                ${notif.title}
                                ${!notif.read ? '<span class="bg-purple-500 text-white text-xs px-2 py-1 rounded-full">Nuevo</span>' : ''}
                            </h4>
                            <p class="text-gray-600 dark:text-gray-300 mt-1">${notif.message}</p>
                            <div class="flex items-center gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
                                <span>De: ${notif.from}</span>
                                <span>${formatRelativeTime(notif.timestamp)}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${notif.tradeId ? `
                                <button onclick="viewTradeDetails('${notif.tradeId}')"
                                        class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">
                                    Ver Intercambio
                                </button>
                            ` : ''}
                            ${!notif.read ? `
                                <button onclick="markNotificationAsRead('${notif.id}')"
                                        class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm">
                                    Marcar como leído
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Función para cargar propuestas recibidas
        function loadReceivedProposals() {
            if (!currentUser) return;
            
            const container = document.getElementById('receivedProposalsList');
            if (!container) return;
            
            const receivedProposals = [];
            
            // Buscar propuestas en todos los intercambios del usuario
            const userTrades = JSON.parse(localStorage.getItem(`userTrades_${currentUser.uid}`) || '[]');
            
            userTrades.forEach(trade => {
                const proposalsKey = `proposals_${trade.id}`;
                const proposals = JSON.parse(localStorage.getItem(proposalsKey) || '[]');
                proposals.forEach(proposal => {
                    receivedProposals.push({
                        ...proposal,
                        tradeName: trade.title,
                        tradeId: trade.id
                    });
                });
            });
            
            if (receivedProposals.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <span class="text-4xl">📭</span>
                        <p class="mt-2">No has recibido propuestas</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = receivedProposals.map(proposal => `
                <div class="proposal-item bg-white dark:bg-gray-700 rounded-lg shadow p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-900 dark:text-white">
                                Propuesta para: ${proposal.tradeName}
                            </h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                De: ${proposal.fromUserName} • ${formatRelativeTime(proposal.createdAt)}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            proposal.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            proposal.status === 'accepted' ? 'bg-green-100 text-green-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${proposal.status === 'pending' ? 'Pendiente' :
                              proposal.status === 'accepted' ? 'Aceptada' : 'Rechazada'}
                        </span>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <h5 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">Te ofrece:</h5>
                            <ul class="space-y-1">
                                ${proposal.offeredCards.map(card => `
                                    <li class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2">
                                        ${card.image ? `<img src="${card.image}" class="w-8 h-10 object-contain rounded">` : '🎴'}
                                        ${card.name} (${card.condition || 'NM'})
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">Busca:</h5>
                            <ul class="space-y-1">
                                ${proposal.wantedCards.map(card => `
                                    <li class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2">
                                        ${card.image ? `<img src="${card.image}" class="w-8 h-10 object-contain rounded">` : '🎴'}
                                        ${card.name} (${card.condition || 'NM'})
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    ${proposal.message ? `
                        <div class="bg-gray-50 dark:bg-gray-800 rounded p-3 mb-3">
                            <p class="text-sm text-gray-600 dark:text-gray-300">"${proposal.message}"</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2">
                        <button onclick="viewProposalDetails('${proposal.id}', '${proposal.tradeId}')"
                                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">
                            Ver Detalles
                        </button>
                        ${proposal.status === 'pending' ? `
                            <button onclick="acceptProposal('${proposal.id}', '${proposal.tradeId}')"
                                    class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm">
                                Aceptar
                            </button>
                            <button onclick="rejectProposal('${proposal.id}', '${proposal.tradeId}')"
                                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-sm">
                                Rechazar
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Función para cargar propuestas enviadas
        function loadSentProposals() {
            if (!currentUser) return;
            
            const container = document.getElementById('sentProposalsList');
            if (!container) return;
            
            const sentProposals = [];
            
            // Buscar todas las propuestas enviadas por el usuario
            const proposalKeys = Object.keys(localStorage).filter(key => key.startsWith('proposals_'));
            
            proposalKeys.forEach(key => {
                const proposals = JSON.parse(localStorage.getItem(key) || '[]');
                const userProposals = proposals.filter(p => p.fromUserId === currentUser.uid);
                userProposals.forEach(proposal => {
                    sentProposals.push(proposal);
                });
            });
            
            if (sentProposals.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <span class="text-4xl">📭</span>
                        <p class="mt-2">No has enviado propuestas</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sentProposals.map(proposal => `
                <div class="proposal-item bg-white dark:bg-gray-700 rounded-lg shadow p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-900 dark:text-white">
                                Propuesta enviada
                            </h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                ${formatRelativeTime(proposal.createdAt)}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            proposal.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            proposal.status === 'accepted' ? 'bg-green-100 text-green-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${proposal.status === 'pending' ? 'Pendiente' :
                              proposal.status === 'accepted' ? 'Aceptada' : 'Rechazada'}
                        </span>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <h5 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">Ofreces:</h5>
                            <ul class="space-y-1">
                                ${proposal.offeredCards.map(card => `
                                    <li class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2">
                                        ${card.image ? `<img src="${card.image}" class="w-8 h-10 object-contain rounded">` : '🎴'}
                                        ${card.name} (${card.condition || 'NM'})
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">Buscas:</h5>
                            <ul class="space-y-1">
                                ${proposal.wantedCards.map(card => `
                                    <li class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2">
                                        ${card.image ? `<img src="${card.image}" class="w-8 h-10 object-contain rounded">` : '🎴'}
                                        ${card.name} (${card.condition || 'NM'})
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    ${proposal.status === 'pending' ? `
                        <button onclick="cancelProposal('${proposal.id}', '${proposal.originalTradeId}')"
                                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-sm">
                            Cancelar Propuesta
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Función para formatear tiempo relativo
        function formatRelativeTime(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `hace ${days} día${days > 1 ? 's' : ''}`;
            if (hours > 0) return `hace ${hours} hora${hours > 1 ? 's' : ''}`;
            if (minutes > 0) return `hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
            return 'hace unos segundos';
        }
        
        // Función para marcar notificación como leída
        window.markNotificationAsRead = function(notifId) {
            if (!currentUser) return;
            
            const notificationsKey = `notifications_${currentUser.uid}`;
            const notifications = JSON.parse(localStorage.getItem(notificationsKey) || '[]');
            
            const notif = notifications.find(n => n.id === notifId);
            if (notif) {
                notif.read = true;
                localStorage.setItem(notificationsKey, JSON.stringify(notifications));
                loadNotifications();
                updateNotificationBadge();
            }
        };
        
        // Función para rechazar propuesta
        window.rejectProposal = function(proposalId, tradeId) {
            if (!currentUser) return;
            
            // Buscar la propuesta
            const proposalsKey = `proposals_${tradeId}`;
            const proposals = JSON.parse(localStorage.getItem(proposalsKey) || '[]');
            const proposal = proposals.find(p => p.id === proposalId);
            
            if (proposal) {
                // Actualizar estado de la propuesta
                proposal.status = 'rejected';
                proposal.rejectedAt = new Date().toISOString();
                localStorage.setItem(proposalsKey, JSON.stringify(proposals));
                
                // Crear notificación para el usuario que envió la propuesta
                const notification = {
                    id: `notif_${Date.now()}`,
                    type: 'proposal_rejected',
                    title: '❌ Propuesta rechazada',
                    message: `Tu propuesta para el intercambio ha sido rechazada`,
                    tradeId: tradeId,
                    proposalId: proposalId,
                    from: localStorage.getItem(`username_${currentUser.uid}`) || currentUser.email.split('@')[0],
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                // Guardar notificación para el proponente
                const proponentNotificationsKey = `notifications_${proposal.fromUserId}`;
                const proponentNotifications = JSON.parse(localStorage.getItem(proponentNotificationsKey) || '[]');
                proponentNotifications.unshift(notification);
                localStorage.setItem(proponentNotificationsKey, JSON.stringify(proponentNotifications));
                
                // Mostrar confirmación
                showNotification('Propuesta rechazada. El usuario ha sido notificado.', 'info', 3000);
                
                // Recargar la lista de propuestas
                loadReceivedProposals();
            }
        };
        
        // Función para aceptar propuesta
        window.acceptProposal = function(proposalId, tradeId) {
            if (!currentUser) return;
            
            // Buscar la propuesta
            const proposalsKey = `proposals_${tradeId}`;
            const proposals = JSON.parse(localStorage.getItem(proposalsKey) || '[]');
            const proposal = proposals.find(p => p.id === proposalId);
            
            if (proposal) {
                // Actualizar estado de la propuesta
                proposal.status = 'accepted';
                proposal.acceptedAt = new Date().toISOString();
                localStorage.setItem(proposalsKey, JSON.stringify(proposals));
                
                // Crear notificación para el usuario que envió la propuesta
                const notification = {
                    id: `notif_${Date.now()}`,
                    type: 'proposal_accepted',
                    title: '✅ Propuesta aceptada',
                    message: `Tu propuesta para el intercambio ha sido aceptada. ¡Es hora de valorar el intercambio!`,
                    tradeId: tradeId,
                    proposalId: proposalId,
                    from: localStorage.getItem(`username_${currentUser.uid}`) || currentUser.email.split('@')[0],
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                // Guardar notificación para el proponente
                const proponentNotificationsKey = `notifications_${proposal.fromUserId}`;
                const proponentNotifications = JSON.parse(localStorage.getItem(proponentNotificationsKey) || '[]');
                proponentNotifications.unshift(notification);
                localStorage.setItem(proponentNotificationsKey, JSON.stringify(proponentNotifications));
                
                // Marcar el intercambio como completado
                const allTrades = [];
                const userKeys = Object.keys(localStorage).filter(key => key.startsWith('userTrades_'));
                userKeys.forEach(key => {
                    const trades = JSON.parse(localStorage.getItem(key) || '[]');
                    const tradeIndex = trades.findIndex(t => t.id === tradeId);
                    if (tradeIndex !== -1) {
                        trades[tradeIndex].status = 'completed';
                        trades[tradeIndex].completedAt = new Date().toISOString();
                        trades[tradeIndex].completedWith = proposal.fromUserId;
                        localStorage.setItem(key, JSON.stringify(trades));
                    }
                });
                
                // Mostrar modal de valoración para ambos usuarios
                setTimeout(() => {
                    showRatingModal(proposal.fromUserId, proposal.fromUserName, tradeId);
                }, 500);
                
                showNotification('✅ Propuesta aceptada. ¡Ahora puedes valorar el intercambio!', 'success', 4000);
                
                // Recargar la lista de propuestas
                loadReceivedProposals();
            }
        };
        
        // Función para ver detalles de propuesta
        window.viewProposalDetails = function(proposalId, tradeId) {
            if (!currentUser) return;
            
            // Buscar la propuesta
            const proposalsKey = `proposals_${tradeId}`;
            const proposals = JSON.parse(localStorage.getItem(proposalsKey) || '[]');
            const proposal = proposals.find(p => p.id === proposalId);
            
            if (!proposal) {
                showNotification('No se encontró la propuesta', 'error');
                return;
            }
            
            // Buscar el intercambio original
            const allTrades = [];
            const userKeys = Object.keys(localStorage).filter(key => key.startsWith('userTrades_'));
            userKeys.forEach(key => {
                const trades = JSON.parse(localStorage.getItem(key) || '[]');
                trades.forEach(trade => {
                    allTrades.push(trade);
                });
            });
            
            const originalTrade = allTrades.find(t => t.id === tradeId);
            
            // Crear modal similar al de viewTradeDetails pero con datos de la propuesta
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            // Generar HTML para las cartas con el mismo diseño que viewTradeDetails
            const generateCardHTML = (cards) => cards.map(card => `
                <div class="group relative bg-gradient-to-b from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                    <!-- Imagen de la carta -->
                    <div class="relative aspect-[3/4] bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800">
                        ${card.image ? `
                            <img src="${card.image}" alt="${card.name}" 
                                 class="w-full h-full object-contain p-2">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center">
                                <span class="text-8xl opacity-50">🎴</span>
                            </div>
                        `}
                        <!-- Badge de condición en la esquina -->
                        <div class="absolute top-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded-full text-xs font-bold">
                            ${card.condition || 'NM'}
                        </div>
                    </div>
                    
                    <!-- Información de la carta -->
                    <div class="p-3 space-y-2">
                        <h4 class="font-bold text-gray-900 dark:text-white text-center">
                            ${card.name}
                        </h4>
                        
                        <!-- Pills de información -->
                        <div class="flex flex-wrap gap-1 justify-center">
                            ${card.set ? `
                                <span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full text-xs">
                                    ${card.set}
                                </span>
                            ` : ''}
                            ${card.number ? `
                                <span class="inline-block bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded-full text-xs">
                                    #${card.number}
                                </span>
                            ` : ''}
                            ${card.language ? `
                                <span class="inline-block bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded-full text-xs">
                                    ${card.language}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl max-w-6xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                    <!-- Header con gradiente -->
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">📋 Detalles de la Propuesta</h2>
                                <div class="flex items-center gap-4 text-purple-100">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                                        </svg>
                                        Propuesta de: ${proposal.fromUserName}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                        </svg>
                                        ${formatRelativeTime(proposal.createdAt)}
                                    </span>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-white hover:text-purple-200 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contenido scrolleable -->
                    <div class="overflow-y-auto max-h-[calc(90vh-120px)] p-6">
                        ${originalTrade ? `
                            <!-- Intercambio Original -->
                            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                    📦 Intercambio Original: ${originalTrade.title}
                                </h3>
                                <div class="grid md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">Ofrece:</span>
                                        <ul class="mt-1 space-y-1">
                                            ${originalTrade.offeredCards.map(card => `
                                                <li class="text-gray-600 dark:text-gray-400">
                                                    • ${card.name} ${card.condition ? `(${card.condition})` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">Busca:</span>
                                        <ul class="mt-1 space-y-1">
                                            ${originalTrade.wantedCards.map(card => `
                                                <li class="text-gray-600 dark:text-gray-400">
                                                    • ${card.name} ${card.condition ? `(${card.condition})` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Propuesta -->
                        <div class="space-y-6">
                            <!-- Cartas que ofrece el proponente -->
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                    <span class="text-2xl">📤</span>
                                    ${proposal.fromUserName} Ofrece
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    ${generateCardHTML(proposal.offeredCards)}
                                </div>
                            </div>
                            
                            <!-- Separador visual con flecha -->
                            <div class="flex items-center justify-center py-4">
                                <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent"></div>
                                <div class="mx-4 text-gray-400">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                    </svg>
                                </div>
                                <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent"></div>
                            </div>
                            
                            <!-- Cartas que busca el proponente -->
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                    <span class="text-2xl">📥</span>
                                    ${proposal.fromUserName} Busca
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    ${generateCardHTML(proposal.wantedCards)}
                                </div>
                            </div>
                            
                            ${proposal.message ? `
                                <!-- Mensaje del proponente -->
                                <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">💬 Mensaje:</h4>
                                    <p class="text-gray-700 dark:text-gray-300">${proposal.message}</p>
                                </div>
                            ` : ''}
                            
                            <!-- Botones de acción -->
                            ${proposal.status === 'pending' && originalTrade && originalTrade.createdBy === currentUser.uid ? `
                                <div class="flex gap-3 justify-center mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                                    <button onclick="acceptProposal('${proposalId}', '${tradeId}'); this.closest('.fixed').remove();"
                                            class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold">
                                        ✅ Aceptar Propuesta
                                    </button>
                                    <button onclick="rejectProposal('${proposalId}', '${tradeId}'); this.closest('.fixed').remove();"
                                            class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold">
                                        ❌ Rechazar Propuesta
                                    </button>
                                    <button onclick="this.closest('.fixed').remove()"
                                            class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold">
                                        Cerrar
                                    </button>
                                </div>
                            ` : `
                                <div class="flex justify-center mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                                    <button onclick="this.closest('.fixed').remove()"
                                            class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold">
                                        Cerrar
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Función para cancelar propuesta enviada
        window.cancelProposal = function(proposalId, tradeId) {
            if (!currentUser) return;
            
            // Buscar la propuesta
            const proposalsKey = `proposals_${tradeId}`;
            const proposals = JSON.parse(localStorage.getItem(proposalsKey) || '[]');
            const proposalIndex = proposals.findIndex(p => p.id === proposalId);
            
            if (proposalIndex !== -1) {
                // Eliminar la propuesta
                proposals.splice(proposalIndex, 1);
                localStorage.setItem(proposalsKey, JSON.stringify(proposals));
                
                showNotification('Propuesta cancelada', 'success', 3000);
                
                // Recargar la lista de propuestas enviadas
                loadSentProposals();
            }
        };
        
        // Sistema de valoración con Pokéballs
        const POKEBALL_RATINGS = {
            0: { 
                name: 'Sin valorar', 
                icon: '⚪', 
                color: 'gray',
                emoji: '⚪'
            },
            1: { 
                name: 'Premier Ball', 
                icon: '⚪', 
                color: 'white', 
                emoji: '⚪',
                image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/premier-ball.png'
            },
            2: { 
                name: 'Poké Ball', 
                icon: '🔴', 
                color: 'red', 
                emoji: '🔴',
                image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'
            },
            3: { 
                name: 'Great Ball', 
                icon: '🔵', 
                color: 'blue', 
                emoji: '🔵',
                image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png'
            },
            4: { 
                name: 'Ultra Ball', 
                icon: '⚫', 
                color: 'black', 
                emoji: '⚫',
                image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png'
            },
            5: { 
                name: 'Master Ball', 
                icon: '🟣', 
                color: 'purple', 
                emoji: '🟣',
                image: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png'
            }
        };
        
        // Función para mostrar el modal de valoración
        function showRatingModal(userId, userName, tradeId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'ratingModal';
            
            let selectedRating = 0;
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full p-6 shadow-2xl">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                            🎉 ¡Intercambio Completado!
                        </h2>
                        <p class="text-gray-600 dark:text-gray-300">
                            ¿Cómo fue tu experiencia con <strong>${userName}</strong>?
                        </p>
                    </div>
                    
                    <!-- Sistema de Pokéballs -->
                    <div class="mb-6">
                        <div class="flex justify-center gap-3 mb-4" id="pokeballRating">
                            ${[1, 2, 3, 4, 5].map(rating => `
                                <button onclick="selectRating(${rating})" 
                                        class="pokeball-rating transform transition-all hover:scale-125 p-2"
                                        data-rating="${rating}"
                                        title="${POKEBALL_RATINGS[rating].name}">
                                    <img src="${POKEBALL_RATINGS[rating].image}" 
                                         alt="${POKEBALL_RATINGS[rating].name}"
                                         class="w-12 h-12 opacity-30 grayscale transition-all pokeball-img">
                                </button>
                            `).join('')}
                        </div>
                        <p class="text-center text-sm text-gray-500 dark:text-gray-400" id="ratingText">
                            Selecciona una valoración
                        </p>
                    </div>
                    
                    <!-- Comentario opcional -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Comentario (opcional)
                        </label>
                        <textarea id="ratingComment" 
                                  rows="3" 
                                  class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-400"
                                  placeholder="Comparte tu experiencia..."></textarea>
                    </div>
                    
                    <!-- Botones -->
                    <div class="flex gap-3">
                        <button onclick="submitRating('${userId}', '${userName}', '${tradeId}')"
                                id="submitRatingBtn"
                                disabled
                                class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg font-semibold transition-colors">
                            Enviar Valoración
                        </button>
                        <button onclick="document.getElementById('ratingModal').remove()"
                                class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold">
                            Omitir
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Función para seleccionar rating
        window.selectRating = function(rating) {
            // Actualizar visual de las Pokéballs
            const pokeballs = document.querySelectorAll('.pokeball-rating');
            pokeballs.forEach((ball, index) => {
                const ballRating = index + 1;
                const img = ball.querySelector('img');
                
                if (ballRating <= rating) {
                    // Pokéball seleccionada
                    img.classList.remove('opacity-30', 'grayscale');
                    img.classList.add('opacity-100');
                    
                    // Añadir animación de rebote
                    ball.classList.add('animate-bounce');
                    setTimeout(() => ball.classList.remove('animate-bounce'), 500);
                } else {
                    // Pokéball no seleccionada
                    img.classList.add('opacity-30', 'grayscale');
                    img.classList.remove('opacity-100');
                }
            });
            
            // Actualizar texto con imagen
            const ratingText = document.getElementById('ratingText');
            ratingText.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <span class="font-semibold">${POKEBALL_RATINGS[rating].name}</span>
                    <img src="${POKEBALL_RATINGS[rating].image}" 
                         alt="${POKEBALL_RATINGS[rating].name}"
                         class="w-6 h-6 inline-block">
                </div>
            `;
            
            // Habilitar botón de enviar
            const submitBtn = document.getElementById('submitRatingBtn');
            submitBtn.disabled = false;
            submitBtn.setAttribute('data-rating', rating);
        };
        
        // Función para enviar valoración
        window.submitRating = function(userId, userName, tradeId) {
            const submitBtn = document.getElementById('submitRatingBtn');
            const rating = parseInt(submitBtn.getAttribute('data-rating'));
            const comment = document.getElementById('ratingComment').value;
            
            if (!rating) {
                showNotification('Por favor selecciona una valoración', 'warning');
                return;
            }
            
            // Crear objeto de valoración
            const ratingData = {
                id: `rating_${Date.now()}`,
                fromUserId: currentUser.uid,
                fromUserName: localStorage.getItem(`username_${currentUser.uid}`) || currentUser.email.split('@')[0],
                toUserId: userId,
                toUserName: userName,
                rating: rating,
                ratingName: POKEBALL_RATINGS[rating].name,
                comment: comment,
                tradeId: tradeId,
                timestamp: new Date().toISOString()
            };
            
            // Guardar valoración
            const ratingsKey = `ratings_${userId}`;
            const userRatings = JSON.parse(localStorage.getItem(ratingsKey) || '[]');
            userRatings.push(ratingData);
            localStorage.setItem(ratingsKey, JSON.stringify(userRatings));
            
            // Actualizar promedio de valoración del usuario
            updateUserRatingAverage(userId);
            
            // Crear notificación para el usuario valorado
            const notification = {
                id: `notif_${Date.now()}`,
                type: 'new_rating',
                title: `${POKEBALL_RATINGS[rating].emoji} Nueva valoración recibida`,
                message: `${ratingData.fromUserName} te ha valorado con ${rating} ${rating === 1 ? 'Pokéball' : 'Pokéballs'}`,
                rating: rating,
                from: ratingData.fromUserName,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            const notificationsKey = `notifications_${userId}`;
            const notifications = JSON.parse(localStorage.getItem(notificationsKey) || '[]');
            notifications.unshift(notification);
            localStorage.setItem(notificationsKey, JSON.stringify(notifications));
            
            // Cerrar modal y mostrar confirmación
            document.getElementById('ratingModal').remove();
            showNotification(`✅ Valoración enviada: ${rating} ${POKEBALL_RATINGS[rating].emoji}`, 'success', 3000);
        };
        
        // Función para actualizar el promedio de valoración
        function updateUserRatingAverage(userId) {
            const ratingsKey = `ratings_${userId}`;
            const userRatings = JSON.parse(localStorage.getItem(ratingsKey) || '[]');
            
            if (userRatings.length === 0) return;
            
            // Calcular promedio
            const totalRating = userRatings.reduce((sum, r) => sum + r.rating, 0);
            const averageRating = totalRating / userRatings.length;
            
            // Guardar promedio
            const userStatsKey = `userStats_${userId}`;
            const userStats = JSON.parse(localStorage.getItem(userStatsKey) || '{}');
            userStats.averageRating = averageRating;
            userStats.totalRatings = userRatings.length;
            userStats.lastUpdated = new Date().toISOString();
            
            localStorage.setItem(userStatsKey, JSON.stringify(userStats));
        }
        
        // Función para mostrar valoración con Pokéballs
        window.displayPokeballRating = function(rating, showNumber = false, size = 'small') {
            const fullBalls = Math.floor(rating);
            const hasHalf = rating % 1 >= 0.5;
            
            // Determinar tamaño de las imágenes
            const sizeClasses = {
                'small': 'w-5 h-5',
                'medium': 'w-6 h-6',
                'large': 'w-8 h-8'
            };
            const imgSize = sizeClasses[size] || sizeClasses['small'];
            
            let display = '<div class="inline-flex items-center gap-1">';
            
            // Mostrar Pokéballs llenas
            for (let i = 1; i <= fullBalls; i++) {
                display += `
                    <img src="${POKEBALL_RATINGS[i].image}" 
                         alt="${POKEBALL_RATINGS[i].name}"
                         title="${POKEBALL_RATINGS[i].name}"
                         class="${imgSize} inline-block">
                `;
            }
            
            // Mostrar media Pokéball si aplica
            if (hasHalf && fullBalls < 5) {
                display += `
                    <img src="${POKEBALL_RATINGS[fullBalls + 1].image}" 
                         alt="${POKEBALL_RATINGS[fullBalls + 1].name}"
                         title="${POKEBALL_RATINGS[fullBalls + 1].name}"
                         class="${imgSize} inline-block opacity-50">
                `;
            }
            
            // Mostrar Pokéballs vacías (usar Premier Ball con muy baja opacidad)
            const emptyCount = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyCount; i++) {
                display += `
                    <img src="${POKEBALL_RATINGS[1].image}" 
                         alt="Vacío"
                         class="${imgSize} inline-block opacity-20 grayscale">
                `;
            }
            
            if (showNumber) {
                display += ` <span class="text-sm text-gray-500 ml-2">(${rating.toFixed(1)})</span>`;
            }
            
            display += '</div>';
            
            return display;
        };
        
        // Función para cargar y mostrar valoraciones del usuario
        function loadUserRating() {
            if (!currentUser) return;
            
            const userStatsKey = `userStats_${currentUser.uid}`;
            const userStats = JSON.parse(localStorage.getItem(userStatsKey) || '{}');
            
            const ratingDisplay = document.getElementById('userRatingDisplay');
            const ratingStats = document.getElementById('userRatingStats');
            
            if (ratingDisplay && ratingStats) {
                if (userStats.averageRating && userStats.totalRatings > 0) {
                    ratingDisplay.innerHTML = displayPokeballRating(userStats.averageRating, true, 'large');
                    ratingStats.innerHTML = `
                        <div>
                            <span class="font-semibold text-2xl">${userStats.totalRatings}</span> 
                            <span class="text-lg">valoración${userStats.totalRatings !== 1 ? 'es' : ''}</span>
                        </div>
                        <div class="text-lg opacity-90">
                            Promedio: ${userStats.averageRating.toFixed(1)}/5.0
                        </div>
                    `;
                } else {
                    ratingDisplay.innerHTML = `
                        <span class="text-xl opacity-75">Sin valoraciones aún</span>
                    `;
                    ratingStats.innerHTML = `
                        <span class="text-sm opacity-75">Completa tu primer intercambio para recibir valoraciones</span>
                    `;
                }
            }
        }
        
        // Función para cargar la pestaña de valoraciones completa
        function loadRatingsTab() {
            if (!currentUser) return;
            
            // Cargar resumen de valoración
            loadUserRating();
            
            // Cargar historial de reseñas
            loadRatingsHistory();
            
            // Cargar estadísticas
            loadRatingStatistics();
        }
        
        // Función para cargar el historial de reseñas
        function loadRatingsHistory() {
            if (!currentUser) return;
            
            const ratingsKey = `ratings_${currentUser.uid}`;
            const userRatings = JSON.parse(localStorage.getItem(ratingsKey) || '[]');
            
            const container = document.getElementById('ratingsHistoryContainer');
            if (!container) return;
            
            if (userRatings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <span class="text-6xl">📭</span>
                        <p class="mt-4 text-gray-500 dark:text-gray-400">
                            No has recibido reseñas aún
                        </p>
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">
                            Las reseñas aparecerán aquí cuando completes intercambios
                        </p>
                    </div>
                `;
            } else {
                // Ordenar por fecha más reciente
                userRatings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                container.innerHTML = userRatings.map(rating => `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-5 hover:shadow-lg transition-shadow">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    ${rating.fromUserName.charAt(0).toUpperCase()}
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <h4 class="font-semibold text-gray-900 dark:text-white">
                                            ${rating.fromUserName}
                                        </h4>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div class="text-lg">
                                                ${displayPokeballRating(rating.rating)}
                                            </div>
                                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                                ${POKEBALL_RATINGS[rating.rating].name}
                                            </span>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                        ${formatRelativeTime(rating.timestamp)}
                                    </span>
                                </div>
                                ${rating.comment ? `
                                    <div class="bg-white dark:bg-gray-800 rounded-lg p-3 mt-3">
                                        <p class="text-gray-700 dark:text-gray-300 italic">
                                            "${rating.comment}"
                                        </p>
                                    </div>
                                ` : ''}
                                ${rating.tradeId ? `
                                    <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                        Intercambio #${rating.tradeId.slice(-6)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Función para cargar estadísticas de valoraciones
        function loadRatingStatistics() {
            if (!currentUser) return;
            
            const ratingsKey = `ratings_${currentUser.uid}`;
            const userRatings = JSON.parse(localStorage.getItem(ratingsKey) || '[]');
            
            // Contar por tipo de Pokéball
            const counts = {
                1: 0, // Premier Ball
                2: 0, // Poké Ball
                3: 0, // Great Ball
                4: 0, // Ultra Ball
                5: 0  // Master Ball
            };
            
            userRatings.forEach(rating => {
                if (rating.rating >= 1 && rating.rating <= 5) {
                    counts[rating.rating]++;
                }
            });
            
            // Actualizar los contadores en el DOM
            document.getElementById('premierBallCount').textContent = counts[1];
            document.getElementById('pokeBallCount').textContent = counts[2];
            document.getElementById('greatBallCount').textContent = counts[3];
            document.getElementById('ultraBallCount').textContent = counts[4];
            document.getElementById('masterBallCount').textContent = counts[5];
        }
        
        // Función para refrescar las valoraciones
        window.refreshRatings = function() {
            loadRatingsTab();
            showNotification('Valoraciones actualizadas', 'success', 2000);
        }
        
        // Función para mostrar historial de valoraciones
        window.showRatingHistory = function() {
            if (!currentUser) return;
            
            const ratingsKey = `ratings_${currentUser.uid}`;
            const userRatings = JSON.parse(localStorage.getItem(ratingsKey) || '[]');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold">🏆 Historial de Valoraciones</h2>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-white hover:text-purple-200 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        ${userRatings.length === 0 ? `
                            <div class="text-center py-8">
                                <span class="text-6xl">📭</span>
                                <p class="mt-4 text-gray-500 dark:text-gray-400">
                                    No has recibido valoraciones aún
                                </p>
                            </div>
                        ` : `
                            <div class="space-y-4">
                                ${userRatings.map(rating => `
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <span class="font-semibold text-gray-900 dark:text-white">
                                                        ${rating.fromUserName}
                                                    </span>
                                                    <div class="text-lg">
                                                        ${displayPokeballRating(rating.rating)}
                                                    </div>
                                                </div>
                                                ${rating.comment ? `
                                                    <p class="text-gray-600 dark:text-gray-300 text-sm italic">
                                                        "${rating.comment}"
                                                    </p>
                                                ` : ''}
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                                    ${formatRelativeTime(rating.timestamp)}
                                                </p>
                                            </div>
                                            <div class="text-2xl">
                                                ${POKEBALL_RATINGS[rating.rating].emoji}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        function viewTradeDetails(tradeId) {
            console.log('👁️ Viendo detalles del intercambio:', tradeId);
            
            // Buscar el intercambio
            const trade = findTradeById(tradeId);
            if (!trade) {
                showNotification('No se encontró el intercambio', 'error');
                return;
            }
            
            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            // Generar HTML para las cartas ofrecidas con diseño mejorado
            const offeredCardsHTML = trade.offeredCards.map(card => `
                <div class="group relative bg-gradient-to-b from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                    <!-- Imagen de la carta -->
                    <div class="relative aspect-[3/4] bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800">
                        ${card.image ? `
                            <img src="${card.image}" alt="${card.name}" 
                                 class="w-full h-full object-contain p-2">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center">
                                <span class="text-8xl opacity-50">🎴</span>
                            </div>
                        `}
                        <!-- Badge de condición en la esquina -->
                        <div class="absolute top-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded-full text-xs font-bold">
                            ${CARD_CONDITIONS[card.condition]?.icon || '✨'} ${card.condition || 'NM'}
                        </div>
                    </div>
                    
                    <!-- Información de la carta -->
                    <div class="p-4 space-y-2">
                        <h4 class="font-bold text-base text-gray-900 dark:text-white text-center line-clamp-2">
                            ${card.name || 'Sin nombre'}
                        </h4>
                        
                        <!-- Detalles en formato compacto -->
                        <div class="flex flex-wrap gap-2 justify-center text-xs">
                            ${card.set ? `
                                <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
                                    ${card.set}
                                </span>
                            ` : ''}
                            ${card.number ? `
                                <span class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-full">
                                    #${card.number}
                                </span>
                            ` : ''}
                            <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">
                                🌐 ${card.language || 'Español'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Determinar el grid layout basado en el número de cartas ofrecidas
            const offeredGridClass = trade.offeredCards.length === 1 
                ? 'flex justify-center' 
                : trade.offeredCards.length === 2 
                    ? 'grid grid-cols-1 md:grid-cols-2 gap-4 justify-items-center'
                    : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 justify-items-center';
            
            // Generar HTML para las cartas buscadas con el mismo diseño mejorado
            const wantedCardsHTML = trade.wantedCards.map(card => `
                <div class="group relative bg-gradient-to-b from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                    <!-- Imagen de la carta -->
                    <div class="relative aspect-[3/4] bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800">
                        ${card.image ? `
                            <img src="${card.image}" alt="${card.name}" 
                                 class="w-full h-full object-contain p-2">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center">
                                <span class="text-8xl opacity-50">🎴</span>
                            </div>
                        `}
                        <!-- Badge de condición en la esquina -->
                        <div class="absolute top-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded-full text-xs font-bold">
                            ${CARD_CONDITIONS[card.condition]?.icon || '✨'} ${card.condition || 'NM'}
                        </div>
                    </div>
                    
                    <!-- Información de la carta -->
                    <div class="p-4 space-y-2">
                        <h4 class="font-bold text-base text-gray-900 dark:text-white text-center line-clamp-2">
                            ${card.name || 'Sin nombre'}
                        </h4>
                        
                        <!-- Detalles en formato compacto -->
                        <div class="flex flex-wrap gap-2 justify-center text-xs">
                            ${card.set ? `
                                <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
                                    ${card.set}
                                </span>
                            ` : ''}
                            ${card.number ? `
                                <span class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-full">
                                    #${card.number}
                                </span>
                            ` : ''}
                            <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">
                                🌐 ${card.language || 'Español'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Determinar el grid layout basado en el número de cartas buscadas
            const wantedGridClass = trade.wantedCards.length === 1 
                ? 'flex justify-center' 
                : trade.wantedCards.length === 2 
                    ? 'grid grid-cols-1 md:grid-cols-2 gap-4 justify-items-center'
                    : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 justify-items-center';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-900 rounded-2xl max-w-7xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                    <!-- Header con gradiente -->
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 dark:from-orange-700 dark:to-orange-800 p-6">
                        <div class="flex justify-between items-start">
                            <div class="text-white">
                                <h2 class="text-3xl font-bold mb-2">
                                    ${trade.title || 'Intercambio sin título'}
                                </h2>
                                <div class="flex items-center gap-4 text-sm opacity-90">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                        </svg>
                                        ${trade.userName || trade.user || 'Usuario'}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                        </svg>
                                        ${trade.createdAt ? new Date(trade.createdAt).toLocaleDateString('es-ES') : 'Fecha desconocida'}
                                    </span>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-white hover:text-gray-200 transition-colors">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content con scroll -->
                    <div class="overflow-y-auto max-h-[calc(90vh-120px)] bg-gray-50 dark:bg-gray-800">
                        <div class="p-8">
                            <!-- Trade Flow mejorado -->
                            <div class="flex flex-col lg:flex-row items-start justify-center gap-8">
                                <!-- Offered Cards -->
                                <div class="flex-1 w-full">
                                    <div class="bg-white dark:bg-gray-900 rounded-xl p-6 shadow-sm">
                                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                            <span class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 p-2 rounded-lg">
                                                📤
                                            </span>
                                            Ofrece
                                        </h3>
                                        <div class="${offeredGridClass} gap-4">
                                            ${offeredCardsHTML || '<p class="text-gray-500 text-center italic py-8">No hay cartas ofrecidas</p>'}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Separador visual -->
                                <div class="flex items-center justify-center lg:pt-20">
                                    <div class="bg-gradient-to-r from-orange-400 to-orange-600 text-white p-4 rounded-full shadow-lg">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                        </svg>
                                    </div>
                                </div>
                                
                                <!-- Wanted Cards -->
                                <div class="flex-1 w-full">
                                    <div class="bg-white dark:bg-gray-900 rounded-xl p-6 shadow-sm">
                                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                            <span class="bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 p-2 rounded-lg">
                                                📥
                                            </span>
                                            Busca
                                        </h3>
                                        <div class="${wantedGridClass} gap-4">
                                            ${wantedCardsHTML || '<p class="text-gray-500 text-center italic py-8">No hay cartas buscadas</p>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        ${trade.description ? `
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-2">📝 Descripción</h3>
                                <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${trade.description}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-3 justify-center">
                            ${currentUser && trade.userId !== currentUser.uid ? `
                                <button onclick="proposeTrade('${tradeId}')" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition-colors">
                                    <span>💬</span> Proponer Intercambio
                                </button>
                                <button onclick="contactUser('${trade.userId}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition-colors">
                                    <span>📧</span> Contactar
                                </button>
                            ` : ''}
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar con ESC o click fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }
        
        // Función para contactar con un usuario
        function contactUser(userId) {
            console.log('📧 Contactando con usuario:', userId);
            showNotification('Función de contacto en desarrollo', 'info');
        }

        // Función para mostrar modal de crear intercambio
        window.showCreateTradeModal = (existingTrade = null) => {
            console.log('🚀 === ABRIENDO MODAL ===');
            console.log('📥 Parámetro existingTrade recibido:', existingTrade);
            
            if (!currentUser) {
                showNotification('Debes iniciar sesión para crear intercambios', 'warning', 4000);
                showAuthModal('login');
                return;
            }

            const isEditing = !!existingTrade;
            console.log('🔧 isEditing calculado:', isEditing);
            console.log(isEditing ? '✏️ Modo edición activado' : '🆕 Modo crear nuevo');
            
            if (isEditing) {
                console.log('📋 Datos para edición:');
                console.log('- existingTrade completo:', existingTrade);
                console.log('- offeredCards:', existingTrade?.offeredCards);
                console.log('- wantedCards:', existingTrade?.wantedCards);
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
                            <span class="icon mr-3">${isEditing ? '✏️' : '🤝'}</span> ${isEditing ? 'Editar Intercambio' : 'Crear Nuevo Intercambio'}
                        </h3>
                        <button id="closeCreateTradeModal" 
                                class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-3xl">
                            &times;
                        </button>
                    </div>

                    <form id="createTradeForm" class="space-y-6">
                        ${isEditing ? `<input type="hidden" id="editingTradeId" value="${existingTrade.id}">` : ''}
                        <!-- Vista previa del título generado -->
                        <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-orange-800 dark:text-orange-300 mb-2 flex items-center">
                                <span class="mr-2">✨</span> Vista Previa del Título
                            </h4>
                            <div id="generatedTitle" class="text-gray-700 dark:text-gray-300 font-medium italic">
                                El título se generará automáticamente cuando añadas cartas
                            </div>
                        </div>

                        <!-- Cartas que ofrezco -->
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-blue-800 dark:text-blue-300 mb-4 flex items-center">
                                <span class="mr-2">📤</span> Cartas que Ofrezco
                            </h4>
                            <div id="offeredCardsContainer" class="space-y-3 mb-4">
                                <!-- Las cartas ofrecidas se añadirán aquí -->
                            </div>
                            <div class="flex gap-2">
                                <button type="button" id="addOfferedCardBtn"
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center">
                                    <span class="mr-2">+</span> Añadir Carta
                                </button>
                                <button type="button" onclick="addFromMyCards('offered')"
                                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center">
                                    <span class="mr-2">📚</span> Desde Mis Cartas
                                </button>
                            </div>
                        </div>

                        <!-- Cartas que busco -->
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-green-800 dark:text-green-300 mb-4 flex items-center">
                                <span class="mr-2">📥</span> Cartas que Busco
                            </h4>
                            <div id="wantedCardsContainer" class="space-y-3 mb-4">
                                <!-- Las cartas buscadas se añadirán aquí -->
                            </div>
                            <div class="flex gap-2">
                                <button type="button" id="addWantedCardBtn"
                                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center">
                                    <span class="mr-2">+</span> Añadir Carta
                                </button>
                            </div>
                        </div>

                        <!-- Otros detalles -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                                <span class="mr-2">📝</span> Otros Detalles
                            </h4>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Información adicional (opcional)
                                </label>
                                <textarea id="tradeDescription" rows="3"
                                          placeholder="Describe condiciones específicas, preferencias, ubicación para intercambio presencial, etc..."
                                          class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 bg-white dark:bg-gray-600 text-gray-900 dark:text-white resize-none"></textarea>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-600">
                            <button type="button" id="cancelCreateTrade"
                                    class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold">
                                Cancelar
                            </button>
                            <button type="submit" id="submitCreateTrade"
                                    class="px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-semibold flex items-center">
                                <span class="mr-2">${isEditing ? '✅' : '🚀'}</span> ${isEditing ? 'Confirmar Intercambio' : 'Crear Intercambio'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            setupCreateTradeModalEvents(modal, isEditing, existingTrade);
        };

        // Configurar eventos del modal de crear intercambio
        function setupCreateTradeModalEvents(modal, isEditing = false, existingTrade = null) {
            console.log('🔧 === CONFIGURANDO EVENTOS DEL MODAL ===');
            console.log('🔧 isEditing recibido:', isEditing);
            console.log('🔧 existingTrade recibido:', existingTrade);
            const closeBtn = modal.querySelector('#closeCreateTradeModal');
            const cancelBtn = modal.querySelector('#cancelCreateTrade');
            const form = modal.querySelector('#createTradeForm');
            const addOfferedBtn = modal.querySelector('#addOfferedCardBtn');
            const addWantedBtn = modal.querySelector('#addWantedCardBtn');

            // Cerrar modal
            const closeModal = () => modal.remove();
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // Cerrar con ESC o click fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', escHandler);
                }
            });

            // Añadir cartas
            addOfferedBtn.addEventListener('click', () => addCardToTrade('offered'));
            addWantedBtn.addEventListener('click', () => addCardToTrade('wanted'));

            // Enviar formulario
            form.addEventListener('submit', handleCreateTradeSubmit);

            // Añadir cartas iniciales o pre-cargar datos existentes
            console.log('🔍 === INICIANDO SETUP DE CARTAS ===');
            console.log('🔧 isEditing:', isEditing);
            console.log('📦 existingTrade:', existingTrade);
            
            if (isEditing && existingTrade) {
                console.log('📋 ✅ ENTRANDO EN MODO EDICIÓN');
                console.log('📋 Modo edición: pre-cargando cartas existentes...', existingTrade);
                console.log('📋 offeredCards para pre-cargar:', existingTrade.offeredCards);
                console.log('📋 wantedCards para pre-cargar:', existingTrade.wantedCards);
                
                // Pre-cargar descripción inmediatamente
                setTimeout(() => {
                    const descriptionTextarea = document.getElementById('tradeDescription');
                    if (descriptionTextarea && existingTrade.description) {
                        descriptionTextarea.value = existingTrade.description;
                        console.log('✅ Descripción pre-cargada:', existingTrade.description);
                    }
                }, 50);
                
                // Pre-cargar cartas ofrecidas
                console.log(`📦 Cargando ${existingTrade.offeredCards.length} cartas ofrecidas`);
                existingTrade.offeredCards.forEach((card, index) => {
                    console.log(`📝 Añadiendo carta ofrecida ${index}:`, card);
                    // Forzar la creación de nueva fila para cada carta guardada
                    addCardToTrade('offered', true);
                    // Pre-cargar datos con delay para asegurar que el DOM esté listo
                    setTimeout(() => {
                        preloadCardData('offered', index, card);
                    }, 100 + (index * 50));
                });
                
                // Pre-cargar cartas buscadas  
                console.log(`📦 Cargando ${existingTrade.wantedCards.length} cartas buscadas`);
                existingTrade.wantedCards.forEach((card, index) => {
                    console.log(`📝 Añadiendo carta buscada ${index}:`, card);
                    // Forzar la creación de nueva fila para cada carta guardada
                    addCardToTrade('wanted', true);
                    // Pre-cargar datos con delay para asegurar que el DOM esté listo
                    setTimeout(() => {
                        preloadCardData('wanted', index, card);
                    }, 100 + (index * 50));
                });
                
                // Actualizar título y añadir filas vacías después de pre-cargar todo
                setTimeout(() => {
                    updateGeneratedTitle();
                    
                    // En modo edición, solo añadir fila vacía si no hay ninguna
                    // IMPORTANTE: Usar forceAdd=true para evitar bloquear las cartas existentes
                    const offeredContainer = document.getElementById('offeredCardsContainer');
                    const wantedContainer = document.getElementById('wantedCardsContainer');
                    
                    // Verificar si necesitamos añadir fila vacía para ofertas
                    const offeredCards = offeredContainer.querySelectorAll('.trade-card');
                    let hasEmptyOffered = false;
                    offeredCards.forEach(card => {
                        const input = card.querySelector('input[name*="_name_"]');
                        if (input && !input.value.trim()) {
                            hasEmptyOffered = true;
                        }
                    });
                    if (!hasEmptyOffered) {
                        addCardToTrade('offered', true); // Forzar para no bloquear
                    }
                    
                    // Verificar si necesitamos añadir fila vacía para búsquedas
                    const wantedCards = wantedContainer.querySelectorAll('.trade-card');
                    let hasEmptyWanted = false;
                    wantedCards.forEach(card => {
                        const input = card.querySelector('input[name*="_name_"]');
                        if (input && !input.value.trim()) {
                            hasEmptyWanted = true;
                        }
                    });
                    if (!hasEmptyWanted) {
                        addCardToTrade('wanted', true); // Forzar para no bloquear
                    }
                    
                    console.log('✅ Pre-carga completada en modo edición - campos EDITABLES');
                }, 600);
            } else {
                // Modo crear nuevo: añadir cartas vacías
                console.log('🆕 Modo crear nuevo: añadiendo cartas vacías');
                addCardToTrade('offered');
                addCardToTrade('wanted');
            }
        }

        // Función para pre-cargar datos en una carta existente
        function preloadCardData(type, cardIndex, cardData) {
            console.log(`📝 Pre-cargando datos para ${type} carta ${cardIndex}:`, cardData);
            
            const container = document.getElementById(type === 'offered' ? 'offeredCardsContainer' : 'wantedCardsContainer');
            const cardElement = container.children[cardIndex];
            
            if (!cardElement) {
                console.error('❌ No se encontró el elemento de carta para pre-cargar');
                return;
            }
            
            // Determinar si la carta viene de "Mis Cartas"
            const isFromMyCards = cardData.fromMyCards === true;
            console.log(`📌 Carta ${isFromMyCards ? 'DE MI COLECCIÓN (bloqueada)' : 'DEL BUSCADOR (editable)'}`);
            
            // Pre-cargar el campo oculto fromMyCards
            const fromMyCardsInput = cardElement.querySelector(`input[name*="${type}_fromMyCards_"]`);
            if (fromMyCardsInput) {
                fromMyCardsInput.value = isFromMyCards ? 'true' : 'false';
            }
            
            // Pre-cargar nombre
            const nameInput = cardElement.querySelector(`input[name*="${type}_name_"]`);
            if (nameInput && cardData.name) {
                nameInput.value = cardData.name;
                
                if (isFromMyCards) {
                    // Si es de "Mis Cartas", BLOQUEAR
                    nameInput.readOnly = true;
                    nameInput.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                    nameInput.classList.remove('bg-white');
                } else {
                    // Si es del buscador, mantener EDITABLE
                    nameInput.readOnly = false;
                    nameInput.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                    nameInput.classList.add('bg-white', 'dark:bg-gray-700');
                }
            }
            
            // Pre-cargar campos ocultos (IMPORTANTE para que funcione la miniatura)
            const idInput = cardElement.querySelector(`input[name*="${type}_id_"]`);
            if (idInput && cardData.id) {
                idInput.value = cardData.id;
            }
            
            const imageInput = cardElement.querySelector(`input[name*="${type}_image_"]`);
            if (imageInput && cardData.image) {
                imageInput.value = cardData.image;
            }
            
            const setInput = cardElement.querySelector(`input[name*="${type}_set_"]`);
            if (setInput && cardData.set) {
                setInput.value = cardData.set;
            }
            
            const numberInput = cardElement.querySelector(`input[name*="${type}_number_"]`);
            if (numberInput && cardData.number) {
                numberInput.value = cardData.number;
            }
            
            // Pre-cargar condición
            const conditionSelect = cardElement.querySelector(`select[name*="${type}_condition_"]`);
            if (conditionSelect && cardData.condition) {
                conditionSelect.value = cardData.condition;
                
                if (isFromMyCards) {
                    // Si es de "Mis Cartas", BLOQUEAR
                    conditionSelect.disabled = true;
                    conditionSelect.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                    conditionSelect.classList.remove('bg-white');
                } else {
                    // Si es del buscador, mantener EDITABLE
                    conditionSelect.disabled = false;
                    conditionSelect.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                    conditionSelect.classList.add('bg-white', 'dark:bg-gray-700');
                }
            }
            
            // Pre-cargar idioma
            const languageSelect = cardElement.querySelector(`select[name*="${type}_language_"]`);
            if (languageSelect && cardData.language) {
                languageSelect.value = cardData.language;
                
                if (isFromMyCards) {
                    // Si es de "Mis Cartas", BLOQUEAR
                    languageSelect.disabled = true;
                    languageSelect.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                    languageSelect.classList.remove('bg-white');
                } else {
                    // Si es del buscador, mantener EDITABLE
                    languageSelect.disabled = false;
                    languageSelect.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');
                    languageSelect.classList.add('bg-white', 'dark:bg-gray-700');
                }
            }
            
            // Mostrar miniatura si hay imagen
            if (cardData.image && cardData.name) {
                console.log(`🖼️ Mostrando miniatura para carta pre-cargada: ${cardData.name}`);
                showCardThumbnail(cardElement, cardData.image, cardData.name);
            }
            
            // NO bloquear en modo edición - el usuario debe poder modificar
            console.log(`✅ Carta ${type} ${cardIndex} pre-cargada con miniatura y EDITABLE (modo edición)`);
        }

        // Función para añadir carta al intercambio
        function addCardToTrade(type, forceAdd = false) {
            console.log(`📝 addCardToTrade llamado para tipo: ${type}, forceAdd: ${forceAdd}`);
            const container = document.getElementById(type === 'offered' ? 'offeredCardsContainer' : 'wantedCardsContainer');
            
            if (!container) {
                console.error('❌ No se encontró el contenedor');
                return;
            }
            
            // Si NO es forzado, verificar si necesitamos nueva fila
            if (!forceAdd) {
                // Bloquear todas las filas con contenido no bloqueadas
                const allCards = container.querySelectorAll('.trade-card');
                let needNewRow = true;
                
                allCards.forEach((card, index) => {
                    const nameInput = card.querySelector('input[name*="_name_"]');
                    
                    if (nameInput && !nameInput.readOnly) {
                        if (nameInput.value.trim()) {
                            // Si tiene contenido y no está bloqueada, bloquearla
                            console.log(`🔒 Bloqueando carta ${index}: ${nameInput.value}`);
                            lockExistingCard(card);
                            
                            // Mostrar miniatura si hay imagen
                            const imageInput = card.querySelector('input[name*="_image_"]');
                            if (imageInput && imageInput.value) {
                                showCardThumbnail(card, imageInput.value, nameInput.value);
                            }
                        } else {
                            // Hay una fila vacía no bloqueada
                            needNewRow = false;
                            console.log(`ℹ️ Fila ${index} está vacía, no se necesita nueva fila`);
                        }
                    }
                });
                
                // Solo añadir nueva fila si todas tienen contenido o están bloqueadas
                if (!needNewRow) {
                    console.log('✓ Ya hay una fila vacía disponible');
                    return;
                }
            }
            
            console.log('➕ Creando nueva fila vacía');
            
            const cardIndex = container.children.length;
            const cardId = `${type}_card_${cardIndex}`;

            const cardElement = document.createElement('div');
            cardElement.className = 'trade-card bg-white dark:bg-gray-600 rounded-lg p-4 border border-gray-200 dark:border-gray-500';
            cardElement.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                    <div class="relative">
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Nombre de la carta *
                        </label>
                        <div class="relative">
                            <input type="text" name="${type}_name_${cardIndex}"
                                   placeholder="Buscar carta..."
                                   value=""
                                   class="card-name-input w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-400"
                                   oninput="searchCardForTrade(this, '${type}', ${cardIndex})"
                                   onkeypress="handleCardInputKeypress(event, '${type}', ${cardIndex})"
                                   onblur="handleCardInputBlur(this, '${type}', ${cardIndex})"
                                   title="Buscar carta en la base de datos">
                            <input type="hidden" name="${type}_id_${cardIndex}" value="">
                            <input type="hidden" name="${type}_image_${cardIndex}" value="">
                            <input type="hidden" name="${type}_set_${cardIndex}" value="">
                            <input type="hidden" name="${type}_number_${cardIndex}" value="">
                            <input type="hidden" name="${type}_fromMyCards_${cardIndex}" value="false">
                        </div>
                        <div class="card-search-results absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Condición *
                        </label>
                        <select name="${type}_condition_${cardIndex}"
                                class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-400"
                                title="Selecciona la condición de la carta">
                            ${Object.values(CARD_CONDITIONS).map(condition => 
                                `<option value="${condition.code}">${condition.icon} ${condition.code}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Idioma
                        </label>
                        <select name="${type}_language_${cardIndex}"
                                class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-400"
                                title="Selecciona el idioma de la carta">
                            <option value="Español">🇪🇸 Español</option>
                            <option value="Inglés">🇺🇸 Inglés</option>
                            <option value="Francés">🇫🇷 Francés</option>
                            <option value="Italiano">🇮🇹 Italiano</option>
                            <option value="Alemán">🇩🇪 Alemán</option>
                            <option value="Portugués">🇵🇹 Portugués</option>
                            <option value="Japonés">🇯🇵 Japonés</option>
                            <option value="Chino">🇨🇳 Chino</option>
                            <option value="Coreano">🇰🇷 Coreano</option>
                            <option value="Tailandés">🇹🇭 Tailandés</option>
                            <option value="Ruso">🇷🇺 Ruso</option>
                            <option value="Holandés">🇳🇱 Holandés</option>
                            <option value="Sueco">🇸🇪 Sueco</option>
                            <option value="Noruego">🇳🇴 Noruego</option>
                            <option value="Danés">🇩🇰 Danés</option>
                            <option value="Finlandés">🇫🇮 Finlandés</option>
                            <option value="Polaco">🇵🇱 Polaco</option>
                            <option value="Checo">🇨🇿 Checo</option>
                            <option value="Húngaro">🇭🇺 Húngaro</option>
                            <option value="Griego">🇬🇷 Griego</option>
                            <option value="Turco">🇹🇷 Turco</option>
                            <option value="Árabe">🇸🇦 Árabe</option>
                            <option value="Hebreo">🇮🇱 Hebreo</option>
                            <option value="Hindi">🇮🇳 Hindi</option>
                            <option value="Vietnamita">🇻🇳 Vietnamita</option>
                            <option value="Malayo">🇲🇾 Malayo</option>
                            <option value="Indonesio">🇮🇩 Indonesio</option>
                            <option value="Filipino">🇵🇭 Filipino</option>
                            <option value="Cualquiera">🌍 Cualquiera</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1 opacity-0">
                            Eliminar
                        </label>
                        <button type="button" onclick="removeCardFromTrade(this)"
                                class="w-full h-[38px] bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm font-semibold transition-colors flex items-center justify-center"
                                title="Eliminar carta">
                            🗑️
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(cardElement);
            updateGeneratedTitle();
            
            console.log(`✅ Nueva carta ${type} añadida y lista para editar`);
        }

        // Función para bloquear una carta completa (todos sus campos)
        function lockExistingCard(cardElement) {
            console.log('🔒 Bloqueando carta completa');
            
            // Bloquear input de nombre
            const nameInput = cardElement.querySelector('input[name*="_name_"]');
            if (nameInput && !nameInput.readOnly) {
                nameInput.readOnly = true;
                nameInput.className = nameInput.className.replace('bg-white dark:bg-gray-700', 'bg-gray-100 dark:bg-gray-600');
                nameInput.className = nameInput.className.replace('text-gray-900 dark:text-white', 'text-gray-700 dark:text-gray-300');
                nameInput.className = nameInput.className.replace(' focus:outline-none focus:ring-2 focus:ring-orange-400', '');
                nameInput.className += ' cursor-not-allowed';
                nameInput.title = "Carta bloqueada - solo se puede eliminar";
            }
            
            // Bloquear select de condición
            const conditionSelect = cardElement.querySelector('select[name*="_condition_"]');
            if (conditionSelect && !conditionSelect.disabled) {
                conditionSelect.disabled = true;
                conditionSelect.className = conditionSelect.className.replace('bg-white dark:bg-gray-700', 'bg-gray-100 dark:bg-gray-600');
                conditionSelect.className = conditionSelect.className.replace('text-gray-900 dark:text-white', 'text-gray-700 dark:text-gray-300');
                conditionSelect.className = conditionSelect.className.replace(' focus:outline-none focus:ring-2 focus:ring-orange-400', '');
                conditionSelect.className += ' cursor-not-allowed';
                conditionSelect.title = "Carta bloqueada - solo se puede eliminar";
            }
            
            // Bloquear select de idioma
            const languageSelect = cardElement.querySelector('select[name*="_language_"]');
            if (languageSelect && !languageSelect.disabled) {
                languageSelect.disabled = true;
                languageSelect.className = languageSelect.className.replace('bg-white dark:bg-gray-700', 'bg-gray-100 dark:bg-gray-600');
                languageSelect.className = languageSelect.className.replace('text-gray-900 dark:text-white', 'text-gray-700 dark:text-gray-300');
                languageSelect.className = languageSelect.className.replace(' focus:outline-none focus:ring-2 focus:ring-orange-400', '');
                languageSelect.className += ' cursor-not-allowed';
                languageSelect.title = "Carta bloqueada - solo se puede eliminar";
            }
        }

        // Función para eliminar carta y actualizar título
        window.removeCardFromTrade = function(button) {
            console.log('🗑️ Intentando eliminar carta...');
            
            // Buscar el elemento de la carta usando la clase específica
            const cardElement = button.closest('.trade-card');
            
            if (!cardElement) {
                console.error('❌ No se pudo encontrar el elemento de la carta');
                return;
            }
            
            const container = cardElement.parentElement;
            console.log('📦 Container encontrado, tiene', container.children.length, 'cartas');
            
            // Verificar que no sea la única carta del tipo
            if (container.children.length <= 1) {
                showNotification('Debes mantener al menos una carta de cada tipo', 'warning', 4000);
                return;
            }
            
            // Eliminar la carta
            console.log('✅ Eliminando carta...');
            cardElement.remove();
            
            // Actualizar el título
            console.log('🔄 Actualizando título...');
            updateGeneratedTitle();
            
            console.log('✨ Carta eliminada exitosamente');
        };

        // Función para generar título automáticamente
        function updateGeneratedTitle() {
            const titleElement = document.getElementById('generatedTitle');
            if (!titleElement) return;

            const offeredCards = [];
            const wantedCards = [];

            // Recoger cartas ofrecidas
            const offeredContainer = document.getElementById('offeredCardsContainer');
            if (offeredContainer) {
                offeredContainer.querySelectorAll('.card-name-input').forEach(input => {
                    if (input.value.trim()) {
                        offeredCards.push(input.value.trim());
                    }
                });
            }

            // Recoger cartas buscadas
            const wantedContainer = document.getElementById('wantedCardsContainer');
            if (wantedContainer) {
                wantedContainer.querySelectorAll('.card-name-input').forEach(input => {
                    if (input.value.trim()) {
                        wantedCards.push(input.value.trim());
                    }
                });
            }

            // Generar título
            let generatedTitle = '';
            
            if (offeredCards.length > 0 && wantedCards.length > 0) {
                const offeredText = offeredCards.length === 1 
                    ? offeredCards[0] 
                    : `${offeredCards[0]} (+${offeredCards.length - 1} más)`;
                
                const wantedText = wantedCards.length === 1 
                    ? wantedCards[0] 
                    : `${wantedCards[0]} (+${wantedCards.length - 1} más)`;
                
                generatedTitle = `Intercambio ${offeredText} por ${wantedText}`;
            } else if (offeredCards.length > 0) {
                const offeredText = offeredCards.length === 1 
                    ? offeredCards[0] 
                    : `${offeredCards[0]} (+${offeredCards.length - 1} más)`;
                generatedTitle = `Intercambio ${offeredText} por [Cartas buscadas]`;
            } else if (wantedCards.length > 0) {
                const wantedText = wantedCards.length === 1 
                    ? wantedCards[0] 
                    : `${wantedCards[0]} (+${wantedCards.length - 1} más)`;
                generatedTitle = `Intercambio [Cartas ofrecidas] por ${wantedText}`;
            } else {
                generatedTitle = 'El título se generará automáticamente cuando añadas cartas';
            }

            titleElement.textContent = generatedTitle;
            titleElement.className = generatedTitle.includes('[') 
                ? 'text-gray-500 dark:text-gray-400 font-medium italic'
                : 'text-gray-800 dark:text-gray-200 font-semibold';
        }

        // Manejar envío del formulario
        async function handleCreateTradeSubmit(e) {
            e.preventDefault();
            
            // Desactivar validación HTML nativa para hacer nuestra propia validación
            const form = e.target;
            const formData = new FormData(form);
            
            // Detectar si estamos editando
            const editingTradeIdElement = document.getElementById('editingTradeId');
            const isEditing = !!editingTradeIdElement;
            const editingTradeId = isEditing ? editingTradeIdElement.value : null;
            
            console.log(isEditing ? `✏️ Editando intercambio: ${editingTradeId}` : '🆕 Creando nuevo intercambio');
            
            // Recoger datos básicos
            const generatedTitleElement = document.getElementById('generatedTitle');
            const generatedTitle = generatedTitleElement ? generatedTitleElement.textContent : '';
            
            const tradeData = {
                title: generatedTitle,
                description: document.getElementById('tradeDescription').value || '',
                offeredCards: [],
                wantedCards: [],
                user: await getUserDisplayName(),
                userId: currentUser.uid, // ID del usuario propietario
                status: 'active',
                type: 'created',
                createdAt: new Date()
            };
            
            // Si estamos editando, mantener datos existentes
            if (isEditing) {
                tradeData.id = editingTradeId;
                const existingTrade = findTradeById(editingTradeId);
                if (existingTrade) {
                    tradeData.createdAt = existingTrade.createdAt; // Mantener fecha original
                    tradeData.updatedAt = new Date(); // Añadir fecha de actualización
                }
            } else {
                tradeData.createdAt = new Date();
            }

            // Recoger cartas ofrecidas
            const offeredContainer = document.getElementById('offeredCardsContainer');
            Array.from(offeredContainer.children).forEach((cardEl, index) => {
                const nameInput = cardEl.querySelector(`input[name*="offered_name_"]`);
                const idInput = cardEl.querySelector(`input[name*="offered_id_"]`);
                const imageInput = cardEl.querySelector(`input[name*="offered_image_"]`);
                const setInput = cardEl.querySelector(`input[name*="offered_set_"]`);
                const numberInput = cardEl.querySelector(`input[name*="offered_number_"]`);
                const conditionSelect = cardEl.querySelector(`select[name*="offered_condition_"]`);
                const languageSelect = cardEl.querySelector(`select[name*="offered_language_"]`);
                
                if (nameInput && nameInput.value.trim()) {
                    const fromMyCardsInput = cardEl.querySelector(`input[name*="offered_fromMyCards_"]`);
                    tradeData.offeredCards.push({
                        name: nameInput.value.trim(),
                        id: idInput ? idInput.value : '',
                        image: imageInput ? imageInput.value : '',
                        set: setInput ? setInput.value : '',
                        number: numberInput ? numberInput.value : '',
                        condition: conditionSelect ? conditionSelect.value : 'NM',
                        language: languageSelect ? languageSelect.value : 'Español',
                        fromMyCards: fromMyCardsInput ? fromMyCardsInput.value === 'true' : false
                    });
                }
            });

            // Recoger cartas buscadas
            const wantedContainer = document.getElementById('wantedCardsContainer');
            Array.from(wantedContainer.children).forEach((cardEl, index) => {
                const nameInput = cardEl.querySelector(`input[name*="wanted_name_"]`);
                const idInput = cardEl.querySelector(`input[name*="wanted_id_"]`);
                const imageInput = cardEl.querySelector(`input[name*="wanted_image_"]`);
                const setInput = cardEl.querySelector(`input[name*="wanted_set_"]`);
                const numberInput = cardEl.querySelector(`input[name*="wanted_number_"]`);
                const conditionSelect = cardEl.querySelector(`select[name*="wanted_condition_"]`);
                const languageSelect = cardEl.querySelector(`select[name*="wanted_language_"]`);
                
                if (nameInput && nameInput.value.trim()) {
                    const fromMyCardsInput = cardEl.querySelector(`input[name*="wanted_fromMyCards_"]`);
                    tradeData.wantedCards.push({
                        name: nameInput.value.trim(),
                        id: idInput ? idInput.value : '',
                        image: imageInput ? imageInput.value : '',
                        set: setInput ? setInput.value : '',
                        number: numberInput ? numberInput.value : '',
                        condition: conditionSelect ? conditionSelect.value : 'NM',
                        language: languageSelect ? languageSelect.value : 'Español',
                        fromMyCards: fromMyCardsInput ? fromMyCardsInput.value === 'true' : false
                    });
                }
            });

            // Validaciones mejoradas - solo cuentan cartas con nombre
            console.log('📋 Validando intercambio:', {
                totalOfferedCards: offeredContainer.children.length,
                validOfferedCards: tradeData.offeredCards.length,
                totalWantedCards: wantedContainer.children.length,
                validWantedCards: tradeData.wantedCards.length,
                title: tradeData.title
            });

            if (tradeData.offeredCards.length === 0) {
                showNotification('Debes completar al menos una carta que ofreces', 'warning', 5000);
                return;
            }

            if (tradeData.wantedCards.length === 0) {
                showNotification('Debes completar al menos una carta que buscas', 'warning', 5000);
                return;
            }

            if (!tradeData.title.trim() || tradeData.title.includes('[') || tradeData.title.includes('automáticamente')) {
                showNotification('El título no se ha generado correctamente. Completa las cartas primero.', 'warning', 5000);
                return;
            }

            try {
                const userTradesKey = `userTrades_${currentUser.uid}`;
                let savedTrades = JSON.parse(localStorage.getItem(userTradesKey) || '[]');
                
                if (isEditing) {
                    // Modo edición: actualizar intercambio existente
                    console.log('✏️ Actualizando intercambio existente:', tradeData);
                    
                    const tradeIndex = savedTrades.findIndex(t => t.id === editingTradeId);
                    if (tradeIndex !== -1) {
                        savedTrades[tradeIndex] = tradeData;
                        localStorage.setItem(userTradesKey, JSON.stringify(savedTrades));
                        
                        // Aquí se implementará la actualización en Firestore
                        // await updateTradeInFirestore(tradeData);
                        
                        showSuccessMessage('¡Intercambio actualizado exitosamente! ✏️');
                    } else {
                        throw new Error('No se encontró el intercambio para actualizar');
                    }
                } else {
                    // Modo creación: crear nuevo intercambio
                    tradeData.id = 'trade_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    console.log('💾 Creando nuevo intercambio:', tradeData);
                    
                    savedTrades.unshift(tradeData); // Añadir al principio
                    localStorage.setItem(userTradesKey, JSON.stringify(savedTrades));
                    
                    // Aquí se implementará el guardado en Firestore
                    // await saveTradeToFirestore(tradeData);
                    
                    showSuccessMessage('¡Intercambio creado exitosamente! 🎉');
                }
                document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50').remove(); // Cerrar modal
                
                // Recargar intercambios
                if (typeof loadUserTrades === 'function') {
                    loadUserTrades();
                }
                
            } catch (error) {
                console.error('❌ Error al crear intercambio:', error);
                showNotification('Error al crear el intercambio. Inténtalo de nuevo.', 'error', 5000);
            }
        }

        // Función para mostrar mensaje de éxito
        function showSuccessMessage(message) {
            const successModal = document.createElement('div');
            successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            successModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 text-center shadow-xl">
                    <div class="text-6xl mb-4">🎉</div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">${message}</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">Tu intercambio estará visible para otros coleccionistas.</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold">
                        ¡Perfecto!
                    </button>
                </div>
            `;
            
            document.body.appendChild(successModal);
            
            // Auto-cerrar después de 3 segundos
            setTimeout(() => {
                if (successModal.parentElement) {
                    successModal.remove();
                }
            }, 3000);
        }

        // Función para mostrar modal de confirmación personalizado
        function showConfirmDeleteModal(tradeTitle, onConfirm) {
            return new Promise((resolve) => {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                confirmModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 text-center shadow-xl">
                        <div class="text-6xl mb-4">🗑️</div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">¿Estás seguro de que quieres eliminar este intercambio?</h3>
                        <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 mb-6">
                            <p class="text-gray-800 dark:text-gray-200 font-semibold">"${tradeTitle}"</p>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300 mb-6">⚠️ Esta acción no se puede deshacer.</p>
                        <div class="flex gap-3 justify-center">
                            <button id="cancelDelete" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                Cancelar
                            </button>
                            <button id="confirmDelete" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                🗑️ Eliminar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(confirmModal);
                
                // Eventos
                const cancelBtn = confirmModal.querySelector('#cancelDelete');
                const confirmBtn = confirmModal.querySelector('#confirmDelete');
                
                cancelBtn.addEventListener('click', () => {
                    confirmModal.remove();
                    resolve(false);
                });
                
                confirmBtn.addEventListener('click', () => {
                    confirmModal.remove();
                    resolve(true);
                });
                
                // ESC para cancelar
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        confirmModal.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // Click fuera del modal para cancelar
                confirmModal.addEventListener('click', (e) => {
                    if (e.target === confirmModal) {
                        confirmModal.remove();
                        resolve(false);
                    }
                });
            });
        }

        // Función para generar selector de condición de carta
        function createConditionSelector(selectedCondition = 'NM', onChangeCallback = null) {
            const select = document.createElement('select');
            select.className = 'condition-selector text-xs px-2 py-1 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400';
            
            Object.values(CARD_CONDITIONS).forEach(condition => {
                const option = document.createElement('option');
                option.value = condition.code;
                option.textContent = `${condition.icon} ${condition.name}`;
                option.style.backgroundColor = condition.color;
                option.style.color = 'white';
                
                if (condition.code === selectedCondition) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });

            if (onChangeCallback) {
                select.addEventListener('change', (e) => {
                    onChangeCallback(e.target.value);
                });
            }

            return select;
        }

        // Función para mostrar información de condición al hacer hover
        function showConditionInfo(conditionCode) {
            const condition = CARD_CONDITIONS[conditionCode];
            if (!condition) return;

            const tooltip = document.createElement('div');
            tooltip.className = 'condition-tooltip absolute z-50 bg-gray-900 text-white text-xs rounded-lg p-2 max-w-xs shadow-lg';
            tooltip.innerHTML = `
                <div class="font-semibold mb-1">${condition.icon} ${condition.name}</div>
                <div class="text-gray-300">${condition.description}</div>
            `;

            return tooltip;
        }

        // Función para obtener el color de una condición
        function getConditionColor(conditionCode) {
            return CARD_CONDITIONS[conditionCode]?.color || '#6B7280';
        }

        // Función para obtener el icono de una condición
        function getConditionIcon(conditionCode) {
            return CARD_CONDITIONS[conditionCode]?.icon || '❓';
        }

        // Función para inicializar FAQ
        function initializeFAQ() {
            const faqQuestions = document.querySelectorAll('.faq-question');
            
            faqQuestions.forEach(question => {
                question.addEventListener('click', () => {
                    const answer = question.nextElementSibling;
                    const icon = question.querySelector('span:last-child');
                    
                    // Toggle respuesta
                    if (answer.classList.contains('hidden')) {
                        answer.classList.remove('hidden');
                        answer.classList.add('show');
                        icon.textContent = '−';
                    } else {
                        answer.classList.add('hidden');
                        answer.classList.remove('show');
                        icon.textContent = '+';
                    }
                });
            });
        }

        // Función para actualizar estadísticas en la UI
        function updateProfileStats(totalCards, uniqueCards, uniqueSets, completedTrades, cards = []) {
            const totalCardsElement = document.getElementById('totalCardsCount');
            const uniqueCardsElement = document.getElementById('uniqueCardsCount');
            const uniqueSetsElement = document.getElementById('uniqueSetsCount');
            const completedTradesElement = document.getElementById('completedTradesCount');
            const totalValueElement = document.getElementById('totalCollectionValue');

            if (totalCardsElement) {
                totalCardsElement.textContent = totalCards;
            }
            if (uniqueCardsElement) uniqueCardsElement.textContent = uniqueCards;
            if (uniqueSetsElement) uniqueSetsElement.textContent = uniqueSets;
            if (completedTradesElement) completedTradesElement.textContent = completedTrades;

            // Calcular valor total de la colección
            if (totalValueElement && cards.length > 0) {
                const totalValue = calculateCollectionValue(cards);
                totalValueElement.textContent = formatCurrency(totalValue);
            } else if (totalValueElement) {
                totalValueElement.textContent = '€0.00';
            }
        }

        // Función para calcular el valor total de la colección
        function calculateCollectionValue(cards) {
            let totalValue = 0;
            
            cards.forEach(card => {
                // Obtener el precio base de la carta según su rareza
                const basePrice = getCardBasePrice(card.rarity || 'Common');
                
                // Aplicar multiplicadores según la condición
                const conditionMultiplier = getConditionMultiplier(card.condition || 'NM');
                
                // Aplicar multiplicador según el idioma (cartas en inglés suelen valer más)
                const languageMultiplier = getLanguageMultiplier(card.language || 'Español');
                
                // Calcular precio final de la carta
                const cardValue = basePrice * conditionMultiplier * languageMultiplier;
                
                totalValue += cardValue;
            });
            
            return totalValue;
        }

        // Función para obtener el precio base según la rareza
        function getCardBasePrice(rarity) {
            const basePrices = {
                'Common': 0.10,
                'Uncommon': 0.25,
                'Rare': 1.00,
                'Rare Holo': 3.00,
                'Rare Ultra': 5.00,
                'Rare Secret': 10.00,
                'Rare Rainbow': 15.00,
                'Rare Gold': 20.00,
                'Rare Shiny': 8.00,
                'Rare Shiny GX': 25.00,
                'Rare Shiny V': 30.00,
                'Rare Shiny VMAX': 50.00,
                'Rare Shiny GX Rainbow': 100.00,
                'Rare Shiny V Rainbow': 120.00,
                'Rare Shiny VMAX Rainbow': 200.00,
                'Rare Shiny Gold': 150.00,
                'Rare Shiny Gold GX': 300.00,
                'Rare Shiny Gold V': 400.00,
                'Rare Shiny Gold VMAX': 600.00,
                'Rare Shiny Gold Rainbow': 800.00,
                'Rare Shiny Gold Rainbow GX': 1000.00,
                'Rare Shiny Gold Rainbow V': 1200.00,
                'Rare Shiny Gold Rainbow VMAX': 1500.00,
                'Rare Shiny Gold Rainbow GX Rainbow': 2000.00,
                'Rare Shiny Gold Rainbow V Rainbow': 2500.00,
                'Rare Shiny Gold Rainbow VMAX Rainbow': 3000.00,
                'Rare Shiny Gold Rainbow GX Rainbow Gold': 5000.00,
                'Rare Shiny Gold Rainbow V Rainbow Gold': 7500.00,
                'Rare Shiny Gold Rainbow VMAX Rainbow Gold': 10000.00
            };
            
            return basePrices[rarity] || 0.50; // Precio por defecto
        }

        // Función para obtener el multiplicador según la condición
        function getConditionMultiplier(condition) {
            const conditionMultipliers = {
                'M': 1.5,    // Mint - 50% más
                'NM': 1.0,   // Near Mint - precio base
                'EX': 0.8,   // Excellent - 20% menos
                'GD': 0.6,   // Good - 40% menos
                'LP': 0.4,   // Light Played - 60% menos
                'PL': 0.2,   // Played - 80% menos
                'PO': 0.1    // Poor - 90% menos
            };
            
            return conditionMultipliers[condition] || 1.0;
        }

        // Función para obtener el multiplicador según el idioma
        function getLanguageMultiplier(language) {
            const languageMultipliers = {
                'English': 1.2,    // Inglés - 20% más
                'Español': 1.0,    // Español - precio base
                'Français': 0.9,   // Francés - 10% menos
                'Deutsch': 0.9,    // Alemán - 10% menos
                'Italiano': 0.9,   // Italiano - 10% menos
                'Português': 0.9,  // Portugués - 10% menos
                '日本語': 1.1,      // Japonés - 10% más
                '한국어': 1.0,      // Coreano - precio base
                '中文': 1.0,        // Chino - precio base
                'Русский': 0.8     // Ruso - 20% menos
            };
            
            return languageMultipliers[language] || 1.0;
        }

        // Función para formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Función para cargar desglose por sets
        async function loadSetsBreakdown(cards) {
            const setsBreakdownElement = document.getElementById('setsBreakdown');
            if (!setsBreakdownElement) return;

            try {
                // Agrupar cartas por set
                const setsMap = new Map();
                cards.forEach(card => {
                    const setName = (typeof card.set === 'string' ? card.set : card.set?.name) || 'Sin Set';
                    if (!setsMap.has(setName)) {
                        setsMap.set(setName, []);
                    }
                    setsMap.get(setName).push(card);
                });

                // Crear HTML para el desglose
                if (setsMap.size === 0) {
                    setsBreakdownElement.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                            <p>No hay cartas en tu colección</p>
                        </div>
                    `;
                    return;
                }

                let setsHTML = '';
                setsMap.forEach((cardsInSet, setName) => {
                    setsHTML += `
                        <div class="set-item bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-semibold text-gray-800 dark:text-gray-100">${setName}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-300">${cardsInSet.length} cartas</p>
                                </div>
                                <div class="text-right">
                                    <div class="w-16 h-2 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden">
                                        <div class="h-full bg-orange-500 rounded-full" style="width: ${Math.min(100, (cardsInSet.length / 10) * 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                setsBreakdownElement.innerHTML = setsHTML;

            } catch (error) {
                console.error('❌ Error al cargar desglose por sets:', error);
                setsBreakdownElement.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <p>Error al cargar el desglose por sets</p>
                    </div>
                `;
            }
        }

        // --- Funciones del Modal de Autenticación ---
        function showAuthModal(mode) {
            if (!authModal) {
                console.error('❌ authModal not found!');
                return;
            }

            console.log('🔧 Adding show class to authModal');
            authModal.classList.add('show');

            const forgotPasswordForm = document.getElementById('forgotPasswordForm');

            if (mode === 'login') {
                if (loginForm) loginForm.classList.remove('hidden');
                if (registerForm) registerForm.classList.add('hidden');
                if (forgotPasswordForm) forgotPasswordForm.classList.add('hidden');
            } else if (mode === 'register') {
                if (loginForm) loginForm.classList.add('hidden');
                if (registerForm) registerForm.classList.remove('hidden');
                if (forgotPasswordForm) forgotPasswordForm.classList.add('hidden');
            } else if (mode === 'forgot') {
                if (loginForm) loginForm.classList.add('hidden');
                if (registerForm) registerForm.classList.add('hidden');
                if (forgotPasswordForm) forgotPasswordForm.classList.remove('hidden');
            }
        }

        // Hacer funciones disponibles globalmente
        window.showAuthModal = showAuthModal;

        function hideAuthModal() {
            if (authModal) authModal.classList.remove('show');
        }

        // --- Función de Búsqueda de Cartas (MEJORADA) ---
        async function fetchCards(query) {
            console.log('🔍 fetchCards called with query:', query);
            
            if (!cardsContainer) {
                console.error('❌ cardsContainer not found!');
                return;
            }

            // Limpiar resultados anteriores
            cardsContainer.innerHTML = '';
            if (noResultsMessage) noResultsMessage.classList.add('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');

            // Validar mínimo de caracteres
            if (query.length > 0 && query.length < 2) {
                if (noResultsMessage) {
                    noResultsMessage.textContent = 'Por favor, escribe al menos 2 caracteres para buscar.';
                    noResultsMessage.classList.remove('hidden');
                }
                if (cardsContainer) cardsContainer.innerHTML = '';
                hideLoadingSpinner();
                return;
            }
            
            // Si la query está vacía, usar búsqueda aleatoria
            const searchQuery = query.length === 0 ? 'pokemon' : query;

            showLoadingSpinner();
            showSearchResults();

            try {
                // Construir URL optimizada con paginación - usar sintaxis simple que funciona
                const base = searchQuery.toLowerCase();
                lastSearchBase = base;
                searchPage = 1;
                searchPageSize = 20;
                
                // Generar ID único para esta búsqueda (para cache)
                currentSearchId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                console.log('🆔 Nueva búsqueda con ID:', currentSearchId);
                const apiUrl = buildCardsApiUrl(base, searchPage, searchPageSize);

                console.log('🌐 Fetching from URL:', apiUrl);

                // Hacer petición con timeout mejorado
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('⏰ Timeout alcanzado, abortando petición...');
                    controller.abort();
                }, 60000); // Aumentado a 60s para dar más tiempo al API

                let response;
                try {
                    response = await fetch(apiUrl, {
                        signal: controller.signal,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        console.log('🔄 Petición cancelada por timeout');
                        throw new Error('TIMEOUT');
                    }
                    throw fetchError;
                }

                console.log('📡 Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ API Error Response:', errorText);
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                const cards = data.data || [];

                console.log('✅ API Response received:', {
                    totalCount: data.totalCount,
                    cardsReturned: cards.length,
                    localResults: data.localResults || 0,
                    apiResults: data.apiResults || 0,
                    combinedResults: data.combinedResults || 0
                });

                // Render paginación
                const totalCount = data.totalCount || 0;
                renderPagination(totalCount, searchPage, searchPageSize);

                if (cards.length > 0) {
                    // Usar la función de renderizado estándar para consistencia
                    renderCardsFromData(cards);
                    
                    console.log('✅ All cards rendered successfully');
                } else {
                    console.log('ℹ️ No cards found for query:', searchQuery);
                    if (noResultsMessage) {
                        // Crear mensaje más específico basado en los filtros aplicados
                        let message = `No se encontraron cartas para "${searchQuery}".`;
                        
                        const activeFilters = [];
                        if (searchFiltersState.series) activeFilters.push(`Serie: ${searchFiltersState.series}`);
                        if (searchFiltersState.set) activeFilters.push(`Set: ${searchFiltersState.set}`);
                        if (searchFiltersState.rarity) activeFilters.push(`Rareza: ${searchFiltersState.rarity}`);
                        if (searchFiltersState.type) activeFilters.push(`Tipo: ${searchFiltersState.type}`);
                        if (searchFiltersState.language) activeFilters.push(`Idioma: ${searchFiltersState.language}`);
                        
                        if (activeFilters.length > 0) {
                            message += `\n\nFiltros aplicados: ${activeFilters.join(', ')}`;
                            message += `\n\n💡 Sugerencias:`;
                            message += `\n• Verifica que el set "${searchFiltersState.set}" exista en la base de datos`;
                            message += `\n• Prueba con filtros menos específicos`;
                            message += `\n• Usa el botón "Limpiar" para quitar todos los filtros`;
                        } else {
                            message += ` Intenta con otro nombre.`;
                        }
                        
                        noResultsMessage.textContent = message;
                        noResultsMessage.classList.remove('hidden');
                    }
                }
                
                // Ocultar spinner de carga
                hideLoadingSpinner();

            } catch (error) {
                console.error('❌ Error completo en fetchCards:', error);

                // Si es timeout, intentar con búsqueda más simple y menos resultados
                if ((error.name === 'AbortError' || error.message.includes('408') || error.message === 'TIMEOUT') && !searchQuery.includes('_retry')) {
                    console.log('🔄 Timeout detectado, reintentando con búsqueda optimizada...');
                    
                    try {
                        // Usar búsqueda más simple para el retry
                        const retryUrl = buildCardsApiUrl(searchQuery.toLowerCase(), 1, 20);
                        console.log('🔄 Retry URL (búsqueda exacta):', retryUrl);
                        
                        const retryController = new AbortController();
                        const retryTimeoutId = setTimeout(() => {
                            console.log('⏰ Retry timeout alcanzado');
                            retryController.abort();
                        }, 30000); // 30 segundos para retry
                        
                        let retryResponse;
                        try {
                            retryResponse = await fetch(retryUrl, {
                                signal: retryController.signal,
                                headers: { 'Content-Type': 'application/json' }
                            });
                            clearTimeout(retryTimeoutId);
                        } catch (retryError) {
                            clearTimeout(retryTimeoutId);
                            throw retryError;
                        }
                        
                        if (retryResponse.ok) {
                            const retryData = await retryResponse.json();
                            const retryCards = retryData.data || [];
                            
                            console.log('✅ Retry successful:', retryCards.length, 'cards');
                            
                            // Mostrar mensaje de retry con opción de cargar más
                            if (errorMessage) {
                                errorMessage.innerHTML = `
                                    ⚠️ Búsqueda optimizada: ${retryCards.length} cartas encontradas. La API está lenta hoy.<br>
                                    <button onclick="loadMoreResults('${query}')" class="btn-primary px-4 py-2 mt-2 rounded-lg text-sm">
                                        🔄 Intentar Cargar Más Cartas
                                    </button>
                                `;
                                errorMessage.classList.remove('hidden');
                            }
                            
                            // Renderizar cartas del retry
                            if (retryCards.length > 0) {
                                retryCards.forEach((card, index) => {
                                    const cardElement = document.createElement('div');
                                    cardElement.className = 'card-bg rounded-xl shadow-lg overflow-hidden transform transition-transform hover:scale-105';
                                    
                                    // Función para escapar caracteres especiales
                                    const escapeForOnclick = (str) => {
                                        return String(str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                                    };
                                    
                                    const safeCardId = escapeForOnclick(card.id);
                                    const safeCardName = escapeForOnclick(card.name);
                                    const safeSetName = escapeForOnclick(card.set?.name || 'N/A');
                                    const safeSeries = escapeForOnclick(card.set?.series || 'N/A');
                                    const safeNumber = escapeForOnclick(card.number || 'N/A');
                                    const safeImageUrl = escapeForOnclick(card.images?.small);
                                    
                                    cardElement.innerHTML = `
                                        <img src="${card.images?.small || 'https://placehold.co/400x550/a0aec0/ffffff?text=Sin+imagen'}"
                                             alt="${card.name || 'Carta sin nombre'}"
                                             class="w-full h-auto object-cover rounded-t-xl"
                                             onerror="this.src='https://placehold.co/400x550/a0aec0/ffffff?text=Error+imagen'">
                                        <div class="p-4">
                                            <h3 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">${card.name || 'Nombre no disponible'}</h3>
                                            <p class="text-gray-600 text-sm mb-3">Set: ${card.set?.name || 'N/A'}</p>
                                            <p class="text-gray-600 text-sm mb-3">Serie: ${card.set?.series || 'N/A'}</p>
                                            <p class="text-gray-600 text-sm mb-3">Número: ${card.number || 'N/A'}</p>
                                            <button class="w-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-2 mb-3 hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors"
                                                    onclick="showCardOffers('${safeCardName}', '${safeSetName}', '${safeImageUrl}')">
                                                <span>🤝</span>
                                                <span>Ofrecidas: ${getCardOffersCount(card.name, card.set?.name || '')}</span>
                                            </button>
                                            <div class="flex justify-between items-center gap-2">
                                                <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold"
                                                        onclick="showCardDetailsOnly('${safeCardId}', '${safeCardName}', '${safeImageUrl}', '${safeSetName}', '${safeSeries}', '${safeNumber}')">
                                                    Ver Detalles
                                                </button>
                                                <button class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold"
                                                        onclick="addCardDirectly('${safeCardId}', '${safeCardName}', '${safeImageUrl}', '${safeSetName}', '${safeSeries}', '${safeNumber}')">
                                                    + Añadir
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                    cardsContainer.appendChild(cardElement);
                                });
                                
                                hideLoadingSpinner();
                                return; // Exit successfully
                            }
                        }
                    } catch (retryError) {
                        console.error('❌ Retry también falló:', retryError);
                    }
                }

                let errorMsg = '';
                let suggestions = '';
                
                if (error.name === 'AbortError' || error.message === 'TIMEOUT') {
                    errorMsg = '⏰ La búsqueda está tardando demasiado tiempo.';
                    suggestions = `
                        <div class="mt-2 text-sm">
                            <strong>Sugerencias:</strong>
                            <ul class="list-disc list-inside mt-1 text-gray-600 dark:text-gray-400">
                                <li>Intenta con un nombre más corto o específico</li>
                                <li>Busca solo una palabra (ej: "Pikachu" en vez de "Pikachu VMAX")</li>
                                <li>Espera unos segundos antes de reintentar</li>
                            </ul>
                        </div>
                    `;
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = '🌐 Problema de conexión con el servidor.';
                    suggestions = '<small class="text-gray-600 dark:text-gray-400">Verifica tu conexión a internet.</small>';
                } else if (error.message.includes('504')) {
                    errorMsg = '⚠️ El servidor de Pokémon TCG no responde.';
                    suggestions = '<small class="text-gray-600 dark:text-gray-400">El servicio puede estar sobrecargado. Intenta más tarde.</small>';
                } else {
                    errorMsg = '❌ Error al buscar cartas.';
                    suggestions = '<small class="text-gray-600 dark:text-gray-400">Intenta de nuevo en unos momentos.</small>';
                }

                if (errorMessage) {
                    errorMessage.innerHTML = `
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                            <div class="text-yellow-800 dark:text-yellow-200 font-semibold">${errorMsg}</div>
                            ${suggestions}
                            <button onclick="fetchCards('${query}')" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                                🔄 Reintentar Búsqueda
                            </button>
                        </div>
                    `;
                    errorMessage.classList.remove('hidden');
                }
            } finally {
                hideLoadingSpinner();
            }
        }
        
        // Función corregida para obtener cartas de un set
        async function fetchAllCardsInSet(setId) {
            console.log(`Obteniendo todas las cartas del set: ${setId}`);

            try {
                // URL corregida para usar tu función pokemon-proxy
                const response = await fetch(`https://tcgtrade-production.up.railway.app/api/pokemontcg/cards?q=set.id:${setId}&pageSize=500`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log(`Obtenidas ${data.data?.length || 0} cartas del set ${setId}`);
                return data.data || [];

            } catch (error) {
                console.error('Error al obtener cartas del set:', error);
                if (myCardsErrorMessage) {
                    myCardsErrorMessage.textContent = 'Error al cargar las cartas de esta expansión.';
                    myCardsErrorMessage.classList.remove('hidden');
                }
                return [];
            }
        }
        // Función para cargar la colección del usuario
        async function loadMyCollection(userId) {
            if (!myCardsContainer) return;

            myCardsContainer.innerHTML = '';
            if (noMyCardsMessage) noMyCardsMessage.classList.add('hidden');
            if (myCardsErrorMessage) myCardsErrorMessage.classList.add('hidden');
            showLoadingSpinner();

            try {
                // Si tenemos sincronización activa, usar los datos del cache
                if (dataSync && userCardsCache.length > 0) {
                    console.log('📦 Usando datos sincronizados de la colección');
                } else {
                    // Fallback: cargar desde Firestore directamente
                    console.log('📦 Cargando colección desde Firestore...');
                    const myCardsCollectionRef = collection(db, `users/${userId}/my_cards`);
                    const querySnapshot = await getDocs(myCardsCollectionRef);
                    userCardsCache = [];

                    querySnapshot.forEach(doc => {
                        userCardsCache.push(doc.data());
                    });
                }

                // Aplicar filtros
                const selectedSeries = seriesFilter?.value || '';
                const selectedSetId = setFilter?.value || '';
                const selectedLanguage = languageFilter?.value || '';
                const showAll = showAllSetCardsToggle?.checked || false;

                let cardsToDisplay = [];

                if (showAll && selectedSetId) {
                    // Mostrar todas las cartas del set (incluyendo faltantes)
                    const allCardsInSet = await fetchAllCardsInSet(selectedSetId);
                    const ownedCardIds = new Set(userCardsCache.map(card => card.id));

                    allCardsInSet.forEach(apiCard => {
                        const matchesSeries = selectedSeries === "" || (apiCard.set && apiCard.set.series === selectedSeries);
                        const matchesLanguage = selectedLanguage === "" || (ownedCardIds.has(apiCard.id) && userCardsCache.find(c => c.id === apiCard.id).language === selectedLanguage);

                        if (matchesSeries && matchesLanguage) {
                            if (ownedCardIds.has(apiCard.id)) {
                                const ownedCard = userCardsCache.find(c => c.id === apiCard.id);
                                cardsToDisplay.push({ ...ownedCard, isOwned: true });
                            } else {
                                cardsToDisplay.push({
                                    id: apiCard.id,
                                    name: apiCard.name,
                                    number: apiCard.number,
                                    imageUrl: 'https://placehold.co/400x550/e2e8f0/4a5568?text=Falta',
                                    set: apiCard.set ? apiCard.set.name : 'N/A',
                                    series: apiCard.set && apiCard.set.series ? apiCard.set.series : 'N/A',
                                    language: 'N/A',
                                    isOwned: false
                                });
                            }
                        }
                    });

                    // Ordenar por número de carta
                    cardsToDisplay.sort((a, b) => {
                        const numA = parseInt(a.number, 10) || Infinity;
                        const numB = parseInt(b.number, 10) || Infinity;
                        return numA - numB;
                    });

                } else {
                    // Modo normal: solo cartas poseídas
                    let filteredCards = userCardsCache.filter(card => {
                        const matchesSeries = selectedSeries === "" || card.series === selectedSeries;
                        const matchesSet = selectedSetId === "" || card.setId === selectedSetId;
                        const matchesLanguage = selectedLanguage === "" || card.language === selectedLanguage;
                        return matchesSeries && matchesSet && matchesLanguage;
                    });

                    filteredCards.sort((a, b) => {
                        if (a.set !== b.set) return a.set.localeCompare(b.set);
                        const numA = parseInt(a.number, 10) || Infinity;
                        const numB = parseInt(b.number, 10) || Infinity;
                        return numA - numB;
                    });

                    cardsToDisplay = filteredCards;
                }

                renderCardsInCollection(cardsToDisplay);

                if (cardsToDisplay.length === 0) {
                    if (noMyCardsMessage) {
                        noMyCardsMessage.textContent = 'No se encontraron cartas con los filtros aplicados.';
                        noMyCardsMessage.classList.remove('hidden');
                    }
                }

            } catch (error) {
                console.error('Error al cargar la colección:', error);
                if (myCardsErrorMessage) myCardsErrorMessage.classList.remove('hidden');
            } finally {
                hideLoadingSpinner();
            }
        }

        // Función para renderizar cartas en la colección (nuevo diseño de lista)
        function renderCardsInCollection(cards) {
            if (!myCardsContainer) return;

            myCardsContainer.innerHTML = '';

            if (cards.length === 0) {
                if (noMyCardsMessage) noMyCardsMessage.classList.remove('hidden');
                return;
            }

            // Cambiar el contenedor a diseño de lista
            myCardsContainer.className = 'space-y-1 border rounded-lg bg-white dark:bg-gray-800';

            cards.forEach((card, index) => {
                const isOwned = card.isOwned !== undefined ? card.isOwned : true;
                const imageUrl = card.imageUrl;
                
                const row = document.createElement('div');
                row.className = 'relative flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 h-16 overflow-visible';
                if (index < cards.length - 1) {
                    row.className += ' border-b';
                }
                
                // Icono de imagen con hover
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'w-10 h-10 flex items-center justify-center bg-transparent rounded cursor-pointer absolute left-3 top-1/2 -translate-y-1/2 z-10';
                imgWrapper.title = 'Pasa el mouse para ver imagen';
                imgWrapper.innerHTML = isOwned ? '<span class="text-xl">🎴</span>' : '<span class="text-xl opacity-50">🎴</span>';
                
                // Contenedor de imagen con hover
                const imgContainer = document.createElement('div');
                imgContainer.className = 'hidden absolute left-14 top-1/2 -translate-y-1/2 z-30';
                imgContainer.style.pointerEvents = 'none';
                
                const imgEl = document.createElement('img');
                imgEl.src = imageUrl || 'https://placehold.co/400x550/a0aec0/ffffff?text=Sin+imagen';
                imgEl.alt = card.name || 'Carta';
                imgEl.className = 'w-64 h-auto object-contain rounded-lg shadow-2xl border-2 border-gray-200';
                imgEl.onerror = () => { imgEl.src = 'https://placehold.co/400x550/a0aec0/ffffff?text=Error'; };
                
                imgContainer.appendChild(imgEl);
                row.appendChild(imgContainer);
                
                // Eventos de hover
                imgWrapper.addEventListener('mouseenter', () => { 
                    imgContainer.classList.remove('hidden');
                });
                
                imgWrapper.addEventListener('mouseleave', () => { 
                    imgContainer.classList.add('hidden');
                });
                
                // Información de la carta
                const info = document.createElement('div');
                info.className = 'flex-1 min-w-0 pl-16';
                
                if (isOwned) {
                    info.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-gray-900 dark:text-white">${card.name}</span>
                                    ${card.quantity > 1 ? `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">x${card.quantity}</span>` : ''}
                                    <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">En colección</span>
                                </div>
                                <div class="text-xs text-gray-600">
                                    #${card.number} · ${card.set} · ${card.series || 'N/A'} · ${card.language || 'N/A'}
                                </div>
                            </div>
                            <button class="btn-secondary px-3 py-1.5 rounded text-xs" onclick="removeCardFromCollection('${card.id}')">
                                Eliminar
                            </button>
                        </div>
                    `;
                } else {
                    info.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-gray-500 line-through">${card.name}</span>
                                    <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">Falta</span>
                                </div>
                                <div class="text-xs text-gray-400">
                                    #${card.number} · ${card.set} · ${card.series || 'N/A'}
                                </div>
                            </div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Falta en tu colección</span>
                        </div>
                    `;
                }
                
                row.appendChild(imgWrapper);
                row.appendChild(info);
                myCardsContainer.appendChild(row);
            });
        }

        // Función para eliminar carta de la colección
        window.removeCardFromCollection = async (cardId) => {
            if (!currentUser) {
                alert('Por favor, inicia sesión.');
                return;
            }

            try {
                await deleteDoc(doc(db, `users/${currentUser.uid}/my_cards/${cardId}`));
                showNotification('Carta eliminada de tu colección', 'success', 3000);
                await loadMyCollection(currentUser.uid);
            } catch (error) {
                console.error('Error al eliminar carta:', error);
                showNotification('Error al eliminar la carta. Inténtalo de nuevo.', 'error', 5000);
            }
        };

        // Función para poblar filtros de búsqueda
        async function fetchSetsAndPopulateSearchFilters() {
            if (allSets.length > 0) {
                await populateSearchFilters();
                return;
            }

            console.log('🔄 Cargando sets para filtros de búsqueda...');

            try {
                const response = await fetch('https://tcgtrade-production.up.railway.app/api/pokemontcg/sets');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                allSets = data.data || [];
                
                console.log('✅ Sets cargados para filtros:', allSets.length);
                allSets.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));
                
                await populateSearchFilters();

            } catch (error) {
                console.error('Error al cargar sets para filtros:', error);
                // Usar datos locales como fallback - TODAS LAS SERIES Y SETS
                allSets = [
                    // BASE SERIES (1996-2000)
                    { id: 'base1', name: 'Base', series: 'Base', releaseDate: '1996-10-20' },
                    { id: 'base2', name: 'Jungle', series: 'Base', releaseDate: '1999-06-16' },
                    { id: 'base3', name: 'Fossil', series: 'Base', releaseDate: '1999-10-10' },
                    { id: 'base4', name: 'Base Set 2', series: 'Base', releaseDate: '2000-02-24' },
                    { id: 'base5', name: 'Team Rocket', series: 'Base', releaseDate: '2000-04-24' },
                    { id: 'base6', name: 'Gym Heroes', series: 'Base', releaseDate: '2000-08-14' },
                    { id: 'base7', name: 'Gym Challenge', series: 'Base', releaseDate: '2000-10-16' },
                    { id: 'base8', name: 'Neo Genesis', series: 'Base', releaseDate: '2000-12-16' },
                    { id: 'base9', name: 'Neo Discovery', series: 'Base', releaseDate: '2001-06-01' },
                    { id: 'base10', name: 'Neo Revelation', series: 'Base', releaseDate: '2001-09-21' },
                    { id: 'base11', name: 'Neo Destiny', series: 'Base', releaseDate: '2002-02-28' },
                    { id: 'base12', name: 'Legendary Collection', series: 'Base', releaseDate: '2002-05-24' },
                    
                    // ADVANCED SERIES (2003-2007)
                    { id: 'adv1', name: 'Expedition Base Set', series: 'Advanced', releaseDate: '2002-09-15' },
                    { id: 'adv2', name: 'Aquapolis', series: 'Advanced', releaseDate: '2003-01-15' },
                    { id: 'adv3', name: 'Skyridge', series: 'Advanced', releaseDate: '2003-05-12' },
                    { id: 'adv4', name: 'EX Ruby & Sapphire', series: 'Advanced', releaseDate: '2003-06-18' },
                    { id: 'adv5', name: 'EX Sandstorm', series: 'Advanced', releaseDate: '2003-09-17' },
                    { id: 'adv6', name: 'EX Dragon', series: 'Advanced', releaseDate: '2003-11-24' },
                    { id: 'adv7', name: 'EX Team Magma vs Team Aqua', series: 'Advanced', releaseDate: '2004-03-15' },
                    { id: 'adv8', name: 'EX Hidden Legends', series: 'Advanced', releaseDate: '2004-06-07' },
                    { id: 'adv9', name: 'EX FireRed & LeafGreen', series: 'Advanced', releaseDate: '2004-09-27' },
                    { id: 'adv10', name: 'EX Team Rocket Returns', series: 'Advanced', releaseDate: '2004-11-08' },
                    { id: 'adv11', name: 'EX Deoxys', series: 'Advanced', releaseDate: '2005-02-14' },
                    { id: 'adv12', name: 'EX Emerald', series: 'Advanced', releaseDate: '2005-05-09' },
                    { id: 'adv13', name: 'EX Unseen Forces', series: 'Advanced', releaseDate: '2005-08-22' },
                    { id: 'adv14', name: 'EX Delta Species', series: 'Advanced', releaseDate: '2005-10-31' },
                    { id: 'adv15', name: 'EX Legend Maker', series: 'Advanced', releaseDate: '2006-02-13' },
                    { id: 'adv16', name: 'EX Holon Phantoms', series: 'Advanced', releaseDate: '2006-05-03' },
                    { id: 'adv17', name: 'EX Crystal Guardians', series: 'Advanced', releaseDate: '2006-08-30' },
                    { id: 'adv18', name: 'EX Dragon Frontiers', series: 'Advanced', releaseDate: '2006-11-08' },
                    { id: 'adv19', name: 'EX Power Keepers', series: 'Advanced', releaseDate: '2007-02-14' },
                    
                    // DIAMOND & PEARL SERIES (2007-2010)
                    { id: 'dp1', name: 'Diamond & Pearl', series: 'Diamond & Pearl', releaseDate: '2007-05-01' },
                    { id: 'dp2', name: 'Mysterious Treasures', series: 'Diamond & Pearl', releaseDate: '2007-08-15' },
                    { id: 'dp3', name: 'Secret Wonders', series: 'Diamond & Pearl', releaseDate: '2007-11-07' },
                    { id: 'dp4', name: 'Great Encounters', series: 'Diamond & Pearl', releaseDate: '2008-02-13' },
                    { id: 'dp5', name: 'Majestic Dawn', series: 'Diamond & Pearl', releaseDate: '2008-05-21' },
                    { id: 'dp6', name: 'Legends Awakened', series: 'Diamond & Pearl', releaseDate: '2008-08-20' },
                    { id: 'dp7', name: 'Stormfront', series: 'Diamond & Pearl', releaseDate: '2008-11-05' },
                    { id: 'dp8', name: 'Platinum', series: 'Diamond & Pearl', releaseDate: '2009-02-11' },
                    { id: 'dp9', name: 'Rising Rivals', series: 'Diamond & Pearl', releaseDate: '2009-05-20' },
                    { id: 'dp10', name: 'Supreme Victors', series: 'Diamond & Pearl', releaseDate: '2009-08-19' },
                    { id: 'dp11', name: 'Arceus', series: 'Diamond & Pearl', releaseDate: '2009-11-04' },
                    
                    // HEARTGOLD & SOULSILVER SERIES (2010-2011)
                    { id: 'hgss1', name: 'HeartGold & SoulSilver', series: 'HeartGold & SoulSilver', releaseDate: '2010-02-10' },
                    { id: 'hgss2', name: 'Unleashed', series: 'HeartGold & SoulSilver', releaseDate: '2010-05-12' },
                    { id: 'hgss3', name: 'Undaunted', series: 'HeartGold & SoulSilver', releaseDate: '2010-08-18' },
                    { id: 'hgss4', name: 'Triumphant', series: 'HeartGold & SoulSilver', releaseDate: '2010-11-03' },
                    { id: 'hgss5', name: 'Call of Legends', series: 'HeartGold & SoulSilver', releaseDate: '2011-02-09' },
                    
                    // BLACK & WHITE SERIES (2011-2013)
                    { id: 'bw1', name: 'Black & White', series: 'Black & White', releaseDate: '2011-04-25' },
                    { id: 'bw2', name: 'Emerging Powers', series: 'Black & White', releaseDate: '2011-08-31' },
                    { id: 'bw3', name: 'Noble Victories', series: 'Black & White', releaseDate: '2011-11-16' },
                    { id: 'bw4', name: 'Next Destinies', series: 'Black & White', releaseDate: '2012-02-08' },
                    { id: 'bw5', name: 'Dark Explorers', series: 'Black & White', releaseDate: '2012-05-09' },
                    { id: 'bw6', name: 'Dragons Exalted', series: 'Black & White', releaseDate: '2012-08-15' },
                    { id: 'bw7', name: 'Boundaries Crossed', series: 'Black & White', releaseDate: '2012-11-07' },
                    { id: 'bw8', name: 'Plasma Storm', series: 'Black & White', releaseDate: '2013-02-06' },
                    { id: 'bw9', name: 'Plasma Freeze', series: 'Black & White', releaseDate: '2013-05-08' },
                    { id: 'bw10', name: 'Plasma Blast', series: 'Black & White', releaseDate: '2013-08-14' },
                    { id: 'bw11', name: 'Legendary Treasures', series: 'Black & White', releaseDate: '2013-11-08' },
                    
                    // XY SERIES (2014-2016)
                    { id: 'xy1', name: 'XY', series: 'XY', releaseDate: '2014-02-05' },
                    { id: 'xy2', name: 'Flashfire', series: 'XY', releaseDate: '2014-05-07' },
                    { id: 'xy3', name: 'Furious Fists', series: 'XY', releaseDate: '2014-08-13' },
                    { id: 'xy4', name: 'Phantom Forces', series: 'XY', releaseDate: '2014-11-05' },
                    { id: 'xy5', name: 'Primal Clash', series: 'XY', releaseDate: '2015-02-04' },
                    { id: 'xy6', name: 'Roaring Skies', series: 'XY', releaseDate: '2015-05-06' },
                    { id: 'xy7', name: 'Ancient Origins', series: 'XY', releaseDate: '2015-08-12' },
                    { id: 'xy8', name: 'BREAKthrough', series: 'XY', releaseDate: '2015-11-04' },
                    { id: 'xy9', name: 'BREAKpoint', series: 'XY', releaseDate: '2016-02-03' },
                    { id: 'xy10', name: 'Fates Collide', series: 'XY', releaseDate: '2016-05-04' },
                    { id: 'xy11', name: 'Steam Siege', series: 'XY', releaseDate: '2016-08-03' },
                    { id: 'xy12', name: 'Evolutions', series: 'XY', releaseDate: '2016-11-02' },
                    
                    // SUN & MOON SERIES (2017-2019)
                    { id: 'sm1', name: 'Sun & Moon', series: 'Sun & Moon', releaseDate: '2017-02-03' },
                    { id: 'sm2', name: 'Guardians Rising', series: 'Sun & Moon', releaseDate: '2017-05-05' },
                    { id: 'sm3', name: 'Burning Shadows', series: 'Sun & Moon', releaseDate: '2017-08-04' },
                    { id: 'sm4', name: 'Crimson Invasion', series: 'Sun & Moon', releaseDate: '2017-11-03' },
                    { id: 'sm5', name: 'Ultra Prism', series: 'Sun & Moon', releaseDate: '2018-02-02' },
                    { id: 'sm6', name: 'Forbidden Light', series: 'Sun & Moon', releaseDate: '2018-05-04' },
                    { id: 'sm7', name: 'Celestial Storm', series: 'Sun & Moon', releaseDate: '2018-08-03' },
                    { id: 'sm8', name: 'Lost Thunder', series: 'Sun & Moon', releaseDate: '2018-11-02' },
                    { id: 'sm9', name: 'Team Up', series: 'Sun & Moon', releaseDate: '2019-02-01' },
                    { id: 'sm10', name: 'Detective Pikachu', series: 'Sun & Moon', releaseDate: '2019-04-05' },
                    { id: 'sm11', name: 'Unbroken Bonds', series: 'Sun & Moon', releaseDate: '2019-05-03' },
                    { id: 'sm12', name: 'Unified Minds', series: 'Sun & Moon', releaseDate: '2019-08-02' },
                    { id: 'sm13', name: 'Hidden Fates', series: 'Sun & Moon', releaseDate: '2019-08-23' },
                    { id: 'sm14', name: 'Cosmic Eclipse', series: 'Sun & Moon', releaseDate: '2019-11-01' },
                    
                    // SWORD & SHIELD SERIES (2020-2022)
                    { id: 'swsh1', name: 'Sword & Shield', series: 'Sword & Shield', releaseDate: '2020-02-07' },
                    { id: 'swsh2', name: 'Rebel Clash', series: 'Sword & Shield', releaseDate: '2020-05-01' },
                    { id: 'swsh3', name: 'Darkness Ablaze', series: 'Sword & Shield', releaseDate: '2020-08-14' },
                    { id: 'swsh4', name: 'Vivid Voltage', series: 'Sword & Shield', releaseDate: '2020-11-13' },
                    { id: 'swsh5', name: 'Battle Styles', series: 'Sword & Shield', releaseDate: '2021-03-19' },
                    { id: 'swsh6', name: 'Chilling Reign', series: 'Sword & Shield', releaseDate: '2021-06-18' },
                    { id: 'swsh7', name: 'Evolving Skies', series: 'Sword & Shield', releaseDate: '2021-08-27' },
                    { id: 'swsh8', name: 'Fusion Strike', series: 'Sword & Shield', releaseDate: '2021-11-12' },
                    { id: 'swsh9', name: 'Brilliant Stars', series: 'Sword & Shield', releaseDate: '2022-02-25' },
                    { id: 'swsh10', name: 'Astral Radiance', series: 'Sword & Shield', releaseDate: '2022-05-27' },
                    { id: 'swsh11', name: 'Lost Origin', series: 'Sword & Shield', releaseDate: '2022-09-09' },
                    { id: 'swsh12', name: 'Silver Tempest', series: 'Sword & Shield', releaseDate: '2022-11-11' },
                    
                    // SCARLET & VIOLET SERIES (2023-2025)
                    { id: 'sv1', name: 'Scarlet & Violet', series: 'Scarlet & Violet', releaseDate: '2023-03-31' },
                    { id: 'sv2', name: 'Paldea Evolved', series: 'Scarlet & Violet', releaseDate: '2023-06-16' },
                    { id: 'sv3', name: 'Obsidian Flames', series: 'Scarlet & Violet', releaseDate: '2023-08-11' },
                    { id: 'sv4', name: '151', series: 'Scarlet & Violet', releaseDate: '2023-09-22' },
                    { id: 'sv5', name: 'Paradox Rift', series: 'Scarlet & Violet', releaseDate: '2023-11-03' },
                    { id: 'sv6', name: 'Paldean Fates', series: 'Scarlet & Violet', releaseDate: '2024-01-26' },
                    { id: 'sv7', name: 'Temporal Forces', series: 'Scarlet & Violet', releaseDate: '2024-03-22' },
                    { id: 'sv8', name: 'Twilight Masquerade', series: 'Scarlet & Violet', releaseDate: '2024-05-24' },
                    { id: 'sv9', name: 'Shrouded Fable', series: 'Scarlet & Violet', releaseDate: '2024-08-30' },
                    { id: 'sv10', name: 'Stellar Crown', series: 'Scarlet & Violet', releaseDate: '2024-11-01' },
                    { id: 'sv11', name: 'Shrouded Fable', series: 'Scarlet & Violet', releaseDate: '2024-12-13' },
                    { id: 'sv12', name: 'Shrouded Fable', series: 'Scarlet & Violet', releaseDate: '2025-01-31' },
                    
                    // SETS ESPECIALES Y PROMOCIONALES
                    { id: 'pop1', name: 'POP Series 1', series: 'POP', releaseDate: '2004-09-01' },
                    { id: 'pop2', name: 'POP Series 2', series: 'POP', releaseDate: '2005-03-01' },
                    { id: 'pop3', name: 'POP Series 3', series: 'POP', releaseDate: '2005-09-01' },
                    { id: 'pop4', name: 'POP Series 4', series: 'POP', releaseDate: '2006-03-01' },
                    { id: 'pop5', name: 'POP Series 5', series: 'POP', releaseDate: '2006-09-01' },
                    { id: 'pop6', name: 'POP Series 6', series: 'POP', releaseDate: '2007-03-01' },
                    { id: 'pop7', name: 'POP Series 7', series: 'POP', releaseDate: '2007-09-01' },
                    { id: 'pop8', name: 'POP Series 8', series: 'POP', releaseDate: '2008-03-01' },
                    { id: 'pop9', name: 'POP Series 9', series: 'POP', releaseDate: '2008-09-01' },
                    
                    // SETS DE JAPÓN
                    { id: 'jpn1', name: 'Base Set (Japón)', series: 'Japón', releaseDate: '1996-10-20' },
                    { id: 'jpn2', name: 'Jungle (Japón)', series: 'Japón', releaseDate: '1999-06-16' },
                    { id: 'jpn3', name: 'Fossil (Japón)', series: 'Japón', releaseDate: '1999-10-10' },
                    { id: 'jpn4', name: 'Team Rocket (Japón)', series: 'Japón', releaseDate: '2000-04-24' },
                    { id: 'jpn5', name: 'Gym Heroes (Japón)', series: 'Japón', releaseDate: '2000-08-14' },
                    { id: 'jpn6', name: 'Gym Challenge (Japón)', series: 'Japón', releaseDate: '2000-10-16' },
                    { id: 'jpn7', name: 'Neo Genesis (Japón)', series: 'Japón', releaseDate: '2000-12-16' },
                    { id: 'jpn8', name: 'Neo Discovery (Japón)', series: 'Japón', releaseDate: '2001-06-01' },
                    { id: 'jpn9', name: 'Neo Revelation (Japón)', series: 'Japón', releaseDate: '2001-09-21' },
                    { id: 'jpn10', name: 'Neo Destiny (Japón)', series: 'Japón', releaseDate: '2002-02-28' },
                    
                    // SETS DE EUROPA
                    { id: 'eur1', name: 'Base Set (Europa)', series: 'Europa', releaseDate: '1999-10-10' },
                    { id: 'eur2', name: 'Jungle (Europa)', series: 'Europa', releaseDate: '1999-06-16' },
                    { id: 'eur3', name: 'Fossil (Europa)', series: 'Europa', releaseDate: '1999-10-10' },
                    { id: 'eur4', name: 'Team Rocket (Europa)', series: 'Europa', releaseDate: '2000-04-24' },
                    { id: 'eur5', name: 'Gym Heroes (Europa)', series: 'Europa', releaseDate: '2000-08-14' },
                    { id: 'eur6', name: 'Gym Challenge (Europa)', series: 'Europa', releaseDate: '2000-10-16' },
                    
                    // SETS DE AUSTRALIA
                    { id: 'aus1', name: 'Base Set (Australia)', series: 'Australia', releaseDate: '1999-10-10' },
                    { id: 'aus2', name: 'Jungle (Australia)', series: 'Australia', releaseDate: '1999-06-16' },
                    { id: 'aus3', name: 'Fossil (Australia)', series: 'Australia', releaseDate: '1999-10-10' },
                    { id: 'aus4', name: 'Team Rocket (Australia)', series: 'Australia', releaseDate: '2000-04-24' },
                    { id: 'aus5', name: 'Gym Heroes (Australia)', series: 'Australia', releaseDate: '2000-08-14' },
                    { id: 'aus6', name: 'Gym Challenge (Australia)', series: 'Australia', releaseDate: '2000-10-16' }
                ];
                
                console.log('✅ Sets locales cargados para filtros:', allSets.length);
                await populateSearchFilters();
            }
        }

        // Función para poblar los filtros de búsqueda con datos reales
        async function populateSearchFilters() {
            const filterSeriesSelect = document.getElementById('filterSeriesSelect');
            const filterSetSelect = document.getElementById('filterSetSelect');
            
            // Obtener sets reales de la base de datos
            const realSets = await fetchRealSetsFromDatabase();
            
            if (filterSeriesSelect) {
                filterSeriesSelect.innerHTML = '<option value="">Todas las Series</option>';
                const uniqueSeries = [...new Set(realSets.map(set => set.series))].filter(Boolean).sort();
                uniqueSeries.forEach(series => {
                    const option = document.createElement('option');
                    option.value = series;
                    option.textContent = series;
                    filterSeriesSelect.appendChild(option);
                });
                console.log('✅ Filtro de series poblado con', uniqueSeries.length, 'series reales');
            }
            
            if (filterSetSelect) {
                filterSetSelect.innerHTML = '<option value="">Todos los Sets</option>';
                // Ordenar sets de más antiguo a más nuevo (orden cronológico)
                const sortedSets = [...realSets].sort((a, b) => {
                    // Mapear nombres de sets a fechas aproximadas para orden cronológico
                    const setDates = {
                        'Base': '1996-10-20',
                        'Jungle': '1999-06-16', 
                        'Fossil': '1999-10-10',
                        'Base Set 2': '2000-02-24',
                        'Team Rocket': '2000-04-24',
                        'Gym Heroes': '2000-08-14',
                        'Gym Challenge': '2000-10-16',
                        'Neo Genesis': '2000-12-16',
                        'Neo Discovery': '2001-06-01',
                        'Neo Revelation': '2001-09-21',
                        'Neo Destiny': '2002-02-28',
                        'Legendary Collection': '2002-05-24'
                    };
                    
                    const dateA = setDates[a.name] || '2020-01-01';
                    const dateB = setDates[b.name] || '2020-01-01';
                    return new Date(dateA) - new Date(dateB);
                });
                
                sortedSets.forEach(set => {
                    const option = document.createElement('option');
                    option.value = set.name; // Usar el nombre real de la base de datos
                    option.textContent = set.name;
                    filterSetSelect.appendChild(option);
                });
                console.log('✅ Filtro de sets poblado con', sortedSets.length, 'sets reales (orden cronológico)');
            }
            
            // Agregar event listener para el filtro de serie
            if (filterSeriesSelect) {
                filterSeriesSelect.addEventListener('change', () => {
                    const selectedSeries = filterSeriesSelect.value;
                    searchFiltersState.series = selectedSeries; // Actualizar estado
                    if (selectedSeries === "") {
                        populateSetFilterForSearch(allSets);
                    } else {
                        const setsInSeries = allSets.filter(set => set.series === selectedSeries);
                        populateSetFilterForSearch(setsInSeries);
                    }
                    if (filterSetSelect) filterSetSelect.value = "";
                    searchFiltersState.set = ""; // Limpiar set cuando cambia serie
                });
            }
        }

        // Función para poblar el filtro de sets en búsqueda
        function populateSetFilterForSearch(setsToDisplay) {
            const filterSetSelect = document.getElementById('filterSetSelect');
            if (!filterSetSelect) return;

            filterSetSelect.innerHTML = '<option value="">Todos los Sets</option>';
            // Ordenar sets de más antiguo a más nuevo
            const sortedSets = [...setsToDisplay].sort((a, b) => new Date(a.releaseDate) - new Date(b.releaseDate));
            sortedSets.forEach(set => {
                const option = document.createElement('option');
                option.value = set.name;
                option.textContent = set.name;
                filterSetSelect.appendChild(option);
            });
        }

        // Función para obtener sets reales de la base de datos
        async function fetchRealSetsFromDatabase() {
            console.log('🔄 Obteniendo sets reales de la base de datos...');
            
            try {
                const response = await fetch('/api/pokemontcg/cards?q=pokemon&pageSize=1000');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const cards = data.data || [];
                
                // Extraer sets únicos de las cartas
                const uniqueSets = new Map();
                cards.forEach(card => {
                    if (card.set && card.set.name && card.set.id) {
                        uniqueSets.set(card.set.id, {
                            id: card.set.id,
                            name: card.set.name,
                            series: card.set.series || 'Unknown'
                        });
                    }
                });
                
                const realSets = Array.from(uniqueSets.values()).sort((a, b) => a.name.localeCompare(b.name));
                console.log('✅ Sets reales obtenidos:', realSets.length);
                return realSets;
                
            } catch (error) {
                console.error('❌ Error obteniendo sets reales:', error);
                return [];
            }
        }

        // Función para obtener sets de la API (MEJORADA)
        async function fetchSetsAndPopulateFilter() {
            if (allSets.length > 0) return;

            console.log('🔄 Cargando sets desde la API...');

            try {
                // Timeout más generoso para sets (pueden ser muchos)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos

                // Intentar primero con menos sets para ver si funciona
                const response = await fetch('https://tcgtrade-production.up.railway.app/api/pokemontcg/sets?pageSize=20&orderBy=-releaseDate', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                clearTimeout(timeoutId);

                console.log('📡 Sets API Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Sets API Error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                allSets = data.data || [];
                
                console.log('✅ Sets cargados:', allSets.length);

                allSets.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));

                // Poblar filtro de Series
                const uniqueSeries = [...new Set(allSets.map(set => set.series))].filter(Boolean).sort();
                if (seriesFilter) {
                    seriesFilter.innerHTML = '<option value="">Todas las Series</option>';
                    uniqueSeries.forEach(series => {
                        const option = document.createElement('option');
                        option.value = series;
                        option.textContent = series;
                        seriesFilter.appendChild(option);
                    });
                }

                // Poblar filtro de Sets
                populateSetFilter(allSets);
                if (setFilter) setFilter.disabled = false;

                console.log(`Cargados ${allSets.length} sets y ${uniqueSeries.length} series`);

            } catch (error) {
                console.error('Error al cargar sets:', error);
                console.log('🔄 Usando sets locales como fallback...');
                
                // Fallback: usar sets locales predefinidos si la API falla
                allSets = [
                    { id: 'sv', name: 'Scarlet & Violet', series: 'Scarlet & Violet', releaseDate: '2023-03-31' },
                    { id: 'pgo', name: 'Pokémon GO', series: 'Sword & Shield', releaseDate: '2022-07-01' },
                    { id: 'astralradiance', name: 'Astral Radiance', series: 'Sword & Shield', releaseDate: '2022-05-27' },
                    { id: 'brilliantstars', name: 'Brilliant Stars', series: 'Sword & Shield', releaseDate: '2022-02-25' },
                    { id: 'fusionstrikes', name: 'Fusion Strike', series: 'Sword & Shield', releaseDate: '2021-11-12' },
                    { id: 'evolvingskies', name: 'Evolving Skies', series: 'Sword & Shield', releaseDate: '2021-08-27' },
                    { id: 'chillingReign', name: 'Chilling Reign', series: 'Sword & Shield', releaseDate: '2021-06-18' },
                    { id: 'battlestyles', name: 'Battle Styles', series: 'Sword & Shield', releaseDate: '2021-03-19' },
                    { id: 'shiningfates', name: 'Shining Fates', series: 'Sword & Shield', releaseDate: '2021-02-19' },
                    { id: 'vividvoltage', name: 'Vivid Voltage', series: 'Sword & Shield', releaseDate: '2020-11-13' },
                    { id: 'championsPath', name: 'Champions Path', series: 'Sword & Shield', releaseDate: '2020-09-25' },
                    { id: 'darknessAblaze', name: 'Darkness Ablaze', series: 'Sword & Shield', releaseDate: '2020-08-14' },
                    { id: 'rebelclash', name: 'Rebel Clash', series: 'Sword & Shield', releaseDate: '2020-05-01' },
                    { id: 'base1', name: 'Base', series: 'Base', releaseDate: '1999-01-09' },
                    { id: 'base2', name: 'Jungle', series: 'Base', releaseDate: '1999-06-16' },
                    { id: 'base3', name: 'Fossil', series: 'Base', releaseDate: '1999-10-10' }
                ];
                
                console.log('✅ Sets locales cargados:', allSets.length);
                
                // Poblar filtros con datos locales
                const uniqueSeries = [...new Set(allSets.map(set => set.series))].filter(Boolean).sort();
                if (seriesFilter) {
                    seriesFilter.innerHTML = '<option value="">Todas las Series</option>';
                    uniqueSeries.forEach(series => {
                        const option = document.createElement('option');
                        option.value = series;
                        option.textContent = series;
                        seriesFilter.appendChild(option);
                    });
                }
                populateSetFilter(allSets);
                if (setFilter) setFilter.disabled = false;
                if (myCardsErrorMessage) {
                    myCardsErrorMessage.textContent = 'No se pudieron cargar los filtros. La API está lenta. Intenta más tarde o configura tu API Key.';
                    myCardsErrorMessage.classList.remove('hidden');
                }
            }
        }

        // Función para poblar el filtro de sets
        function populateSetFilter(setsToDisplay) {
            if (!setFilter) return;

            setFilter.innerHTML = '<option value="">Todas las Expansiones</option>';
            setsToDisplay.forEach(set => {
                const option = document.createElement('option');
                option.value = set.id;
                option.textContent = set.name;
                setFilter.appendChild(option);
            });
        }

        // --- Funciones de Autenticación ---
        window.logoutUser = async () => {
            try {
                console.log('🚪 Cerrando sesión...');
                
                // Limpiar sistema de chat antes de cerrar sesión
                if (window.chatManager) {
                    try {
                        window.chatManager.disconnectAll();
                    } catch (e) {
                        console.warn('Error al desconectar chat manager:', e);
                    }
                    window.chatManager = null;
                }
                if (window.chatUI) {
                    // Cerrar todas las ventanas de chat abiertas
                    const chatWindows = document.querySelectorAll('[id^="chat-window-"]');
                    chatWindows.forEach(window => window.remove());
                    
                    // Limpiar barra de chats minimizados
                    const minimizedBar = document.getElementById('minimized-chats-bar');
                    if (minimizedBar) minimizedBar.remove();
                    
                    window.chatUI = null;
                }
                // Limpiar debugger si existe
                if (window.chatDebugger) {
                    window.chatDebugger = null;
                }
                if (window.chatDebug) {
                    window.chatDebug = null;
                }
                
                // Cerrar sesión en Firebase
                await signOut(auth);
                
                // Limpiar datos del usuario actual
                currentUser = null;
                
                // Reinicializar variables de chat
                chatManager = null;
                chatUI = null;
                
                // Limpiar cualquier dato en caché
                userCardsCache = [];
                
                // Limpiar formularios si existen
                const forms = document.querySelectorAll('form');
                forms.forEach(form => form.reset());
                
                // Limpiar contenido sensible de los contenedores
                const myCardsContainer = document.getElementById('myCardsContainer');
                if (myCardsContainer) myCardsContainer.innerHTML = '';
                
                const myTradesContainer = document.getElementById('myTradesContainer');
                if (myTradesContainer) myTradesContainer.innerHTML = '';
                
                const availableTradesContainer = document.getElementById('availableTradesContainer');
                if (availableTradesContainer) availableTradesContainer.innerHTML = '';
                
                // Ocultar todas las secciones privadas
                const profileSection = document.getElementById('profileSection');
                const myCardsSection = document.getElementById('myCardsSection');
                const interchangesSection = document.getElementById('interchangesSection');
                const helpSection = document.getElementById('helpSection');
                const searchResultsSection = document.getElementById('searchResults');
                const inboxSection = document.getElementById('inboxSection');
                
                if (profileSection) profileSection.classList.add('hidden');
                if (myCardsSection) myCardsSection.classList.add('hidden');
                if (interchangesSection) interchangesSection.classList.add('hidden');
                if (helpSection) helpSection.classList.add('hidden');
                if (searchResultsSection) searchResultsSection.classList.add('hidden');
                if (inboxSection) inboxSection.classList.add('hidden');
                
                // Actualizar manualmente los enlaces de navegación
                const loginLink = document.getElementById('loginLink');
                const registerLink = document.getElementById('registerLink');
                const logoutLink = document.getElementById('logoutLink');
                const chatLink = document.getElementById('chatLink');
                const inboxLink = document.getElementById('inboxLink');
                
                // Mostrar enlaces de login/register, ocultar logout y chat
                if (loginLink) loginLink.classList.remove('hidden');
                if (registerLink) registerLink.classList.remove('hidden');
                if (logoutLink) logoutLink.classList.add('hidden');
                if (chatLink) chatLink.classList.add('hidden');
                if (inboxLink) inboxLink.classList.add('hidden');
                
                // Mostrar la pantalla inicial (hero y how it works)
                showInitialSections();
                
                // Limpiar la barra de búsqueda si existe
                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.value = '';
                
                // Scroll al inicio de la página
                window.scrollTo(0, 0);
                
                console.log('✅ Sesión cerrada exitosamente');
                showNotification('Has cerrado sesión exitosamente', 'success', 3000);
                
            } catch (error) {
                console.error('❌ Error al cerrar sesión:', error);
                showNotification('Error al cerrar sesión. Por favor, intenta de nuevo.', 'error', 5000);
            }
        };

        // --- Configuración de Event Listeners ---
        function setupNavigationEvents() {
            console.log('🚀 Inicializando aplicación...');
            
            // Verificar que las funciones estén disponibles
            if (typeof showInitialSections === 'undefined') {
                console.error('❌ showInitialSections no está definida');
                return;
            }
            if (typeof showAuthModal === 'undefined') {
                console.error('❌ showAuthModal no está definida');
                return;
            }
            if (typeof showMyCardsSection === 'undefined') {
                console.error('❌ showMyCardsSection no está definida');
                return;
            }
            if (typeof showInterchangesSection === 'undefined') {
                console.error('❌ showInterchangesSection no está definida');
                return;
            }
            if (typeof showProfileSection === 'undefined') {
                console.error('❌ showProfileSection no está definida');
                return;
            }
            if (typeof logoutUser === 'undefined') {
                console.error('❌ logoutUser no está definida');
                return;
            }

            console.log('✅ Todas las funciones están disponibles');

        }

        // Función para animar la Pokéball cambiante (removida - ya no se usa)

        // Función para generar elementos flotantes
        function generateFloatingElements() {
            const floatingBg = document.getElementById('floatingBackground');
            if (!floatingBg) return;
            
            // URLs de solo Pokéballs
            const pokemonImages = [
                'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png',
                'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png',
                'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png',
                'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png',
                'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/premier-ball.png',
                'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/luxury-ball.png',
                'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/quick-ball.png',
                'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/timer-ball.png'
            ];
            
            const sizes = ['small', 'medium', 'large'];
            const numElements = 15; // Número de elementos flotantes
            
            // Limpiar elementos existentes
            floatingBg.innerHTML = '';
            
            // Generar elementos con diferentes capas para parallax
            for (let i = 0; i < numElements; i++) {
                const element = document.createElement('img');
                const size = sizes[Math.floor(Math.random() * sizes.length)];
                const layer = i % 3; // Distribuir en 3 capas
                
                element.className = `floating-element ${size}`;
                element.src = pokemonImages[Math.floor(Math.random() * pokemonImages.length)];
                element.alt = 'Pokemon';
                
                // Posición aleatoria
                element.style.left = `${Math.random() * 100}%`;
                element.style.top = `${Math.random() * 100}%`;
                
                // Retraso aleatorio en la animación
                element.style.animationDelay = `${Math.random() * 20}s`;
                
                // Ajustar velocidad según la capa para efecto parallax
                if (layer === 0) {
                    element.style.animationDuration = '40s'; // Capa trasera más lenta
                    element.style.opacity = '0.08';
                } else if (layer === 1) {
                    element.style.animationDuration = '30s'; // Capa media
                    element.style.opacity = '0.12';
                } else {
                    element.style.animationDuration = '20s'; // Capa frontal más rápida
                    element.style.opacity = '0.15';
                }
                
                // Ajustar opacidad para modo oscuro
                if (document.body.classList.contains('dark-mode')) {
                    element.classList.add('dark-mode');
                    element.style.opacity = parseFloat(element.style.opacity) * 0.5;
                }
                
                floatingBg.appendChild(element);
            }
        }
        
        // Actualizar elementos flotantes cuando cambia el modo oscuro
        function updateFloatingElementsOpacity() {
            const elements = document.querySelectorAll('.floating-element');
            elements.forEach(el => {
                if (document.body.classList.contains('dark-mode')) {
                    el.classList.add('dark-mode');
                } else {
                    el.classList.remove('dark-mode');
                }
            });
        }
        
        // Función para configurar el sidebar
        function setupSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            
            // Función para abrir sidebar
            function openSidebar() {
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('show');
                hamburgerBtn.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevenir scroll del body
            }
            
            // Función para cerrar sidebar
            function closeSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('show');
                hamburgerBtn.classList.remove('active');
                document.body.style.overflow = ''; // Restaurar scroll
            }
            
            // Click en hamburguesa
            hamburgerBtn.addEventListener('click', () => {
                if (sidebar.classList.contains('open')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
            
            // Click en overlay
            sidebarOverlay.addEventListener('click', closeSidebar);
            
            // ESC para cerrar
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                    closeSidebar();
                }
            });
            
            // Configurar links del sidebar
            const sidebarLinks = {
                'sidebarHomeLink': () => {
                    closeSidebar();
                    showInitialSections();
                    window.scrollTo(0, 0);
                },
                'sidebarMyCardsLink': () => {
                    closeSidebar();
                    showMyCardsSection();
                },
                'sidebarInterchangesLink': () => {
                    closeSidebar();
                    showInterchangesSection();
                },
                'sidebarCollectionLink': () => {
                    closeSidebar();
                    // Ir directamente a Mi Perfil > Mi Colección
                    document.getElementById('profileLink')?.click();
                    setTimeout(() => {
                        const collectionTab = document.querySelector('[data-tab="collection"]');
                        if (collectionTab) collectionTab.click();
                    }, 100);
                },
                'sidebarInboxLink': () => {
                    closeSidebar();
                    document.getElementById('inboxLink')?.click();
                },
                'sidebarChatLink': () => {
                    closeSidebar();
                    document.getElementById('chatLink')?.click();
                },
                'sidebarHelpLink': () => {
                    closeSidebar();
                    showHelpSection();
                },
                'sidebarLoginLink': () => {
                    closeSidebar();
                    document.getElementById('loginLink')?.click();
                },
                'sidebarRegisterLink': () => {
                    closeSidebar();
                    document.getElementById('registerLink')?.click();
                },
                'sidebarLogoutLink': () => {
                    closeSidebar();
                    document.getElementById('logoutLink')?.click();
                }
            };
            
            // Asignar eventos a los links
            Object.keys(sidebarLinks).forEach(linkId => {
                const link = document.getElementById(linkId);
                if (link) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        sidebarLinks[linkId]();
                    });
                }
            });
            
            // Actualizar tema del sidebar cuando cambie el modo oscuro
            const updateSidebarTheme = () => {
                if (document.body.classList.contains('dark-mode')) {
                    sidebar.classList.add('dark');
                } else {
                    sidebar.classList.remove('dark');
                }
            };
            
            // Observar cambios en el modo oscuro
            const observer = new MutationObserver(updateSidebarTheme);
            observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
            
            // Aplicar tema inicial
            updateSidebarTheme();
            
            // Actualizar visibilidad de items según el estado de login
            window.updateSidebarVisibility = function() {
                const isLoggedIn = !!currentUser;
                
                // Items que solo se muestran cuando está logueado
                const loggedInItems = ['sidebarInboxLink', 'sidebarChatLink', 'sidebarLogoutLink', 'sidebarCommDivider'];
                loggedInItems.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.toggle('hidden', !isLoggedIn);
                    }
                });
                
                // Items que solo se muestran cuando NO está logueado
                const loggedOutItems = ['sidebarLoginLink', 'sidebarRegisterLink'];
                loggedOutItems.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.toggle('hidden', isLoggedIn);
                    }
                });
            };
        }
        
        // Función para animar números
        function animateNumber(element, start, end, duration) {
            const startTime = performance.now();
            const startValue = start;
            const endValue = end;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Función de easing para hacer la animación más suave
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                
                const currentValue = Math.floor(startValue + (endValue - startValue) * easeOutQuart);
                element.textContent = currentValue.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // ==============================================
        // FUNCIONES DEL HEADER MODERNO
        // ==============================================
        
        // Inicializar header moderno
        function initializeModernHeader() {
            console.log('🎨 Inicializando header moderno...');
            
            const header = document.getElementById('modernHeader');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            
            // Configurar hamburguesa moderna
            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', toggleModernHamburger);
            }
            
            // Configurar logo animado
            const logo = document.querySelector('.modern-logo');
            if (logo) {
                logo.addEventListener('mouseenter', () => {
                    logo.style.transform = 'scale(1.05) rotate(2deg)';
                });
                
                logo.addEventListener('mouseleave', () => {
                    logo.style.transform = 'scale(1) rotate(0deg)';
                });
            }
            
            // Configurar botones con efectos
            setupModernButtons();
            
            console.log('✅ Header moderno inicializado');
        }
        
        // Toggle hamburguesa moderna
        function toggleModernHamburger() {
            const hamburger = document.getElementById('hamburgerBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (hamburger && sidebar) {
                hamburger.classList.toggle('active');
                
                if (sidebar.classList.contains('open')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            }
        }
        
        
        // Configurar búsqueda inteligente
        function setupSmartSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchSuggestions = document.getElementById('searchSuggestions');
            
            if (!searchInput || !searchSuggestions) return;
            
            let searchTimeout;
            let currentSuggestions = [];
            
            // Debounce para búsqueda
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    hideSuggestions();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    performSmartSearch(query);
                }, 300);
            });
            
            // Mostrar sugerencias al hacer focus
            searchInput.addEventListener('focus', () => {
                if (currentSuggestions.length > 0) {
                    showSuggestions();
                }
            });
            
            // Ocultar sugerencias al hacer blur
            searchInput.addEventListener('blur', (e) => {
                // Delay para permitir clicks en sugerencias
                setTimeout(() => {
                    if (!searchSuggestions.contains(e.relatedTarget)) {
                        hideSuggestions();
                    }
                }, 200);
            });
            
            // Búsqueda inteligente
            async function performSmartSearch(query) {
                try {
                    // Simular búsqueda inteligente (aquí iría la lógica real)
                    const suggestions = await generateSmartSuggestions(query);
                    currentSuggestions = suggestions;
                    displaySuggestions(suggestions);
                } catch (error) {
                    console.error('Error en búsqueda inteligente:', error);
                }
            }
            
            // Generar sugerencias inteligentes
            async function generateSmartSuggestions(query) {
                if (query.length < 2) return [];
                
                // Sugerencias más realistas basadas en Pokémon TCG
                const suggestions = [];
                
                // Sugerencias de cartas populares
                const popularCards = [
                    'Pikachu', 'Charizard', 'Blastoise', 'Venusaur', 'Mewtwo', 
                    'Lugia', 'Ho-Oh', 'Rayquaza', 'Garchomp', 'Lucario',
                    'Greninja', 'Decidueye', 'Incineroar', 'Primarina'
                ];
                
                popularCards.forEach(card => {
                    if (card.toLowerCase().includes(query.toLowerCase())) {
                        suggestions.push({ 
                            type: 'card', 
                            text: card, 
                            icon: '⚡',
                            description: 'Carta Pokémon'
                        });
                    }
                });
                
                // Sugerencias de sets populares
                const popularSets = [
                    'Base', 'Jungle', 'Fossil', 'Team Rocket', 'Gym Heroes',
                    'Neo Genesis', 'Neo Discovery', 'Neo Destiny', 'Expedition',
                    'Aquapolis', 'Skyridge', 'Ruby & Sapphire', 'Diamond & Pearl'
                ];
                
                popularSets.forEach(set => {
                    if (set.toLowerCase().includes(query.toLowerCase())) {
                        suggestions.push({ 
                            type: 'set', 
                            text: set, 
                            icon: '📦',
                            description: 'Set de cartas'
                        });
                    }
                });
                
                // Sugerencias de tipos
                const types = [
                    'Fire', 'Water', 'Grass', 'Electric', 'Psychic', 'Fighting',
                    'Darkness', 'Metal', 'Dragon', 'Fairy', 'Colorless'
                ];
                
                types.forEach(type => {
                    if (type.toLowerCase().includes(query.toLowerCase())) {
                        suggestions.push({ 
                            type: 'type', 
                            text: type, 
                            icon: '🏷️',
                            description: 'Tipo de energía'
                        });
                    }
                });
                
                return suggestions.slice(0, 6); // Máximo 6 sugerencias
            }
            
            // Mostrar sugerencias
            function displaySuggestions(suggestions) {
                if (suggestions.length === 0) {
                    hideSuggestions();
                    return;
                }
                
                searchSuggestions.innerHTML = suggestions.map(suggestion => `
                    <div class="suggestion-item" data-type="${suggestion.type}">
                        <span class="suggestion-icon">${suggestion.icon}</span>
                        <div class="suggestion-content">
                            <span class="suggestion-text">${suggestion.text}</span>
                            <span class="suggestion-description">${suggestion.description || ''}</span>
                        </div>
                    </div>
                `).join('');
                
                showSuggestions();
                
                // Agregar eventos a las sugerencias
                searchSuggestions.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const text = item.querySelector('.suggestion-text').textContent;
                        searchInput.value = text;
                        hideSuggestions();
                        quickSearch(); // Ejecutar búsqueda
                    });
                });
            }
            
            function showSuggestions() {
                searchSuggestions.classList.remove('hidden');
                searchSuggestions.style.opacity = '0';
                searchSuggestions.style.transform = 'translateY(-10px)';
                
                requestAnimationFrame(() => {
                    searchSuggestions.style.transition = 'all 0.3s ease';
                    searchSuggestions.style.opacity = '1';
                    searchSuggestions.style.transform = 'translateY(0)';
                });
            }
            
            function hideSuggestions() {
                if (searchSuggestions.classList.contains('hidden')) return;
                
                searchSuggestions.style.transition = 'all 0.2s ease';
                searchSuggestions.style.opacity = '0';
                searchSuggestions.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    searchSuggestions.classList.add('hidden');
                }, 200);
            }
        }
        
        // Configurar animaciones de partículas
        function setupParticleAnimations() {
            const particles = document.querySelectorAll('.particle');
            
            particles.forEach((particle, index) => {
                // Animación aleatoria para cada partícula
                const delay = Math.random() * 2;
                const duration = 4 + Math.random() * 4;
                
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                
                // Efecto hover en partículas
                particle.addEventListener('mouseenter', () => {
                    particle.style.transform = 'scale(1.5)';
                    particle.style.background = 'rgba(255, 255, 255, 1)';
                });
                
                particle.addEventListener('mouseleave', () => {
                    particle.style.transform = 'scale(1)';
                    particle.style.background = 'rgba(255, 255, 255, 0.6)';
                });
            });
        }
        
        // Configurar botones modernos
        function setupModernButtons() {
            // Botones de navegación
            const navButtons = document.querySelectorAll('.modern-nav-btn, .modern-login-btn');
            
            navButtons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    button.style.transform = 'translateY(-2px) scale(1.05)';
                });
                
                button.addEventListener('mouseleave', () => {
                    button.style.transform = 'translateY(0) scale(1)';
                });
                
                // Efecto ripple
                button.addEventListener('click', createRippleEffect);
            });
            
            // Botón de búsqueda
            const searchBtn = document.querySelector('.modern-search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', () => {
                    searchBtn.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        searchBtn.style.transform = 'scale(1)';
                    }, 150);
                });
            }
        }
        
        // Crear efecto ripple
        function createRippleEffect(e) {
            const button = e.currentTarget;
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple');
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }
        
        // Agregar estilos para el efecto ripple
        const rippleStyles = `
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: scale(0);
                animation: ripple-animation 0.6s linear;
                pointer-events: none;
            }
            
            @keyframes ripple-animation {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
            
            .suggestion-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                cursor: pointer;
                transition: all 0.2s ease;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .suggestion-item:hover {
                background: rgba(255, 255, 255, 0.1);
                transform: translateX(4px);
            }
            
            .suggestion-item:last-child {
                border-bottom: none;
            }
            
            .suggestion-icon {
                font-size: 1.2rem;
                flex-shrink: 0;
            }
            
            .suggestion-content {
                display: flex;
                flex-direction: column;
                gap: 2px;
                flex: 1;
            }
            
            .suggestion-text {
                color: white;
                font-weight: 600;
                font-size: 0.95rem;
            }
            
            .suggestion-description {
                color: rgba(255, 255, 255, 0.7);
                font-size: 0.8rem;
                font-weight: 400;
            }
        `;
        
        // Inyectar estilos
        const styleSheet = document.createElement('style');
        styleSheet.textContent = rippleStyles;
        document.head.appendChild(styleSheet);

        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM cargado, configurando eventos...');
            
            // Inicializar búsqueda avanzada (opcional)
            setTimeout(() => {
                initAdvancedSearch();
            }, 1000);
            
            // Prueba de conectividad API
            console.log('🔍 Probando conectividad API...');
            fetch('https://tcgtrade-production.up.railway.app/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('✅ API conectada:', data);
                })
                .catch(error => {
                    console.error('❌ Error API:', error);
                });
            
            // Generar elementos flotantes
            generateFloatingElements();
            
            // ==============================================
            // FUNCIONALIDADES DEL HEADER MODERNO
            // ==============================================
            
            // Inicializar header moderno
            initializeModernHeader();
            
            
            // Configurar búsqueda inteligente
            setupSmartSearch();
            
            // Configurar animaciones de partículas
            setupParticleAnimations();
            
            // Configurar sidebar
            setupSidebar();
            
            // Configurar animación de estadísticas cuando entren en vista
            const statsObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !entry.target.dataset.animated) {
                        const element = entry.target;
                        const finalValue = parseInt(element.textContent.replace(/,/g, ''));
                        element.dataset.animated = 'true';
                        element.classList.add('count-animate');
                        animateNumber(element, 0, finalValue, 2000);
                    }
                });
            }, { threshold: 0.5 });
            
            // Observar elementos de estadísticas
            const totalUsers = document.getElementById('totalUsersCount');
            const totalTrades = document.getElementById('totalTradesCount');
            const globalTotalCards = document.getElementById('globalTotalCardsCount');
            
            if (totalUsers) statsObserver.observe(totalUsers);
            if (totalTrades) statsObserver.observe(totalTrades);
            if (globalTotalCards) statsObserver.observe(globalTotalCards);
            
            // CARGAR MODO OSCURO DESDE LOCALSTORAGE AL INICIO
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                const isDark = savedDarkMode === 'true';
                console.log('🌙 Cargando modo oscuro desde localStorage:', isDark);
                applyDarkMode(isDark);
                
                // El estado del botón se sincroniza automáticamente con las clases CSS
            }

            // Asignar referencias a elementos del DOM
            searchInput = document.getElementById('searchInput');
            searchResultsSection = document.getElementById('searchResults');
            heroSection = document.getElementById('heroSection');
            howItWorksSection = document.getElementById('howItWorksSection');
            cardsContainer = document.getElementById('cardsContainer');
            loadingSpinner = document.getElementById('loadingSpinner');
            noResultsMessage = document.getElementById('noResultsMessage');
            errorMessage = document.getElementById('errorMessage');
            
            authModal = document.getElementById('authModal');
            loginForm = document.getElementById('loginForm');
            registerForm = document.getElementById('registerForm');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginBtn = document.getElementById('loginBtn');
            loginError = document.getElementById('loginError');
            registerEmailInput = document.getElementById('registerEmail');
            registerPasswordInput = document.getElementById('registerPassword');
            confirmPasswordInput = document.getElementById('confirmPassword');
            registerBtn = document.getElementById('registerBtn');
            registerError = document.getElementById('registerError');
            closeAuthModalBtn = document.getElementById('closeAuthModalBtn');
            toggleToRegister = document.getElementById('toggleToRegister');
            toggleToLogin = document.getElementById('toggleToLogin');

            loginLink = document.getElementById('loginLink');
            registerLink = document.getElementById('registerLink');
            profileLink = document.getElementById('profileLink');
            logoutLink = document.getElementById('logoutLink');
            
            myCardsNavLink = document.getElementById('myCardsNavLink');
            myCardsLink = document.getElementById('myCardsLink');
            myCardsSection = document.getElementById('myCardsSection');
            myCardsContainer = document.getElementById('myCardsContainer');
            noMyCardsMessage = document.getElementById('noMyCardsMessage');
            myCardsErrorMessage = document.getElementById('myCardsErrorMessage');

            seriesFilter = document.getElementById('seriesFilter');
            setFilter = document.getElementById('setFilter');
            languageFilter = document.getElementById('languageFilter');
            applyFiltersBtn = document.getElementById('applyFiltersBtn');
            showAllSetCardsToggle = document.getElementById('showAllSetCardsToggle');

            interchangesSection = document.getElementById('interchangesSection');
            helpSection = document.getElementById('helpSection');
            
            // Inicializar elementos del perfil
            profileLink = document.getElementById('profileLink');
            profileSection = document.getElementById('profileSection');

            // Inicializar la aplicación después de un pequeño delay
            setTimeout(() => {
                setupNavigationEvents();
            }, 100);



            // Event listeners para tabs del perfil
            const profilePersonalTab = document.getElementById('profilePersonalTab');
            const profileDashboardTab = document.getElementById('profileDashboardTab');
            const profileCollectionTab = document.getElementById('profileCollectionTab');
            const profileTradesTab = document.getElementById('profileTradesTab');
            const profileSettingsTab = document.getElementById('profileSettingsTab');

            if (profilePersonalTab) {
                profilePersonalTab.addEventListener('click', () => switchProfileTab('personal'));
            }
            if (profileDashboardTab) {
                profileDashboardTab.addEventListener('click', () => switchProfileTab('dashboard'));
            }
            if (profileCollectionTab) {
                profileCollectionTab.addEventListener('click', () => switchProfileTab('collection'));
            }
            if (profileTradesTab) {
                profileTradesTab.addEventListener('click', () => switchProfileTab('trades'));
            }
            if (profileSettingsTab) {
                profileSettingsTab.addEventListener('click', () => switchProfileTab('settings'));
            }
            
            const profileRatingsTab = document.getElementById('profileRatingsTab');
            if (profileRatingsTab) {
                profileRatingsTab.addEventListener('click', () => switchProfileTab('ratings'));
            }

            // Event listeners para tabs de ayuda
            const helpGettingStartedTab = document.getElementById('helpGettingStartedTab');
            const helpTradingTab = document.getElementById('helpTradingTab');
            const helpCardConditionsTab = document.getElementById('helpCardConditionsTab');
            const helpAccountTab = document.getElementById('helpAccountTab');
            const helpFAQTab = document.getElementById('helpFAQTab');

            if (helpGettingStartedTab) {
                helpGettingStartedTab.addEventListener('click', () => switchHelpTab('getting-started'));
            }
            if (helpTradingTab) {
                helpTradingTab.addEventListener('click', () => switchHelpTab('trading'));
            }
            if (helpCardConditionsTab) {
                helpCardConditionsTab.addEventListener('click', () => switchHelpTab('card-conditions'));
            }
            if (helpAccountTab) {
                helpAccountTab.addEventListener('click', () => switchHelpTab('account'));
            }
            if (helpFAQTab) {
                helpFAQTab.addEventListener('click', () => switchHelpTab('faq'));
            }
            
            const helpNewFeaturesTab = document.getElementById('helpNewFeaturesTab');
            if (helpNewFeaturesTab) {
                helpNewFeaturesTab.addEventListener('click', () => switchHelpTab('newFeatures'));
            }

            // Event listeners para tabs de intercambios
            const tradesActiveTab = document.getElementById('tradesActiveTab');
            const tradesPendingTab = document.getElementById('tradesPendingTab');
            const tradesCompletedTab = document.getElementById('tradesCompletedTab');
            const tradesReceivedTab = document.getElementById('tradesReceivedTab');

            if (tradesActiveTab) {
                tradesActiveTab.addEventListener('click', () => switchTradeTab('active'));
            }
            if (tradesPendingTab) {
                tradesPendingTab.addEventListener('click', () => switchTradeTab('pending'));
            }
            if (tradesCompletedTab) {
                tradesCompletedTab.addEventListener('click', () => switchTradeTab('completed'));
            }
            if (tradesReceivedTab) {
                tradesReceivedTab.addEventListener('click', () => switchTradeTab('received'));
            }

            // Event listeners para botones de ayuda
            const searchHelpBtn = document.getElementById('searchHelpBtn');
            const contactSupportBtn = document.getElementById('contactSupportBtn');

            if (searchHelpBtn) {
                searchHelpBtn.addEventListener('click', () => {
                    console.log('🔍 Buscar ayuda clicked');
                    alert('Función de búsqueda de ayuda en desarrollo');
                });
            }

            if (contactSupportBtn) {
                contactSupportBtn.addEventListener('click', () => {
                    console.log('📧 Contactar soporte clicked');
                    alert('Función de contacto con soporte en desarrollo');
                });
            }

            // Event listeners para botones de intercambios
            const createTradeBtn = document.getElementById('createTradeBtn');
            const findTradesBtn = document.getElementById('findTradesBtn');

            if (createTradeBtn) {
                createTradeBtn.addEventListener('click', () => {
                    console.log('➕ Crear intercambio clicked');
                    showCreateTradeModal();
                });
            }

            if (findTradesBtn) {
                findTradesBtn.addEventListener('click', () => {
                    console.log('🔍 Buscar intercambios clicked');
                    alert('Función de búsqueda en desarrollo');
                });
            }

            // Event listener para el formulario de perfil personal
            const profilePersonalForm = document.getElementById('profilePersonalForm');
            if (profilePersonalForm) {
                profilePersonalForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProfileData();
                });
            }

            // Event listener para el botón cancelar
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');
            if (cancelProfileBtn) {
                cancelProfileBtn.addEventListener('click', () => {
                    loadUserInfo(); // Recargar datos originales
                    showProfileSaveMessage('Cambios cancelados', 'info');
                });
            }

            // Event listeners para cambio de contraseña
            const passwordChangeForm = document.getElementById('passwordChangeForm');
            if (passwordChangeForm) {
                passwordChangeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
            if (cancelPasswordBtn) {
                cancelPasswordBtn.addEventListener('click', () => {
                    document.getElementById('passwordChangeForm').reset();
                    showPasswordChangeMessage('Cambios cancelados', 'info');
                });
            }

            // Event listeners para modal
            if (closeAuthModalBtn) closeAuthModalBtn.addEventListener('click', hideAuthModal);
            if (toggleToRegister) toggleToRegister.addEventListener('click', (e) => { e.preventDefault(); showAuthModal('register'); });
            if (toggleToLogin) toggleToLogin.addEventListener('click', (e) => { e.preventDefault(); showAuthModal('login'); });
            
            // Event listeners para recuperación de contraseña
            const toggleToForgotPassword = document.getElementById('toggleToForgotPassword');
            const backToLogin = document.getElementById('backToLogin');
            const resetPasswordBtn = document.getElementById('resetPasswordBtn');
            const resetEmailInput = document.getElementById('resetEmail');
            const resetPasswordError = document.getElementById('resetPasswordError');
            const resetPasswordSuccess = document.getElementById('resetPasswordSuccess');
            
            if (toggleToForgotPassword) {
                toggleToForgotPassword.addEventListener('click', (e) => {
                    e.preventDefault();
                    showAuthModal('forgot');
                });
            }
            
            if (backToLogin) {
                backToLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    showAuthModal('login');
                });
            }
            
            // Función para manejar el reset de contraseña
            async function handlePasswordReset() {
                const email = resetEmailInput?.value;
                
                if (!email) {
                    if (resetPasswordError) {
                        resetPasswordError.textContent = 'Por favor, ingresa tu correo electrónico.';
                        resetPasswordError.classList.remove('hidden');
                    }
                    return;
                }
                
                // Ocultar mensajes anteriores
                if (resetPasswordError) resetPasswordError.classList.add('hidden');
                if (resetPasswordSuccess) resetPasswordSuccess.classList.add('hidden');
                
                try {
                    console.log('📧 Enviando email de recuperación a:', email);
                    await sendPasswordResetEmail(auth, email);
                    
                    // Mostrar mensaje de éxito con aviso de SPAM
                    if (resetPasswordSuccess) {
                        resetPasswordSuccess.innerHTML = `
                            <span class="block font-semibold">✅ ¡Email enviado exitosamente!</span>
                            <span class="block mt-1">📧 Enviado a: ${email}</span>
                            <span class="block mt-2 text-yellow-600 font-semibold">
                                ⚠️ IMPORTANTE: Revisa tu carpeta de SPAM/Correo no deseado
                            </span>
                            <span class="block text-xs mt-1">
                                El email puede tardar 1-2 minutos en llegar
                            </span>
                        `;
                        resetPasswordSuccess.classList.remove('hidden');
                    }
                    
                    // Limpiar el campo
                    if (resetEmailInput) resetEmailInput.value = '';
                    
                    // Volver al login después de 10 segundos (más tiempo para leer el aviso)
                    setTimeout(() => {
                        showAuthModal('login');
                    }, 10000);
                    
                } catch (error) {
                    console.error('❌ Error al enviar email de recuperación:', error);
                    
                    let errorMessage = 'Error al enviar el email de recuperación.';
                    
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No existe una cuenta con este correo electrónico.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'El formato del correo electrónico no es válido.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Demasiados intentos. Por favor, espera un momento.';
                    }
                    
                    if (resetPasswordError) {
                        resetPasswordError.textContent = errorMessage;
                        resetPasswordError.classList.remove('hidden');
                    }
                }
            }
            
            // Event listener para el botón de reset
            if (resetPasswordBtn) {
                resetPasswordBtn.addEventListener('click', handlePasswordReset);
            }
            
            // Event listener para Enter en el campo de email
            if (resetEmailInput) {
                resetEmailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handlePasswordReset();
                    }
                });
            }

            // Event listeners para filtros
            if (seriesFilter) {
                seriesFilter.addEventListener('change', () => {
                    const selectedSeries = seriesFilter.value;
                    if (selectedSeries === "") {
                        populateSetFilter(allSets);
                    } else {
                        const setsInSeries = allSets.filter(set => set.series === selectedSeries);
                        populateSetFilter(setsInSeries);
                    }
                    if (setFilter) setFilter.value = "";
                    if (showAllSetCardsToggle) {
                        showAllSetCardsToggle.checked = false;
                        showAllSetCardsToggle.disabled = selectedSeries === "";
                    }
                });
            }

            if (setFilter) {
                setFilter.addEventListener('change', () => {
                    if (showAllSetCardsToggle) {
                        showAllSetCardsToggle.disabled = !setFilter.value;
                        if (!setFilter.value) showAllSetCardsToggle.checked = false;
                    }
                });
            }

            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', () => {
                    console.log('🔍 Aplicando filtros...');
                    if (currentUser) {
                        loadMyCollection(currentUser.uid);
                    } else {
                        if (noMyCardsMessage) {
                            noMyCardsMessage.textContent = 'Debes iniciar sesión para aplicar filtros.';
                            noMyCardsMessage.classList.remove('hidden');
                        }
                    }
                });
            }

            // Event listener para el filtro de idioma (actualización automática)
            if (languageFilter) {
                languageFilter.addEventListener('change', () => {
                    console.log('🌍 Idioma seleccionado:', languageFilter.value);
                    if (currentUser) {
                        loadMyCollection(currentUser.uid);
                    }
                });
            }

            if (showAllSetCardsToggle) {
                showAllSetCardsToggle.addEventListener('change', () => {
                    if (currentUser && setFilter?.value) {
                        loadMyCollection(currentUser.uid);
                    } else if (showAllSetCardsToggle.checked) {
                        alert('Debes iniciar sesión y seleccionar una expansión.');
                        showAllSetCardsToggle.checked = false;
                    }
                });
            }

            // Función para manejar el login
            async function handleLogin() {
                console.log('🔐 handleLogin ejecutado');
                const email = loginEmailInput?.value;
                const password = loginPasswordInput?.value;
                
                console.log('📧 Email:', email);
                console.log('🔑 Password length:', password?.length);
                
                if (!email || !password) {
                    console.error('❌ Email o contraseña vacíos');
                    if (loginError) {
                        loginError.textContent = 'Por favor ingresa email y contraseña';
                        loginError.classList.remove('hidden');
                    }
                    return;
                }
                
                if (loginError) loginError.classList.add('hidden');

                try {
                    console.log('🚀 Intentando iniciar sesión con Firebase...');
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    console.log('✅ Inicio de sesión exitoso:', userCredential.user.email);
                    hideAuthModal();
                    console.log('✅ Modal cerrado');
                    showNotification('¡Bienvenido de nuevo!', 'success');
                } catch (error) {
                    console.error('❌ Error al iniciar sesión:', error.code, error.message);
                    let errorMessage = 'Error al iniciar sesión.';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No existe una cuenta con este correo electrónico.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Contraseña incorrecta.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Formato de correo inválido.';
                    } else if (error.code === 'auth/invalid-credential') {
                        errorMessage = 'Credenciales inválidas. Verifica tu email y contraseña.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Demasiados intentos fallidos. Intenta más tarde.';
                    }
                    if (loginError) {
                        loginError.textContent = errorMessage;
                        loginError.classList.remove('hidden');
                    }
                    showNotification(errorMessage, 'error');
                }
            }

            // Event listeners para autenticación - BOTÓN LOGIN
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }

            // Event listener para ENTER en el formulario de login
            if (loginForm) {
                // Agregar event listener a los campos de input del login
                const loginInputs = [loginEmailInput, loginPasswordInput];
                loginInputs.forEach(input => {
                    if (input) {
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                handleLogin();
                            }
                        });
                    }
                });
            }

            // Función para manejar el registro
            async function handleRegister() {
                    const username = document.getElementById('registerUsername')?.value?.trim();
                    const email = registerEmailInput?.value;
                    const password = registerPasswordInput?.value;
                    const confirmPassword = confirmPasswordInput?.value;
                    if (registerError) registerError.classList.add('hidden');

                    // Validaciones
                    if (!username) {
                        if (registerError) {
                            registerError.textContent = 'El nombre de usuario es obligatorio.';
                            registerError.classList.remove('hidden');
                        }
                        return;
                    }

                    if (username.length < 3) {
                        if (registerError) {
                            registerError.textContent = 'El nombre de usuario debe tener al menos 3 caracteres.';
                            registerError.classList.remove('hidden');
                        }
                        return;
                    }

                    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                        if (registerError) {
                            registerError.textContent = 'El nombre de usuario solo puede contener letras, números y guiones bajos.';
                            registerError.classList.remove('hidden');
                        }
                        return;
                    }

                    if (password !== confirmPassword) {
                        if (registerError) {
                            registerError.textContent = 'Las contraseñas no coinciden.';
                            registerError.classList.remove('hidden');
                        }
                        return;
                    }

                    if (password.length < 6) {
                        if (registerError) {
                            registerError.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                            registerError.classList.remove('hidden');
                        }
                        return;
                    }

                    try {
                        console.log('🚀 Iniciando proceso de registro...');
                        console.log('📝 Username:', username);
                        console.log('📧 Email:', email);
                        
                        // NOTA: La verificación de nombre de usuario duplicado está deshabilitada
                        // porque requeriría permisos especiales en Firestore para leer todos los usuarios.
                        // En producción, esto se manejaría con una Cloud Function o un índice especial.
                        console.log('ℹ️ Saltando verificación de nombre de usuario duplicado (requiere configuración adicional)');

                        console.log('🔐 Creando cuenta con Firebase Auth...');
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        console.log('✅ Cuenta creada exitosamente:', user.uid);

                        // Crear perfil completo en Firestore
                        console.log('💾 Guardando perfil en Firestore...');
                        await setDoc(doc(db, 'users', user.uid), {
                            username: username, // Username único elegido en el registro
                            name: '', // Nombre real (se llenará después en el perfil)
                            lastName: '', // Apellido (se llenará después en el perfil)
                            email: user.email,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        console.log('✅ Perfil guardado en Firestore');

                        hideAuthModal();
                        console.log('🎉 Usuario registrado exitosamente:', user.email, 'Username:', username);
                        
                        // Mostrar mensaje de éxito
                        alert(`¡Bienvenido ${username}! Tu cuenta ha sido creada exitosamente.`);
                        
                    } catch (error) {
                        console.error('❌ Error detallado al registrar:', error);
                        console.error('Código de error:', error.code);
                        console.error('Mensaje de error:', error.message);
                        
                        let errorMessage = 'Error al registrar. Por favor, intenta de nuevo.';
                        
                        // Errores de Firebase Auth
                        if (error.code === 'auth/email-already-in-use') {
                            errorMessage = 'Este correo ya está registrado.';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = 'Formato de correo inválido.';
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = 'La contraseña es demasiado débil. Debe tener al menos 6 caracteres.';
                        } else if (error.code === 'auth/network-request-failed') {
                            errorMessage = 'Error de conexión. Verifica tu conexión a internet.';
                        } else if (error.code === 'auth/too-many-requests') {
                            errorMessage = 'Demasiados intentos. Por favor, espera un momento.';
                        } else if (error.code === 'auth/operation-not-allowed') {
                            errorMessage = 'El registro está temporalmente deshabilitado.';
                        } else if (error.message) {
                            // Si hay un mensaje de error específico, mostrarlo
                            errorMessage = `Error: ${error.message}`;
                        }
                        
                        if (registerError) {
                            registerError.textContent = errorMessage;
                            registerError.classList.remove('hidden');
                        }
                    }
            }

            // Event listener para BOTÓN REGISTRO
            if (registerBtn) {
                registerBtn.addEventListener('click', handleRegister);
            }

            // Event listener para ENTER en el formulario de registro
            if (registerForm) {
                const registerUsernameInput = document.getElementById('registerUsername');
                const registerInputs = [registerUsernameInput, registerEmailInput, registerPasswordInput, confirmPasswordInput];
                registerInputs.forEach(input => {
                    if (input) {
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                handleRegister();
                            }
                        });
                    }
                });
            }

            // Configurar tabs del buzón
            const inboxTabs = document.querySelectorAll('.inbox-tab');
            inboxTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remover clase active de todos los tabs
                    inboxTabs.forEach(t => {
                        t.classList.remove('active', 'border-purple-500', 'text-purple-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Añadir clase active al tab clickeado
                    tab.classList.add('active', 'border-purple-500', 'text-purple-600');
                    tab.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Ocultar todos los contenidos
                    document.querySelectorAll('.inbox-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Mostrar el contenido correspondiente
                    if (tab.id === 'inboxNotificationsTab') {
                        document.getElementById('inboxNotificationsContent').classList.remove('hidden');
                        loadNotifications();
                    } else if (tab.id === 'inboxProposalsTab') {
                        document.getElementById('inboxProposalsContent').classList.remove('hidden');
                        loadReceivedProposals();
                    } else if (tab.id === 'inboxSentProposalsTab') {
                        document.getElementById('inboxSentProposalsContent').classList.remove('hidden');
                        loadSentProposals();
                    }
                });
            });

            // Event listener delegado para botones de chat (como respaldo)
            document.addEventListener('click', function(e) {
                if (e.target && e.target.textContent && e.target.textContent.includes('💭 Chat')) {
                    e.preventDefault();
                    const button = e.target;
                    const tradeId = button.getAttribute('data-trade-id');
                    const userId = button.getAttribute('data-user-id');
                    const tradeTitle = button.getAttribute('data-trade-title');
                    
                    console.log('Chat button clicked via delegated event:', { tradeId, userId, tradeTitle });
                    
                    if (window.openTradeChat && tradeId) {
                        window.openTradeChat(tradeId, userId || '', tradeTitle || '');
                    } else {
                        console.error('openTradeChat no está disponible o falta tradeId');
                    }
                }
            });

            // Escuchar cambios de autenticación
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                window.currentUser = user; // Actualizar referencia global
                console.log('🔐 onAuthStateChanged ejecutado. Usuario:', !!user, user?.email);

                // Inicializar sistema de chat si el usuario está autenticado
                if (user && !chatManager) {
                    console.log('💬 Inicializando sistema de chat...');
                    try {
                        chatManager = new ChatManager(auth, db);
                        chatUI = new ChatUI(chatManager);
                        const chatDebugger = new ChatDebugger(chatManager);
                        
                        window.chatManager = chatManager; // Hacer disponible globalmente
                        window.chatUI = chatUI; // Hacer disponible globalmente
                        window.chatDebugger = chatDebugger; // Hacer disponible globalmente
                        
                        console.log('✅ Sistema de chat inicializado correctamente');
                    } catch (error) {
                        console.error('❌ Error al inicializar chat:', error);
                    }
                    
                    // Inicializar sistema de migración y sincronización
                    try {
                        console.log('🔄 Inicializando sistema de migración y sincronización...');
                        dataMigration = new DataMigration(auth, db);
                        dataSync = new DataSync(auth, db);
                        
                        window.dataMigration = dataMigration; // Hacer disponible globalmente
                        window.dataSync = dataSync; // Hacer disponible globalmente
                        
                        console.log('✅ Sistema de migración y sincronización inicializado');
                        
                        // Ejecutar migración automática
                        setTimeout(async () => {
                            console.log('🚀 Iniciando migración automática...');
                            const migrationSuccess = await dataMigration.migrateAllData();
                            if (migrationSuccess) {
                                console.log('🎉 Migración completada exitosamente');
                                
                                // Iniciar sincronización en tiempo real
                                await startDataSync();
                            } else {
                                console.log('⚠️ Migración parcial o fallida');
                            }
                        }, 2000);
                        
                    } catch (error) {
                        console.error('❌ Error al inicializar migración/sincronización:', error);
                    }
                    
                    // Escuchar actualizaciones de mensajes no leídos
                    window.addEventListener('unreadCountUpdated', (event) => {
                        // Contar CHATS con mensajes sin leer (no mensajes totales)
                        let chatsWithUnread = 0;
                        for (const [chatId, count] of chatManager.unreadCounts) {
                            if (count > 0) {
                                chatsWithUnread++;
                            }
                        }
                        
                        const chatBadge = document.getElementById('chatBadge');
                        if (chatBadge) {
                            if (chatsWithUnread > 0) {
                                chatBadge.textContent = chatsWithUnread;
                                chatBadge.classList.remove('hidden');
                            } else {
                                chatBadge.classList.add('hidden');
                            }
                        }
                        
                        // Actualizar también el bocadillo de chats
                        if (chatUI && typeof chatUI.updateMinimizedBar === 'function') {
                            chatUI.updateMinimizedBar();
                        }
                    });
                    
                    // Cargar chats persistidos después de un pequeño delay
                    setTimeout(async () => {
                        console.log('⏰ Cargando chats persistidos después de autenticación...');
                        if (chatUI && typeof chatUI.loadPersistedChats === 'function') {
                            await chatUI.loadPersistedChats();
                        }
                        // Actualizar badge de chats
                        if (chatUI && typeof chatUI.updateChatBadge === 'function') {
                            await chatUI.updateChatBadge();
                        }
                        
                        // Verificar si hay chats guardados y mostrar barra si es necesario
                        try {
                            const userId = currentUser.uid;
                            const savedState = localStorage.getItem(`chatsState_${userId}`);
                            if (savedState) {
                                const chatsState = JSON.parse(savedState);
                                if (chatsState.activeChats && chatsState.activeChats.length > 0) {
                                    console.log('💬 Hay chats guardados, verificando barra minimizada...');
                                    // Si no hay barra visible, crearla
                                    if (!document.getElementById('minimized-chats-bar')) {
                                        chatUI.createMinimizedBar();
                                        chatUI.updateMinimizedBar();
                                    }
                                }
                            }
                        } catch (e) {
                            console.log('No se pudo verificar estado de chats:', e);
                        }
                    }, 1500); // Esperar 1.5 segundos para asegurar que todo esté inicializado
                    
                    // Actualizar badge de chats cada 10 segundos
                    setInterval(async () => {
                        if (chatUI && typeof chatUI.updateChatBadge === 'function') {
                            await chatUI.updateChatBadge();
                        }
                    }, 10000);
                    
                } else if (!user && chatManager) {
                    // Limpiar chat si el usuario cierra sesión
                    console.log('💬 Limpiando sistema de chat...');
                    chatManager.disconnectAll();
                    chatManager = null;
                    chatUI = null;
                    
                    // Limpiar sistema de migración y sincronización
                    if (dataSync) {
                        console.log('🔄 Desconectando sincronización...');
                        dataSync.disconnectAll();
                        dataSync = null;
                    }
                    dataMigration = null;
                }

                // Obtener referencias a los elementos de navegación
                const loginLink = document.getElementById('loginLink');
                const registerLink = document.getElementById('registerLink');
                const logoutLink = document.getElementById('logoutLink');
                const profileLink = document.getElementById('profileLink');
                const myCardsNavLink = document.getElementById('myCardsNavLink');
                const inboxLink = document.getElementById('inboxLink');
                const chatLink = document.getElementById('chatLink');

                // Mis Cartas siempre visible
                if (myCardsNavLink) myCardsNavLink.classList.remove('hidden');

                if (user) {
                    // Usuario conectado: ocultar login/register, mostrar logout y buzón
                    if (loginLink) loginLink.classList.add('hidden');
                    if (registerLink) registerLink.classList.add('hidden');
                    if (logoutLink) logoutLink.classList.remove('hidden');
                    // Mi Perfil siempre visible (funciona diferente según estado)
                    if (profileLink) profileLink.classList.remove('hidden');
                    // Mostrar buzón y chat para usuarios autenticados
                    if (inboxLink) inboxLink.classList.remove('hidden');
                    if (chatLink) chatLink.classList.remove('hidden');
                    
                    // Actualizar badge de notificaciones
                    updateNotificationBadge();
                    
                    // Actualizar sidebar
                    if (window.updateSidebarVisibility) {
                        window.updateSidebarVisibility();
                    }
                    
                    // CARGAR MODO OSCURO INMEDIATAMENTE AL INICIAR SESIÓN
                    try {
                        console.log('🌙 Cargando preferencia de modo oscuro del usuario...');
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        const userData = userDoc.data();
                        
                        if (userData && userData.darkMode !== undefined) {
                            console.log('🌙 Aplicando modo oscuro:', userData.darkMode);
                            applyDarkMode(userData.darkMode);
                            
                            // El estado del botón se sincroniza automáticamente con las clases CSS
                        } else {
                            console.log('🌙 No hay preferencia guardada, manteniendo modo actual');
                        }
                    } catch (error) {
                        console.error('Error al cargar preferencia de modo oscuro:', error);
                    }
                } else {
                    console.log('🔓 Usuario desconectado, actualizando navegación...');
                    
                    // Usuario desconectado: mostrar login/register, ocultar logout
                    if (loginLink) {
                        loginLink.classList.remove('hidden');
                        console.log('✅ Login link mostrado');
                    } else {
                        console.warn('⚠️ loginLink no encontrado');
                    }
                    
                    if (registerLink) {
                        registerLink.classList.remove('hidden');
                        console.log('✅ Register link mostrado');
                    } else {
                        console.warn('⚠️ registerLink no encontrado');
                    }
                    
                    if (logoutLink) {
                        logoutLink.classList.add('hidden');
                        console.log('✅ Logout link ocultado');
                    } else {
                        console.warn('⚠️ logoutLink no encontrado');
                    }
                    
                    // Ocultar chat y buzón para usuarios no autenticados
                    if (chatLink) chatLink.classList.add('hidden');
                    if (inboxLink) inboxLink.classList.add('hidden');
                    // OCULTAR Mi Perfil cuando no hay usuario autenticado
                    if (profileLink) profileLink.classList.add('hidden');
                    
                    // Actualizar sidebar
                    if (window.updateSidebarVisibility) {
                        window.updateSidebarVisibility();
                    }
                    
                    // Opcional: Restaurar modo por defecto al cerrar sesión
                    // Si quieres que al cerrar sesión vuelva al modo claro, descomenta estas líneas:
                    // applyDarkMode(false);
                    // const darkModeToggle = document.getElementById('darkModeToggle');
                    // if (darkModeToggle) darkModeToggle.checked = false;
                }
            });

            // Event listener para búsqueda
            let searchTimeout;
            if (searchInput) {
                searchInput.addEventListener('keyup', (event) => {
                    clearTimeout(searchTimeout);
                    const query = event.target.value.trim();
                    // Eliminar mínimo de caracteres - buscar siempre
                    searchTimeout = setTimeout(() => {
                        fetchCards(query);
                    }, 500);
                });
            }

            // Inicializar la Pokéball animada (removida)

            // Mostrar secciones iniciales
            showInitialSections();

            // Cargar sets para filtros de búsqueda
            fetchSetsAndPopulateSearchFilters();

            // Filtros de búsqueda
            const filterSeriesSelect = document.getElementById('filterSeriesSelect');
            const filterSetSelect = document.getElementById('filterSetSelect');
            const filterRaritySelect = document.getElementById('filterRaritySelect');
            const filterTypeSelect = document.getElementById('filterTypeSelect');
            const filterLanguageSelect = document.getElementById('filterLanguageSelect');
            const applySearchFiltersBtn = document.getElementById('applySearchFiltersBtn');
            const clearSearchFiltersBtn = document.getElementById('clearSearchFiltersBtn');

            // Event listeners para actualizar filtros automáticamente
            if (filterSetSelect) {
                filterSetSelect.addEventListener('change', () => {
                    searchFiltersState.set = filterSetSelect.value;
                });
            }
            
            if (filterRaritySelect) {
                filterRaritySelect.addEventListener('change', () => {
                    searchFiltersState.rarity = filterRaritySelect.value;
                });
            }
            
            if (filterTypeSelect) {
                filterTypeSelect.addEventListener('change', () => {
                    searchFiltersState.type = filterTypeSelect.value;
                });
            }
            
            if (filterLanguageSelect) {
                filterLanguageSelect.addEventListener('change', () => {
                    searchFiltersState.language = filterLanguageSelect.value;
                });
            }

            if (applySearchFiltersBtn) {
                applySearchFiltersBtn.addEventListener('click', () => {
                    searchFiltersState.series = filterSeriesSelect?.value || '';
                    searchFiltersState.set = filterSetSelect?.value || '';
                    searchFiltersState.rarity = filterRaritySelect?.value || '';
                    searchFiltersState.type = filterTypeSelect?.value || '';
                    searchFiltersState.language = filterLanguageSelect?.value || '';
                    const q = (searchInput?.value || '').trim();
                    
                    // Aplicar filtros incluso sin término de búsqueda específico
                    if (q.length >= 2) {
                        fetchCards(q);
                    } else if (searchFiltersState.series || searchFiltersState.set || 
                               searchFiltersState.rarity || searchFiltersState.type || 
                               searchFiltersState.language) {
                        // Si hay filtros pero no término de búsqueda, usar búsqueda general
                        console.log('🔍 Aplicando filtros sin término de búsqueda:', searchFiltersState);
                        fetchCards('pokemon');
                    } else {
                        showNotification('Por favor ingresa un término de búsqueda o selecciona filtros', 'warning');
                    }
                });
            }
            if (clearSearchFiltersBtn) {
                clearSearchFiltersBtn.addEventListener('click', () => {
                    if (filterSeriesSelect) filterSeriesSelect.value = '';
                    if (filterSetSelect) filterSetSelect.value = '';
                    if (filterRaritySelect) filterRaritySelect.value = '';
                    if (filterTypeSelect) filterTypeSelect.value = '';
                    if (filterLanguageSelect) filterLanguageSelect.value = '';
                    searchFiltersState.series = '';
                    searchFiltersState.set = '';
                    searchFiltersState.rarity = '';
                    searchFiltersState.type = '';
                    searchFiltersState.language = '';
                    const q = (searchInput?.value || '').trim();
                    if (q.length >= 3) fetchCards(q);
                });
            }

            // Event listeners para enlaces de navegación
            const loginLinkNav = document.getElementById('loginLink');
            const registerLinkNav = document.getElementById('registerLink');
            const logoutLinkNav = document.getElementById('logoutLink');
            const profileLinkNav = document.getElementById('profileLink');
            const myCardsNavLinkNav = document.getElementById('myCardsNavLink');
            const inboxLinkNav = document.getElementById('inboxLink');
            const chatLinkNav = document.getElementById('chatLink');
            
            console.log('🔍 Enlaces encontrados:', {
                loginLink: !!loginLinkNav,
                registerLink: !!registerLinkNav,
                logoutLink: !!logoutLinkNav,
                profileLink: !!profileLinkNav,
                myCardsNavLink: !!myCardsNavLinkNav,
                inboxLink: !!inboxLinkNav,
                chatLink: !!chatLinkNav
            });

            // Event listener para login
            if (loginLinkNav) {
                loginLinkNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('🔐 Login link clicked');
                    showAuthModal('login');
                });
            }

            // Event listener para register
            if (registerLinkNav) {
                registerLinkNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('📝 Register link clicked');
                    showAuthModal('register');
                });
            }

            // Event listener para logout
            if (logoutLinkNav) {
                logoutLinkNav.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('🚪 Logout link clicked');
                    try {
                        await signOut(auth);
                        console.log('✅ Usuario desconectado');
                        showNotification('Sesión cerrada exitosamente', 'success');
                        // Volver a la página principal
                        showInitialSections();
                    } catch (error) {
                        console.error('❌ Error al cerrar sesión:', error);
                        showNotification('Error al cerrar sesión', 'error');
                    }
                });
            }

            // Event listener para Mi Perfil
            if (profileLinkNav) {
                profileLinkNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('👤 Profile link clicked');
                    // El botón de perfil solo es visible cuando hay usuario autenticado
                    // Por lo tanto, no necesitamos verificar autenticación aquí
                    showProfileSection();
                });
            }

            // Event listener para Mis Cartas
            if (myCardsNavLinkNav) {
                myCardsNavLinkNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('🎴 My cards link clicked');
                    showMyCardsSection();
                });
            }

            // Event listener para Buzón
            if (inboxLinkNav) {
                inboxLinkNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('📬 Inbox link clicked');
                    showInboxSection();
                });
            }

            // Event listener para Chat
            if (chatLinkNav) {
                chatLinkNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('💬 Chat link clicked');
                    // Verificar si hay sistema de chat inicializado
                    if (window.chatUI && window.chatUI.toggleMinimizedBar) {
                        window.chatUI.toggleMinimizedBar();
                    } else {
                        console.warn('⚠️ Sistema de chat no inicializado');
                        showNotification('El sistema de chat se está cargando...', 'info');
                    }
                });
            }

        });

        // Función para mostrar detalles de carta (mejorada)
        window.showCardDetailsOnly = async (cardId, cardName, imageUrl, setName, series, number) => {
            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            // Mostrar modal con loading
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Detalles de la Carta</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <!-- Loading spinner -->
                    <div id="cardDetailsLoading" class="flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400">Cargando detalles...</span>
                    </div>
                    
                    <!-- Contenido de detalles (se llenará dinámicamente) -->
                    <div id="cardDetailsContent" class="hidden">
                        <!-- Se llenará con datos de la API -->
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            try {
                // Obtener datos completos de la carta desde la API
                const response = await fetch(`/api/pokemontcg/cards?q=${encodeURIComponent(cardName)}&pageSize=50`);
                const data = await response.json();
                const card = data.data?.find(c => c.id === cardId) || data.data?.[0];
                
                if (card) {
                    // Ocultar loading y mostrar contenido
                    document.getElementById('cardDetailsLoading').classList.add('hidden');
                    document.getElementById('cardDetailsContent').classList.remove('hidden');
                    
                    // Generar contenido detallado
                    document.getElementById('cardDetailsContent').innerHTML = generateCardDetailsHTML(card);
                } else {
                    // Fallback si no se encuentra la carta
                    document.getElementById('cardDetailsLoading').innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-600 dark:text-gray-400">No se pudieron cargar los detalles completos</p>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Cerrar
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error cargando detalles de carta:', error);
                // Mostrar error
                document.getElementById('cardDetailsLoading').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-600 dark:text-red-400">Error al cargar los detalles</p>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                            Cerrar
                        </button>
                    </div>
                `;
            }
        };

        // Función para generar HTML detallado de la carta
        function generateCardDetailsHTML(card) {
            const safeCardName = (card.name || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeImageUrl = (card.images?.large || card.images?.small || '/images/card-placeholder.svg').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeSetName = (card.set?.name || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeSeries = (card.set?.series || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeNumber = (card.number || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeCardId = (card.id || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            
            // Obtener precios si están disponibles
            const tcgplayerPrices = card.tcgplayer?.prices || {};
            const cardmarketPrices = card.cardmarket?.prices || {};
            
            // Función para formatear precios
            const formatPrice = (price) => price ? `$${parseFloat(price).toFixed(2)}` : 'N/A';
            
            // Función para obtener color del tipo
            const getTypeColor = (type) => {
                const colors = {
                    'Fire': 'bg-red-500',
                    'Water': 'bg-blue-500',
                    'Grass': 'bg-green-500',
                    'Electric': 'bg-yellow-500',
                    'Psychic': 'bg-purple-500',
                    'Fighting': 'bg-orange-600',
                    'Darkness': 'bg-gray-700',
                    'Metal': 'bg-gray-400',
                    'Dragon': 'bg-indigo-500',
                    'Fairy': 'bg-pink-400',
                    'Colorless': 'bg-gray-300'
                };
                return colors[type] || 'bg-gray-400';
            };
            
            return `
                <!-- Header con gradiente -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 rounded-lg p-6 text-white mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold mb-1">${safeCardName}</h2>
                            <p class="text-blue-100 text-sm">${safeSetName} • ${safeSeries}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">#${safeNumber}</div>
                            <div class="text-blue-100 text-xs">${card.rarity || 'Common'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Imagen de la carta -->
                    <div class="text-center">
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-lg">
                            <img src="${safeImageUrl}" alt="${safeCardName}" 
                                 class="w-full max-w-sm mx-auto rounded-lg"
                                 onerror="this.src='/images/card-placeholder.svg'">
                        </div>
                    </div>
                    
                    <!-- Información detallada -->
                    <div class="space-y-4">
                        <!-- Información básica -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                                <span class="mr-2">📋</span>
                                Información Básica
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                        <span class="text-blue-600 dark:text-blue-400 text-sm">🏷️</span>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Nombre</p>
                                        <p class="font-semibold text-gray-900 dark:text-white">${safeCardName}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                        <span class="text-green-600 dark:text-green-400 text-sm">📦</span>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Set</p>
                                        <p class="font-semibold text-gray-900 dark:text-white">${safeSetName}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                        <span class="text-purple-600 dark:text-purple-400 text-sm">🎯</span>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Serie</p>
                                        <p class="font-semibold text-gray-900 dark:text-white">${safeSeries}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                        <span class="text-orange-600 dark:text-orange-400 text-sm">⭐</span>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Rareza</p>
                                        <p class="font-semibold text-gray-900 dark:text-white">${card.rarity || 'Common'}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                        <span class="text-gray-600 dark:text-gray-400 text-sm">🔢</span>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">ID</p>
                                        <p class="font-mono text-xs text-gray-900 dark:text-white">${safeCardId}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tipos y subtipos -->
                        ${(card.types?.length > 0 || card.subtypes?.length > 0) ? `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                                <span class="mr-2">⚡</span>
                                Tipos
                            </h3>
                            <div class="space-y-3">
                                ${card.types?.length > 0 ? `
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Tipos de Energía</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${card.types.map(type => `
                                            <span class="px-3 py-1 ${getTypeColor(type)} text-white rounded-full text-sm font-semibold">
                                                ${type}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                ${card.subtypes?.length > 0 ? `
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Subtipos</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${card.subtypes.map(subtype => `
                                            <span class="px-2 py-1 bg-emerald-500 text-white rounded-full text-xs font-medium">
                                                ${subtype}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Precios -->
                        ${(Object.keys(tcgplayerPrices).length > 0 || Object.keys(cardmarketPrices).length > 0) ? `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-lg border border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                                <span class="mr-2">💰</span>
                                Precios de Mercado
                            </h3>
                            <div class="space-y-4">
                                ${Object.keys(tcgplayerPrices).length > 0 ? `
                                <div>
                                    <div class="flex items-center mb-2">
                                        <div class="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center mr-2">
                                            <span class="text-white text-xs font-bold">T</span>
                                        </div>
                                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">TCGPlayer</h4>
                                    </div>
                                    <div class="grid grid-cols-1 gap-2">
                                        ${Object.entries(tcgplayerPrices).map(([condition, prices]) => `
                                            <div class="bg-gray-50 dark:bg-gray-700 rounded p-3">
                                                <div class="font-semibold text-gray-700 dark:text-gray-300 mb-1 capitalize text-sm">${condition}</div>
                                                <div class="space-y-1 text-xs">
                                                    ${prices.low ? `<div class="flex justify-between"><span class="text-gray-500">Bajo:</span><span class="font-semibold text-green-600">${formatPrice(prices.low)}</span></div>` : ''}
                                                    ${prices.mid ? `<div class="flex justify-between"><span class="text-gray-500">Medio:</span><span class="font-semibold text-blue-600">${formatPrice(prices.mid)}</span></div>` : ''}
                                                    ${prices.high ? `<div class="flex justify-between"><span class="text-gray-500">Alto:</span><span class="font-semibold text-red-600">${formatPrice(prices.high)}</span></div>` : ''}
                                                    ${prices.market ? `<div class="flex justify-between"><span class="text-gray-500">Mercado:</span><span class="font-semibold text-purple-600">${formatPrice(prices.market)}</span></div>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${Object.keys(cardmarketPrices).length > 0 ? `
                                <div>
                                    <div class="flex items-center mb-2">
                                        <div class="w-5 h-5 bg-orange-500 rounded-full flex items-center justify-center mr-2">
                                            <span class="text-white text-xs font-bold">C</span>
                                        </div>
                                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">Cardmarket</h4>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded p-3">
                                        <div class="grid grid-cols-3 gap-2 text-xs">
                                            ${cardmarketPrices.averageSellPrice ? `<div class="text-center"><div class="text-gray-500">Promedio</div><div class="font-semibold text-green-600">${formatPrice(cardmarketPrices.averageSellPrice)}</div></div>` : ''}
                                            ${cardmarketPrices.lowPrice ? `<div class="text-center"><div class="text-gray-500">Bajo</div><div class="font-semibold text-blue-600">${formatPrice(cardmarketPrices.lowPrice)}</div></div>` : ''}
                                            ${cardmarketPrices.trendPrice ? `<div class="text-center"><div class="text-gray-500">Tendencia</div><div class="font-semibold text-purple-600">${formatPrice(cardmarketPrices.trendPrice)}</div></div>` : ''}
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Botones de acción -->
                <div class="mt-6 flex flex-wrap gap-3 justify-center">
                    <button onclick="addCardDirectly('${safeCardId}', '${safeCardName}', '${safeImageUrl}', '${safeSetName}', '${safeSeries}', '${safeNumber}')" 
                            class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold transition-colors">
                        + Añadir a Colección
                    </button>
                    <button onclick="showCardOffers('${safeCardName}', '${safeSetName}', '${safeImageUrl}')" 
                            class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold transition-colors">
                        🤝 Ver Intercambios
                    </button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold transition-colors">
                        Cerrar
                    </button>
                </div>
            `;
        }

        // Función para mostrar modal de confirmación personalizado
        window.showAddCardModal = (cardId, cardName, imageUrl, setName, series, number) => {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full shadow-xl">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 text-center">Añadir a Colección</h3>
                            
                            <!-- Vista previa de la carta -->
                            <div class="flex flex-col items-center mb-4">
                                <img src="${imageUrl}" alt="${cardName}" class="w-32 h-44 object-contain rounded mb-3">
                                <div class="text-center">
                                    <p class="font-semibold text-gray-900 dark:text-white">${cardName}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${setName} • #${number}</p>
                                </div>
                            </div>
                            
                            <!-- Selector de condición -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Condición de la carta
                                </label>
                                <select id="cardConditionSelect" 
                                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-400">
                                    ${Object.values(CARD_CONDITIONS).map(condition => 
                                        `<option value="${condition.code}" ${condition.code === 'NM' ? 'selected' : ''}>
                                            ${condition.icon} ${condition.code} - ${condition.name}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <!-- Selector de idioma -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Idioma de la carta
                                </label>
                                <select id="cardLanguageSelect" 
                                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-400">
                                    <option value="Español" selected>🇪🇸 Español</option>
                                    <option value="Inglés">🇺🇸 Inglés</option>
                                    <option value="Francés">🇫🇷 Francés</option>
                                    <option value="Italiano">🇮🇹 Italiano</option>
                                    <option value="Alemán">🇩🇪 Alemán</option>
                                    <option value="Portugués">🇵🇹 Portugués</option>
                                    <option value="Japonés">🇯🇵 Japonés</option>
                                    <option value="Chino">🇨🇳 Chino</option>
                                    <option value="Coreano">🇰🇷 Coreano</option>
                                    <option value="Otro">🌍 Otro</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 justify-end">
                            <button id="cancelAddCard" 
                                    class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                                Cancelar
                            </button>
                            <button id="confirmAddCard" 
                                    class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                Añadir a Colección
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Event listeners
                const cancelBtn = modal.querySelector('#cancelAddCard');
                const confirmBtn = modal.querySelector('#confirmAddCard');
                const conditionSelect = modal.querySelector('#cardConditionSelect');
                const languageSelect = modal.querySelector('#cardLanguageSelect');
                
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(null);
                });
                
                confirmBtn.addEventListener('click', () => {
                    const selectedCondition = conditionSelect.value;
                    const selectedLanguage = languageSelect.value;
                    modal.remove();
                    resolve({ condition: selectedCondition, language: selectedLanguage });
                });
                
                // Cerrar con ESC o click fuera
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                });
                
                document.addEventListener('keydown', function escHandler(e) {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', escHandler);
                        resolve(null);
                    }
                });
            });
        };

        // Función para añadir carta directamente (botón separado)
        window.addCardDirectly = async (cardId, cardName, imageUrl, setName, series, number) => {
            if (!currentUser) {
                showNotification('Inicia sesión para añadir cartas a tu colección', 'warning', 4000);
                showAuthModal('login');
                return;
            }

            const result = await showAddCardModal(cardId, cardName, imageUrl, setName, series, number);
            
            if (result) {
                addCardToCollection(cardId, cardName, imageUrl, setName, series, number, result.condition, result.language);
                if (typeof loadUserCollection === 'function') {
                    loadUserCollection();
                }
                if (typeof loadProfileStats === 'function') {
                    loadProfileStats();
                }
            }
        };

        // Mantener función original para compatibilidad (deprecated)
        window.showCardDetails = window.addCardDirectly;

        // Función para añadir carta a la colección
        async function addCardToCollection(cardId, cardName, imageUrl, setName, series, number, condition = 'NM', language = 'Español') {
            if (!currentUser) return;

            try {
                // Primero verificar si la carta ya existe
                const cardRef = doc(db, 'users', currentUser.uid, 'my_cards', cardId);
                const cardDoc = await getDoc(cardRef);
                
                if (cardDoc.exists()) {
                    // Si existe, incrementar la cantidad
                    const currentData = cardDoc.data();
                    const currentQuantity = currentData.quantity || 1;
                    await setDoc(cardRef, {
                        ...currentData,
                        quantity: currentQuantity + 1,
                        lastUpdated: new Date()
                    });
                    showNotification(`¡Carta "${cardName}" añadida! Ahora tienes ${currentQuantity + 1} copias.`, 'success', 4000);
                } else {
                    // Si no existe, crear nueva entrada con cantidad 1
                    const cardData = {
                        id: cardId,
                        name: cardName,
                        imageUrl: imageUrl,
                        set: setName,
                        series: series,
                        number: number,
                        condition: condition,
                        language: language,
                        setId: cardId.split('-')[0], // Extraer setId del cardId
                        quantity: 1,
                        addedAt: new Date()
                    };
                    await setDoc(cardRef, cardData);
                    showNotification(`¡Carta "${cardName}" añadida a tu colección!`, 'success', 4000);
                }
            } catch (error) {
                console.error('Error al añadir carta:', error);
                showNotification('Error al añadir la carta. Inténtalo de nuevo.', 'error', 5000);
            }
        }

        // Función para mostrar modal de agregar cartas por set
        window.showBulkAddModal = async () => {
            if (!currentUser) {
                showNotification('Inicia sesión para añadir cartas a tu colección', 'warning');
                showAuthModal('login');
                return;
            }

            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                            ➕ Agregar Cartas por Set
                        </h2>
                        <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                onclick="this.closest('.fixed').remove()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Selector de Set -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Selecciona un Set:
                        </label>
                        <select id="bulkSetSelector" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                            <option value="">Cargando sets...</option>
                        </select>
                    </div>
                    
                    <!-- Filtros y controles -->
                    <div class="mb-4 flex flex-wrap gap-2">
                        <button id="selectAllBtn" class="btn-secondary px-3 py-1 rounded text-sm" disabled>
                            ✅ Seleccionar Todas
                        </button>
                        <button id="deselectAllBtn" class="btn-secondary px-3 py-1 rounded text-sm" disabled>
                            ❌ Deseleccionar Todas
                        </button>
                        <span class="text-sm text-gray-600 dark:text-gray-400 ml-auto">
                            Seleccionadas: <span id="selectedCount">0</span>
                        </span>
                    </div>
                    
                    <!-- Contenedor de cartas -->
                    <div class="overflow-y-auto max-h-[50vh] border dark:border-gray-700 rounded-lg p-4">
                        <style>
                            .card-hover-container {
                                position: relative;
                                z-index: 1;
                            }
                            .card-hover-container:hover {
                                z-index: 999;
                            }
                            .card-hover-image {
                                transition: transform 0.2s ease, box-shadow 0.2s ease;
                                transform-origin: left center;
                            }
                            .card-hover-image:hover {
                                transform: scale(3);
                                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                                position: relative;
                                z-index: 1000;
                                background: white;
                                border-radius: 0.375rem;
                            }
                            .dark .card-hover-image:hover {
                                background: rgb(31, 41, 55);
                            }
                        </style>
                        <div id="bulkCardsContainer" class="text-center text-gray-500 dark:text-gray-400 py-8">
                            Selecciona un set para ver las cartas disponibles
                        </div>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="btn-secondary px-4 py-2 rounded" onclick="this.closest('.fixed').remove()">
                            Cancelar
                        </button>
                        <button id="bulkAddBtn" class="btn-primary px-4 py-2 rounded" disabled>
                            ➕ Agregar Seleccionadas (0)
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cargar sets disponibles
            loadAvailableSets();
            
            // Event listeners
            const setSelector = document.getElementById('bulkSetSelector');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const bulkAddBtn = document.getElementById('bulkAddBtn');
            
            setSelector.addEventListener('change', (e) => {
                if (e.target.value) {
                    loadSetCards(e.target.value);
                }
            });
            
            selectAllBtn.addEventListener('click', () => selectAllCards(true));
            deselectAllBtn.addEventListener('click', () => selectAllCards(false));
            bulkAddBtn.addEventListener('click', () => addSelectedCards());
        };

        // Cargar sets disponibles (INCLUYE TCGDEX)
        async function loadAvailableSets() {
            const selector = document.getElementById('bulkSetSelector');
            if (!selector) return;
            
            try {
                // Cargar sets de ambas APIs
                const [pokemonResponse, tcgdexResponse] = await Promise.allSettled([
                    fetch('https://tcgtrade-production.up.railway.app/api/pokemontcg/sets'),
                    fetch('/api/tcgdex/sets')
                ]);
                
                let allSets = [];
                
                // Procesar sets de Pokemon TCG
                if (pokemonResponse.status === 'fulfilled' && pokemonResponse.value.ok) {
                    const data = await pokemonResponse.value.json();
                    const pokemonSets = data.data || [];
                    allSets = [...pokemonSets];
                }
                
                // Procesar sets de TCGdex
                if (tcgdexResponse.status === 'fulfilled' && tcgdexResponse.value.ok) {
                    const data = await tcgdexResponse.value.json();
                    const tcgdexSets = data.data || [];
                    
                    // Añadir sets de TCGdex que no estén duplicados
                    tcgdexSets.forEach(tcgSet => {
                        const exists = allSets.some(set => 
                            set.id === tcgSet.id || 
                            (set.name === tcgSet.name && set.releaseDate === tcgSet.releaseDate)
                        );
                        if (!exists) {
                            allSets.push({
                                ...tcgSet,
                                source: 'tcgdex'
                            });
                        }
                    });
                }
                
                // Ordenar sets por fecha de lanzamiento (más recientes primero)
                allSets.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));
                
                selector.innerHTML = '<option value="">Selecciona un set...</option>';
                
                // Agrupar por fuente
                const pokemonTCGSets = allSets.filter(s => s.source !== 'tcgdex');
                const tcgdexSets = allSets.filter(s => s.source === 'tcgdex');
                
                // Añadir sets de Pokemon TCG
                if (pokemonTCGSets.length > 0) {
                    const optgroup1 = document.createElement('optgroup');
                    optgroup1.label = '🌍 Pokemon TCG (Internacional)';
                    pokemonTCGSets.forEach(set => {
                        const option = document.createElement('option');
                        option.value = set.id;
                        option.dataset.source = 'pokemontcg';
                        option.textContent = `${set.displayName || set.name} (${set.total || set.printedTotal || 0} cartas)`;
                        optgroup1.appendChild(option);
                    });
                    selector.appendChild(optgroup1);
                }
                
                // Añadir sets de TCGdex
                if (tcgdexSets.length > 0) {
                    const optgroup2 = document.createElement('optgroup');
                    optgroup2.label = '🌏 TCGdex (Japonés/Coreano/Chino)';
                    tcgdexSets.forEach(set => {
                        const option = document.createElement('option');
                        option.value = set.id;
                        option.dataset.source = 'tcgdex';
                        
                        // Crear indicadores de idioma mejorados
                        const langIndicators = set.languageIndicators || [];
                        let langBadges = '';
                        
                        if (langIndicators.length === 1) {
                            // Un solo idioma
                            const langClass = langIndicators[0] === 'JP' ? 'lang-indicator-jp' : 
                                            langIndicators[0] === 'KO' ? 'lang-indicator-ko' : 
                                            'lang-indicator-ch';
                            langBadges = `<span class="lang-indicator ${langClass}">${langIndicators[0]}</span>`;
                        } else if (langIndicators.length > 1) {
                            // Múltiples idiomas
                            langBadges = `<span class="lang-indicator lang-indicator-multi">${langIndicators.join('/')}</span>`;
                        }
                        
                        // Añadir banderas también
                        const flags = set.availableLanguages?.map(l => {
                            switch(l) {
                                case 'ja': return '🇯🇵';
                                case 'ko': return '🇰🇷';
                                case 'zh-cn': 
                                case 'zh-tw': return '🇨🇳';
                                default: return '';
                            }
                        }).filter(Boolean).join('') || '';
                        
                        // Usar innerHTML para incluir el HTML del badge
                        const displayText = `${set.displayName || set.name} ${flags} (${set.total || set.printedTotal || 0} cartas)`;
                        option.textContent = displayText;
                        // Guardar indicadores como data attribute para uso posterior
                        option.dataset.langIndicators = langIndicators.join(',');
                        option.dataset.languages = JSON.stringify(set.availableLanguages || []);
                        optgroup2.appendChild(option);
                    });
                    selector.appendChild(optgroup2);
                }
            } catch (error) {
                console.error('Error al cargar sets:', error);
                selector.innerHTML = '<option value="">Error al cargar sets</option>';
            }
        }

        // Cargar cartas de un set (INCLUYE TCGDEX)
        async function loadSetCards(setId) {
            const container = document.getElementById('bulkCardsContainer');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const selector = document.getElementById('bulkSetSelector');
            
            if (!container || !selector) return;
            
            // Obtener la fuente del set seleccionado
            const selectedOption = selector.options[selector.selectedIndex];
            const source = selectedOption?.dataset?.source || 'pokemontcg';
            
            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mb-4"></div>
                    <p class="text-lg text-gray-600 dark:text-gray-300">Cargando cartas del set...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Esto puede tardar unos segundos</p>
                </div>
            `;
            selectAllBtn.disabled = true;
            deselectAllBtn.disabled = true;
            
            try {
                let response;
                if (source === 'tcgdex') {
                    // Usar API de TCGdex
                    response = await fetch(`/api/tcgdex/cards?set=${setId}`);
                } else {
                    // Usar API de Pokemon TCG
                    response = await fetch(`https://tcgtrade-production.up.railway.app/api/pokemontcg/cards?q=set.id:${setId}&pageSize=250&orderBy=number`);
                }
                
                if (!response.ok) throw new Error('Error al cargar cartas');
                
                const data = await response.json();
                const cards = data.data || [];
                
                if (cards.length === 0) {
                    container.innerHTML = '<div class="text-center py-4">No se encontraron cartas</div>';
                    return;
                }
                
                // Crear tabla de cartas
                container.innerHTML = `
                    <table class="w-full">
                        <thead>
                            <tr class="border-b dark:border-gray-600">
                                <th class="text-left p-2 w-10">
                                    <input type="checkbox" id="selectAllCheckbox" class="rounded">
                                </th>
                                <th class="text-left p-2">#</th>
                                <th class="text-left p-2">Imagen</th>
                                <th class="text-left p-2">Nombre</th>
                                <th class="text-left p-2">Rareza</th>
                                <th class="text-left p-2 w-20">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody id="cardsTableBody">
                            ${cards.map(card => `
                                <tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="p-2">
                                        <input type="checkbox" class="card-checkbox rounded" 
                                               data-card-id="${card.id}"
                                               data-card-name="${card.displayName || card.name}"
                                               data-card-image="${card.images.small}"
                                               data-card-set="${card.set?.displayName || card.set?.name || ''}"
                                               data-card-series="${card.set?.series || ''}"
                                               data-card-number="${card.number}">
                                    </td>
                                    <td class="p-2 text-sm">${card.number}</td>
                                    <td class="p-2">
                                        <div class="card-hover-container">
                                            <img src="${card.images?.small || '/images/card-placeholder.svg'}" 
                                                 alt="${card.displayName || card.name}" 
                                                 class="card-hover-image w-12 h-16 object-contain cursor-pointer"
                                                 loading="lazy"
                                                 onerror="this.src='/images/card-placeholder.svg'"
                                                 onclick="window.open('${card.images?.large || card.images?.small || '#'}', '_blank')">
                                        </div>
                                    </td>
                                    <td class="p-2 font-medium">${card.displayName || card.name}</td>
                                    <td class="p-2 text-sm">${card.rarity || 'Common'}</td>
                                    <td class="p-2">
                                        <input type="number" min="1" max="99" value="1" 
                                               class="card-quantity w-16 px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"
                                               data-card-id="${card.id}">
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Habilitar botones
                selectAllBtn.disabled = false;
                deselectAllBtn.disabled = false;
                
                // Event listeners para checkboxes
                const checkboxes = container.querySelectorAll('.card-checkbox');
                checkboxes.forEach(cb => {
                    cb.addEventListener('change', updateSelectedCount);
                });
                
                // Checkbox para seleccionar todas
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                selectAllCheckbox.addEventListener('change', (e) => {
                    checkboxes.forEach(cb => cb.checked = e.target.checked);
                    updateSelectedCount();
                });
                
            } catch (error) {
                console.error('Error al cargar cartas del set:', error);
                container.innerHTML = '<div class="text-center py-4 text-red-500">Error al cargar las cartas</div>';
            }
        }

        // Seleccionar/deseleccionar todas las cartas
        function selectAllCards(select) {
            const checkboxes = document.querySelectorAll('.card-checkbox');
            checkboxes.forEach(cb => cb.checked = select);
            document.getElementById('selectAllCheckbox').checked = select;
            updateSelectedCount();
        }

        // Actualizar contador de seleccionadas
        function updateSelectedCount() {
            const selected = document.querySelectorAll('.card-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = selected;
            
            const bulkAddBtn = document.getElementById('bulkAddBtn');
            bulkAddBtn.disabled = selected === 0;
            bulkAddBtn.textContent = `➕ Agregar Seleccionadas (${selected})`;
        }

        // Agregar cartas seleccionadas
        async function addSelectedCards() {
            const selected = document.querySelectorAll('.card-checkbox:checked');
            if (selected.length === 0) return;
            
            const bulkAddBtn = document.getElementById('bulkAddBtn');
            bulkAddBtn.disabled = true;
            bulkAddBtn.textContent = 'Agregando...';
            
            let addedCount = 0;
            const errors = [];
            
            for (const checkbox of selected) {
                const cardId = checkbox.dataset.cardId;
                const quantityInput = document.querySelector(`.card-quantity[data-card-id="${cardId}"]`);
                const quantity = parseInt(quantityInput.value) || 1;
                
                try {
                    // Agregar cada carta con la cantidad especificada
                    for (let i = 0; i < quantity; i++) {
                        await addCardToCollection(
                            cardId,
                            checkbox.dataset.cardName,
                            checkbox.dataset.cardImage,
                            checkbox.dataset.cardSet,
                            checkbox.dataset.cardSeries,
                            checkbox.dataset.cardNumber,
                            'NM', // Condición por defecto
                            'Español' // Idioma por defecto
                        );
                        addedCount++;
                    }
                } catch (error) {
                    console.error(`Error al agregar ${checkbox.dataset.cardName}:`, error);
                    errors.push(checkbox.dataset.cardName);
                }
            }
            
            // Cerrar modal
            document.querySelector('.fixed').remove();
            
            // Mostrar resultado
            if (errors.length === 0) {
                showNotification(`✅ ${addedCount} cartas agregadas exitosamente`, 'success');
            } else {
                showNotification(`⚠️ ${addedCount} cartas agregadas. ${errors.length} errores.`, 'warning');
            }
            
            // Recargar colección
            if (typeof loadUserCollection === 'function') {
                loadUserCollection();
            }
        }

        // Función para cargar más resultados
        window.loadMoreResults = async (query) => {
            console.log('🔄 Intentando cargar más resultados para:', query);
            
            if (errorMessage) errorMessage.classList.add('hidden');
            showLoadingSpinner();
            
            try {
                // Intentar con wildcard pero menos resultados
                const encodedQuery = encodeURIComponent(query.toLowerCase());
                const moreUrl = `https://tcgtrade-production.up.railway.app/api/pokemontcg/cards?q=${encodedQuery}&pageSize=50`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // Más tiempo
                
                const response = await fetch(moreUrl, {
                    signal: controller.signal,
                    headers: { 'Content-Type': 'application/json' }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    const cards = data.data || [];
                    
                    // Limpiar contenedor y mostrar nuevos resultados
                    cardsContainer.innerHTML = '';
                    
                    if (cards.length > 0) {
                        // Usar la función de renderizado estándar para consistencia
                        renderCardsFromData(cards);
                        
                        if (errorMessage) {
                            errorMessage.innerHTML = `✅ ¡Éxito! Cargadas ${cards.length} cartas adicionales.`;
                            errorMessage.classList.remove('hidden');
                        }
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error al cargar más resultados:', error);
                if (errorMessage) {
                    errorMessage.textContent = '❌ No se pudieron cargar más resultados. La API está muy lenta en este momento.';
                    errorMessage.classList.remove('hidden');
                }
            } finally {
                hideLoadingSpinner();
            }
        };

        // Función de búsqueda súper rápida (solo 10 resultados)
        window.quickSearch = async () => {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (query.length > 0 && query.length < 2) {
                alert('Por favor, escribe al menos 2 caracteres para buscar.');
                return;
            }
            
            console.log('🚀 Búsqueda rápida iniciada para:', query);
            
            if (cardsContainer) cardsContainer.innerHTML = '';
            if (noResultsMessage) noResultsMessage.classList.add('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');
            
            showLoadingSpinner();
            showSearchResults();
            
            try {
                const encodedQuery = encodeURIComponent(query.toLowerCase());
                // Búsqueda súper específica y rápida
                const quickUrl = `https://tcgtrade-production.up.railway.app/api/pokemontcg/cards?q=${encodedQuery}&pageSize=10`;
                
                console.log('🚀 Quick URL:', quickUrl);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // Solo 5 segundos
                
                const response = await fetch(quickUrl, {
                    signal: controller.signal,
                    headers: { 'Content-Type': 'application/json' }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    const cards = data.data || [];
                    
                    console.log('🚀 Quick search success:', cards.length, 'cards');
                    
                    if (cards.length > 0) {
                        // Usar la función de renderizado estándar para consistencia
                        renderCardsFromData(cards);
                        
                        if (errorMessage) {
                            errorMessage.innerHTML = `✅ Búsqueda rápida: ${cards.length} cartas encontradas. <button onclick="fetchCards('${query}')" class="bg-blue-500 text-white px-3 py-1 rounded ml-2">🔍 Buscar Más</button>`;
                            errorMessage.classList.remove('hidden');
                        }
                    } else {
                        if (noResultsMessage) {
                            noResultsMessage.textContent = `Búsqueda rápida: No se encontraron cartas para "${query}".`;
                            noResultsMessage.classList.remove('hidden');
                        }
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('❌ Quick search error:', error);
                if (errorMessage) {
                    errorMessage.textContent = '⚡ Búsqueda rápida falló. Prueba la búsqueda normal.';
                    errorMessage.classList.remove('hidden');
                }
            } finally {
                hideLoadingSpinner();
            }
        };

        // Hacer funciones disponibles globalmente
        // Hacer funciones disponibles globalmente
        window.showAuthModal = showAuthModal;
        window.hideAuthModal = hideAuthModal;
        window.showMyCardsSection = showMyCardsSection;
        window.showHelpSection = showHelpSection;
        window.showInterchangesSection = showInterchangesSection;
        window.showProfileSection = showProfileSection;
        window.showInitialSections = showInitialSections;
        window.fetchCards = fetchCards;
        window.editTrade = editTrade;
        window.deleteTrade = deleteTrade;
        window.proposeTrade = proposeTrade;
        window.viewTradeDetails = viewTradeDetails;
        window.createConditionSelector = createConditionSelector;
        window.showConditionInfo = showConditionInfo;
        window.getConditionColor = getConditionColor;
        window.getConditionIcon = getConditionIcon;
        window.calculateCollectionValue = calculateCollectionValue;
        window.formatCurrency = formatCurrency;

        // Cargar y renderizar Mi Colección
        async function loadUserCollection() {
            const grid = document.getElementById('myCardsGrid');
            const status = document.getElementById('myCardsStatus');
            if (!grid) return;
            if (!currentUser) {
                if (status) status.textContent = 'Inicia sesión para ver tu colección';
                grid.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-8">
                        <p>No hay cartas en tu colección</p>
                    </div>
                `;
                return;
            }

            try {
                if (status) status.textContent = 'Cargando tu colección...';
                const cardsRef = collection(db, 'users', currentUser.uid, 'my_cards');
                const snap = await getDocs(cardsRef);
                const cards = [];
                snap.forEach(d => cards.push({ id: d.id, ...d.data() }));

                if (cards.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center text-gray-500 py-8">
                            <p>No hay cartas en tu colección</p>
                        </div>
                    `;
                } else {
                    renderMyCards(cards);
                }
                if (status) status.textContent = '';
            } catch (err) {
                console.error('Error al cargar colección:', err);
                if (status) status.textContent = 'Error al cargar tu colección';
            }
        }

        function renderMyCards(cards) {
            const container = document.getElementById('myCardsGrid');
            if (!container) return;
            
            // Cambiar el contenedor a diseño de lista
            container.className = 'space-y-1 border rounded-lg bg-white dark:bg-gray-800';
            container.innerHTML = '';
            
            if (cards.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No hay cartas en tu colección</div>';
                return;
            }
            
            cards.forEach((card, index) => {
                const imageUrl = card.imageUrl || '';
                const name = card.name || card.id;
                const setName = (typeof card.set === 'string' ? card.set : card.set?.name) || 'Set';
                const number = card.number || '';
                const language = card.language || 'Español';
                const condition = card.condition || 'NM';
                
                const row = document.createElement('div');
                row.className = 'relative flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 h-16 overflow-visible';
                if (index < cards.length - 1) {
                    row.className += ' border-b';
                }
                
                // Icono de imagen con hover
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'w-10 h-10 flex items-center justify-center bg-transparent rounded cursor-pointer absolute left-3 top-1/2 -translate-y-1/2 z-10';
                imgWrapper.title = 'Pasa el mouse para ver imagen';
                imgWrapper.innerHTML = '<span class="text-xl">🎴</span>';
                
                // Contenedor de imagen con hover
                const imgContainer = document.createElement('div');
                imgContainer.className = 'hidden absolute left-14 top-1/2 -translate-y-1/2 z-30';
                imgContainer.style.pointerEvents = 'none';
                
                const imgEl = document.createElement('img');
                imgEl.src = imageUrl || 'https://placehold.co/400x550/a0aec0/ffffff?text=Sin+imagen';
                imgEl.alt = name || 'Carta';
                imgEl.className = 'w-64 h-auto object-contain rounded-lg shadow-2xl border-2 border-gray-200';
                imgEl.onerror = () => { imgEl.src = 'https://placehold.co/400x550/a0aec0/ffffff?text=Error'; };
                
                imgContainer.appendChild(imgEl);
                row.appendChild(imgContainer);
                
                // Eventos de hover
                imgWrapper.addEventListener('mouseenter', () => { 
                    imgContainer.classList.remove('hidden');
                });
                
                imgWrapper.addEventListener('mouseleave', () => { 
                    imgContainer.classList.add('hidden');
                });
                
                // Información de la carta
                const info = document.createElement('div');
                info.className = 'flex-1 min-w-0 pl-16';
                info.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                                                    <span class="font-semibold text-gray-900 dark:text-white">${name}</span>
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">En colección</span>
                            </div>
                            <div class="text-xs text-gray-600">
                                #${number} · ${setName} · ${language} · ${condition}
                            </div>
                        </div>
                        <button class="btn-secondary px-3 py-1.5 rounded text-xs" onclick="removeCardFromCollection('${card.id || name}')">
                            Eliminar
                        </button>
                    </div>
                `;
                
                row.appendChild(imgWrapper);
                row.appendChild(info);
                container.appendChild(row);
            });
        }

        // Estado de filtros de búsqueda
        const searchFiltersState = {
            series: '', set: '', rarity: '', type: '', language: '', subtype: '', hasImage: '', hasPrice: ''
        };

        // Estado de paginación de búsqueda
        let lastSearchBase = '';
        let searchPage = 1;
        let searchPageSize = 20;
        let searchTotal = 0;
        let searchCache = new Map(); // Cache para resultados de búsqueda
        let currentSearchId = null; // ID único para cada búsqueda

        function buildCardsQuery(baseQuery) {
            // Para nuestro endpoint combinado, solo devolvemos la query base
            // Los filtros se pasan como parámetros separados
            return baseQuery;
        }

        function buildCardsApiUrl(baseQuery, page, pageSize) {
            const withFilters = buildCardsQuery(baseQuery);
            const qParam = encodeURIComponent(withFilters);
            const pageParam = page ? `&page=${page}` : '';
            const seriesParam = searchFiltersState.series ? `&series=${encodeURIComponent(searchFiltersState.series)}` : '';
            const setParam = searchFiltersState.set ? `&set=${encodeURIComponent(searchFiltersState.set)}` : '';
            const rarityParam = searchFiltersState.rarity ? `&rarity=${encodeURIComponent(searchFiltersState.rarity)}` : '';
            const typeParam = searchFiltersState.type ? `&type=${encodeURIComponent(searchFiltersState.type)}` : '';
            const languageParam = searchFiltersState.language ? `&language=${encodeURIComponent(searchFiltersState.language)}` : '';
            const subtypeParam = searchFiltersState.subtype ? `&subtype=${encodeURIComponent(searchFiltersState.subtype)}` : '';
            const hasImageParam = searchFiltersState.hasImage ? `&hasImage=${searchFiltersState.hasImage}` : '';
            const hasPriceParam = searchFiltersState.hasPrice ? `&hasPrice=${searchFiltersState.hasPrice}` : '';
            
            // Usar URL relativa para que funcione tanto en local como en producción
            const baseUrl = window.location.origin;
            const finalUrl = `${baseUrl}/api/pokemontcg/cards?q=${qParam}${pageParam}&pageSize=${pageSize}${seriesParam}${setParam}${rarityParam}${typeParam}${languageParam}${subtypeParam}${hasImageParam}${hasPriceParam}`;
            
            console.log('🔗 buildCardsApiUrl generando URL:');
            console.log('  - Base query:', baseQuery);
            console.log('  - With filters:', withFilters);
            console.log('  - searchFiltersState:', searchFiltersState);
            console.log('  - URL final:', finalUrl);
            
            return finalUrl;
        }

        function renderPagination(totalCount, page, pageSize) {
            const pagination = document.getElementById('searchPagination');
            if (!pagination) return;
            pagination.innerHTML = '';
            if (!totalCount || totalCount <= pageSize) return;

            const totalPages = Math.ceil(totalCount / pageSize);
            const maxButtons = 7;
            const start = Math.max(1, page - 3);
            const end = Math.min(totalPages, start + maxButtons - 1);

            const makeBtn = (label, targetPage, isActive = false, disabled = false) => {
                const btn = document.createElement('button');
                btn.textContent = label;
                btn.className = `px-3 py-1 rounded ${isActive ? 'bg-orange-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600'} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                if (!disabled && !isActive) {
                    btn.addEventListener('click', () => goToSearchPage(targetPage));
                }
                return btn;
            };

            pagination.appendChild(makeBtn('«', 1, false, page === 1));
            pagination.appendChild(makeBtn('‹', Math.max(1, page - 1), false, page === 1));

            for (let p = start; p <= end; p++) {
                pagination.appendChild(makeBtn(String(p), p, p === page));
            }

            pagination.appendChild(makeBtn('›', Math.min(totalPages, page + 1), false, page === totalPages));
            pagination.appendChild(makeBtn('»', totalPages, false, page === totalPages));
        }

        async function goToSearchPage(targetPage) {
            // Verificar si ya tenemos esta página en cache
            const cacheKey = `${currentSearchId}_${targetPage}`;
            if (searchCache.has(cacheKey)) {
                console.log('⚡ Loading from cache:', targetPage);
                const cachedData = searchCache.get(cacheKey);
                searchPage = targetPage;
                renderCardsFromData(cachedData.cards);
                renderPagination(cachedData.totalCount, searchPage, searchPageSize);
                return;
            }

            // Si no está en cache, hacer la llamada a la API
            searchPage = targetPage;
            const apiUrl = buildCardsApiUrl(lastSearchBase, searchPage, searchPageSize);
            console.log('🌐 Fetching page:', searchPage, apiUrl);

            // Mostrar loading instantáneo
            showPageLoading();

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000);
            try {
                const response = await fetch(apiUrl, { signal: controller.signal, headers: { 'Content-Type': 'application/json' } });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                const cards = data.data || [];
                cardsContainer.innerHTML = '';
                cards.forEach((card) => {
                    // Función para escapar caracteres especiales
                    const escapeForOnclick = (str) => {
                        return String(str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                    };
                    
                    const safeCardId = escapeForOnclick(card.id);
                    const safeCardName = escapeForOnclick(card.name);
                    const safeSetName = escapeForOnclick(card.set?.name || 'N/A');
                    const safeSeries = escapeForOnclick(card.set?.series || 'N/A');
                    const safeNumber = escapeForOnclick(card.number || 'N/A');
                    const safeImageUrl = escapeForOnclick(card.images?.small);

                    const row = document.createElement('div');
                    row.className = 'relative flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 h-16 overflow-visible';
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'w-10 h-10 flex items-center justify-center bg-transparent rounded cursor-pointer absolute left-3 top-1/2 -translate-y-1/2 z-10';
                    imgWrapper.title = 'Pasa el mouse para ver imagen';
                    imgWrapper.innerHTML = '<span class="text-xl">🎴</span>';
                    
                    // Crear contenedor de imagen con hover
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'hidden absolute left-14 top-1/2 -translate-y-1/2 z-30';
                    imgContainer.style.pointerEvents = 'none';
                    
                    const imgEl = document.createElement('img');
                    imgEl.src = (card.images?.large || card.images?.small) || 'https://placehold.co/400x550/a0aec0/ffffff?text=Sin+imagen';
                    imgEl.alt = card.name || 'Carta';
                    imgEl.className = 'w-64 h-auto object-contain rounded-lg shadow-2xl border-2 border-gray-200';
                    imgEl.onerror = () => { imgEl.src = 'https://placehold.co/400x550/a0aec0/ffffff?text=Error'; };
                    
                    imgContainer.appendChild(imgEl);
                    row.appendChild(imgContainer);
                    
                    // Eventos de hover
                    imgWrapper.addEventListener('mouseenter', () => { 
                        imgContainer.classList.remove('hidden');
                    });
                    
                    imgWrapper.addEventListener('mouseleave', () => { 
                        imgContainer.classList.add('hidden');
                    });

                    const info = document.createElement('div');
                    info.className = 'flex-1 min-w-0 pl-16';
                    info.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="truncate">
                                <div class="font-semibold text-gray-900 dark:text-white truncate">${card.name || 'Nombre no disponible'}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-300 truncate">Set: ${card.set?.name || 'N/A'} · Serie: ${card.set?.series || 'N/A'} · Nº: ${card.number || 'N/A'}</div>
                            </div>
                            <div class="flex gap-2 items-center">
                                <button class="bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-2 py-1 rounded text-xs font-semibold flex items-center gap-1 hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors"
                                        onclick="showCardOffers('${safeCardName}', '${safeSetName}', '${safeImageUrl}')">
                                    <span>🤝</span>
                                    <span>Ofrecidas: ${getCardOffersCount(card.name, card.set?.name || '')}</span>
                                </button>
                                <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
                                    onclick="showCardDetailsOnly('${safeCardId}', '${safeCardName}', '${safeImageUrl}', '${safeSetName}', '${safeSeries}', '${safeNumber}')">Ver Detalles</button>
                                <button class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs"
                                    onclick="addCardDirectly('${safeCardId}', '${safeCardName}', '${safeImageUrl}', '${safeSetName}', '${safeSeries}', '${safeNumber}')">+ Añadir</button>
                            </div>
                        </div>
                    `;

                    row.appendChild(imgWrapper);
                    row.appendChild(info);
                    cardsContainer.appendChild(row);
                });

                const totalCount = data.totalCount || 0;

                // Guardar en cache
                searchCache.set(cacheKey, { cards, totalCount });
                
                // Limpiar cache si es muy grande (máximo 50 páginas)
                if (searchCache.size > 50) {
                    const firstKey = searchCache.keys().next().value;
                    searchCache.delete(firstKey);
                }

                renderCardsFromData(cards);
                renderPagination(totalCount, searchPage, searchPageSize);
                hidePageLoading();
            } catch (e) {
                clearTimeout(timeoutId);
                console.error('❌ Error al cargar página:', e);
                hidePageLoading();
                showPageError();
            }
        }

        // Función para renderizar cartas desde datos (reutilizable)
        function renderCardsFromData(cards) {
            console.log('🎴 Renderizando', cards.length, 'cartas...');
            cardsContainer.innerHTML = '';
            cards.forEach((card) => {
                // Función para escapar caracteres especiales
                const escapeForOnclick = (str) => {
                    return String(str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                };
                
                const safeCardId = escapeForOnclick(card.id);
                const safeCardName = escapeForOnclick(card.name);
                const safeSetName = escapeForOnclick(card.set?.name || 'N/A');
                const safeSeries = escapeForOnclick(card.set?.series || 'N/A');
                const safeNumber = escapeForOnclick(card.number || 'N/A');
                const safeImageUrl = escapeForOnclick(card.images?.small);

                const row = document.createElement('div');
                row.className = 'relative flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 h-16 overflow-visible';
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'w-10 h-10 flex items-center justify-center bg-transparent rounded cursor-pointer absolute left-3 top-1/2 -translate-y-1/2 z-10';
                imgWrapper.title = 'Pasa el mouse para ver imagen';
                imgWrapper.innerHTML = '<span class="text-xl">🎴</span>';
                
                // Crear contenedor de imagen con hover
                const imgContainer = document.createElement('div');
                imgContainer.className = 'hidden absolute left-14 top-1/2 -translate-y-1/2 z-30';
                imgContainer.style.pointerEvents = 'none';
                
                const imgEl = document.createElement('img');
                imgEl.src = (card.images?.large || card.images?.small) || 'https://placehold.co/400x550/a0aec0/ffffff?text=Sin+imagen';
                imgEl.alt = card.name || 'Carta';
                imgEl.className = 'w-64 h-auto object-contain rounded-lg shadow-2xl border-2 border-gray-200';
                imgEl.onerror = () => { imgEl.src = 'https://placehold.co/400x550/a0aec0/ffffff?text=Error'; };
                
                imgContainer.appendChild(imgEl);
                row.appendChild(imgContainer);
                
                // Eventos de hover
                imgWrapper.addEventListener('mouseenter', () => { 
                    imgContainer.classList.remove('hidden');
                });
                
                imgWrapper.addEventListener('mouseleave', () => { 
                    imgContainer.classList.add('hidden');
                });

                const info = document.createElement('div');
                info.className = 'flex-1 min-w-0 pl-16';
                info.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="truncate">
                            <div class="font-semibold text-gray-900 dark:text-white truncate">${card.name || 'Nombre no disponible'}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-300 truncate">Set: ${card.set?.name || 'N/A'} · Serie: ${card.set?.series || 'N/A'} · Nº: ${card.number || 'N/A'}</div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs"
                                onclick="showCardDetailsOnly('${safeCardId}', '${safeCardName}', '${safeImageUrl}', '${safeSetName}', '${safeSeries}', '${safeNumber}')">Ver Detalles</button>
                            <button class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs"
                                onclick="addCardDirectly('${safeCardId}', '${safeCardName}', '${safeImageUrl}', '${safeSetName}', '${safeSeries}', '${safeNumber}')">+ Añadir</button>
                        </div>
                    </div>
                `;

                row.appendChild(imgWrapper);
                row.appendChild(info);
                cardsContainer.appendChild(row);
                console.log('✅ Carta renderizada:', card.name);
            });
            
        }

        // Funciones para mostrar/ocultar loading de página
        function showPageLoading() {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'pageLoadingIndicator';
            loadingIndicator.className = 'absolute inset-0 bg-white dark:bg-gray-800 bg-opacity-90 flex items-center justify-center z-10';
            loadingIndicator.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-3"></div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Cambiando página...</p>
                </div>
            `;
            cardsContainer.style.position = 'relative';
            cardsContainer.appendChild(loadingIndicator);
        }

        function hidePageLoading() {
            const loadingIndicator = document.getElementById('pageLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        function showPageError() {
            const errorIndicator = document.createElement('div');
            errorIndicator.className = 'text-center text-red-500 py-8';
            errorIndicator.innerHTML = '❌ Error al cargar la página. Intenta de nuevo.';
            cardsContainer.appendChild(errorIndicator);
        }


    </script>

    <style>
        /* CSS styles - mantener los estilos originales */
        :root {
            --color-primary-bg: #f0f9ff;
            --color-text: #1a202c;
            --color-header-bg: #2a6f8b;
            --color-footer-bg: #1f4e5a;
            --color-card-bg: #ffffff;
            --color-nav-link-hover: #e0f2fe;
            --color-btn-secondary-bg: #4a5568;
            --color-btn-secondary-hover: #2d3748;
            --color-missing-card-bg: #e2e8f0;
            --color-missing-card-border: #a0aec0;
            --color-settings-bg: #f7fafc;
            --color-input-text: #1a202c;
            --color-input-placeholder: #a0aec0;
            --color-select-text: #1a202c;
        }
        
        /* Nuevos estilos para gradiente animado */
        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        .animated-gradient {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
        }
        
        /* Efecto glassmorphism */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .glassmorphism-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Mejorar el buscador en el header */
        .header-bg .search-container {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .header-bg .search-container:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.5);
        }
        
        /* Efecto glow para el botón de búsqueda */
        .search-container button:hover {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        /* Language indicator styles */
        .lang-indicator {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }
        
        .lang-indicator-jp {
            background-color: #dc2626;
            color: white;
        }
        
        .lang-indicator-ko {
            background-color: #2563eb;
            color: white;
        }
        
        .lang-indicator-ch {
            background-color: #ca8a04;
            color: white;
        }
        
        .lang-indicator-multi {
            background: linear-gradient(90deg, #dc2626 0%, #2563eb 50%, #ca8a04 100%);
            color: white;
        }
        
        /* Set selector improvements */
        #bulkSetSelector optgroup {
            font-weight: bold;
            color: #1f2937;
            background-color: #f3f4f6;
            padding: 8px;
        }
        
        #bulkSetSelector option {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        #bulkSetSelector option:hover {
            background-color: #f9fafb;
        }
        
        .dark #bulkSetSelector optgroup {
            color: #f3f4f6;
            background-color: #374151;
        }
        
        .dark #bulkSetSelector option {
            border-bottom-color: #4b5563;
        }
        
        .dark #bulkSetSelector option:hover {
            background-color: #4b5563;
        }
        
        /* Fondo animado con elementos flotantes */
        .floating-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            background: linear-gradient(135deg, 
                rgba(249, 115, 22, 0.08) 0%, 
                rgba(59, 130, 246, 0.08) 25%, 
                rgba(147, 51, 234, 0.08) 50%, 
                rgba(236, 72, 153, 0.08) 75%, 
                rgba(249, 115, 22, 0.08) 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }
        
        /* Capas para efecto parallax */
        .parallax-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        
        .parallax-back {
            transform: translateZ(-2px) scale(3);
        }
        
        .parallax-mid {
            transform: translateZ(-1px) scale(2);
        }
        
        .parallax-front {
            transform: translateZ(0) scale(1);
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .floating-element {
            position: absolute;
            opacity: 0.15;
            filter: blur(0px);
            animation: float 20s infinite ease-in-out;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .floating-element.dark-mode {
            opacity: 0.08;
            filter: brightness(1.2);
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            33% {
                transform: translateY(-30px) rotate(120deg);
            }
            66% {
                transform: translateY(30px) rotate(240deg);
            }
        }
        
        @keyframes floatReverse {
            0%, 100% {
                transform: translateY(0) rotate(0deg) translateX(0);
            }
            33% {
                transform: translateY(30px) rotate(-120deg) translateX(-20px);
            }
            66% {
                transform: translateY(-30px) rotate(-240deg) translateX(20px);
            }
        }
        
        .floating-element:nth-child(even) {
            animation: floatReverse 25s infinite ease-in-out;
        }
        
        .floating-element:nth-child(3n) {
            animation-duration: 30s;
        }
        
        .floating-element:nth-child(5n) {
            animation-duration: 35s;
        }
        
        /* Diferentes tamaños para los elementos */
        .floating-element.small {
            width: 40px;
            height: 40px;
        }
        
        .floating-element.medium {
            width: 60px;
            height: 60px;
        }
        
        .floating-element.large {
            width: 80px;
            height: 80px;
        }
        
        /* Animaciones de entrada para las cartas */
        @keyframes cardFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .card-animate {
            animation: cardFadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        
        /* Retraso escalonado para las cartas */
        .card-animate:nth-child(1) { animation-delay: 0.05s; }
        .card-animate:nth-child(2) { animation-delay: 0.1s; }
        .card-animate:nth-child(3) { animation-delay: 0.15s; }
        .card-animate:nth-child(4) { animation-delay: 0.2s; }
        .card-animate:nth-child(5) { animation-delay: 0.25s; }
        .card-animate:nth-child(6) { animation-delay: 0.3s; }
        .card-animate:nth-child(7) { animation-delay: 0.35s; }
        .card-animate:nth-child(8) { animation-delay: 0.4s; }
        .card-animate:nth-child(9) { animation-delay: 0.45s; }
        .card-animate:nth-child(10) { animation-delay: 0.5s; }
        .card-animate:nth-child(n+11) { animation-delay: 0.55s; }
        
        /* Animación para los números de estadísticas */
        @keyframes countUp {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .count-animate {
            animation: countUp 0.6s ease-out;
        }
        
        /* Estilos para el sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            transition: left 0.3s ease-out;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar.dark {
            background: #1f2937;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
            z-index: 999;
        }
        
        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        /* Hamburger menu animation */
        .hamburger {
            width: 30px;
            height: 24px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .hamburger span {
            display: block;
            height: 3px;
            width: 100%;
            background: white;
            border-radius: 3px;
            transition: all 0.3s ease-out;
            transform-origin: left center;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg);
            width: 33px;
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
            transform: translateX(-20px);
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg);
            width: 33px;
        }
        
        /* Sidebar content styles */
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .sidebar.dark .sidebar-header {
            border-bottom-color: #374151;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar.dark .sidebar-item {
            color: #e5e7eb;
        }
        
        .sidebar-item:hover {
            background: #f3f4f6;
            color: #f97316;
            padding-left: 30px;
        }
        
        .sidebar.dark .sidebar-item:hover {
            background: #374151;
        }
        
        .sidebar-item.active {
            background: #fef3c7;
            color: #f97316;
            font-weight: 600;
        }
        
        .sidebar.dark .sidebar-item.active {
            background: #374151;
        }
        
        .sidebar-item .icon {
            font-size: 20px;
            margin-right: 15px;
            width: 25px;
            text-align: center;
        }
        
        .sidebar-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 15px 25px;
        }
        
        .sidebar.dark .sidebar-divider {
            background: #374151;
        }

        body.dark-mode {
            --color-primary-bg: #1a1a1a;
            --color-text: white;
            --color-header-bg: #000000;
            --color-footer-bg: #000000;
            --color-card-bg: #2d2d2d;
            --color-nav-link-hover: #444444;
            --color-btn-secondary-bg: #555555;
            --color-btn-secondary-hover: #666666;
            --color-missing-card-bg: #444444;
            --color-missing-card-border: #888888;
            --color-settings-bg: #333333;
            --color-input-text: white;
            --color-input-placeholder: #a0aec0;
            --color-select-text: white;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-primary-bg);
            color: var(--color-text);
        }

        .header-bg { background-color: var(--color-header-bg); }
        .nav-link { transition: color 0.3s ease, transform 0.2s ease; }
        .nav-link:hover {
            background-color: var(--color-nav-link-hover);
            color: var(--color-header-bg);
        }

        /* ==============================================
           ESTILOS DEL HEADER MODERNO
           ============================================== */
        
        /* Header principal */
        .modern-header {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        /* Fondo animado del header */
        .header-background {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Efecto glassmorphism */
        .header-glass {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Partículas flotantes */
        .header-particles {
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }
        
        .particle-1 {
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }
        
        .particle-2 {
            top: 60%;
            left: 20%;
            animation-delay: 1s;
        }
        
        .particle-3 {
            top: 30%;
            right: 15%;
            animation-delay: 2s;
        }
        
        .particle-4 {
            top: 70%;
            right: 25%;
            animation-delay: 3s;
        }
        
        .particle-5 {
            top: 50%;
            left: 50%;
            animation-delay: 4s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.6; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }
        
        /* Botón hamburguesa moderno */
        .modern-hamburger {
            width: 32px;
            height: 24px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .modern-hamburger:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .hamburger-line {
            display: block;
            height: 3px;
            width: 100%;
            background: white;
            border-radius: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        
        .modern-hamburger.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }
        
        .modern-hamburger.active .hamburger-line:nth-child(2) {
            opacity: 0;
            transform: scaleX(0);
        }
        
        .modern-hamburger.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }
        
        /* Logo moderno */
        .modern-logo {
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .modern-logo:hover {
            transform: scale(1.05);
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            position: relative;
        }
        
        /* Pokéball styles removed */
        
        .logo-glow {
            position: absolute;
            inset: -4px;
            background: linear-gradient(45deg, #fbbf24, #f59e0b, #d97706);
            border-radius: 50%;
            opacity: 0;
            filter: blur(8px);
            transition: opacity 0.3s ease;
        }
        
        .modern-logo:hover .logo-glow {
            opacity: 0.6;
        }
        
        /* @keyframes rotate removed */
        
        .logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1;
        }
        
        .logo-main {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .logo-sub {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        /* Búsqueda moderna */
        .modern-search-container {
            position: relative;
        }
        
        /* Botón de búsqueda avanzada */
        .advanced-search-toggle-btn {
            margin-left: 8px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
        }
        
        .advanced-search-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        /* Panel de búsqueda avanzada */
        .advanced-search-panel {
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .advanced-search-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .advanced-search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .advanced-search-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .close-advanced-btn {
            padding: 8px;
            border-radius: 8px;
            background: #f3f4f6;
            transition: background-color 0.2s;
            color: #6b7280;
            border: none;
            cursor: pointer;
        }
        
        .close-advanced-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        /* Grid de filtros */
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        
        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            color: #374151;
            font-size: 14px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Opciones de ordenamiento */
        .sort-options {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .sort-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sort-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            white-space: nowrap;
        }
        
        /* Botones de acción */
        .advanced-search-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        
        .search-advanced-btn {
            padding: 12px 24px;
            background: #2563eb;
            color: white;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-advanced-btn:hover {
            background: #1d4ed8;
        }
        
        .clear-filters-btn {
            padding: 12px 24px;
            background: #6b7280;
            color: white;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .clear-filters-btn:hover {
            background: #4b5563;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .sort-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .advanced-search-actions {
                flex-direction: column;
            }
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .search-suggestions.hidden {
            display: none;
        }
        
        .search-glass {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .search-glass:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .search-glass:focus-within {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }
        
        .search-input-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        
        .modern-search-input {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 0.95rem;
            font-weight: 500;
            box-sizing: border-box;
        }
        
        .modern-search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .modern-search-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .modern-search-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .modern-search-btn:hover::before {
            left: 100%;
        }
        
        .modern-search-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        .search-btn-icon {
            display: flex;
            align-items: center;
        }
        
        .search-btn-text {
            white-space: nowrap;
        }
        
        /* Botones de navegación modernos */
        .modern-nav-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .modern-nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .nav-icon {
            font-size: 1.2rem;
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        
        /* Botón de login moderno */
        .modern-login-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .modern-login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .modern-login-btn:hover::before {
            left: 100%;
        }
        
        .modern-login-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        
        .login-icon {
            font-size: 1.1rem;
        }
        
        .login-text {
            white-space: nowrap;
        }
        
        /* Toggle de tema moderno */
        .modern-theme-toggle {
            position: relative;
            width: 56px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .modern-theme-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .theme-toggle-track {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            overflow: hidden;
        }
        
        .theme-toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .dark .theme-toggle-thumb {
            transform: translateX(24px);
            background: linear-gradient(135deg, #1f2937, #111827);
        }
        
        .theme-icon {
            position: absolute;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .theme-icon-sun {
            opacity: 1;
        }
        
        .theme-icon-moon {
            opacity: 0;
        }
        
        .dark .theme-icon-sun {
            opacity: 0;
        }
        
        .dark .theme-icon-moon {
            opacity: 1;
        }
        
        
        
        /* Responsive */
        @media (max-width: 768px) {
            .modern-header {
                padding: 0 16px;
            }
            
            .logo-main {
                font-size: 1.25rem;
            }
            
            .logo-sub {
                display: none;
            }
            
            .search-btn-text,
            .login-text,
            
            .modern-search-container {
                margin: 0 8px;
            }
        }
        
        @media (max-width: 640px) {
            .modern-header .container {
                padding: 0 12px;
            }
            
            .modern-search-container {
                margin: 0 4px;
            }
            
            .modern-nav-btn,
            .modern-login-btn {
                width: 40px;
                height: 40px;
                padding: 8px;
            }
        }

        /* ==============================================
           ESTILOS DE LA SECCIÓN MIS CARTAS MODERNA
           ============================================== */
        
        /* Header de la sección */
        .modern-section-header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .collection-icon {
            width: 45px;
            height: 45px;
            position: relative;
        }
        
        /* Pokéball mini styles removed */
        
        /* Controles de vista */
        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .view-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .view-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .view-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .modern-add-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .modern-add-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        /* Estadísticas de la colección */
        .collection-stats {
            margin-bottom: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            font-size: 1.5rem;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2));
            border-radius: 10px;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            margin-top: 0.25rem;
        }
        
        /* Panel de filtros */
        .modern-filters-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.25rem;
        }
        
        .filters-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 1rem;
        }
        
        .filters-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            flex: 1;
        }
        
        .clear-filters-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #fca5a5;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clear-filters-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
        }
        
        .search-input-group {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .modern-search-input {
            flex: 1;
            padding: 10px 14px;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 0.9rem;
        }
        
        .modern-search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .search-btn {
            padding: 10px 14px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
        }
        
        .modern-select {
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modern-select:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .modern-select option {
            background: #1f2937;
            color: white;
        }
        
        .filters-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .apply-filters-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .apply-filters-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
        
        .filter-options {
            display: flex;
            align-items: center;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .modern-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #8b5cf6;
            cursor: pointer;
        }
        
        /* Contenedor de cartas */
        .cards-container {
            min-height: 400px;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .cards-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Estados vacío y error */
        .collection-messages {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        
        .empty-state,
        .error-state {
            text-align: center;
            max-width: 400px;
            padding: 3rem 2rem;
        }
        
        .empty-icon,
        .error-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }
        
        .empty-title,
        .error-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
        }
        
        .empty-description,
        .error-description {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .empty-action-btn,
        .error-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .empty-action-btn:hover,
        .error-action-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        /* Responsive para Mis Cartas */
        @media (max-width: 768px) {
            .modern-section-header {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }
            
            .stat-number {
                font-size: 1.25rem;
            }
            
            .modern-filters-panel {
                padding: 1rem;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .filters-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }
        }
        
        @media (max-width: 640px) {
            .modern-section-header {
                padding: 0.75rem;
            }
            
            .collection-icon {
                width: 40px;
                height: 40px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            .modern-filters-panel {
                padding: 0.75rem;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        .btn-primary {
            background-color: #f97316;
            color: white;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: var(--color-btn-secondary-bg);
            color: white;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover {
            background-color: var(--color-btn-secondary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .card-bg {
            background-color: var(--color-card-bg);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        .card-bg:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .footer-bg { background-color: var(--color-footer-bg); }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para los tabs del perfil */
        .profile-tab {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .profile-tab:hover {
            color: #f97316;
        }
        
        .profile-tab.active {
            color: #f97316;
            border-bottom-color: #f97316;
        }
        
        .profile-tab-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .profile-tab-content.hidden {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Estilos para los tabs de intercambios */
        .trade-tab {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .trade-tab:hover {
            color: #f97316;
        }
        
        .trade-tab.active {
            color: #f97316;
            border-bottom-color: #f97316;
        }
        
        .trade-tab-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .trade-tab-content.hidden {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Estilos para los tabs de ayuda */
        .help-tab {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .help-tab:hover {
            color: #f97316;
        }
        
        .help-tab.active {
            color: #f97316;
            border-bottom-color: #f97316;
        }
        
        .help-tab-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .help-tab-content.hidden {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Estilos para FAQ */
        .faq-question {
            transition: all 0.3s ease;
        }
        
        .faq-question:hover {
            background-color: #f3f4f6;
        }
        
        .faq-answer {
            transition: all 0.3s ease;
        }
        
        .faq-answer.show {
            display: block;
        }
        
        /* Estilos para las estadísticas */
        .stats-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* Asegurar alineación consistente de iconos */
        .stats-card .flex-shrink-0 {
            width: 48px;
            height: 48px;
        }
        
        /* Asegurar tamaño consistente de texto */
        .stats-card p {
            line-height: 1.5;
        }
        
        /* Estilos para el desglose de sets */
        .set-item {
            transition: background-color 0.3s ease;
        }
        
        .set-item:hover {
            background-color: #f8fafc;
        }

        /* Estilos mejorados para el selector de idioma */
        #languageFilter {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            font-size: 14px;
            line-height: 1.5;
            background-color: #ffffff;
            color: #374151;
            border: 2px solid #d1d5db;
        }

        #languageFilter option {
            font-weight: 500;
            padding: 8px 12px;
            background-color: #ffffff;
            color: #374151;
        }

        #languageFilter:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        /* Mejorar visibilidad en modo oscuro */
        .dark-mode #languageFilter {
            background-color: #1f2937;
            color: #f9fafb;
            border-color: #4b5563;
        }

        .dark-mode #languageFilter option {
            background-color: #1f2937;
            color: #f9fafb;
        }



        .hero-section {
            background: linear-gradient(to right, var(--color-header-bg), var(--color-footer-bg));
            color: white;
            padding: 4rem 1rem;
            text-align: center;
            border-radius: 1rem;
            margin-bottom: 3rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .hero-section h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .hero-section p {
            font-size: 1.5rem;
            margin-bottom: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        .auth-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .auth-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .auth-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        
        /* Modo oscuro para el modal */
        .dark-mode .auth-modal-content {
            background-color: #2d2d2d;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        .auth-modal-overlay.show .auth-modal-content {
            transform: translateY(0);
        }
        .auth-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4a5568;
            transition: color 0.3s ease;
        }
        
        .dark-mode .auth-modal-close {
            color: #cbd5e0;
        }
        
        .dark-mode .auth-modal-close:hover {
            color: #ffffff;
        }
        .auth-form-toggle {
            color: #2a6f8b;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.3s ease;
        }
        
        .dark-mode .auth-form-toggle {
            color: #60a5fa;
        }
        
        .dark-mode .auth-form-toggle:hover {
            color: #93bbfc;
        }

        .missing-card {
            background-color: var(--color-missing-card-bg);
            border: 2px dashed var(--color-missing-card-border);
            color: var(--color-text);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
            height: 100%;
        }
        .missing-card img {
            opacity: 0.3;
        }

        /* Modo oscuro específico */
        body.dark-mode label { color: var(--color-text) !important; }
        body.dark-mode input[type="text"],
        body.dark-mode input[type="email"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="tel"] {
            background-color: #444444;
            color: var(--color-input-text);
            border-color: #666666;
        }
        body.dark-mode input[type="text"]::placeholder,
        body.dark-mode input[type="email"]::placeholder,
        body.dark-mode input[type="password"]::placeholder,
        body.dark-mode input[type="tel"]::placeholder {
            color: var(--color-input-placeholder);
        }

        body.dark-mode #myCardsSection h2 { color: white; }
        body        .dark-mode #interchangesSection h2 { color: white; }

        /* Estilos para selectores de condición de cartas */
        .condition-selector {
            background-color: #ffffff;
            color: #374151;
            border: 2px solid #d1d5db;
            transition: all 0.2s ease;
        }

        .condition-selector:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .condition-selector option {
            padding: 8px 12px;
            font-weight: 500;
        }

        .condition-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            transition: all 0.2s ease;
        }

        .condition-badge:hover {
            transform: scale(1.05);
            cursor: help;
        }

        .condition-tooltip {
            pointer-events: none;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modo oscuro para selectores de condición */
        .dark-mode .condition-selector {
            background-color: #1f2937;
            color: #f9fafb;
            border-color: #4b5563;
        }

        .dark-mode .condition-selector:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        /* Estilos para búsqueda avanzada */
        .advanced-search-panel {
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
            z-index: 50;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .dark-mode .advanced-search-panel {
            background: rgba(31, 41, 55, 0.95);
            border-bottom-color: #374151;
        }

        .dark-mode .advanced-search-title {
            color: #f9fafb;
        }

        .dark-mode .close-advanced-btn {
            color: #d1d5db;
        }

        .dark-mode .close-advanced-btn:hover {
            color: #f9fafb;
            background: rgba(75, 85, 99, 0.5);
        }

        .advanced-search-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .advanced-search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .advanced-search-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }

        .dark-mode .advanced-search-title {
            color: #f9fafb;
        }

        .close-advanced-btn {
            padding: 0.5rem;
            color: #6b7280;
            hover: color: #374151;
            transition: color 0.2s;
        }

        .dark-mode .close-advanced-btn {
            color: #9ca3af;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .dark-mode .filter-group label {
            color: #d1d5db;
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            color: #374151;
            font-size: 0.875rem;
        }

        .dark-mode .filter-select {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        .dark-mode .filter-select:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .dark-mode .filters-grid {
            background: rgba(55, 65, 81, 0.3);
            border: 1px solid #4b5563;
        }

        .dark-mode .filter-group {
            border-color: #4b5563;
        }

        .dark-mode .sort-options {
            background: rgba(55, 65, 81, 0.3);
            border: 1px solid #4b5563;
        }

        .dark-mode .sort-group {
            border-color: #4b5563;
        }

        .sort-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .sort-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 150px;
        }

        .advanced-search-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .search-advanced-btn, .clear-filters-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .search-advanced-btn {
            background: #f97316;
            color: white;
        }

        .search-advanced-btn:hover {
            background: #ea580c;
        }

        .clear-filters-btn {
            background: #6b7280;
            color: white;
        }

        .clear-filters-btn:hover {
            background: #4b5563;
        }

        .dark-mode .search-advanced-btn {
            background: #f97316;
            color: white;
        }

        .dark-mode .search-advanced-btn:hover {
            background: #ea580c;
        }

        .dark-mode .clear-filters-btn {
            background: #6b7280;
            color: white;
        }

        .dark-mode .clear-filters-btn:hover {
            background: #4b5563;
        }

        .advanced-search-toggle-btn {
            margin-left: 8px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
        }

        .advanced-search-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Fondo animado con elementos flotantes -->
    <div class="floating-background" id="floatingBackground">
        <!-- Los elementos se generarán dinámicamente con JavaScript -->
    </div>

    <!-- Sidebar overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" style="pointer-events: none;"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">TCGtrade</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Tu plataforma de intercambio</p>
        </div>
        
        <nav class="sidebar-menu">
            <!-- Navegación principal -->
            <a href="#" class="sidebar-item" id="sidebarHomeLink">
                <span class="icon">🏠</span>
                <span>Inicio</span>
            </a>
            
            <a href="#" class="sidebar-item" id="sidebarMyCardsLink">
                <span class="icon">📦</span>
                <span>Mis Cartas</span>
            </a>
            
            <a href="#" class="sidebar-item" id="sidebarInterchangesLink">
                <span class="icon">💱</span>
                <span>Intercambios</span>
            </a>
            
            <a href="#" class="sidebar-item" id="sidebarCollectionLink">
                <span class="icon">📚</span>
                <span>Mi Colección</span>
            </a>
            
            <div class="sidebar-divider"></div>
            
            <!-- Comunicación -->
            <a href="#" class="sidebar-item hidden" id="sidebarInboxLink">
                <span class="icon">📬</span>
                <span>Buzón</span>
                <span class="ml-auto bg-red-500 text-white text-xs rounded-full px-2 py-1 hidden" id="sidebarInboxBadge">0</span>
            </a>
            
            <a href="#" class="sidebar-item hidden" id="sidebarChatLink">
                <span class="icon">💬</span>
                <span>Chats</span>
                <span class="ml-auto bg-green-500 text-white text-xs rounded-full px-2 py-1 hidden" id="sidebarChatBadge">0</span>
            </a>
            
            <div class="sidebar-divider hidden" id="sidebarCommDivider"></div>
            
            <!-- Ayuda y configuración -->
            <a href="#" class="sidebar-item" id="sidebarHelpLink">
                <span class="icon">❓</span>
                <span>Ayuda</span>
            </a>
            
            <div class="sidebar-divider"></div>
            
            <!-- Sesión -->
            <a href="#" class="sidebar-item" id="sidebarLoginLink">
                <span class="icon">🚪</span>
                <span>Iniciar Sesión</span>
            </a>
            
            <a href="#" class="sidebar-item" id="sidebarRegisterLink">
                <span class="icon">📝</span>
                <span>Registrarse</span>
            </a>
            
            <a href="#" class="sidebar-item hidden" id="sidebarLogoutLink">
                <span class="icon">👋</span>
                <span>Cerrar Sesión</span>
            </a>
        </nav>
    </aside>

    <!-- Enlaces ocultos para mantener compatibilidad -->
    <div class="hidden">
        <a id="myCardsLink"></a>
        <a id="interchangesLink"></a>
        <a id="helpLink"></a>
        <a id="registerLink"></a>
        <a id="navHomeLink"></a>
    </div>

    <!-- Header Moderno con Glassmorphism -->
    <header class="modern-header fixed top-0 left-0 right-0 z-50" id="modernHeader">
        <!-- Fondo con gradiente animado -->
        <div class="header-background absolute inset-0 bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 opacity-90 dark:opacity-95"></div>
        
        <!-- Efecto glassmorphism -->
        <div class="header-glass absolute inset-0 backdrop-blur-xl bg-white/10 dark:bg-black/20 border-b border-white/20 dark:border-white/10"></div>
        
        <!-- Partículas flotantes -->
        <div class="header-particles absolute inset-0 overflow-hidden pointer-events-none">
            <div class="particle particle-1"></div>
            <div class="particle particle-2"></div>
            <div class="particle particle-3"></div>
            <div class="particle particle-4"></div>
            <div class="particle particle-5"></div>
        </div>
        
        <!-- Contenido del header -->
        <div class="relative z-10 container mx-auto px-4 md:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 md:h-20">
                
                <!-- Lado izquierdo: Logo y navegación -->
                <div class="flex items-center gap-4 md:gap-6">
                    <!-- Botón hamburguesa mejorado -->
                    <button class="modern-hamburger group" id="hamburgerBtn" aria-label="Menú">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>
                    
                    <!-- Logo moderno -->
                    <a href="#" class="modern-logo group flex items-center gap-3" id="homeLink">
                        <div class="logo-icon relative">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-lg font-bold">T</span>
                            </div>
                            <div class="logo-glow"></div>
                        </div>
                        <span class="logo-text">
                            <span class="logo-main">TCGtrade</span>
                            <span class="logo-sub">Pokémon TCG</span>
                        </span>
                    </a>
                </div>

                <!-- Centro: Búsqueda inteligente -->
                <div class="flex-1 max-w-2xl mx-4 md:mx-8">
                    <div class="modern-search-container relative">
                        <div class="search-glass">
                            <div class="search-input-container">
                                <input type="text" 
                                       id="searchInput" 
                                       placeholder="Buscar cartas, sets, usuarios..."
                                       class="modern-search-input"
                                       autocomplete="off">
                                <div class="search-suggestions hidden" id="searchSuggestions"></div>
                            </div>
                            <button type="button" 
                                    onclick="quickSearch()" 
                                    class="modern-search-btn group"
                                    title="Búsqueda rápida">
                                <span class="search-btn-icon">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </span>
                                <span class="search-btn-text">Buscar</span>
                            </button>
                            <button type="button" 
                                    onclick="toggleAdvancedSearch()" 
                                    class="advanced-search-toggle-btn"
                                    title="Búsqueda avanzada">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lado derecho: Acciones y perfil -->
                <div class="flex items-center gap-2 md:gap-4">
                    
                    <!-- Notificaciones -->
                    <div class="flex items-center gap-1">
                        <button id="inboxLink" class="modern-nav-btn group hidden" title="Bandeja de entrada">
                            <span class="nav-icon">📬</span>
                            <span id="notificationBadge" class="notification-badge hidden">0</span>
                        </button>
                        
                        <button id="chatLink" class="modern-nav-btn group hidden" title="Chat">
                            <span class="nav-icon">💬</span>
                            <span id="chatBadge" class="notification-badge hidden">0</span>
                        </button>
                    </div>
                    
                    <!-- Perfil / Login / Logout -->
                    <div class="relative flex items-center gap-2">
                        <button id="profileLink" class="modern-nav-btn group hidden" title="Perfil">
                            <span class="nav-icon">👤</span>
                        </button>
                        
                        <button id="logoutLink" class="modern-nav-btn group hidden" title="Cerrar sesión">
                            <span class="nav-icon">🚪</span>
                            <span class="hidden md:inline text-sm">Salir</span>
                        </button>
                        
                        <button id="loginLink" class="modern-login-btn group" title="Iniciar sesión">
                            <span class="login-icon">🚪</span>
                            <span class="login-text hidden md:inline">Entrar</span>
                        </button>
                    </div>
                    
                    <!-- Modo oscuro mejorado -->
                    <button id="darkModeToggle" class="modern-theme-toggle group" title="Cambiar tema">
                        <div class="theme-toggle-track">
                            <div class="theme-toggle-thumb">
                                <span class="theme-icon theme-icon-sun">☀️</span>
                                <span class="theme-icon theme-icon-moon">🌙</span>
                            </div>
                        </div>
                    </button>
                    
                </div>
            </div>
        </div>
    </header>
    
    <!-- Panel de Búsqueda Avanzada -->
    <div id="advancedSearchPanel" class="advanced-search-panel hidden">
        <div class="advanced-search-content">
            <div class="advanced-search-header">
                <h3 class="advanced-search-title">🔍 Búsqueda Avanzada</h3>
                <button onclick="toggleAdvancedSearch()" class="close-advanced-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="filters-grid">
                <!-- Filtro por Serie -->
                <div class="filter-group">
                    <label for="filterSeries">📚 Serie</label>
                    <select id="filterSeries" class="filter-select">
                        <option value="">Todas las series</option>
                    </select>
                </div>
                
                <!-- Filtro por Set -->
                <div class="filter-group">
                    <label for="filterSet">🎴 Set</label>
                    <select id="filterSet" class="filter-select">
                        <option value="">Todos los sets</option>
                    </select>
                </div>
                
                <!-- Filtro por Rareza -->
                <div class="filter-group">
                    <label for="filterRarity">💎 Rareza</label>
                    <select id="filterRarity" class="filter-select">
                        <option value="">Todas las rarezas</option>
                    </select>
                </div>
                
                <!-- Filtro por Tipo -->
                <div class="filter-group">
                    <label for="filterType">⚡ Tipo</label>
                    <select id="filterType" class="filter-select">
                        <option value="">Todos los tipos</option>
                    </select>
                </div>
                
                <!-- Filtro por Subtipo -->
                <div class="filter-group">
                    <label for="filterSubtype">🏷️ Subtipo</label>
                    <select id="filterSubtype" class="filter-select">
                        <option value="">Todos los subtipos</option>
                    </select>
                </div>
                
                <!-- Filtro por Idioma -->
                <div class="filter-group">
                    <label for="filterLanguage">🌍 Idioma</label>
                    <select id="filterLanguage" class="filter-select">
                        <option value="">Todos los idiomas</option>
                    </select>
                </div>
                
                <!-- Filtro por Disponibilidad de Imagen -->
                <div class="filter-group">
                    <label for="filterHasImage">🖼️ Con Imagen</label>
                    <select id="filterHasImage" class="filter-select">
                        <option value="">Cualquiera</option>
                        <option value="true">Solo con imagen</option>
                        <option value="false">Solo sin imagen</option>
                    </select>
                </div>
                
                <!-- Filtro por Disponibilidad de Precio -->
                <div class="filter-group">
                    <label for="filterHasPrice">💰 Con Precio</label>
                    <select id="filterHasPrice" class="filter-select">
                        <option value="">Cualquiera</option>
                        <option value="true">Solo con precio</option>
                        <option value="false">Solo sin precio</option>
                    </select>
                </div>
            </div>
            
            <!-- Opciones de ordenamiento -->
            <div class="sort-options">
                <div class="sort-group">
                    <label for="sortBy">📊 Ordenar por</label>
                    <select id="sortBy" class="filter-select">
                        <option value="name">Nombre</option>
                        <option value="rarity">Rareza</option>
                        <option value="number">Número</option>
                        <option value="random">Aleatorio</option>
                    </select>
                </div>
                
                <div class="sort-group">
                    <label for="sortDirection">🔄 Dirección</label>
                    <select id="sortDirection" class="filter-select">
                        <option value="asc">Ascendente</option>
                        <option value="desc">Descendente</option>
                    </select>
                </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="advanced-search-actions">
                <button onclick="performAdvancedSearch()" class="search-advanced-btn">
                    🔍 Buscar
                </button>
                <button onclick="clearAdvancedFilters()" class="clear-filters-btn">
                    🗑️ Limpiar Filtros
                </button>
            </div>
        </div>
    </div>
    
    <!-- Espaciador para el header fijo -->
    <div class="header-spacer h-16 md:h-20"></div>

    <main class="flex-grow container mx-auto p-6 md:p-10">
        <!-- Hero Section Renovada -->
        <section id="heroSection" class="relative overflow-hidden rounded-3xl mb-12">
            <!-- Fondo animado con gradiente -->
            <div class="absolute inset-0 animated-gradient opacity-20 dark:opacity-30 rounded-3xl"></div>
            
            <!-- Overlay sutil para mejorar legibilidad -->
            <div class="absolute inset-0 bg-white/50 dark:bg-black/50 rounded-3xl"></div>
            
            <div class="relative z-10 py-20 px-4">
                <div class="max-w-6xl mx-auto text-center">
                    <!-- Logo y título principal -->
                    <div class="mb-8">
                        <div class="inline-flex items-center justify-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-2xl font-bold">T</span>
                            </div>
                        </div>
                        <h1 class="text-5xl md:text-6xl font-bold text-gray-800 dark:text-white mb-4">
                            TCGtrade
                        </h1>
                        <p class="text-2xl md:text-3xl text-gray-600 dark:text-gray-300 font-light">
                            La plataforma definitiva para intercambiar cartas Pokémon TCG
                        </p>
                    </div>

                    <!-- Características principales -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="text-4xl mb-3">🔄</div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Intercambios Inteligentes</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">
                                Sistema de propuestas con notificaciones en tiempo real
                            </p>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="text-4xl mb-3">📚</div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Tu Colección Personal</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">
                                Organiza y gestiona todas tus cartas en un solo lugar
                            </p>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="text-4xl mb-3">🛡️</div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Compra y Vende Seguro</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">
                                Sistema de valoraciones para transacciones confiables
                            </p>
                        </div>
                    </div>

                    <!-- CTAs principales -->
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="startTradingBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-xl px-8 py-4 rounded-full font-bold shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            🚀 Empezar Ahora
                        </button>
                        <button onclick="showHelpSection('newFeatures')" class="bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-800 dark:text-white text-xl px-8 py-4 rounded-full font-bold shadow-lg hover:shadow-xl transition-all border-2 border-gray-300 dark:border-gray-600">
                            ✨ Ver Novedades
                        </button>
                    </div>

                    <!-- Estadísticas -->
                    <div class="mt-16 grid grid-cols-3 gap-8 max-w-3xl mx-auto">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-orange-500" id="totalUsersCount">1,234</div>
                            <div class="text-gray-600 dark:text-gray-400">Usuarios Activos</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-500" id="totalTradesCount">5,678</div>
                            <div class="text-gray-600 dark:text-gray-400">Intercambios</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-purple-500" id="globalTotalCardsCount">45,678</div>
                            <div class="text-gray-600 dark:text-gray-400">Cartas en Colección</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Nueva Sección: Cómo Funciona -->
        <section id="howItWorksSection" class="py-16 bg-gray-50 dark:bg-gray-900">
            <div class="max-w-6xl mx-auto px-4">
                <h2 class="text-4xl font-bold text-center text-gray-800 dark:text-white mb-12">
                    ¿Cómo funciona TCGtrade?
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <!-- Paso 1 -->
                    <div class="relative">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                            <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-purple-500 to-pink-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl">
                                1
                            </div>
                            <div class="mt-4 text-center">
                                <div class="text-3xl mb-3">📝</div>
                                <h3 class="font-bold text-gray-800 dark:text-white mb-2">Regístrate</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    Crea tu cuenta con nombre único
                                </p>
                            </div>
                        </div>
                        <div class="hidden md:block absolute top-1/2 -right-4 transform -translate-y-1/2 text-gray-400">
                            →
                        </div>
                    </div>

                    <!-- Paso 2 -->
                    <div class="relative">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                            <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-pink-500 to-orange-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl">
                                2
                            </div>
                            <div class="mt-4 text-center">
                                <div class="text-3xl mb-3">🎴</div>
                                <h3 class="font-bold text-gray-800 dark:text-white mb-2">Añade Cartas</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    Construye tu colección personal
                                </p>
                            </div>
                        </div>
                        <div class="hidden md:block absolute top-1/2 -right-4 transform -translate-y-1/2 text-gray-400">
                            →
                        </div>
                    </div>

                    <!-- Paso 3 -->
                    <div class="relative">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                            <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-orange-500 to-yellow-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl">
                                3
                            </div>
                            <div class="mt-4 text-center">
                                <div class="text-3xl mb-3">💬</div>
                                <h3 class="font-bold text-gray-800 dark:text-white mb-2">Propón Intercambios</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    Envía y recibe propuestas
                                </p>
                            </div>
                        </div>
                        <div class="hidden md:block absolute top-1/2 -right-4 transform -translate-y-1/2 text-gray-400">
                            →
                        </div>
                    </div>

                    <!-- Paso 4 -->
                    <div class="relative">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                            <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-500 to-green-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl">
                                4
                            </div>
                            <div class="mt-4 text-center">
                                <div class="text-3xl mb-3">⭐</div>
                                <h3 class="font-bold text-gray-800 dark:text-white mb-2">Valora</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    Califica con Pokéballs
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Nueva Sección: Características Destacadas -->
        <section id="featuresSection" class="py-16">
            <div class="max-w-6xl mx-auto px-4">
                <h2 class="text-4xl font-bold text-center text-gray-800 dark:text-white mb-12">
                    Características Exclusivas
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Contador de Ofrecidas -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-8 border border-blue-200 dark:border-blue-800">
                        <div class="flex items-start gap-4">
                            <div class="text-4xl">📊</div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-3">
                                    Contador de Cartas Ofrecidas
                                </h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">
                                    Ve al instante cuántas personas ofrecen cada carta. Haz click en el contador para ver quién las tiene y qué buscan a cambio.
                                </p>
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-3 inline-block">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Ejemplo:</span>
                                    <span class="ml-2 bg-green-500 text-white px-2 py-1 rounded text-sm font-bold">
                                        12 Ofrecidas
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema de Buzón -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-8 border border-purple-200 dark:border-purple-800">
                        <div class="flex items-start gap-4">
                            <div class="text-4xl">📨</div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-3">
                                    Buzón Inteligente
                                </h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">
                                    Nunca pierdas una propuesta. Recibe notificaciones instantáneas, gestiona ofertas recibidas y enviadas, todo en un solo lugar.
                                </p>
                                <div class="flex gap-2">
                                    <span class="bg-purple-500 text-white px-3 py-1 rounded-full text-sm">
                                        Notificaciones
                                    </span>
                                    <span class="bg-pink-500 text-white px-3 py-1 rounded-full text-sm">
                                        Propuestas
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selección desde Colección -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl p-8 border border-green-200 dark:border-green-800">
                        <div class="flex items-start gap-4">
                            <div class="text-4xl">📚</div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-3">
                                    Integración con Tu Colección
                                </h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">
                                    Añade cartas directamente desde tu colección a los intercambios. Los campos se bloquean automáticamente para evitar errores.
                                </p>
                                <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                                    📚 Desde Mis Cartas
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Valoraciones con Pokéballs -->
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-xl p-8 border border-yellow-200 dark:border-yellow-800">
                        <div>
                            <div class="flex items-center flex-wrap gap-3 mb-4">
                                <div class="flex gap-1 flex-shrink-0">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" 
                                         class="w-8 h-8">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png" 
                                         class="w-8 h-8">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" 
                                         class="w-8 h-8">
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                                    Sistema de Valoración Único
                                </h3>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 mb-3">
                                Valora a otros usuarios con Pokéballs reales. Desde Premier Ball hasta Master Ball, construye tu reputación en la comunidad.
                            </p>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                ⭐⭐⭐⭐⭐ = Master Ball
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Final -->
        <section id="ctaSection" class="py-20 bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-800 dark:to-pink-800">
            <div class="max-w-4xl mx-auto px-4 text-center">
                <h2 class="text-4xl font-bold text-white mb-6">
                    ¿Listo para empezar tu aventura?
                </h2>
                <p class="text-xl text-white/90 mb-8">
                    Únete a la comunidad de intercambio de cartas Pokémon más innovadora
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="showAuthModal('register')" class="bg-white hover:bg-gray-100 text-purple-600 text-xl px-8 py-4 rounded-full font-bold shadow-lg hover:shadow-xl transition-all">
                        🎯 Crear Cuenta Gratis
                    </button>
                    <button onclick="showInterchangesSection(); loadAvailableTrades()" class="bg-purple-800 hover:bg-purple-900 text-white text-xl px-8 py-4 rounded-full font-bold shadow-lg hover:shadow-xl transition-all">
                        🔍 Explorar Intercambios
                    </button>
                </div>
            </div>
        </section>

        <section id="searchResults" class="mb-12 hidden">
            <h2 class="text-3xl font-bold mb-6 text-gray-700 dark:text-white flex items-center">
                <span class="icon">✨</span> Resultados de Búsqueda
            </h2>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Sidebar de filtros -->
                <aside id="searchFiltersSidebar" class="w-full lg:w-64 bg-white dark:bg-gray-800 rounded-xl shadow p-4 h-max">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Filtros</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Serie</label>
                            <select id="filterSeriesSelect" class="w-full border rounded px-2 py-2 dark:bg-gray-700 dark:text-white">
                                <option value="">Todas las Series</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Set</label>
                            <select id="filterSetSelect" class="w-full border rounded px-2 py-2 dark:bg-gray-700 dark:text-white">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rareza</label>
                            <select id="filterRaritySelect" class="w-full border rounded px-2 py-2 dark:bg-gray-700 dark:text-white">
                                <option value="">Todas</option>
                                <!-- Ordenado de menos raro a más raro -->
                                <option value="Common">Common</option>
                                <option value="Uncommon">Uncommon</option>
                                <option value="Rare">Rare</option>
                                <option value="Rare Holo">Rare Holo</option>
                                <option value="Rare Prime">Rare Prime</option>
                                <option value="Rare BREAK">Rare BREAK</option>
                                <option value="Rare Holo EX">Rare Holo EX</option>
                                <option value="Rare Holo GX">Rare Holo GX</option>
                                <option value="Rare Holo V">Rare Holo V</option>
                                <option value="Rare Holo VMAX">Rare Holo VMAX</option>
                                <option value="Rare Holo VSTAR">Rare Holo VSTAR</option>
                                <option value="Rare Holo ex">Rare Holo ex</option>
                                <option value="Rare Holo Tera ex">Rare Holo Tera ex</option>
                                <option value="Rare Ultra">Rare Ultra</option>
                                <option value="Rare Rainbow">Rare Rainbow</option>
                                <option value="Rare Shining">Rare Shining</option>
                                <option value="Rare Shiny">Rare Shiny</option>
                                <option value="Rare Shiny GX">Rare Shiny GX</option>
                                <option value="Rare Shiny V">Rare Shiny V</option>
                                <option value="Rare Shiny VMAX">Rare Shiny VMAX</option>
                                <option value="Rare Shiny ex">Rare Shiny ex</option>
                                <option value="Rare Shiny Tera ex">Rare Shiny Tera ex</option>
                                <option value="Rare Amazing">Rare Amazing</option>
                                <option value="Rare Radiant">Rare Radiant</option>
                                <option value="Rare Special">Rare Special</option>
                                <option value="Rare Illustration">Rare Illustration</option>
                                <option value="Rare ACE SPEC">Rare ACE SPEC</option>
                                <option value="Rare Hyper">Rare Hyper</option>
                                <option value="Rare Double Rare">Rare Double Rare</option>
                                <option value="Rare Triple Rare">Rare Triple Rare</option>
                                <option value="Rare Ultra Rare">Rare Ultra Rare</option>
                                <option value="Rare Secret">Rare Secret</option>
                                <option value="Rare Secret Rare">Rare Secret Rare</option>
                                <option value="Rare Amazing Rare">Rare Amazing Rare</option>
                                <option value="Rare Radiant Rare">Rare Radiant Rare</option>
                                <option value="Rare Special Illustration Rare">Rare Special Illustration Rare</option>
                                <option value="Rare Hyper Rare">Rare Hyper Rare</option>
                                <option value="Rare LEGEND">Rare LEGEND</option>
                                <option value="Rare Promo">Rare Promo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo</label>
                            <select id="filterTypeSelect" class="w-full border rounded px-2 py-2 dark:bg-gray-700 dark:text-white">
                                <option value="">Todos</option>
                                <option value="Grass">Grass</option>
                                <option value="Fire">Fire</option>
                                <option value="Water">Water</option>
                                <option value="Lightning">Lightning</option>
                                <option value="Psychic">Psychic</option>
                                <option value="Fighting">Fighting</option>
                                <option value="Darkness">Darkness</option>
                                <option value="Metal">Metal</option>
                                <option value="Fairy">Fairy</option>
                                <option value="Dragon">Dragon</option>
                                <option value="Colorless">Colorless</option>
                                <option value="Trainer">Trainer</option>
                                <option value="Energy">Energy</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Idioma</label>
                            <select id="filterLanguageSelect" class="w-full border rounded px-2 py-2 dark:bg-gray-700 dark:text-white">
                                <option value="">Cualquiera</option>
                                <option value="English">Inglés</option>
                                <option value="Spanish">Español</option>
                                <option value="Japanese">Japonés</option>
                                <option value="French">Francés</option>
                                <option value="German">Alemán</option>
                                <option value="Italian">Italiano</option>
                                <option value="Chinese">Chino</option>
                                <option value="Korean">Coreano</option>
                            </select>
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button id="applySearchFiltersBtn" class="btn-primary px-3 py-2 rounded text-sm">Aplicar</button>
                            <button id="clearSearchFiltersBtn" class="btn-secondary px-3 py-2 rounded text-sm">Limpiar</button>
                        </div>
                    </div>
                </aside>
                <!-- Lista de resultados -->
                <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl shadow p-2">
                    <!-- Loading spinner -->
                    <div id="loadingSpinner" class="hidden flex flex-col items-center justify-center py-20">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-8"></div>
                        <div class="text-center">
                            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">🔍 Buscando cartas...</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-lg">Espera un momento mientras encontramos las mejores cartas para ti</p>
                        </div>
                    </div>
                    <div id="cardsContainer" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
                    <p id="noResultsMessage" class="text-center text-gray-600 dark:text-gray-400 mt-8 hidden">No se encontraron resultados para tu búsqueda.</p>
                    <p id="errorMessage" class="text-center text-red-500 mt-8 hidden">Ha ocurrido un error al cargar las cartas.</p>
                    <div id="searchPagination" class="mt-4 flex justify-center items-center gap-1"></div>
                </div>
            </div>
        </section>

        <!-- Sección Mis Cartas Moderna -->
        <section id="myCardsSection" class="mb-12 hidden">
            <!-- Header de la sección -->
            <div class="modern-section-header mb-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="collection-icon">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-xl">📚</span>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                                Mi Colección
                            </h2>
                            <p class="text-gray-600 dark:text-gray-400 mt-1">Gestiona y organiza tus cartas Pokémon TCG</p>
                        </div>
                    </div>
                    
                    <!-- Controles de vista -->
                    <div class="flex items-center gap-3">
                        <div class="view-toggle">
                            <button id="gridViewBtn" class="view-btn active" title="Vista de tarjetas">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                </svg>
                            </button>
                            <button id="listViewBtn" class="view-btn" title="Vista de lista">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <button id="addCardBtn" class="modern-add-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <span>Añadir Carta</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estadísticas de la colección -->
            <div class="collection-stats mb-8">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">🎴</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalCardsStat">0</div>
                            <div class="stat-label">Cartas Totales</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📦</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalSetsStat">0</div>
                            <div class="stat-label">Sets Diferentes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⭐</div>
                        <div class="stat-content">
                            <div class="stat-number" id="rareCardsStat">0</div>
                            <div class="stat-label">Cartas Raras</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💎</div>
                        <div class="stat-content">
                            <div class="stat-number" id="holoCardsStat">0</div>
                            <div class="stat-label">Cartas Holo</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de filtros y búsqueda -->
            <div class="modern-filters-panel mb-6">
                <div class="filters-header">
                    <h3 class="filters-title">Filtros y Búsqueda</h3>
                    <button id="clearFiltersBtn" class="clear-filters-btn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Limpiar
                    </button>
                </div>
                
                <div class="filters-grid">
                    <!-- Búsqueda rápida -->
                    <div class="filter-group">
                        <label class="filter-label">🔍 Búsqueda Rápida</label>
                        <div class="search-input-group">
                            <input type="text" id="collectionSearchInput" placeholder="Buscar por nombre, set, tipo..." class="modern-search-input">
                            <button id="searchCollectionBtn" class="search-btn">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtro por serie -->
                    <div class="filter-group">
                        <label class="filter-label">📚 Serie</label>
                        <select id="seriesFilter" class="modern-select">
                            <option value="">Todas las Series</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por set -->
                    <div class="filter-group">
                        <label class="filter-label">📦 Expansión</label>
                        <select id="setFilter" class="modern-select" disabled>
                            <option value="">Todas las Expansiones</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por rareza -->
                    <div class="filter-group">
                        <label class="filter-label">⭐ Rareza</label>
                        <select id="rarityFilter" class="modern-select">
                            <option value="">Todas las Rarezas</option>
                            <option value="Common">Common</option>
                            <option value="Uncommon">Uncommon</option>
                            <option value="Rare">Rare</option>
                            <option value="Rare Holo">Rare Holo</option>
                            <option value="Rare Ultra">Rare Ultra</option>
                            <option value="Rare Secret">Rare Secret</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por idioma -->
                    <div class="filter-group">
                        <label class="filter-label">🌍 Idioma</label>
                        <select id="languageFilter" class="modern-select">
                            <option value="">Todos los Idiomas</option>
                            <option value="Español">🇪🇸 Español</option>
                            <option value="Inglés">🇺🇸 Inglés</option>
                            <option value="Japonés">🇯🇵 Japonés</option>
                            <option value="Francés">🇫🇷 Francés</option>
                            <option value="Alemán">🇩🇪 Alemán</option>
                            <option value="Chino">🇨🇳 Chino</option>
                            <option value="Coreano">🇰🇷 Coreano</option>
                            <option value="Italiano">🇮🇹 Italiano</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por condición -->
                    <div class="filter-group">
                        <label class="filter-label">🔧 Condición</label>
                        <select id="conditionFilter" class="modern-select">
                            <option value="">Todas las Condiciones</option>
                            <option value="Mint">Mint</option>
                            <option value="Near Mint">Near Mint</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Good">Good</option>
                            <option value="Light Played">Light Played</option>
                            <option value="Played">Played</option>
                            <option value="Poor">Poor</option>
                        </select>
                    </div>
                </div>
                
                <div class="filters-actions">
                    <button id="applyFiltersBtn" class="apply-filters-btn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                        </svg>
                        Aplicar Filtros
                    </button>
                    
                    <div class="filter-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="showAllSetCardsToggle" class="modern-checkbox" disabled>
                            <span class="checkmark"></span>
                            Mostrar cartas faltantes del set
                        </label>
                    </div>
                </div>
            </div>

            <!-- Contenedor de cartas -->
            <div class="cards-container">
                <!-- Vista de tarjetas (grid) -->
                <div id="cardsGridView" class="cards-grid">
                    <!-- Las cartas se mostrarán aquí en formato grid -->
                </div>
                
                <!-- Vista de lista -->
                <div id="cardsListView" class="cards-list hidden">
                    <!-- Las cartas se mostrarán aquí en formato lista -->
                </div>
            </div>

            <!-- Mensajes de estado -->
            <div id="collectionMessages" class="collection-messages">
                <div id="noMyCardsMessage" class="empty-state hidden">
                    <div class="empty-icon">📦</div>
                    <h3 class="empty-title">Tu colección está vacía</h3>
                    <p class="empty-description">Aún no tienes cartas en tu colección. ¡Busca y añade algunas para empezar!</p>
                    <button class="empty-action-btn" onclick="showSearchSection()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Buscar Cartas
                    </button>
                </div>
                
                <div id="myCardsErrorMessage" class="error-state hidden">
                    <div class="error-icon">⚠️</div>
                    <h3 class="error-title">Error al cargar la colección</h3>
                    <p class="error-description">No se pudo cargar tu colección. Por favor, inténtalo de nuevo.</p>
                    <button class="error-action-btn" onclick="location.reload()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Recargar Página
                    </button>
                </div>
            </div>
        </section>

        <!-- Sección de Buzón -->
        <div id="inboxSection" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6">
                        <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                            📬 Buzón de Notificaciones
                        </h2>
                        <p class="text-purple-100 mt-2">Gestiona tus propuestas y mensajes</p>
                    </div>
                    
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <nav class="flex space-x-8 px-6" aria-label="Tabs">
                            <button id="inboxNotificationsTab" class="inbox-tab active py-4 px-1 border-b-2 border-purple-500 text-purple-600 font-medium text-sm">
                                🔔 Notificaciones
                            </button>
                            <button id="inboxProposalsTab" class="inbox-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                💼 Propuestas Recibidas
                            </button>
                            <button id="inboxSentProposalsTab" class="inbox-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                📤 Propuestas Enviadas
                            </button>
                        </nav>
                    </div>
                    
                    <div class="p-6">
                        <!-- Tab de Notificaciones -->
                        <div id="inboxNotificationsContent" class="inbox-content">
                            <div id="notificationsList" class="space-y-3">
                                <!-- Las notificaciones se cargarán aquí -->
                            </div>
                        </div>
                        
                        <!-- Tab de Propuestas Recibidas -->
                        <div id="inboxProposalsContent" class="inbox-content hidden">
                            <div id="receivedProposalsList" class="space-y-4">
                                <!-- Las propuestas recibidas se cargarán aquí -->
                            </div>
                        </div>
                        
                        <!-- Tab de Propuestas Enviadas -->
                        <div id="inboxSentProposalsContent" class="inbox-content hidden">
                            <div id="sentProposalsList" class="space-y-4">
                                <!-- Las propuestas enviadas se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Ayuda -->
        <section id="helpSection" class="mb-12 hidden">
            <div class="max-w-6xl mx-auto">
                <!-- Header de Ayuda -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2 flex items-center">
                                <span class="icon mr-3">❓</span> Centro de Ayuda
                            </h2>
                            <p class="text-gray-600">Encuentra respuestas a todas tus preguntas sobre TCGtrade</p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="searchHelpBtn" class="btn-primary px-6 py-3 rounded-lg text-sm font-semibold flex items-center">
                                <span class="icon mr-2">🔍</span> Buscar Ayuda
                            </button>
                            <button id="contactSupportBtn" class="btn-secondary px-6 py-3 rounded-lg text-sm font-semibold flex items-center">
                                <span class="icon mr-2">📧</span> Contactar Soporte
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabs de Ayuda -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6" aria-label="Tabs">
                            <button id="helpGettingStartedTab" class="help-tab active py-4 px-1 border-b-2 border-orange-500 text-orange-600 font-medium text-sm">
                                🚀 Primeros Pasos
                            </button>
                            <button id="helpTradingTab" class="help-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                🤝 Intercambios
                            </button>
                            <button id="helpCardConditionsTab" class="help-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                🎴 Condiciones de Cartas
                            </button>
                            <button id="helpAccountTab" class="help-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                👤 Cuenta y Perfil
                            </button>
                            <button id="helpFAQTab" class="help-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                ❓ FAQ
                            </button>
                            <button id="helpNewFeaturesTab" class="help-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                ✨ Novedades
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Contenido de Primeros Pasos -->
                <div id="helpGettingStartedContent" class="help-tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <span class="icon mr-2">🚀</span> Primeros Pasos en TCGtrade
                        </h3>
                        
                        <div class="space-y-6">
                            <div class="border-l-4 border-orange-500 pl-4">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">1. Crear tu Cuenta</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">Regístrate con tu email y crea un nombre de usuario único. Este será tu identificador en toda la plataforma.</p>
                                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                    <p class="text-sm text-gray-700 dark:text-gray-300">
                                        <strong>💡 Nuevo:</strong> Tu nombre de usuario aparecerá en todos tus intercambios. 
                                        Puedes recuperar tu contraseña desde la pantalla de login si la olvidas.
                                    </p>
                                </div>
                            </div>

                            <div class="border-l-4 border-blue-500 pl-4">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">2. Construir tu Colección</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">Busca cartas y añádelas a tu colección personal con todos los detalles.</p>
                                <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                                    <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                                        <li>✅ Selecciona la condición (Mint, NM, EX, etc.)</li>
                                        <li>✅ Elige el idioma (Español, Inglés, Japonés, Chino, Coreano, etc.)</li>
                                        <li>✅ Las imágenes se guardan automáticamente</li>
                                        <li>✅ Puedes ver tu colección en "Mis Cartas"</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="border-l-4 border-green-500 pl-4">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">3. Crear tu Primer Intercambio</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">Crea intercambios de dos formas:</p>
                                <div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                                    <ul class="text-sm text-green-700 dark:text-green-300 space-y-1">
                                        <li>🔍 <strong>Búsqueda en API:</strong> Busca cartas en tiempo real</li>
                                        <li>📚 <strong>Desde Mis Cartas:</strong> Selecciona directamente de tu colección</li>
                                        <li>🔒 Las cartas de tu colección se bloquean automáticamente</li>
                                        <li>✏️ Puedes modificar tus intercambios en cualquier momento</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="border-l-4 border-purple-500 pl-4">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">4. Sistema de Propuestas</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">Responde a intercambios de otros usuarios con contrapropuestas.</p>
                                <div class="bg-purple-50 dark:bg-purple-900/30 p-3 rounded-lg">
                                    <ul class="text-sm text-purple-700 dark:text-purple-300 space-y-1">
                                        <li>💬 Propón intercambios alternativos</li>
                                        <li>📨 Recibe notificaciones en tu Buzón</li>
                                        <li>👁️ Ve los detalles completos de cada propuesta</li>
                                        <li>✅ Acepta, rechaza o contraoferta</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="border-l-4 border-yellow-500 pl-4">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">5. Sistema de Valoraciones</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">Valora a otros usuarios después de completar intercambios.</p>
                                <div class="bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg">
                                    <p class="text-sm text-yellow-700 dark:text-yellow-300">
                                        <strong>🎯 Sistema Pokéball:</strong> Valora de 1 a 5 usando Pokéballs 
                                        (Premier, Poké, Great, Ultra, Master Ball). Las valoraciones aparecen en tu perfil.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Intercambios -->
                <div id="helpTradingContent" class="help-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <span class="icon mr-2">🤝</span> Guía Completa de Intercambios
                        </h3>
                        
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">📋 Crear un Intercambio</h4>
                                <div class="space-y-3">
                                    <div class="bg-white/70 dark:bg-gray-800/70 p-3 rounded">
                                        <h5 class="font-medium text-gray-700 dark:text-gray-300 mb-2">Métodos de Selección:</h5>
                                        <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                            <li>• <strong>Búsqueda API:</strong> Escribe el nombre y selecciona de los resultados</li>
                                            <li>• <strong>Desde Mis Cartas:</strong> Click en "📚 Desde Mis Cartas" para tu colección</li>
                                            <li>• <strong>Bloqueo Inteligente:</strong> Las cartas de API se bloquean al añadir, las de colección se bloquean automáticamente</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">💬 Sistema de Propuestas</h4>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div class="bg-white/70 dark:bg-gray-800/70 p-3 rounded">
                                        <h5 class="font-medium text-green-700 dark:text-green-300 mb-2">Enviar Propuesta:</h5>
                                        <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                            <li>1. Click en "Ver" en un intercambio</li>
                                            <li>2. Click en "Proponer Intercambio"</li>
                                            <li>3. Ofrece tus cartas</li>
                                            <li>4. Añade un mensaje opcional</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/70 dark:bg-gray-800/70 p-3 rounded">
                                        <h5 class="font-medium text-green-700 dark:text-green-300 mb-2">Gestionar Propuestas:</h5>
                                        <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                            <li>• Ve al Buzón para ver propuestas</li>
                                            <li>• Acepta, rechaza o contraoferta</li>
                                            <li>• Recibe notificaciones automáticas</li>
                                            <li>• Ve detalles completos con imágenes</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">📊 Contador de Ofertas</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">En los resultados de búsqueda, verás cuántas personas ofrecen cada carta:</p>
                                <div class="bg-white/70 dark:bg-gray-800/70 p-3 rounded">
                                    <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                        <li>• Click en el número de "Ofrecidas" para ver quién las ofrece</li>
                                        <li>• Ve qué buscan a cambio</li>
                                        <li>• Contacta directamente con los usuarios</li>
                                        <li>• Encuentra intercambios más fácilmente</li>
                                    </ul>
                                </div>
                            </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div class="bg-white dark:bg-gray-700 p-3 rounded border dark:border-gray-600">
                                        <h5 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">📤 Crear un Intercambio</h5>
                                        <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                            <li>• Selecciona las cartas que ofreces</li>
                                            <li>• Especifica las cartas que buscas</li>
                                            <li>• Define las condiciones aceptables</li>
                                            <li>• Añade una descripción clara</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white dark:bg-gray-700 p-3 rounded border dark:border-gray-600">
                                        <h5 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">📥 Responder a Intercambios</h5>
                                        <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                            <li>• Revisa las condiciones detalladamente</li>
                                            <li>• Propón una oferta específica</li>
                                            <li>• Comunícate con el creador</li>
                                            <li>• Acuerda los detalles del envío</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">🛡️ Consejos de Seguridad</h4>
                                <ul class="text-gray-600 dark:text-gray-400 space-y-2">
                                    <li><strong>📸 Fotos detalladas:</strong> Siempre incluye fotos claras de las cartas que ofreces</li>
                                    <li><strong>📋 Descripción completa:</strong> Describe cualquier defecto o característica especial</li>
                                    <li><strong>📞 Comunicación:</strong> Mantén una comunicación clara y respetuosa</li>
                                    <li><strong>📦 Envío seguro:</strong> Usa métodos de envío con seguimiento</li>
                                    <li><strong>⏰ Paciencia:</strong> Los intercambios pueden tomar tiempo, sé paciente</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Condiciones de Cartas -->
                <div id="helpCardConditionsContent" class="help-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <span class="icon mr-2">🎴</span> Guía de Condiciones de Cartas
                        </h3>
                        
                        <div class="mb-6">
                            <p class="text-gray-600 dark:text-gray-400 mb-4">En TCGtrade utilizamos el sistema de condiciones de <strong>CardMarket</strong>, el estándar europeo más reconocido para la evaluación de cartas Pokémon TCG.</p>
                            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                                <p class="text-sm text-blue-700 dark:text-blue-300"><strong>💡 Importante:</strong> La condición de una carta es fundamental para determinar su valor y aceptabilidad en intercambios.</p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 border-b dark:border-gray-600">
                                    <h4 class="font-semibold text-gray-800 dark:text-gray-200">Condiciones de Mejor a Peor</h4>
                                </div>
                                <div class="p-4">
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: #10B981;">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">💎</span>
                                                <div>
                                                    <h5 class="font-semibold text-white">Mint (M)</h5>
                                                    <p class="text-green-100 text-sm">Perfectas condiciones, sin excusas</p>
                                                </div>
                                            </div>
                                            <span class="text-white font-medium">M</span>
                                        </div>

                                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: #059669;">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">✨</span>
                                                <div>
                                                    <h5 class="font-semibold text-white">Near Mint (NM)</h5>
                                                    <p class="text-green-100 text-sm">Aspecto de no haber sido jugada sin fundas</p>
                                                </div>
                                            </div>
                                            <span class="text-white font-medium">NM</span>
                                        </div>

                                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: #3B82F6;">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">⭐</span>
                                                <div>
                                                    <h5 class="font-semibold text-white">Excellent (EX)</h5>
                                                    <p class="text-blue-100 text-sm">Como si se hubiera usado poco sin fundas</p>
                                                </div>
                                            </div>
                                            <span class="text-white font-medium">EX</span>
                                        </div>

                                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: #F59E0B;">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">🟡</span>
                                                <div>
                                                    <h5 class="font-semibold text-white">Good (GD)</h5>
                                                    <p class="text-yellow-100 text-sm">Aspecto de mucho uso en torneo sin fundas</p>
                                                </div>
                                            </div>
                                            <span class="text-white font-medium">GD</span>
                                        </div>

                                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: #F97316;">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">🟠</span>
                                                <div>
                                                    <h5 class="font-semibold text-white">Light Played (LP)</h5>
                                                    <p class="text-orange-100 text-sm">Uso prolongado sin fundas, válida para torneos</p>
                                                </div>
                                            </div>
                                            <span class="text-white font-medium">LP</span>
                                        </div>

                                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: #DC2626;">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">🔴</span>
                                                <div>
                                                    <h5 class="font-semibold text-white">Played (PL)</h5>
                                                    <p class="text-red-100 text-sm">Aspecto muy deteriorado, dudoso para torneos</p>
                                                </div>
                                            </div>
                                            <span class="text-white font-medium">PL</span>
                                        </div>

                                        <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: #7F1D1D;">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">💀</span>
                                                <div>
                                                    <h5 class="font-semibold text-white">Poor (PO)</h5>
                                                    <p class="text-red-100 text-sm">Literalmente destrozada o alterada</p>
                                                </div>
                                            </div>
                                            <span class="text-white font-medium">PO</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">⚠️ Consejos Importantes</h4>
                                <ul class="text-gray-600 dark:text-gray-400 space-y-2">
                                    <li><strong>🔍 Inspección detallada:</strong> Examina las cartas bajo buena luz antes de evaluar</li>
                                    <li><strong>📸 Fotos claras:</strong> Incluye fotos de frente y reverso en tus intercambios</li>
                                    <li><strong>📋 Descripción honesta:</strong> Sé transparente sobre cualquier defecto</li>
                                    <li><strong>🎯 Condiciones específicas:</strong> Especifica qué condiciones aceptas en tus intercambios</li>
                                    <li><strong>🤝 Comunicación:</strong> Si tienes dudas, pregunta antes de intercambiar</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Cuenta y Perfil -->
                <div id="helpAccountContent" class="help-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <span class="icon mr-2">👤</span> Gestión de Cuenta y Perfil
                        </h3>
                        
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                    <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">🔐 Seguridad de la Cuenta</h4>
                                    <ul class="text-gray-600 dark:text-gray-400 space-y-2">
                                        <li>• Usa una contraseña fuerte y única</li>
                                        <li>• No compartas tus credenciales</li>
                                        <li>• Cambia tu contraseña regularmente</li>
                                        <li>• Activa la verificación en dos pasos si está disponible</li>
                                    </ul>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                    <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">📊 Tu Perfil</h4>
                                    <ul class="text-gray-600 dark:text-gray-400 space-y-2">
                                        <li>• Mantén tu información actualizada</li>
                                        <li>• Añade una foto de perfil</li>
                                        <li>• Completa tu información de contacto</li>
                                        <li>• Revisa tu historial de intercambios</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">📈 Estadísticas de tu Colección</h4>
                                <p class="text-gray-600 dark:text-gray-300 mb-3">En tu perfil puedes ver estadísticas detalladas de tu colección:</p>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-blue-600">🎴</div>
                                        <div class="text-sm text-gray-600">Total de Cartas</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-green-600">📦</div>
                                        <div class="text-sm text-gray-600">Sets Diferentes</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-purple-600">🤝</div>
                                        <div class="text-sm text-gray-600">Intercambios</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-orange-600">⭐</div>
                                        <div class="text-sm text-gray-600">Cartas Únicas</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de FAQ -->
                <div id="helpFAQContent" class="help-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <span class="icon mr-2">❓</span> Preguntas Frecuentes Actualizadas
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                                <button class="faq-question w-full px-4 py-3 text-left bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-400 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800 dark:text-gray-200">🚀 ¿Cómo empiezo en TCGtrade?</span>
                                        <span class="text-gray-500 dark:text-gray-400">+</span>
                                    </div>
                                </button>
                                <div class="faq-answer hidden px-4 py-3 border-t dark:border-gray-700">
                                    <p class="text-gray-600 dark:text-gray-400">
                                        1. Regístrate con email y nombre de usuario<br>
                                        2. Busca cartas y añádelas a tu colección<br>
                                        3. Crea intercambios o responde a propuestas<br>
                                        4. Usa el Buzón para gestionar notificaciones<br>
                                        5. Valora a otros usuarios con Pokéballs
                                    </p>
                                </div>
                            </div>

                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                                <button class="faq-question w-full px-4 py-3 text-left bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-400 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800 dark:text-gray-200">💬 ¿Cómo funciona el sistema de propuestas?</span>
                                        <span class="text-gray-500 dark:text-gray-400">+</span>
                                    </div>
                                </button>
                                <div class="faq-answer hidden px-4 py-3 border-t dark:border-gray-700">
                                    <p class="text-gray-600 dark:text-gray-400">
                                        Ve un intercambio → Click en "Proponer Intercambio" → Ofrece tus cartas → 
                                        El dueño recibe notificación en su Buzón → Puede aceptar, rechazar o contraoferta → 
                                        Recibes respuesta en tu Buzón. Todo con imágenes de cartas y detalles completos.
                                    </p>
                                </div>
                            </div>

                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                                <button class="faq-question w-full px-4 py-3 text-left bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-400 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800 dark:text-gray-200">🎯 ¿Qué son las valoraciones con Pokéballs?</span>
                                        <span class="text-gray-500 dark:text-gray-400">+</span>
                                    </div>
                                </button>
                                <div class="faq-answer hidden px-4 py-3 border-t dark:border-gray-700">
                                    <p class="text-gray-600 dark:text-gray-400">
                                        Sistema único de valoración: 1⭐ Premier Ball (blanca), 2⭐ Poké Ball (roja), 
                                        3⭐ Great Ball (azul), 4⭐ Ultra Ball (negra), 5⭐ Master Ball (morada). 
                                        Las valoraciones aparecen en tu perfil con promedio y reseñas.
                                    </p>
                                </div>
                            </div>

                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                                <button class="faq-question w-full px-4 py-3 text-left bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-400 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800 dark:text-gray-200">📚 ¿Cómo añado cartas desde mi colección?</span>
                                        <span class="text-gray-500 dark:text-gray-400">+</span>
                                    </div>
                                </button>
                                <div class="faq-answer hidden px-4 py-3 border-t dark:border-gray-700">
                                    <p class="text-gray-600 dark:text-gray-400">
                                        En crear/modificar intercambio: Click en "📚 Desde Mis Cartas" → 
                                        Selecciona de tu colección → Las cartas se bloquean automáticamente → 
                                        Las imágenes y datos se copian. También funciona en propuestas.
                                    </p>
                                </div>
                            </div>

                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                                <button class="faq-question w-full px-4 py-3 text-left bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-400 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800 dark:text-gray-200">🔍 ¿Qué es el contador de "Ofrecidas"?</span>
                                        <span class="text-gray-500 dark:text-gray-400">+</span>
                                    </div>
                                </button>
                                <div class="faq-answer hidden px-4 py-3 border-t dark:border-gray-700">
                                    <p class="text-gray-600 dark:text-gray-400">
                                        En búsquedas, verás cuántas personas ofrecen cada carta. 
                                        Click en el número para ver quién las tiene y qué buscan a cambio. 
                                        Facilita encontrar intercambios compatibles.
                                    </p>
                                </div>
                            </div>

                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                                <button class="faq-question w-full px-4 py-3 text-left bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-400 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800 dark:text-gray-200">🌙 ¿Cómo activo el modo oscuro?</span>
                                        <span class="text-gray-500 dark:text-gray-400">+</span>
                                    </div>
                                </button>
                                <div class="faq-answer hidden px-4 py-3 border-t dark:border-gray-700">
                                    <p class="text-gray-600 dark:text-gray-400">
                                        Usa el botón de modo oscuro en la esquina superior derecha de la navegación (☀️/🌙). 
                                        Se guarda automáticamente y persiste entre sesiones. 
                                        Todos los modales y secciones son compatibles con el modo oscuro.
                                    </p>
                                </div>
                            </div>

                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                                <button class="faq-question w-full px-4 py-3 text-left bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-400 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800 dark:text-gray-200">📧 ¿Cómo recupero mi contraseña?</span>
                                        <span class="text-gray-500 dark:text-gray-400">+</span>
                                    </div>
                                </button>
                                <div class="faq-answer hidden px-4 py-3 border-t dark:border-gray-700">
                                    <p class="text-gray-600 dark:text-gray-400">
                                        En la pantalla de login → Click en "¿Olvidaste tu contraseña?" → 
                                        Ingresa tu email → Recibirás un enlace de recuperación. 
                                        Revisa spam si no llega.
                                    </p>
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-lg">
                                <button class="faq-question w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-orange-400 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800">¿Qué hago si tengo un problema con un intercambio?</span>
                                        <span class="text-gray-500">+</span>
                                    </div>
                                </button>
                                <div class="faq-answer hidden px-4 py-3 border-t">
                                    <p class="text-gray-600">Primero intenta resolverlo directamente con el otro usuario. Si no es posible, contacta con nuestro soporte técnico usando el botón "Contactar Soporte".</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Novedades -->
                <div id="helpNewFeaturesContent" class="help-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <span class="icon mr-2">✨</span> Funcionalidades Nuevas de TCGtrade
                        </h3>
                        
                        <div class="space-y-6">
                            <!-- Sistema de Buzón -->
                            <div class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-purple-800 dark:text-purple-200 mb-3 flex items-center">
                                    📨 Sistema de Buzón Completo
                                </h4>
                                <ul class="space-y-2 text-gray-700 dark:text-gray-300">
                                    <li>✅ <strong>Notificaciones:</strong> Recibe alertas de nuevas propuestas y respuestas</li>
                                    <li>✅ <strong>Propuestas Recibidas:</strong> Gestiona todas las ofertas que recibes</li>
                                    <li>✅ <strong>Propuestas Enviadas:</strong> Rastrea tus propuestas activas</li>
                                    <li>✅ <strong>Badge de Notificaciones:</strong> Contador visual en el menú</li>
                                </ul>
                            </div>

                            <!-- Sistema de Valoraciones -->
                            <div class="bg-gradient-to-r from-yellow-100 to-orange-100 dark:from-yellow-900/30 dark:to-orange-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-yellow-800 dark:text-yellow-200 mb-3 flex items-center">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" 
                                         class="w-6 h-6 mr-2" alt="Master Ball">
                                    Sistema de Valoraciones con Pokéballs
                                </h4>
                                <ul class="space-y-2 text-gray-700 dark:text-gray-300">
                                    <li>✅ Valora de 1-5 con Pokéballs reales (Premier → Master)</li>
                                    <li>✅ Pestaña dedicada en el perfil con historial</li>
                                    <li>✅ Promedio visual con imágenes de Pokéballs</li>
                                    <li>✅ Reseñas con comentarios y fecha</li>
                                    <li>✅ Estadísticas detalladas por tipo de Pokéball</li>
                                </ul>
                            </div>

                            <!-- Mejoras en Intercambios -->
                            <div class="bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-green-800 dark:text-green-200 mb-3 flex items-center">
                                    🔄 Mejoras en Sistema de Intercambios
                                </h4>
                                <ul class="space-y-2 text-gray-700 dark:text-gray-300">
                                    <li>✅ <strong>Selección desde Mi Colección:</strong> Añade cartas directamente</li>
                                    <li>✅ <strong>Bloqueo Inteligente:</strong> Campos se bloquean según origen</li>
                                    <li>✅ <strong>Vista Detallada:</strong> Modal con imágenes grandes y detalles</li>
                                    <li>✅ <strong>Propuestas con Imágenes:</strong> Todas las cartas muestran sus imágenes</li>
                                    <li>✅ <strong>Modificación Flexible:</strong> Edita intercambios existentes</li>
                                </ul>
                            </div>

                            <!-- Contador de Ofrecidas -->
                            <div class="bg-gradient-to-r from-blue-100 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-blue-800 dark:text-blue-200 mb-3 flex items-center">
                                    📊 Contador de Cartas Ofrecidas
                                </h4>
                                <ul class="space-y-2 text-gray-700 dark:text-gray-300">
                                    <li>✅ Ve cuántas personas ofrecen cada carta</li>
                                    <li>✅ Click para ver lista de usuarios</li>
                                    <li>✅ Descubre qué buscan a cambio</li>
                                    <li>✅ Encuentra intercambios compatibles rápidamente</li>
                                </ul>
                            </div>

                            <!-- Mejoras de UX -->
                            <div class="bg-gradient-to-r from-gray-100 to-slate-100 dark:from-gray-900/30 dark:to-slate-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-3 flex items-center">
                                    🎨 Mejoras de Experiencia de Usuario
                                </h4>
                                <ul class="space-y-2 text-gray-700 dark:text-gray-300">
                                    <li>✅ <strong>Modo Oscuro Persistente:</strong> Se mantiene entre sesiones</li>
                                    <li>✅ <strong>Recuperación de Contraseña:</strong> Por email con enlace</li>
                                    <li>✅ <strong>Enter para Login:</strong> Presiona Enter para iniciar sesión</li>
                                    <li>✅ <strong>Notificaciones Personalizadas:</strong> Diseño moderno sin alerts</li>
                                    <li>✅ <strong>Idiomas Adicionales:</strong> Chino y Coreano disponibles</li>
                                    <li>✅ <strong>Condición Mint:</strong> Añadida a todas las selecciones</li>
                                </ul>
                            </div>

                            <!-- Seguridad -->
                            <div class="bg-gradient-to-r from-red-100 to-rose-100 dark:from-red-900/30 dark:to-rose-900/30 p-4 rounded-lg">
                                <h4 class="text-lg font-bold text-red-800 dark:text-red-200 mb-3 flex items-center">
                                    🔒 Mejoras de Seguridad
                                </h4>
                                <ul class="space-y-2 text-gray-700 dark:text-gray-300">
                                    <li>✅ Solo puedes modificar tus propios intercambios</li>
                                    <li>✅ Validación de propietario en todas las acciones</li>
                                    <li>✅ Logout limpia todos los datos sensibles</li>
                                    <li>✅ Nombres de usuario únicos y bloqueados</li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-8 p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-lg">
                            <p class="text-center text-gray-700 dark:text-gray-300">
                                <strong>🚀 TCGtrade evoluciona constantemente</strong><br>
                                <span class="text-sm">Estas funcionalidades han sido añadidas recientemente para mejorar tu experiencia</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="interchangesSection" class="mb-12 hidden">
            <div class="max-w-7xl mx-auto">
                <!-- Header de Intercambios -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2 flex items-center">
                                <span class="icon mr-3">🤝</span> Intercambios
                            </h2>
                            <p class="text-gray-600 dark:text-gray-300">Gestiona tus intercambios de cartas y encuentra nuevos coleccionistas</p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="createTradeBtn" class="btn-primary px-6 py-3 rounded-lg text-sm font-semibold flex items-center">
                                <span class="icon mr-2">➕</span> Crear Intercambio
                            </button>
                            <button id="findTradesBtn" class="btn-secondary px-6 py-3 rounded-lg text-sm font-semibold flex items-center">
                                <span class="icon mr-2">🔍</span> Buscar Intercambios
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabs de Intercambios -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg mb-6">
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <nav class="flex space-x-8 px-6" aria-label="Tabs">
                            <button id="tradesActiveTab" class="trade-tab active py-4 px-1 border-b-2 border-orange-500 text-orange-600 font-medium text-sm">
                                🔄 Activos
                            </button>
                            <button id="tradesPendingTab" class="trade-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                ⏳ Pendientes
                            </button>
                            <button id="tradesCompletedTab" class="trade-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                ✅ Completados
                            </button>
                            <button id="tradesReceivedTab" class="trade-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                📥 Recibidos
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Contenido de Intercambios Activos -->
                <div id="tradesActiveContent" class="trade-tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Intercambios que he creado -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                                <span class="icon mr-2">📤</span> Mis Ofertas
                            </h3>
                            <div id="myTradesContainer" class="space-y-4">
                                <!-- Los intercambios se cargarán dinámicamente aquí -->
                                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                    <p>No tienes intercambios activos</p>
                                    <button onclick="showCreateTradeModal()" class="btn-primary mt-4 px-4 py-2 rounded-lg text-sm font-semibold">
                                        Crear mi primer intercambio
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Intercambios disponibles -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                                <span class="icon mr-2">🎯</span> Intercambios Disponibles
                            </h3>
                            <div id="availableTradesContainer" class="space-y-4">
                                <!-- Los intercambios disponibles se cargarán dinámicamente aquí -->
                                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                    <p>No hay intercambios disponibles en este momento</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Intercambios Pendientes -->
                <div id="tradesPendingContent" class="trade-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                            <span class="icon mr-2">⏳</span> Intercambios Pendientes
                        </h3>
                        <div id="pendingTradesContainer" class="space-y-4">
                            <!-- Los intercambios pendientes se cargarán dinámicamente aquí -->
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                <p>No tienes intercambios pendientes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Intercambios Completados -->
                <div id="tradesCompletedContent" class="trade-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                            <span class="icon mr-2">✅</span> Intercambios Completados
                        </h3>
                        <div id="completedTradesContainer" class="space-y-4">
                            <!-- Los intercambios completados se cargarán dinámicamente aquí -->
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                <p>No tienes intercambios completados</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Intercambios Recibidos -->
                <div id="tradesReceivedContent" class="trade-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                            <span class="icon mr-2">📥</span> Intercambios Recibidos
                        </h3>
                        <div id="receivedTradesContainer" class="space-y-4">
                            <!-- Los intercambios recibidos se cargarán dinámicamente aquí -->
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                <p>No has recibido propuestas de intercambio</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección Mi Perfil -->
        <section id="profileSection" class="mb-12 hidden">
            <div class="max-w-6xl mx-auto">
                <!-- Header del Perfil -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
                        <!-- Avatar del Usuario -->
                        <div class="flex-shrink-0">
                            <div class="w-20 h-20 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                👤
                            </div>
                        </div>
                        
                        <!-- Información del Usuario -->
                        <div class="flex-1">
                            <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-2" id="profileUserName">Usuario</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Miembro desde <span id="profileJoinDate">Enero 2024</span></p>
                        </div>
                        

                    </div>
                </div>

                <!-- Tabs de Navegación -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6" aria-label="Tabs">
                            <button id="profilePersonalTab" class="profile-tab active py-4 px-1 border-b-2 border-orange-500 text-orange-600 font-medium text-sm">
                                👤 Mi Perfil
                            </button>
                            <button id="profileDashboardTab" class="profile-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                📊 Dashboard
                            </button>
                            <button id="profileCollectionTab" class="profile-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                🎴 Mi Colección
                            </button>
                            <button id="profileTradesTab" class="profile-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                🤝 Mis Intercambios
                            </button>
                            <button id="profileSettingsTab" class="profile-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                ⚙️ Configuración
                            </button>
                            <button id="profileRatingsTab" class="profile-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                🏆 Valoraciones
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Contenido de Mi Perfil -->
                <div id="profilePersonalContent" class="profile-tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <span class="icon mr-2">👤</span> Información Personal
                        </h3>
                        
                        <form id="profilePersonalForm" class="space-y-6">
                            <!-- Usuario (solo lectura) -->
                            <div>
                                <label for="profileUsername" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                    Nombre de Usuario
                                </label>
                                <input type="text" id="profileUsername" name="username" 
                                       class="shadow appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 text-gray-600 dark:text-gray-400 leading-tight bg-gray-100 dark:bg-gray-800 cursor-not-allowed"
                                       placeholder="usuario123" readonly>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">El nombre de usuario no se puede modificar</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Nombre -->
                                <div>
                                    <label for="profileName" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                        Nombre *
                                    </label>
                                    <input type="text" id="profileName" name="name" 
                                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400"
                                           placeholder="Tu nombre">
                                </div>
                                
                                <!-- Apellidos -->
                                <div>
                                    <label for="profileLastName" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                        Apellidos *
                                    </label>
                                    <input type="text" id="profileLastName" name="lastName" 
                                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400"
                                           placeholder="Tus apellidos">
                                </div>
                            </div>
                            
                            <!-- Dirección -->
                            <div>
                                <label for="profileAddress" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                    Dirección
                                </label>
                                <input type="text" id="profileAddress" name="address" 
                                       class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400"
                                       placeholder="Tu dirección completa">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Fecha de Nacimiento -->
                                <div>
                                    <label for="profileBirthDate" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                        Fecha de Nacimiento
                                    </label>
                                    <input type="date" id="profileBirthDate" name="birthDate" 
                                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400">
                                </div>
                                
                                <!-- Correo Electrónico -->
                                <div>
                                    <label for="profileEmail" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                        Correo Electrónico *
                                    </label>
                                    <input type="email" id="profileEmail" name="email" 
                                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400"
                                           placeholder="tu@email.com">
                                </div>
                            </div>
                            
                            <!-- Botones -->
                            <div class="flex justify-end space-x-4 pt-4">
                                <button type="button" id="cancelProfileBtn" class="btn-secondary px-6 py-2 rounded-lg text-sm font-semibold">
                                    Cancelar
                                </button>
                                <button type="submit" id="saveProfileBtn" class="btn-primary px-6 py-2 rounded-lg text-sm font-semibold">
                                    💾 Guardar Cambios
                                </button>
                            </div>
                        </form>
                        
                        <!-- Mensaje de estado -->
                        <div id="profileSaveMessage" class="mt-4 p-3 rounded-lg hidden">
                            <p class="text-sm"></p>
                        </div>
                        

                    </div>
                </div>

                <!-- Contenido del Dashboard -->
                <div id="profileDashboardContent" class="profile-tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                        <!-- Estadística: Total de Cartas -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-blue-500 stats-card">
                            <div class="flex items-center h-full">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                        <span class="text-2xl">🎴</span>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total de Cartas</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalCardsCount">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Estadística: Cartas por Sets -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-green-500 stats-card">
                            <div class="flex items-center h-full">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                        <span class="text-2xl">📦</span>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Sets Diferentes</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="uniqueSetsCount">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Estadística: Intercambios Completados -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-purple-500 stats-card">
                            <div class="flex items-center h-full">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                        <span class="text-2xl">🤝</span>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Intercambios</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="completedTradesCount">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Estadística: Cartas Únicas -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-orange-500 stats-card">
                            <div class="flex items-center h-full">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                        <span class="text-2xl">⭐</span>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Cartas Únicas</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="uniqueCardsCount">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Estadística: Valor Total de la Colección -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-emerald-500 stats-card">
                            <div class="flex items-center h-full">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-900 rounded-lg flex items-center justify-center">
                                        <span class="text-2xl">💰</span>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalCollectionValue">€0.00</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400" id="valueEstimateNote">Estimado</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Desglose por Sets -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                            <span class="icon mr-2">📊</span> Desglose por Sets
                        </h3>
                        <div id="setsBreakdown" class="space-y-4">
                            <!-- Los sets se cargarán dinámicamente aquí -->
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                <p>No hay datos de sets disponibles</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Mi Colección (oculto por defecto) -->
                <div id="profileCollectionContent" class="profile-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">🎴 Mi Colección</h3>
                            <button onclick="showBulkAddModal()" class="btn-primary px-4 py-2 rounded text-sm">
                                ➕ Agregar por Set
                            </button>
                        </div>
                        <p id="myCardsStatus" class="text-gray-600 dark:text-gray-300 mb-4"></p>
                        <div id="myCardsGrid" class="space-y-1 border rounded-lg bg-white">
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                <p>No hay cartas en tu colección</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Mis Intercambios (oculto por defecto) -->
                <div id="profileTradesContent" class="profile-tab-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">🤝 Mis Intercambios</h3>
                        <p class="text-gray-600 dark:text-gray-300">Aquí podrás ver el historial de tus intercambios.</p>
                    </div>
                </div>

                <!-- Contenido de Configuración (oculto por defecto) -->
                <div id="profileSettingsContent" class="profile-tab-content hidden">
                    <div class="space-y-6">
                        <!-- Sección de Seguridad -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                                <span class="icon mr-2">🔒</span> Seguridad
                            </h3>
                            
                            <form id="passwordChangeForm" class="space-y-6">
                                <div class="mb-4">
                                    <label for="currentPassword" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                        Contraseña Actual *
                                    </label>
                                    <input type="password" id="currentPassword" name="currentPassword" 
                                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400"
                                           placeholder="Tu contraseña actual" required>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="newPassword" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                            Nueva Contraseña *
                                        </label>
                                        <input type="password" id="newPassword" name="newPassword" 
                                               class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400"
                                               placeholder="Nueva contraseña" required>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 dark:text-gray-400 mt-1">Mínimo 6 caracteres</p>
                                    </div>
                                    
                                    <div>
                                        <label for="confirmNewPassword" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                            Confirmar Nueva Contraseña *
                                        </label>
                                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" 
                                               class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400"
                                               placeholder="Confirmar nueva contraseña" required>
                                    </div>
                                </div>
                                
                                <!-- Botones -->
                                <div class="flex justify-end space-x-4 pt-4">
                                    <button type="button" id="cancelPasswordBtn" class="btn-secondary px-6 py-2 rounded-lg text-sm font-semibold">
                                        Cancelar
                                    </button>
                                    <button type="submit" id="savePasswordBtn" class="btn-primary px-6 py-2 rounded-lg text-sm font-semibold">
                                        🔐 Cambiar Contraseña
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Mensaje de estado -->
                            <div id="passwordChangeMessage" class="mt-4 p-3 rounded-lg hidden">
                                <p class="text-sm"></p>
                            </div>
                            

                        </div>
                    </div>
                </div>
                
                <!-- Contenido de Valoraciones (oculto por defecto) -->
                <div id="profileRatingsContent" class="profile-tab-content hidden">
                    <div class="space-y-6">
                        <!-- Resumen de Valoración -->
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl shadow-lg p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-2xl font-bold mb-3">🏆 Tu Valoración</h3>
                                    <div class="flex items-center gap-4">
                                        <div class="text-3xl" id="userRatingDisplay">
                                            <!-- Se llenará con JavaScript -->
                                        </div>
                                        <div id="userRatingStats">
                                            <!-- Se llenará con JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                <div class="text-6xl opacity-20">
                                    🏆
                                </div>
                            </div>
                        </div>
                        
                        <!-- Historial de Valoraciones -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center justify-between">
                                <span class="flex items-center">
                                    <span class="icon mr-2">📝</span> 
                                    Reseñas Recibidas
                                </span>
                                <button onclick="refreshRatings()" 
                                        class="px-3 py-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-sm">
                                    🔄 Actualizar
                                </button>
                            </h3>
                            
                            <div id="ratingsHistoryContainer" class="space-y-4">
                                <!-- Las valoraciones se cargarán aquí -->
                            </div>
                        </div>
                        
                        <!-- Estadísticas de Valoraciones -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                                <span class="icon mr-2">📊</span> 
                                Estadísticas
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <!-- Distribución por Pokéballs -->
                                <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:shadow-lg transition-shadow">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" 
                                         alt="Master Ball" 
                                         class="w-12 h-12 mx-auto mb-2">
                                    <div class="text-sm font-semibold text-gray-700 dark:text-gray-300">Master Ball</div>
                                    <div class="text-xl font-bold text-purple-600 dark:text-purple-400" id="masterBallCount">0</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:shadow-lg transition-shadow">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png" 
                                         alt="Ultra Ball" 
                                         class="w-12 h-12 mx-auto mb-2">
                                    <div class="text-sm font-semibold text-gray-700 dark:text-gray-300">Ultra Ball</div>
                                    <div class="text-xl font-bold text-gray-800 dark:text-gray-200" id="ultraBallCount">0</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:shadow-lg transition-shadow">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png" 
                                         alt="Great Ball" 
                                         class="w-12 h-12 mx-auto mb-2">
                                    <div class="text-sm font-semibold text-gray-700 dark:text-gray-300">Great Ball</div>
                                    <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="greatBallCount">0</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:shadow-lg transition-shadow">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" 
                                         alt="Poké Ball" 
                                         class="w-12 h-12 mx-auto mb-2">
                                    <div class="text-sm font-semibold text-gray-700 dark:text-gray-300">Poké Ball</div>
                                    <div class="text-xl font-bold text-red-600 dark:text-red-400" id="pokeBallCount">0</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:shadow-lg transition-shadow">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/premier-ball.png" 
                                         alt="Premier Ball" 
                                         class="w-12 h-12 mx-auto mb-2">
                                    <div class="text-sm font-semibold text-gray-700 dark:text-gray-300">Premier Ball</div>
                                    <div class="text-xl font-bold text-gray-600 dark:text-gray-400" id="premierBallCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="authModal" class="auth-modal-overlay">
        <div class="auth-modal-content">
            <span class="auth-modal-close" id="closeAuthModalBtn">&times;</span>

            <div id="loginForm">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Iniciar Sesión</h2>
                <div class="mb-4">
                    <label for="loginEmail" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Correo Electrónico:</label>
                    <input type="email" id="loginEmail" class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400" required>
                </div>
                <div class="mb-4">
                    <label for="loginPassword" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Contraseña:</label>
                    <input type="password" id="loginPassword" class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400" required>
                    <div class="text-right mt-1">
                        <a class="auth-form-toggle text-xs text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300" id="toggleToForgotPassword">
                            ¿Olvidaste tu contraseña?
                        </a>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <button id="loginBtn" class="btn-primary px-4 py-2 rounded focus:outline-none focus:shadow-outline" type="button">
                        Iniciar Sesión
                    </button>
                    <a class="auth-form-toggle text-sm" id="toggleToRegister">
                        ¿No tienes cuenta? Regístrate
                    </a>
                </div>
                <p id="loginError" class="text-red-500 text-xs italic mt-4 hidden">Error al iniciar sesión.</p>
            </div>

            <div id="forgotPasswordForm" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Recuperar Contraseña</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Ingresa tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.
                </p>
                <div class="mb-4">
                    <label for="resetEmail" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Correo Electrónico:</label>
                    <input type="email" id="resetEmail" class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400" required placeholder="tu@email.com">
                </div>
                <div class="flex items-center justify-between">
                    <button id="resetPasswordBtn" class="btn-primary px-3 py-1.5 text-sm rounded focus:outline-none focus:shadow-outline" type="button">
                        📧 Enviar Email
                    </button>
                    <a class="auth-form-toggle text-sm" id="backToLogin">
                        Volver a Iniciar Sesión
                    </a>
                </div>
                <div id="resetPasswordError" class="text-red-500 text-xs mt-4 hidden p-3 bg-red-50 dark:bg-red-900/20 rounded border border-red-200 dark:border-red-800"></div>
                <div id="resetPasswordSuccess" class="text-green-600 dark:text-green-400 text-xs mt-4 hidden p-3 bg-green-50 dark:bg-green-900/20 rounded border border-green-200 dark:border-green-800"></div>
            </div>

            <div id="registerForm" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Registrarse</h2>
                <div class="mb-4">
                    <label for="registerUsername" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Nombre de Usuario *:</label>
                    <input type="text" id="registerUsername" class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400" required placeholder="usuario123">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Este será tu nombre único en la plataforma</p>
                </div>
                <div class="mb-4">
                    <label for="registerEmail" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Correo Electrónico:</label>
                    <input type="email" id="registerEmail" class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400" required>
                </div>
                <div class="mb-4">
                    <label for="registerPassword" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Contraseña:</label>
                    <input type="password" id="registerPassword" class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400" required>
                </div>
                <div class="mb-6">
                    <label for="confirmPassword" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Confirmar Contraseña:</label>
                    <input type="password" id="confirmPassword" class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-orange-400" required>
                </div>
                <div class="flex items-center justify-between">
                    <button id="registerBtn" class="btn-primary px-4 py-2 rounded focus:outline-none focus:shadow-outline" type="button">
                        Registrarse
                    </button>
                    <a class="auth-form-toggle text-sm" id="toggleToLogin">
                        ¿Ya tienes cuenta? Inicia sesión
                    </a>
                </div>
                <p id="registerError" class="text-red-500 text-xs italic mt-4 hidden">Error al registrarse.</p>
            </div>
        </div>
    </div>

    <footer class="footer-bg text-white py-12 px-6 md:px-10">
        <div class="container mx-auto">
            <!-- Sección principal del footer -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <!-- Logo y descripción -->
                <div class="text-center md:text-left">
                    <h3 class="text-2xl font-bold mb-4 flex items-center justify-center md:justify-start">
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" 
                             alt="Pokéball" class="w-8 h-8 mr-2">
                        TCGtrade
                    </h3>
                    <p class="text-gray-300 text-sm">
                        La plataforma líder para intercambiar cartas Pokémon TCG de forma segura y confiable.
                    </p>
                </div>
                
                <!-- Enlaces legales -->
                <div class="text-center">
                    <h4 class="font-semibold mb-4">Legal</h4>
                    <ul class="space-y-2">
                        <li>
                            <a href="#" class="text-gray-300 hover:text-orange-400 transition-colors text-sm">
                                Política de Privacidad
                            </a>
                        </li>
                        <li>
                            <a href="#" class="text-gray-300 hover:text-orange-400 transition-colors text-sm">
                                Términos y Condiciones
                            </a>
                        </li>
                        <li>
                            <a href="#" class="text-gray-300 hover:text-orange-400 transition-colors text-sm">
                                Política de Cookies
                            </a>
                        </li>
                        <li>
                            <a href="#" class="text-gray-300 hover:text-orange-400 transition-colors text-sm">
                                Aviso Legal
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- Redes sociales -->
                <div class="text-center md:text-right">
                    <h4 class="font-semibold mb-4">Síguenos</h4>
                    <div class="flex justify-center md:justify-end space-x-4">
                        <!-- Twitter/X -->
                        <a href="#" class="text-gray-300 hover:text-orange-400 transition-colors">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        
                        <!-- Facebook -->
                        <a href="#" class="text-gray-300 hover:text-orange-400 transition-colors">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>
                        
                        <!-- Instagram -->
                        <a href="#" class="text-gray-300 hover:text-orange-400 transition-colors">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1 1 12.324 0 6.162 6.162 0 0 1-12.324 0zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm4.965-10.405a1.44 1.44 0 1 1 2.881.001 1.44 1.44 0 0 1-2.881-.001z"/>
                            </svg>
                        </a>
                        
                        <!-- TikTok -->
                        <a href="#" class="text-gray-300 hover:text-orange-400 transition-colors">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Separador -->
            <div class="border-t border-gray-700 pt-8">
                <div class="text-center">
                    <p data-i18n="footer.copyright">&copy; 2024 TCGtrade. Todos los derechos reservados.</p>
                    <p class="text-sm mt-2 text-gray-400" data-i18n="footer.tagline">
                        Conectando coleccionistas de Pokémon TCG en todo el mundo.
                    </p>
                    <p class="text-xs mt-4 text-gray-500">
                        Pokémon y todas las marcas relacionadas son propiedad de Nintendo, The Pokémon Company y Game Freak.
                    </p>
                </div>
            </div>
        </div>
    </footer>




    <!-- Scripts globales fuera del módulo ES6 -->
    <script>
        // Función para iniciar sincronización de datos
        async function startDataSync() {
            if (!dataSync || !window.currentUser) {
                console.log('⚠️ No se puede iniciar sincronización: dataSync o usuario no disponible');
                return;
            }

            try {
                console.log('🔄 Iniciando sincronización en tiempo real...');
                
                // Sincronizar colección personal
                await dataSync.syncUserCollection((cards) => {
                    console.log('📦 Colección sincronizada:', cards.length, 'cartas');
                    window.userCardsCache = cards;
                    
                    // Actualizar UI si está abierta la sección de colección
                    if (document.getElementById('myCardsSection') && !document.getElementById('myCardsSection').classList.contains('hidden')) {
                        loadMyCollection(window.currentUser.uid);
                    }
                });
                
                // Sincronizar intercambios
                await dataSync.syncUserTrades((trades) => {
                    console.log('🔄 Intercambios sincronizados:', trades.length, 'intercambios');
                    
                    // Actualizar UI si está abierta la sección de intercambios
                    if (document.getElementById('interchangesSection') && !document.getElementById('interchangesSection').classList.contains('hidden')) {
                        loadAvailableTrades();
                    }
                });
                
                // Sincronizar valoraciones
                await dataSync.syncUserRatings((ratings) => {
                    console.log('⭐ Valoraciones sincronizadas:', ratings.length, 'valoraciones');
                });
                
                console.log('✅ Sincronización en tiempo real iniciada');
                
            } catch (error) {
                console.error('❌ Error al iniciar sincronización:', error);
            }
        }

        // Inicializar búsqueda avanzada
        async function initAdvancedSearch() {
            try {
                console.log('🔍 Inicializando búsqueda avanzada...');
                
                // Verificar que el módulo esté disponible
                if (typeof AdvancedSearch === 'undefined') {
                    console.error('❌ Módulo AdvancedSearch no está disponible');
                    return;
                }
                
                advancedSearch = new AdvancedSearch();
                window.advancedSearch = advancedSearch;
                
                // Cargar opciones de filtros
                await loadFilterOptions();
                
                console.log('✅ Búsqueda avanzada inicializada');
            } catch (error) {
                console.error('❌ Error inicializando búsqueda avanzada:', error);
                // No bloquear la aplicación si falla la búsqueda avanzada
            }
        }

        // Cargar opciones de filtros
        async function loadFilterOptions() {
            if (!advancedSearch) return;
            
            try {
                const options = await advancedSearch.getFilterOptions();
                
                // Cargar series
                const seriesSelect = document.getElementById('filterSeries');
                if (seriesSelect) {
                    seriesSelect.innerHTML = '<option value="">Todas las series</option>';
                    options.series.forEach(series => {
                        const option = document.createElement('option');
                        option.value = series.value;
                        option.textContent = `${series.label} (${series.count})`;
                        seriesSelect.appendChild(option);
                    });
                }
                
                // Cargar sets
                const setSelect = document.getElementById('filterSet');
                if (setSelect) {
                    setSelect.innerHTML = '<option value="">Todos los sets</option>';
                    options.sets.forEach(set => {
                        const option = document.createElement('option');
                        option.value = set.value;
                        option.textContent = `${set.label} (${set.count})`;
                        setSelect.appendChild(option);
                    });
                }
                
                // Cargar rarezas
                const raritySelect = document.getElementById('filterRarity');
                if (raritySelect) {
                    raritySelect.innerHTML = '<option value="">Todas las rarezas</option>';
                    options.rarities.forEach(rarity => {
                        const option = document.createElement('option');
                        option.value = rarity.value;
                        option.textContent = `${rarity.label} (${rarity.count})`;
                        raritySelect.appendChild(option);
                    });
                }
                
                // Cargar tipos
                const typeSelect = document.getElementById('filterType');
                if (typeSelect) {
                    typeSelect.innerHTML = '<option value="">Todos los tipos</option>';
                    options.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.value;
                        option.textContent = `${type.label} (${type.count})`;
                        typeSelect.appendChild(option);
                    });
                }
                
                // Cargar subtipos
                const subtypeSelect = document.getElementById('filterSubtype');
                if (subtypeSelect) {
                    subtypeSelect.innerHTML = '<option value="">Todos los subtipos</option>';
                    options.subtypes.forEach(subtype => {
                        const option = document.createElement('option');
                        option.value = subtype.value;
                        option.textContent = `${subtype.label} (${subtype.count})`;
                        subtypeSelect.appendChild(option);
                    });
                }
                
                // Cargar idiomas
                const languageSelect = document.getElementById('filterLanguage');
                if (languageSelect) {
                    languageSelect.innerHTML = '<option value="">Todos los idiomas</option>';
                    options.languages.forEach(language => {
                        const option = document.createElement('option');
                        option.value = language.value;
                        option.textContent = `${language.label} (${language.count})`;
                        languageSelect.appendChild(option);
                    });
                }
                
                console.log('✅ Opciones de filtros cargadas');
            } catch (error) {
                console.error('❌ Error cargando opciones de filtros:', error);
            }
        }

        // Alternar panel de búsqueda avanzada
        function toggleAdvancedSearch() {
            try {
                const panel = document.getElementById('advancedSearchPanel');
                if (panel) {
                    const isHidden = panel.classList.contains('hidden');
                    panel.classList.toggle('hidden');
                    
                    // Si se está abriendo el panel, cargar los filtros
                    if (isHidden) {
                        console.log('🔄 Abriendo panel de filtros avanzados, cargando datos...');
                        loadAdvancedFilters();
                    }
                    
                    // Ajustar espaciador del header
                    const spacer = document.querySelector('.header-spacer');
                    if (spacer) {
                        if (panel.classList.contains('hidden')) {
                            spacer.classList.remove('mt-64');
                        } else {
                            spacer.classList.add('mt-64');
                        }
                    }
                } else {
                    console.warn('⚠️ Panel de búsqueda avanzada no encontrado');
                }
            } catch (error) {
                console.error('❌ Error al alternar búsqueda avanzada:', error);
            }
        }

        // Realizar búsqueda avanzada
        async function performAdvancedSearch() {
            console.log('🚀 performAdvancedSearch() ejecutándose...');
            try {
                // Obtener valores de los filtros
                const filters = {
                    series: document.getElementById('filterSeries')?.value || '',
                    set: document.getElementById('filterSet')?.value || '',
                    rarity: document.getElementById('filterRarity')?.value || '',
                    type: document.getElementById('filterType')?.value || '',
                    subtype: document.getElementById('filterSubtype')?.value || '',
                    language: document.getElementById('filterLanguage')?.value || '',
                    hasImage: document.getElementById('filterHasImage')?.value || '',
                    hasPrice: document.getElementById('filterHasPrice')?.value || ''
                };
                
                // Obtener query de búsqueda
                const query = document.getElementById('searchInput')?.value || '';
                
                console.log('🔍 Ejecutando búsqueda avanzada...', { query, filters });
                
                // Actualizar el estado de filtros global
                searchFiltersState.series = filters.series;
                searchFiltersState.set = filters.set;
                searchFiltersState.rarity = filters.rarity;
                searchFiltersState.type = filters.type;
                searchFiltersState.language = filters.language;
                searchFiltersState.subtype = filters.subtype;
                searchFiltersState.hasImage = filters.hasImage;
                searchFiltersState.hasPrice = filters.hasPrice;
                
                console.log('📋 Estado de filtros actualizado:', searchFiltersState);
                
                // Verificar que los filtros se aplicaron correctamente
                console.log('🔍 Verificando filtros antes de búsqueda:');
                console.log('  - Serie:', searchFiltersState.series);
                console.log('  - Set:', searchFiltersState.set);
                console.log('  - Rareza:', searchFiltersState.rarity);
                console.log('  - Tipo:', searchFiltersState.type);
                console.log('  - Idioma:', searchFiltersState.language);
                console.log('  - Subtipo:', searchFiltersState.subtype);
                console.log('  - Con imagen:', searchFiltersState.hasImage);
                console.log('  - Con precio:', searchFiltersState.hasPrice);
                
                // Verificar si hay filtros activos
                const hasActiveFilters = filters.series || filters.set || filters.rarity || filters.type || filters.subtype || filters.language || filters.hasImage || filters.hasPrice;
                
                // Construir query de texto
                let searchQuery = '';
                if (hasActiveFilters) {
                    // Si hay filtros, no buscar texto, solo usar filtros
                    searchQuery = '';
                    console.log('🔍 Búsqueda solo con filtros (sin texto)');
                } else {
                    // Si no hay filtros, usar el texto de búsqueda
                    searchQuery = query || 'pokemon';
                    console.log('🔍 Búsqueda solo con texto:', searchQuery);
                }
                
                console.log('🔤 Query de texto final:', searchQuery);
                
                // Construir descripción para mostrar en el input (solo para visualización)
                const filterDescriptions = [];
                if (filters.series) filterDescriptions.push(`Serie: ${filters.series}`);
                if (filters.set) filterDescriptions.push(`Set: ${filters.set}`);
                if (filters.rarity) filterDescriptions.push(`Rareza: ${filters.rarity}`);
                if (filters.type) filterDescriptions.push(`Tipo: ${filters.type}`);
                if (filters.subtype) filterDescriptions.push(`Subtipo: ${filters.subtype}`);
                if (filters.language) filterDescriptions.push(`Idioma: ${filters.language}`);
                if (filters.hasImage === 'true') filterDescriptions.push('Con imagen');
                if (filters.hasPrice === 'true') filterDescriptions.push('Con precio');
                
                // Mostrar descripción en el input
                let displayText = '';
                if (hasActiveFilters) {
                    // Si hay filtros, mostrar solo los filtros
                    displayText = filterDescriptions.join(', ');
                } else {
                    // Si no hay filtros, mostrar el texto de búsqueda
                    displayText = searchQuery;
                }
                
                console.log('📱 Texto a mostrar en input:', displayText);
                
                // Establecer el valor en el input de búsqueda (solo para visualización)
                if (searchInput) {
                    searchInput.value = displayText;
                }
                
                // Cerrar panel de filtros avanzados
                toggleAdvancedSearch();
                
                // Ejecutar búsqueda normal con la query construida
                // Los filtros ya están en searchFiltersState y se aplicarán automáticamente
                await fetchCards(searchQuery);
                
                console.log('✅ Búsqueda avanzada redirigida a búsqueda normal');
                
            } catch (error) {
                console.error('❌ Error en búsqueda avanzada:', error);
                showNotification('Error en la búsqueda avanzada: ' + error.message, 'error');
            }
        }

        // Limpiar filtros avanzados
        function clearAdvancedFilters() {
            const selects = document.querySelectorAll('#advancedSearchPanel .filter-select');
            selects.forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Limpiar también el input de búsqueda
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Limpiar el estado de filtros global
            searchFiltersState.series = '';
            searchFiltersState.set = '';
            searchFiltersState.rarity = '';
            searchFiltersState.type = '';
            searchFiltersState.language = '';
            searchFiltersState.subtype = '';
            searchFiltersState.hasImage = '';
            searchFiltersState.hasPrice = '';
            
            showNotification('Filtros limpiados', 'success');
        }

        // Función de prueba para mostrar resultados manualmente
        function testShowResults() {
            console.log('🧪 Función de prueba ejecutándose...');
            const searchSection = document.getElementById('searchResults');
            if (searchSection) {
                searchSection.classList.remove('hidden');
                searchSection.style.display = 'block';
                searchSection.style.visibility = 'visible';
                searchSection.style.opacity = '1';
                console.log('✅ Sección forzada a ser visible');
                
                // Ocultar hero section
                if (heroSection) {
                    heroSection.classList.add('hidden');
                    console.log('✅ Hero section ocultado');
                }
            } else {
                console.error('❌ No se encontró la sección searchResults');
            }
        }

        // Hacer funciones disponibles globalmente
        window.toggleAdvancedSearch = toggleAdvancedSearch;
        window.performAdvancedSearch = performAdvancedSearch;
        window.clearAdvancedFilters = clearAdvancedFilters;
        window.testShowResults = testShowResults;

        console.log('🚀 Script principal iniciado correctamente');
        
        // Función de prueba de API (removida - ya no se necesita)

        // Función de búsqueda rápida
        window.quickSearch = async () => {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (query.length > 0 && query.length < 2) {
                alert('Por favor, escribe al menos 2 caracteres para buscar.');
                return;
            }
            
            console.log('🚀 Búsqueda rápida iniciada para:', query);
            
            try {
                const encodedQuery = encodeURIComponent(query.toLowerCase());
                const quickUrl = `https://tcgtrade-production.up.railway.app/api/pokemontcg/cards?q=${encodedQuery}&pageSize=10`;
                
                console.log('🚀 Quick URL:', quickUrl);
                
                const response = await fetch(quickUrl, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const cards = data.data || [];
                    console.log('✅ Cartas encontradas:', cards.length);
                    alert(`✅ Encontradas ${cards.length} cartas para "${query}"`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('❌ Error en búsqueda:', error);
                alert(`❌ Error en búsqueda: ${error.message}`);
            }
        };

        console.log('🚀 Funciones globales cargadas');
    </script>
</body>
</html>